"use strict";function SymbolDef(a,c,b){this.name=c.name;this.orig=[c];this.init=b;this.eliminated=0;this.scope=a;this.references=[];this.replaced=0;this.global=false;this.mangled_name=null;this.undeclared=false;this.id=SymbolDef.next_id++}SymbolDef.next_id=1;SymbolDef.prototype={unmangleable:function(options){if(!options){options={}}return this.global&&!options.toplevel||this.undeclared||!options.eval&&this.scope.pinned()||options.keep_fnames&&(this.orig[0] instanceof AST_SymbolLambda||this.orig[0] instanceof AST_SymbolDefun)},mangle:function(b){var a=b.cache&&b.cache.props;if(this.global&&a&&a.has(this.name)){this.mangled_name=a.get(this.name)}else{if(!this.mangled_name&&!this.unmangleable(b)){var c;if(c=this.redefined()){this.mangled_name=c.mangled_name||c.name}else{this.mangled_name=next_mangled_name(this.scope,b,this)}if(this.global&&a){a.set(this.name,this.mangled_name)}}}},redefined:function(){return this.defun&&this.defun.variables.get(this.name)}};AST_Toplevel.DEFMETHOD("figure_out_scope",function(d){d=defaults(d,{cache:null,ie8:false});var c=this;var e=c.parent_scope=null;var a=null;var b=new TreeWalker(function(j,i){if(j instanceof AST_Catch){var g=e;e=new AST_Scope(j);e.init_scope_vars(g);i();e=g;return true}if(j instanceof AST_Scope){j.init_scope_vars(e);var g=e;var f=a;a=e=j;i();e=g;a=f;return true}if(j instanceof AST_With){for(var h=e;h;h=h.parent_scope){h.uses_with=true}return}if(j instanceof AST_Symbol){j.scope=e}if(j instanceof AST_Label){j.thedef=j;j.references=[]}if(j instanceof AST_SymbolLambda){a.def_function(j,j.name=="arguments"?undefined:a)}else{if(j instanceof AST_SymbolDefun){(j.scope=a.parent_scope).def_function(j,a)}else{if(j instanceof AST_SymbolVar){a.def_variable(j,j.TYPE=="SymbolVar"?null:undefined);if(a!==e){j.mark_enclosed(d);var k=e.find_variable(j);if(j.thedef!==k){j.thedef=k}j.reference(d)}}else{if(j instanceof AST_SymbolCatch){e.def_variable(j).defun=a}}}}});c.walk(b);c.globals=new Dictionary();var b=new TreeWalker(function(j,i){if(j instanceof AST_LoopControl&&j.label){j.label.thedef.references.push(j);return true}if(j instanceof AST_SymbolRef){var g=j.name;if(g=="eval"&&b.parent() instanceof AST_Call){for(var h=j.scope;h&&!h.uses_eval;h=h.parent_scope){h.uses_eval=true}}var f=j.scope.find_variable(g);if(!f){f=c.def_global(j)}else{if(f.scope instanceof AST_Lambda&&g=="arguments"){f.scope.uses_arguments=true}}j.thedef=f;j.reference(d);return true}var k;if(j instanceof AST_SymbolCatch&&(k=j.definition().redefined())){var h=j.scope;while(h){push_uniq(h.enclosed,k);if(h===k.scope){break}h=h.parent_scope}}});c.walk(b);if(d.ie8){c.walk(new TreeWalker(function(j,i){if(j instanceof AST_SymbolCatch){var g=j.name;var f=j.thedef.references;var h=j.thedef.defun;var k=h.find_variable(g)||c.globals.get(g)||h.def_variable(j);f.forEach(function(l){l.thedef=k;l.reference(d)});j.thedef=k;j.reference(d);return true}}))}});AST_Toplevel.DEFMETHOD("def_global",function(d){var c=this.globals,a=d.name;if(c.has(a)){return c.get(a)}else{var b=new SymbolDef(this,d);b.undeclared=true;b.global=true;c.set(a,b);return b}});AST_Scope.DEFMETHOD("init_scope_vars",function(a){this.variables=new Dictionary();this.functions=new Dictionary();this.uses_with=false;this.uses_eval=false;this.parent_scope=a;this.enclosed=[];this.cname=-1});AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments);this.uses_arguments=false;this.def_variable(new AST_SymbolFunarg({name:"arguments",start:this.start,end:this.end}))});AST_Symbol.DEFMETHOD("mark_enclosed",function(a){var c=this.definition();var b=this.scope;while(b){push_uniq(b.enclosed,c);if(a.keep_fnames){b.functions.each(function(e){push_uniq(c.scope.enclosed,e)})}if(b===c.scope){break}b=b.parent_scope}});AST_Symbol.DEFMETHOD("reference",function(a){this.definition().references.push(this);this.mark_enclosed(a)});AST_Scope.DEFMETHOD("find_variable",function(a){if(a instanceof AST_Symbol){a=a.name}return this.variables.get(a)||(this.parent_scope&&this.parent_scope.find_variable(a))});AST_Scope.DEFMETHOD("def_function",function(b,c){var a=this.def_variable(b,c);if(!a.init||a.init instanceof AST_Defun){a.init=c}this.functions.set(b.name,a);return a});AST_Scope.DEFMETHOD("def_variable",function(b,c){var a=this.variables.get(b.name);if(a){a.orig.push(b);if(a.init&&(a.scope!==b.scope||a.init instanceof AST_Function)){a.init=c}}else{a=new SymbolDef(this,b,c);this.variables.set(b.name,a);a.global=!this.parent_scope}return b.thedef=a});function names_in_use(b,a){var c=b.names_in_use;if(!c){b.names_in_use=c=Object.create(b.mangled_names||null);b.cname_holes=[];b.enclosed.forEach(function(d){if(d.unmangleable(a)){c[d.name]=true}})}return c}function next_mangled_name(k,l,b){var h=names_in_use(k,l);var c=k.cname_holes;var g=Object.create(null);if(k instanceof AST_Function&&k.name&&b.orig[0] instanceof AST_SymbolFunarg){var f=k.name.definition();g[f.mangled_name||f.name]=true}var j=[k];b.references.forEach(function(i){var n=i.scope;do{if(j.indexOf(n)<0){for(var m in names_in_use(n,l)){g[m]=true}j.push(n)}else{break}}while(n=n.parent_scope)});var a;for(var d=0,e=c.length;d<e;d++){a=base54(c[d]);if(g[a]){continue}c.splice(d,1);k.names_in_use[a]=true;return a}while(true){a=base54(++k.cname);if(h[a]||!is_identifier(a)||l.reserved.has[a]){continue}if(!g[a]){break}c.push(k.cname)}k.names_in_use[a]=true;if(l.ie8&&b.orig[0] instanceof AST_SymbolLambda){names_in_use(k.parent_scope,l)[a]=true}return a}AST_Symbol.DEFMETHOD("unmangleable",function(a){var b=this.definition();return !b||b.unmangleable(a)});AST_Label.DEFMETHOD("unmangleable",return_false);AST_Symbol.DEFMETHOD("unreferenced",function(){return !this.definition().references.length&&!this.scope.pinned()});AST_Symbol.DEFMETHOD("definition",function(){return this.thedef});AST_Symbol.DEFMETHOD("global",function(){return this.definition().global});function _default_mangler_options(options){options=defaults(options,{eval:false,ie8:false,keep_fnames:false,reserved:[],toplevel:false});if(!Array.isArray(options.reserved)){options.reserved=[]}push_uniq(options.reserved,"arguments");options.reserved.has=makePredicate(options.reserved);return options}AST_Toplevel.DEFMETHOD("mangle_names",function(e){e=_default_mangler_options(e);var c=-1;if(e.cache&&e.cache.props){var f=this.mangled_names=Object.create(null);e.cache.props.each(function(g){f[g]=true})}var d=[];var b=new TreeWalker(function(l,k){if(l instanceof AST_LabeledStatement){var j=c;k();c=j;return true}if(l instanceof AST_Scope){k();if(e.cache&&l instanceof AST_Toplevel){l.globals.each(a)}l.variables.each(a);return true}if(l instanceof AST_Label){var i;do{i=base54(++c)}while(!is_identifier(i));l.mangled_name=i;return true}if(!e.ie8&&l instanceof AST_Catch){var m=l.argname.definition();var h=m.redefined();if(h){d.push(m);g(l.argname);m.references.forEach(g)}k();if(!h){a(m)}return true}function g(n){n.thedef=h;n.reference(e);n.thedef=m}});this.walk(b);d.forEach(a);function a(g){if(e.reserved.has[g.name]){return}g.mangle(e)}});AST_Toplevel.DEFMETHOD("find_colliding_names",function(d){var a=d.cache&&d.cache.props;var c=Object.create(null);d.reserved.forEach(e);this.globals.each(b);this.walk(new TreeWalker(function(f){if(f instanceof AST_Scope){f.variables.each(b)}if(f instanceof AST_SymbolCatch){b(f.definition())}}));return c;function e(f){c[f]=true}function b(g){var f=g.name;if(g.global&&a&&a.has(f)){f=a.get(f)}else{if(!g.unmangleable(d)){return}}e(f)}});AST_Toplevel.DEFMETHOD("expand_names",function(e){base54.reset();base54.sort();e=_default_mangler_options(e);var d=this.find_colliding_names(e);var c=0;this.globals.each(a);this.walk(new TreeWalker(function(f){if(f instanceof AST_Scope){f.variables.each(a)}if(f instanceof AST_SymbolCatch){a(f.definition())}}));function b(){var f;do{f=base54(c++)}while(d[f]||!is_identifier(f));return f}function a(f){if(f.global&&e.cache){return}if(f.unmangleable(e)){return}if(e.reserved.has[f.name]){return}var g=f.redefined();f.name=g?g.name:b();f.orig.forEach(function(h){h.name=f.name});f.references.forEach(function(h){h.name=f.name})}});AST_Node.DEFMETHOD("tail_node",return_this);AST_Sequence.DEFMETHOD("tail_node",function(){return this.expressions[this.expressions.length-1]});AST_Toplevel.DEFMETHOD("compute_char_frequency",function(b){b=_default_mangler_options(b);base54.reset();try{AST_Node.prototype.print=function(d,c){this._print(d,c);if(this instanceof AST_Symbol&&!this.unmangleable(b)){base54.consider(this.name,-1)}else{if(b.properties){if(this instanceof AST_Dot){base54.consider(this.property,-1)}else{if(this instanceof AST_Sub){a(this.property)}}}}};base54.consider(this.print_to_string(),1)}finally{AST_Node.prototype.print=AST_Node.prototype._print}base54.sort();function a(c){if(c instanceof AST_String){base54.consider(c.value,-1)}else{if(c instanceof AST_Conditional){a(c.consequent);a(c.alternative)}else{if(c instanceof AST_Sequence){a(c.tail_node())}}}}});var base54=(function(){var a=Object.create(null);function i(m){var n=[];for(var k=0,j=m.length;k<j;k++){var l=m[k];n.push(l);a[l]=-0.01*k}return n}var c=i("0123456789");var d=i("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_");var g,f;function e(){f=Object.create(a)}h.consider=function(k,l){for(var j=k.length;--j>=0;){f[k[j]]+=l}};function b(k,j){return f[j]-f[k]}h.sort=function(){g=d.sort(b).concat(c.sort(b))};h.reset=e;e();function h(k){var j="",l=54;k++;do{k--;j+=g[k%l];k=Math.floor(k/l);l=64}while(k>0);return j}return h})();