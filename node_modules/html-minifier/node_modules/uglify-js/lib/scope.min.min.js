"use strict";function SymbolDef(e,f,d){this.name=f.name;this.orig=[f];this.init=d;this.eliminated=0;this.scope=e;this.references=[];this.replaced=0;this.global=false;this.mangled_name=null;this.undeclared=false;this.id=SymbolDef.next_id++}SymbolDef.next_id=1;SymbolDef.prototype={unmangleable:function(options){if(!options){options={}}return this.global&&!options.toplevel||this.undeclared||!options.eval&&this.scope.pinned()||options.keep_fnames&&(this.orig[0] instanceof AST_SymbolLambda||this.orig[0] instanceof AST_SymbolDefun)},mangle:function(d){var e=d.cache&&d.cache.props;if(this.global&&e&&e.has(this.name)){this.mangled_name=e.get(this.name)}else{if(!this.mangled_name&&!this.unmangleable(d)){var f;if(f=this.redefined()){this.mangled_name=f.mangled_name||f.name}else{this.mangled_name=next_mangled_name(this.scope,d,this)}if(this.global&&e){e.set(this.name,this.mangled_name)}}}},redefined:function(){return this.defun&&this.defun.variables.get(this.name)}};AST_Toplevel.DEFMETHOD("figure_out_scope",function(i){i=defaults(i,{cache:null,ie8:false});var j=this;var h=j.parent_scope=null;var g=null;var f=new TreeWalker(function(b,c){if(b instanceof AST_Catch){var e=h;h=new AST_Scope(b);h.init_scope_vars(e);c();h=e;return true}if(b instanceof AST_Scope){b.init_scope_vars(h);var e=h;var l=g;g=h=b;c();h=e;g=l;return true}if(b instanceof AST_With){for(var d=h;d;d=d.parent_scope){d.uses_with=true}return}if(b instanceof AST_Symbol){b.scope=h}if(b instanceof AST_Label){b.thedef=b;b.references=[]}if(b instanceof AST_SymbolLambda){g.def_function(b,b.name=="arguments"?undefined:g)}else{if(b instanceof AST_SymbolDefun){(b.scope=g.parent_scope).def_function(b,g)}else{if(b instanceof AST_SymbolVar){g.def_variable(b,b.TYPE=="SymbolVar"?null:undefined);if(g!==h){b.mark_enclosed(i);var a=h.find_variable(b);if(b.thedef!==a){b.thedef=a}b.reference(i)}}else{if(b instanceof AST_SymbolCatch){h.def_variable(b).defun=g}}}}});j.walk(f);j.globals=new Dictionary();var f=new TreeWalker(function(b,c){if(b instanceof AST_LoopControl&&b.label){b.label.thedef.references.push(b);return true}if(b instanceof AST_SymbolRef){var e=b.name;if(e=="eval"&&f.parent() instanceof AST_Call){for(var d=b.scope;d&&!d.uses_eval;d=d.parent_scope){d.uses_eval=true}}var l=b.scope.find_variable(e);if(!l){l=j.def_global(b)}else{if(l.scope instanceof AST_Lambda&&e=="arguments"){l.scope.uses_arguments=true}}b.thedef=l;b.reference(i);return true}var a;if(b instanceof AST_SymbolCatch&&(a=b.definition().redefined())){var d=b.scope;while(d){push_uniq(d.enclosed,a);if(d===a.scope){break}d=d.parent_scope}}});j.walk(f);if(i.ie8){j.walk(new TreeWalker(function(b,c){if(b instanceof AST_SymbolCatch){var e=b.name;var l=b.thedef.references;var d=b.thedef.defun;var a=d.find_variable(e)||j.globals.get(e)||d.def_variable(b);l.forEach(function(k){k.thedef=a;k.reference(i)});b.thedef=a;b.reference(i);return true}}))}});AST_Toplevel.DEFMETHOD("def_global",function(g){var h=this.globals,f=g.name;if(h.has(f)){return h.get(f)}else{var e=new SymbolDef(this,g);e.undeclared=true;e.global=true;h.set(f,e);return e}});AST_Scope.DEFMETHOD("init_scope_vars",function(b){this.variables=new Dictionary();this.functions=new Dictionary();this.uses_with=false;this.uses_eval=false;this.parent_scope=b;this.enclosed=[];this.cname=-1});AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments);this.uses_arguments=false;this.def_variable(new AST_SymbolFunarg({name:"arguments",start:this.start,end:this.end}))});AST_Symbol.DEFMETHOD("mark_enclosed",function(e){var f=this.definition();var d=this.scope;while(d){push_uniq(d.enclosed,f);if(e.keep_fnames){d.functions.each(function(a){push_uniq(f.scope.enclosed,a)})}if(d===f.scope){break}d=d.parent_scope}});AST_Symbol.DEFMETHOD("reference",function(b){this.definition().references.push(this);this.mark_enclosed(b)});AST_Scope.DEFMETHOD("find_variable",function(b){if(b instanceof AST_Symbol){b=b.name}return this.variables.get(b)||(this.parent_scope&&this.parent_scope.find_variable(b))});AST_Scope.DEFMETHOD("def_function",function(d,f){var e=this.def_variable(d,f);if(!e.init||e.init instanceof AST_Defun){e.init=f}this.functions.set(d.name,e);return e});AST_Scope.DEFMETHOD("def_variable",function(d,f){var e=this.variables.get(d.name);if(e){e.orig.push(d);if(e.init&&(e.scope!==d.scope||e.init instanceof AST_Function)){e.init=f}}else{e=new SymbolDef(this,d,f);this.variables.set(d.name,e);e.global=!this.parent_scope}return d.thedef=e});function names_in_use(d,e){var f=d.names_in_use;if(!f){d.names_in_use=f=Object.create(d.mangled_names||null);d.cname_holes=[];d.enclosed.forEach(function(a){if(a.unmangleable(e)){f[a.name]=true}})}return f}function next_mangled_name(m,i,u){var o=names_in_use(m,i);var t=m.cname_holes;var p=Object.create(null);if(m instanceof AST_Function&&m.name&&u.orig[0] instanceof AST_SymbolFunarg){var q=m.name.definition();p[q.mangled_name||q.name]=true}var n=[m];u.references.forEach(function(b){var c=b.scope;do{if(n.indexOf(c)<0){for(var a in names_in_use(c,i)){p[a]=true}n.push(c)}else{break}}while(c=c.parent_scope)});var v;for(var s=0,r=t.length;s<r;s++){v=base54(t[s]);if(p[v]){continue}t.splice(s,1);m.names_in_use[v]=true;return v}while(true){v=base54(++m.cname);if(o[v]||!is_identifier(v)||i.reserved.has[v]){continue}if(!p[v]){break}t.push(m.cname)}m.names_in_use[v]=true;if(i.ie8&&u.orig[0] instanceof AST_SymbolLambda){names_in_use(m.parent_scope,i)[v]=true}return v}AST_Symbol.DEFMETHOD("unmangleable",function(d){var c=this.definition();return !c||c.unmangleable(d)});AST_Label.DEFMETHOD("unmangleable",return_false);AST_Symbol.DEFMETHOD("unreferenced",function(){return !this.definition().references.length&&!this.scope.pinned()});AST_Symbol.DEFMETHOD("definition",function(){return this.thedef});AST_Symbol.DEFMETHOD("global",function(){return this.definition().global});function _default_mangler_options(options){options=defaults(options,{eval:false,ie8:false,keep_fnames:false,reserved:[],toplevel:false});if(!Array.isArray(options.reserved)){options.reserved=[]}push_uniq(options.reserved,"arguments");options.reserved.has=makePredicate(options.reserved);return options}AST_Toplevel.DEFMETHOD("mangle_names",function(j){j=_default_mangler_options(j);var l=-1;if(j.cache&&j.cache.props){var i=this.mangled_names=Object.create(null);j.cache.props.each(function(a){i[a]=true})}var k=[];var g=new TreeWalker(function(b,c){if(b instanceof AST_LabeledStatement){var d=l;c();l=d;return true}if(b instanceof AST_Scope){c();if(j.cache&&b instanceof AST_Toplevel){b.globals.each(h)}b.variables.each(h);return true}if(b instanceof AST_Label){var e;do{e=base54(++l)}while(!is_identifier(e));b.mangled_name=e;return true}if(!j.ie8&&b instanceof AST_Catch){var a=b.argname.definition();var f=a.redefined();if(f){k.push(a);n(b.argname);a.references.forEach(n)}c();if(!f){h(a)}return true}function n(m){m.thedef=f;m.reference(j);m.thedef=a}});this.walk(g);k.forEach(h);function h(a){if(j.reserved.has[a.name]){return}a.mangle(j)}});AST_Toplevel.DEFMETHOD("find_colliding_names",function(i){var g=i.cache&&i.cache.props;var j=Object.create(null);i.reserved.forEach(h);this.globals.each(f);this.walk(new TreeWalker(function(a){if(a instanceof AST_Scope){a.variables.each(f)}if(a instanceof AST_SymbolCatch){f(a.definition())}}));return j;function h(a){j[a]=true}function f(a){var b=a.name;if(a.global&&g&&g.has(b)){b=g.get(b)}else{if(!a.unmangleable(i)){return}}h(b)}});AST_Toplevel.DEFMETHOD("expand_names",function(h){base54.reset();base54.sort();h=_default_mangler_options(h);var i=this.find_colliding_names(h);var j=0;this.globals.each(g);this.walk(new TreeWalker(function(a){if(a instanceof AST_Scope){a.variables.each(g)}if(a instanceof AST_SymbolCatch){g(a.definition())}}));function f(){var a;do{a=base54(j++)}while(i[a]||!is_identifier(a));return a}function g(b){if(b.global&&h.cache){return}if(b.unmangleable(h)){return}if(h.reserved.has[b.name]){return}var a=b.redefined();b.name=a?a.name:f();b.orig.forEach(function(c){c.name=b.name});b.references.forEach(function(c){c.name=b.name})}});AST_Node.DEFMETHOD("tail_node",return_this);AST_Sequence.DEFMETHOD("tail_node",function(){return this.expressions[this.expressions.length-1]});AST_Toplevel.DEFMETHOD("compute_char_frequency",function(c){c=_default_mangler_options(c);base54.reset();try{AST_Node.prototype.print=function(a,b){this._print(a,b);if(this instanceof AST_Symbol&&!this.unmangleable(c)){base54.consider(this.name,-1)}else{if(c.properties){if(this instanceof AST_Dot){base54.consider(this.property,-1)}else{if(this instanceof AST_Sub){d(this.property)}}}}};base54.consider(this.print_to_string(),1)}finally{AST_Node.prototype.print=AST_Node.prototype._print}base54.sort();function d(a){if(a instanceof AST_String){base54.consider(a.value,-1)}else{if(a instanceof AST_Conditional){d(a.consequent);d(a.alternative)}else{if(a instanceof AST_Sequence){d(a.tail_node())}}}}});var base54=(function(){var r=Object.create(null);function j(a){var e=[];for(var c=0,d=a.length;c<d;c++){var b=a[c];e.push(b);r[b]=-0.01*c}return e}var p=j("0123456789");var o=j("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_");var l,m;function n(){m=Object.create(r)}k.consider=function(b,a){for(var c=b.length;--c>=0;){m[b[c]]+=a}};function q(a,b){return m[b]-m[a]}k.sort=function(){l=o.sort(q).concat(p.sort(q))};k.reset=n;n();function k(b){var c="",a=54;b++;do{b--;c+=l[b%a];b=Math.floor(b/a);a=64}while(b>0);return c}return k})();