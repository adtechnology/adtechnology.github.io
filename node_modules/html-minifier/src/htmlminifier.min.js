"use strict";var CleanCSS=require("clean-css");var decode=require("he").decode;var HTMLParser=require("./htmlparser").HTMLParser;var RelateUrl=require("relateurl");var TokenChain=require("./tokenchain");var UglifyJS=require("uglify-js");var utils=require("./utils");function trimWhitespace(a){return a&&a.replace(/^[ \n\r\t\f]+/,"").replace(/[ \n\r\t\f]+$/,"")}function collapseWhitespaceAll(a){return a&&a.replace(/[ \n\r\t\f\xA0]+/g,function(b){return b==="\t"?"\t":b.replace(/(^|\xA0+)[^\xA0]+/g,"$1 ")})}function collapseWhitespace(g,d,f,b,a){var c="",e="";if(d.preserveLineBreaks){g=g.replace(/^[ \n\r\t\f]*?[\n\r][ \n\r\t\f]*/,function(){c="\n";return""}).replace(/[ \n\r\t\f]*?[\n\r][ \n\r\t\f]*$/,function(){e="\n";return""})}if(f){g=g.replace(/^[ \n\r\t\f\xA0]+/,function(i){var h=!c&&d.conservativeCollapse;if(h&&i==="\t"){return"\t"}return i.replace(/^[^\xA0]+/,"").replace(/(\xA0+)[^\xA0]+/g,"$1 ")||(h?" ":"")})}if(b){g=g.replace(/[ \n\r\t\f\xA0]+$/,function(i){var h=!e&&d.conservativeCollapse;if(h&&i==="\t"){return"\t"}return i.replace(/[^\xA0]+(\xA0+)/g," $1").replace(/[^\xA0]+$/,"")||(h?" ":"")})}if(a){g=collapseWhitespaceAll(g)}return c+g+e}var createMapFromString=utils.createMapFromString;var inlineTags=createMapFromString("a,abbr,acronym,b,bdi,bdo,big,button,cite,code,del,dfn,em,font,i,ins,kbd,label,mark,math,nobr,object,q,rp,rt,rtc,ruby,s,samp,select,small,span,strike,strong,sub,sup,svg,textarea,time,tt,u,var");var inlineTextTags=createMapFromString("a,abbr,acronym,b,big,del,em,font,i,ins,kbd,mark,nobr,rp,s,samp,small,span,strike,strong,sub,sup,time,tt,u,var");var selfClosingInlineTags=createMapFromString("comment,img,input,wbr");function collapseWhitespaceSmart(f,b,d,c){var e=b&&!selfClosingInlineTags(b);if(e&&!c.collapseInlineTagWhitespace){e=b.charAt(0)==="/"?!inlineTags(b.slice(1)):!inlineTextTags(b)}var a=d&&!selfClosingInlineTags(d);if(a&&!c.collapseInlineTagWhitespace){a=d.charAt(0)==="/"?!inlineTextTags(d.slice(1)):!inlineTags(d)}return collapseWhitespace(f,c,e,a,b&&d)}function isConditionalComment(a){return/^\[if\s[^\]]+]|\[endif]$/.test(a)}function isIgnoredComment(d,b){for(var c=0,a=b.ignoreCustomComments.length;c<a;c++){if(b.ignoreCustomComments[c].test(d)){return true}}return false}function isEventAttribute(c,a){var d=a.customEventAttributes;if(d){for(var b=d.length;b--;){if(d[b].test(c)){return true}}return false}return/^on[a-z]{3,}$/.test(c)}function canRemoveAttributeQuotes(a){return/^[^ \t\n\f\r"'`=<>]+$/.test(a)}function attributesInclude(a,c){for(var b=a.length;b--;){if(a[b].name.toLowerCase()===c){return true}}return false}function isAttributeRedundant(a,c,d,b){d=d?trimWhitespace(d.toLowerCase()):"";return(a==="script"&&c==="language"&&d==="javascript"||a==="form"&&c==="method"&&d==="get"||a==="input"&&c==="type"&&d==="text"||a==="script"&&c==="charset"&&!attributesInclude(b,"src")||a==="a"&&c==="name"&&attributesInclude(b,"id")||a==="area"&&c==="shape"&&d==="rect")}var executableScriptsMimetypes=utils.createMap(["text/javascript","text/ecmascript","text/jscript","application/javascript","application/x-javascript","application/ecmascript"]);function isScriptTypeAttribute(a){a=trimWhitespace(a.split(/;/,2)[0]).toLowerCase();return a===""||executableScriptsMimetypes(a)}function isExecutableScript(b,c){if(b!=="script"){return false}for(var e=0,a=c.length;e<a;e++){var d=c[e].name.toLowerCase();if(d==="type"){return isScriptTypeAttribute(c[e].value)}}return true}function isStyleLinkTypeAttribute(a){a=trimWhitespace(a).toLowerCase();return a===""||a==="text/css"}function isStyleSheet(b,c){if(b!=="style"){return false}for(var e=0,a=c.length;e<a;e++){var d=c[e].name.toLowerCase();if(d==="type"){return isStyleLinkTypeAttribute(c[e].value)}}return true}var isSimpleBoolean=createMapFromString("allowfullscreen,async,autofocus,autoplay,checked,compact,controls,declare,default,defaultchecked,defaultmuted,defaultselected,defer,disabled,enabled,formnovalidate,hidden,indeterminate,inert,ismap,itemscope,loop,multiple,muted,nohref,noresize,noshade,novalidate,nowrap,open,pauseonexit,readonly,required,reversed,scoped,seamless,selected,sortable,truespeed,typemustmatch,visible");var isBooleanValue=createMapFromString("true,false");function isBooleanAttribute(a,b){return isSimpleBoolean(a)||a==="draggable"&&!isBooleanValue(b)}function isUriTypeAttribute(b,a){return(/^(?:a|area|link|base)$/.test(a)&&b==="href"||a==="img"&&/^(?:src|longdesc|usemap)$/.test(b)||a==="object"&&/^(?:classid|codebase|data|usemap)$/.test(b)||a==="q"&&b==="cite"||a==="blockquote"&&b==="cite"||(a==="ins"||a==="del")&&b==="cite"||a==="form"&&b==="action"||a==="input"&&(b==="src"||b==="usemap")||a==="head"&&b==="profile"||a==="script"&&(b==="src"||b==="for"))}function isNumberTypeAttribute(b,a){return(/^(?:a|area|object|button)$/.test(a)&&b==="tabindex"||a==="input"&&(b==="maxlength"||b==="tabindex")||a==="select"&&(b==="size"||b==="tabindex")||a==="textarea"&&/^(?:rows|cols|tabindex)$/.test(b)||a==="colgroup"&&b==="span"||a==="col"&&b==="span"||(a==="th"||a==="td")&&(b==="rowspan"||b==="colspan"))}function isLinkType(b,c,e){if(b!=="link"){return false}for(var d=0,a=c.length;d<a;d++){if(c[d].name==="rel"&&c[d].value===e){return true}}}function isMediaQuery(a,b,c){return c==="media"&&(isLinkType(a,b,"stylesheet")||isStyleSheet(a,b))}var srcsetTags=createMapFromString("img,source");function isSrcset(b,a){return b==="srcset"&&srcsetTags(a)}function cleanAttributeValue(a,d,e,c,b){if(isEventAttribute(d,c)){e=trimWhitespace(e).replace(/^javascript:\s*/i,"");return c.minifyJS(e,true)}else{if(d==="class"){e=trimWhitespace(e);if(c.sortClassName){e=c.sortClassName(e)}else{e=collapseWhitespaceAll(e)}return e}else{if(isUriTypeAttribute(d,a)){e=trimWhitespace(e);return isLinkType(a,b,"canonical")?e:c.minifyURLs(e)}else{if(isNumberTypeAttribute(d,a)){return trimWhitespace(e)}else{if(d==="style"){e=trimWhitespace(e);if(e){if(/;$/.test(e)&&!/&#?[0-9a-zA-Z]+;$/.test(e)){e=e.replace(/\s*;$/,";")}e=c.minifyCSS(e,"inline")}return e}else{if(isSrcset(d,a)){e=trimWhitespace(e).split(/\s+,\s*|\s*,\s+/).map(function(i){var h=i;var k="";var g=i.match(/\s+([1-9][0-9]*w|[0-9]+(?:\.[0-9]+)?x)$/);if(g){h=h.slice(0,-g[0].length);var f=+g[1].slice(0,-1);var j=g[1].slice(-1);if(f!==1||j!=="x"){k=" "+f+j}}return c.minifyURLs(h)+k}).join(", ")}else{if(isMetaViewport(a,b)&&d==="content"){e=e.replace(/\s+/g,"").replace(/[0-9]+\.[0-9]+/g,function(f){return(+f).toString()})}else{if(c.customAttrCollapse&&c.customAttrCollapse.test(d)){e=e.replace(/\n+|\r+|\s{2,}/g,"")}else{if(a==="script"&&d==="type"){e=trimWhitespace(e.replace(/\s*;\s*/g,";"))}else{if(isMediaQuery(a,b,d)){e=trimWhitespace(e);return c.minifyCSS(e,"media")}}}}}}}}}}return e}function isMetaViewport(b,c){if(b!=="meta"){return false}for(var d=0,a=c.length;d<a;d++){if(c[d].name==="name"&&c[d].value==="viewport"){return true}}}function wrapInlineCSS(a){return"*{"+a+"}"}function unwrapInlineCSS(b){var a=b.match(/^\*\{([\s\S]*)\}$/);return a?a[1]:b}function wrapMediaQuery(a){return"@media "+a+"{a{top:0}}"}function unwrapMediaQuery(b){var a=b.match(/^@media ([\s\S]*?)\s*{[\s\S]*}$/);return a?a[1]:b}function cleanConditionalComment(b,a){return a.processConditionalComments?b.replace(/^(\[if\s[^\]]+]>)([\s\S]*?)(<!\[endif])$/,function(c,d,f,e){return d+minify(f,a,true)+e}):b}function processScript(e,c,b){for(var d=0,a=b.length;d<a;d++){if(b[d].name.toLowerCase()==="type"&&c.processScripts.indexOf(b[d].value)>-1){return minify(e,c)}}return e}var optionalStartTags=createMapFromString("html,head,body,colgroup,tbody");var optionalEndTags=createMapFromString("html,head,body,li,dt,dd,p,rb,rt,rtc,rp,optgroup,option,colgroup,caption,thead,tbody,tfoot,tr,td,th");var headerTags=createMapFromString("meta,link,script,style,template,noscript");var descriptionTags=createMapFromString("dt,dd");var pBlockTags=createMapFromString("address,article,aside,blockquote,details,div,dl,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,hr,main,menu,nav,ol,p,pre,section,table,ul");var pInlineTags=createMapFromString("a,audio,del,ins,map,noscript,video");var rubyTags=createMapFromString("rb,rt,rtc,rp");var rtcTag=createMapFromString("rb,rtc,rp");var optionTag=createMapFromString("option,optgroup");var tableContentTags=createMapFromString("tbody,tfoot");var tableSectionTags=createMapFromString("thead,tbody,tfoot");var cellTags=createMapFromString("td,th");var topLevelTags=createMapFromString("html,head,body");var compactTags=createMapFromString("html,body");var looseTags=createMapFromString("head,colgroup,caption");var trailingTags=createMapFromString("dt,thead");var htmlTags=createMapFromString("a,abbr,acronym,address,applet,area,article,aside,audio,b,base,basefont,bdi,bdo,bgsound,big,blink,blockquote,body,br,button,canvas,caption,center,cite,code,col,colgroup,command,content,data,datalist,dd,del,details,dfn,dialog,dir,div,dl,dt,element,em,embed,fieldset,figcaption,figure,font,footer,form,frame,frameset,h1,h2,h3,h4,h5,h6,head,header,hgroup,hr,html,i,iframe,image,img,input,ins,isindex,kbd,keygen,label,legend,li,link,listing,main,map,mark,marquee,menu,menuitem,meta,meter,multicol,nav,nobr,noembed,noframes,noscript,object,ol,optgroup,option,output,p,param,picture,plaintext,pre,progress,q,rb,rp,rt,rtc,ruby,s,samp,script,section,select,shadow,small,source,spacer,span,strike,strong,style,sub,summary,sup,table,tbody,td,template,textarea,tfoot,th,thead,time,title,tr,track,tt,u,ul,var,video,wbr,xmp");function canRemoveParentTag(b,a){switch(b){case"html":case"head":return true;case"body":return !headerTags(a);case"colgroup":return a==="col";case"tbody":return a==="tr"}return false}function isStartTagMandatory(b,a){switch(a){case"colgroup":return b==="colgroup";case"tbody":return tableSectionTags(b)}return false}function canRemovePrecedingTag(b,a){switch(b){case"html":case"head":case"body":case"colgroup":case"caption":return true;case"li":case"optgroup":case"tr":return a===b;case"dt":case"dd":return descriptionTags(a);case"p":return pBlockTags(a);case"rb":case"rt":case"rp":return rubyTags(a);case"rtc":return rtcTag(a);case"option":return optionTag(a);case"thead":case"tbody":return tableContentTags(a);case"tfoot":return a==="tbody";case"td":case"th":return cellTags(a)}return false}var reEmptyAttribute=new RegExp("^(?:class|id|style|title|lang|dir|on(?:focus|blur|change|click|dblclick|mouse(?:down|up|over|move|out)|key(?:press|down|up)))$");function canDeleteEmptyAttribute(a,c,d,b){var e=!d||/^\s*$/.test(d);if(!e){return false}if(typeof b.removeEmptyAttributes==="function"){return b.removeEmptyAttributes(c,a)}return a==="input"&&c==="value"||reEmptyAttribute.test(c)}function hasAttrName(b,a){for(var c=a.length-1;c>=0;c--){if(a[c].name===b){return true}}return false}function canRemoveElement(a,b){switch(a){case"textarea":return false;case"audio":case"script":case"video":if(hasAttrName("src",b)){return false}break;case"iframe":if(hasAttrName("src",b)||hasAttrName("srcdoc",b)){return false}break;case"object":if(hasAttrName("data",b)){return false}break;case"applet":if(hasAttrName("code",b)){return false}break}return true}function canCollapseWhitespace(a){return !/^(?:script|style|pre|textarea)$/.test(a)}function canTrimWhitespace(a){return !/^(?:pre|textarea)$/.test(a)}function normalizeAttr(b,d,a,c){var e=c.name(b.name),f=b.value;if(c.decodeEntities&&f){f=decode(f,{isAttributeValue:true})}if(c.removeRedundantAttributes&&isAttributeRedundant(a,e,f,d)||c.removeScriptTypeAttributes&&a==="script"&&e==="type"&&isScriptTypeAttribute(f)||c.removeStyleLinkTypeAttributes&&(a==="style"||a==="link")&&e==="type"&&isStyleLinkTypeAttribute(f)){return}if(f){f=cleanAttributeValue(a,e,f,c,d)}if(c.removeEmptyAttributes&&canDeleteEmptyAttribute(a,e,f,c)){return}if(c.decodeEntities&&f){f=f.replace(/&(#?[0-9a-zA-Z]+;)/g,"&amp;$1")}return{attr:b,name:e,value:f}}function buildAttr(l,a,m,e,k){var h=l.name,f=l.value,g=l.attr,i=g.quote,j,b;if(typeof f!=="undefined"&&(!m.removeAttributeQuotes||~f.indexOf(k)||!canRemoveAttributeQuotes(f))){if(!m.preventAttributesEscaping){if(typeof m.quoteCharacter==="undefined"){var d=(f.match(/'/g)||[]).length;var c=(f.match(/"/g)||[]).length;i=d<c?"'":'"'}else{i=m.quoteCharacter==="'"?"'":'"'}if(i==='"'){f=f.replace(/"/g,"&#34;")}else{f=f.replace(/'/g,"&#39;")}}b=i+f+i;if(!e&&!m.removeTagWhitespace){b+=" "}}else{if(e&&!a&&!/\/$/.test(f)){b=f}else{b=f+" "}}if(typeof f==="undefined"||m.collapseBooleanAttributes&&isBooleanAttribute(h.toLowerCase(),f.toLowerCase())){j=h;if(!e){j+=" "}}else{j=h+g.customAssign+b}return g.customOpen+j+g.customClose}function identity(a){return a}function processOptions(a){var b={name:function(c){return c.toLowerCase()},canCollapseWhitespace:canCollapseWhitespace,canTrimWhitespace:canTrimWhitespace,html5:true,ignoreCustomComments:[/^!/],ignoreCustomFragments:[/<%[\s\S]*?%>/,/<\?[\s\S]*?\?>/],includeAutoGeneratedTags:true,log:identity,minifyCSS:identity,minifyJS:identity,minifyURLs:identity};Object.keys(a).forEach(function(c){var d=a[c];if(c==="caseSensitive"){if(d){b.name=identity}}else{if(c==="log"){if(typeof d==="function"){b.log=d}}else{if(c==="minifyCSS"&&typeof d!=="function"){if(!d){return}if(typeof d!=="object"){d={}}b.minifyCSS=function(g,e){g=g.replace(/(url\s*\(\s*)("|'|)(.*?)\2(\s*\))/ig,function(j,k,h,i,l){return k+h+b.minifyURLs(i)+h+l});try{if(e==="inline"){g=wrapInlineCSS(g)}else{if(e==="media"){g=wrapMediaQuery(g)}}g=new CleanCSS(d).minify(g).styles;if(e==="inline"){g=unwrapInlineCSS(g)}else{if(e==="media"){g=unwrapMediaQuery(g)}}return g}catch(f){b.log(f);return g}}}else{if(c==="minifyJS"&&typeof d!=="function"){if(!d){return}if(typeof d!=="object"){d={}}(d.parse||(d.parse={})).bare_returns=false;b.minifyJS=function(h,g){var i=h.match(/^\s*<!--.*/);var f=i?h.slice(i[0].length).replace(/\n\s*-->\s*$/,""):h;d.parse.bare_returns=g;var e=UglifyJS.minify(f,d);if(e.error){b.log(e.error);return h}return e.code.replace(/;$/,"")}}else{if(c==="minifyURLs"&&typeof d!=="function"){if(!d){return}if(typeof d==="string"){d={site:d}}else{if(typeof d!=="object"){d={}}}b.minifyURLs=function(f){try{return RelateUrl.relate(f,d)}catch(e){b.log(e);return f}}}else{b[c]=d}}}}}});return b}function uniqueId(a){var b;do{b=Math.random().toString(36).replace(/^0\.[0-9]*/,"")}while(~a.indexOf(b));return b}var specialContentTags=createMapFromString("script,style");function createSortFns(g,n,j,h){var f=n.sortAttributes&&Object.create(null);var e=n.sortClassName&&new TokenChain();function d(o){return o.map(function(p){return n.name(p.name)})}function b(p,o){return !o||p.indexOf(o)===-1}function i(o){return b(o,j)&&b(o,h)}function m(o){var q,p;new HTMLParser(o,{start:function(t,u){if(f){if(!f[t]){f[t]=new TokenChain()}f[t].add(d(u).filter(i))}for(var v=0,s=u.length;v<s;v++){var r=u[v];if(e&&r.value&&n.name(r.name)==="class"){e.add(trimWhitespace(r.value).split(/[ \t\n\f\r]+/).filter(i))}else{if(n.processScripts&&r.name.toLowerCase()==="type"){q=t;p=r.value}}}},end:function(){q=""},chars:function(r){if(n.processScripts&&specialContentTags(q)&&n.processScripts.indexOf(p)>-1){m(r)}}})}var c=n.log;n.log=identity;n.sortAttributes=false;n.sortClassName=false;m(minify(g,n));n.log=c;if(f){var a=Object.create(null);for(var l in f){a[l]=f[l].createSorter()}n.sortAttributes=function(o,q){var s=a[o];if(s){var p=Object.create(null);var r=d(q);r.forEach(function(u,t){(p[u]||(p[u]=[])).push(q[t])});s.sort(r).forEach(function(u,t){q[t]=p[u].shift()})}}}if(e){var k=e.createSorter();n.sortClassName=function(o){return k.sort(o.split(/[ \n\f\r]+/)).join(" ")}}}function minify(u,f,r){if(f.collapseWhitespace){u=collapseWhitespace(u,f,true,true)}var w=[],o,m="",b,s="",n=[],l=[],e=[],y="",i="",h=[],p=[],a,B,d;u=u.replace(/<!-- htmlmin:ignore -->([\s\S]*?)<!-- htmlmin:ignore -->/g,function(D,C){if(!a){a=uniqueId(u);var F=new RegExp("^"+a+"([0-9]+)$");if(f.ignoreCustomComments){f.ignoreCustomComments=f.ignoreCustomComments.slice()}else{f.ignoreCustomComments=[]}f.ignoreCustomComments.push(F)}var E="<!--"+a+h.length+"-->";h.push(C);return E});function k(C){return function(E,D){return C(E.replace(d,function(G,H,F){var I=p[+F];return I[1]+B+F+I[2]}),D)}}var j=f.ignoreCustomFragments.map(function(C){return C.source});if(j.length){var x=new RegExp("\\s*(?:"+j.join("|")+")+\\s*","g");u=u.replace(x,function(C){if(!B){B=uniqueId(u);d=new RegExp("(\\s*)"+B+"([0-9]+)(\\s*)","g");if(f.minifyCSS){f.minifyCSS=k(f.minifyCSS)}if(f.minifyJS){f.minifyJS=k(f.minifyJS)}}var D=B+p.length;p.push(/^(\s*)[\s\S]*?(\s*)$/.exec(C));return"\t"+D+"\t"})}if(f.sortAttributes&&typeof f.sortAttributes!=="function"||f.sortClassName&&typeof f.sortClassName!=="function"){createSortFns(u,f,a,B)}function A(C,D){return f.canCollapseWhitespace(C,D,canCollapseWhitespace)}function z(C,D){return f.canTrimWhitespace(C,D,canTrimWhitespace)}function v(){var C=w.length-1;while(C>0&&!/^<[^/!]/.test(w[C])){C--}w.length=Math.max(0,C)}function g(){var C=w.length-1;while(C>0&&!/^<\//.test(w[C])){C--}w.length=Math.max(0,C)}function q(D,F){for(var E=null;D>=0&&z(E);D--){var G=w[D];var C=G.match(/^<\/([\w:-]+)>$/);if(C){E=C[1]}else{if(/>$/.test(G)||(w[D]=collapseWhitespaceSmart(G,null,F,f))){break}}}}function c(E){var C=w.length-1;if(w.length>1){var D=w[w.length-1];if(/^(?:<!|$)/.test(D)&&D.indexOf(a)===-1){C--}}q(C,E)}new HTMLParser(u,{partialMarkup:r,html5:f.html5,start:function(O,M,E,K,J){if(O.toLowerCase()==="svg"){f=Object.create(f);f.caseSensitive=true;f.keepClosingSlash=true;f.name=identity}O=f.name(O);s=O;o=O;if(!inlineTextTags(O)){m=""}b=false;n=M;var L=f.removeOptionalTags;if(L){var G=htmlTags(O);if(G&&canRemoveParentTag(y,O)){v()}y="";if(G&&canRemovePrecedingTag(i,O)){g();L=!isStartTagMandatory(i,O)}i=""}if(f.collapseWhitespace){if(!l.length){c(O)}if(!E){if(!z(O,M)||l.length){l.push(O)}if(!A(O,M)||e.length){e.push(O)}}}var D="<"+O;var C=K&&f.keepClosingSlash;w.push(D);if(f.sortAttributes){f.sortAttributes(O,M)}var F=[];for(var I=M.length,H=true;--I>=0;){var N=normalizeAttr(M[I],M,O,f);if(N){F.unshift(buildAttr(N,C,f,H,B));H=false}}if(F.length>0){w.push(" ");w.push.apply(w,F)}else{if(L&&optionalStartTags(O)){y=O}}w.push(w.pop()+(C?"/":"")+">");if(J&&!f.includeAutoGeneratedTags){v();y=""}},end:function(C,D,E){if(C.toLowerCase()==="svg"){f=Object.getPrototypeOf(f)}C=f.name(C);if(f.collapseWhitespace){if(l.length){if(C===l[l.length-1]){l.pop()}}else{c("/"+C)}if(e.length&&C===e[e.length-1]){e.pop()}}var F=false;if(C===s){s="";F=!b}if(f.removeOptionalTags){if(F&&topLevelTags(y)){v()}y="";if(htmlTags(C)&&i&&!trailingTags(i)&&(i!=="p"||!pInlineTags(C))){g()}i=optionalEndTags(C)?C:""}if(f.removeEmptyElements&&F&&canRemoveElement(C,D)){v();y="";i=""}else{if(E&&!f.includeAutoGeneratedTags){i=""}else{w.push("</"+C+">")}o="/"+C;if(!inlineTags(C)){m=""}else{if(F){m+="|"}}}},chars:function(H,C,G){C=C===""?"comment":C;G=G===""?"comment":G;if(f.decodeEntities&&H&&!specialContentTags(s)){H=decode(H)}if(f.collapseWhitespace){if(!l.length){if(C==="comment"){var F=w[w.length-1];if(F.indexOf(a)===-1){if(!F){C=o}if(w.length>1&&(!F||!f.conservativeCollapse&&/ $/.test(m))){var D=w.length-2;w[D]=w[D].replace(/\s+$/,function(I){H=I+H;return""})}}}if(C){if(C==="/nobr"||C==="wbr"){if(/^\s/.test(H)){var E=w.length-1;while(E>0&&w[E].lastIndexOf("<"+C)!==0){E--}q(E-1,"br")}}else{if(inlineTextTags(C.charAt(0)==="/"?C.slice(1):C)){H=collapseWhitespace(H,f,/(?:^|\s)$/.test(m))}}}if(C||G){H=collapseWhitespaceSmart(H,C,G,f)}else{H=collapseWhitespace(H,f,true,true)}if(!H&&/\s$/.test(m)&&C&&C.charAt(0)==="/"){q(w.length-1,G)}}if(!e.length&&G!=="html"&&!(C&&G)){H=collapseWhitespace(H,f,false,false,true)}}if(f.processScripts&&specialContentTags(s)){H=processScript(H,f,n)}if(isExecutableScript(s,n)){H=f.minifyJS(H)}if(isStyleSheet(s,n)){H=f.minifyCSS(H)}if(f.removeOptionalTags&&H){if(y==="html"||y==="body"&&!/^\s/.test(H)){v()}y="";if(compactTags(i)||looseTags(i)&&!/^\s/.test(H)){g()}i=""}o=/^\s*$/.test(H)?C:"comment";if(f.decodeEntities&&H&&!specialContentTags(s)){H=H.replace(/&(#?[0-9a-zA-Z]+;)/g,"&amp$1").replace(/</g,"&lt;")}if(d&&f.collapseWhitespace&&l.length){H=H.replace(d,function(J,K,I){return p[+I][0]})}m+=H;if(H){b=true}w.push(H)},comment:function(E,F){var C=F?"<!":"<!--";var D=F?">":"-->";if(isConditionalComment(E)){E=C+cleanConditionalComment(E,f)+D}else{if(f.removeComments){if(isIgnoredComment(E,f)){E="<!--"+E+"-->"}else{E=""}}else{E=C+E+D}}if(f.removeOptionalTags&&E){y="";i=""}w.push(E)},doctype:function(C){w.push(f.useShortDoctype?"<!DOCTYPE html>":collapseWhitespaceAll(C))},customAttrAssign:f.customAttrAssign,customAttrSurround:f.customAttrSurround});if(f.removeOptionalTags){if(topLevelTags(y)){v()}if(i&&!trailingTags(i)){g()}}if(f.collapseWhitespace){c("br")}var t=joinResultSegments(w,f);if(d){t=t.replace(d,function(E,F,D,G){var C=p[+D][0];if(f.collapseWhitespace){if(F!=="\t"){C=F+C}if(G!=="\t"){C+=G}return collapseWhitespace(C,{preserveLineBreaks:f.preserveLineBreaks,conservativeCollapse:!f.trimCustomFragments},/^[ \n\r\t\f]/.test(C),/[ \n\r\t\f]$/.test(C))}return C})}if(a){t=t.replace(new RegExp("<!--"+a+"([0-9]+)-->","g"),function(D,C){return h[+C]})}return t}function joinResultSegments(g,f){var h;var b=f.maxLineLength;if(b){var e="",d=[];while(g.length){var a=e.length;var c=g[0].indexOf("\n");if(c<0){e+=g.shift()}else{e+=g[0].slice(0,c);g[0]=g[0].slice(c+1)}if(a>0&&e.length>=b){d.push(e.slice(0,a));e=e.slice(a)}else{if(c>=0){d.push(e);e=""}}}if(e){d.push(e)}h=d.join("\n")}else{h=g.join("")}return f.collapseWhitespace?collapseWhitespace(h,f,true,true):h}exports.minify=function(c,b){var d=Date.now();b=processOptions(b||{});var a=minify(c,b);b.log("minified in: "+(Date.now()-d)+"ms");return a};