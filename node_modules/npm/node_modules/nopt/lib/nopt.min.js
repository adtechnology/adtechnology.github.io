var debug=process.env.DEBUG_NOPT||process.env.NOPT_DEBUG?function(){console.error.apply(console,arguments)}:function(){};var url=require("url"),path=require("path"),Stream=require("stream").Stream,abbrev=require("abbrev"),osenv=require("osenv");module.exports=exports=nopt;exports.clean=clean;exports.typeDefs={String:{type:String,validate:validateString},Boolean:{type:Boolean,validate:validateBoolean},url:{type:url,validate:validateUrl},Number:{type:Number,validate:validateNumber},path:{type:path,validate:validatePath},Stream:{type:Stream,validate:validateStream},Date:{type:Date,validate:validateDate}};function nopt(e,b,c,g){c=c||process.argv;e=e||{};b=b||{};if(typeof g!=="number"){g=2}debug(e,b,c,g);c=c.slice(g);var f={},d,a={remain:[],cooked:c,original:c.slice(0)};parse(c,f,a.remain,e,b);clean(f,e,exports.typeDefs);f.argv=a;Object.defineProperty(f.argv,"toString",{value:function(){return this.original.map(JSON.stringify).join(" ")},enumerable:false});return f}function clean(c,b,e){e=e||exports.typeDefs;var a={},d=[false,true,null,String,Array];Object.keys(c).forEach(function(g){if(g==="argv"){return}var i=c[g],f=Array.isArray(i),h=b[g];if(!f){i=[i]}if(!h){h=d}if(h===Array){h=d.concat(Array)}if(!Array.isArray(h)){h=[h]}debug("val=%j",i);debug("types=",h);i=i.map(function(k){if(typeof k==="string"){debug("string %j",k);k=k.trim();if((k==="null"&&~h.indexOf(null))||(k==="true"&&(~h.indexOf(true)||~h.indexOf(Boolean)))||(k==="false"&&(~h.indexOf(false)||~h.indexOf(Boolean)))){k=JSON.parse(k);debug("jsonable %j",k)}else{if(~h.indexOf(Number)&&!isNaN(k)){debug("convert to number",k);k=+k}else{if(~h.indexOf(Date)&&!isNaN(Date.parse(k))){debug("convert to date",k);k=new Date(k)}}}}if(!b.hasOwnProperty(g)){return k}if(k===false&&~h.indexOf(null)&&!(~h.indexOf(false)||~h.indexOf(Boolean))){k=null}var j={};j[g]=k;debug("prevalidated val",j,k,b[g]);if(!validate(j,g,k,b[g],e)){if(exports.invalidHandler){exports.invalidHandler(g,k,b[g],c)}else{if(exports.invalidHandler!==false){debug("invalid: "+g+"="+k,b[g])}}return a}debug("validated val",j,k,b[g]);return j[g]}).filter(function(j){return j!==a});if(!i.length){delete c[g]}else{if(f){debug(f,c[g],i);c[g]=i}else{c[g]=i[0]}}debug("k=%s val=%j",g,i,c[g])})}function validateString(b,a,c){b[a]=String(c)}function validatePath(c,a,e){if(e===true){return false}if(e===null){return true}e=String(e);var b=process.platform==="win32",f=b?/^~(\/|\\)/:/^~\//,d=osenv.home();if(d&&e.match(f)){c[a]=path.resolve(d,e.substr(2))}else{c[a]=path.resolve(e)}return true}function validateNumber(b,a,c){debug("validate Number %j %j %j",a,c,isNaN(c));if(isNaN(c)){return false}b[a]=+c}function validateDate(c,a,d){var b=Date.parse(d);debug("validate Date %j %j %j",a,d,b);if(isNaN(b)){return false}c[a]=new Date(d)}function validateBoolean(b,a,c){if(c instanceof Boolean){c=c.valueOf()}else{if(typeof c==="string"){if(!isNaN(c)){c=!!(+c)}else{if(c==="null"||c==="false"){c=false}else{c=true}}}else{c=!!c}}b[a]=c}function validateUrl(b,a,c){c=url.parse(String(c));if(!c.host){return false}b[a]=c.href}function validateStream(b,a,c){if(!(c instanceof Stream)){return false}b[a]=c}function validate(f,e,b,m,a){if(Array.isArray(m)){for(var g=0,c=m.length;g<c;g++){if(m[g]===Array){continue}if(validate(f,e,b,m[g],a)){return true}}delete f[e];return false}if(m===Array){return true}if(m!==m){debug("Poison NaN",e,b,m);delete f[e];return false}if(b===m){debug("Explicitly allowed %j",b);f[e]=b;return true}var n=false,h=Object.keys(a);for(var g=0,c=h.length;g<c;g++){debug("test type %j %j %j",e,b,h[g]);var o=a[h[g]];if(o&&((m&&m.name&&o.type&&o.type.name)?(m.name===o.type.name):(m===o.type))){var j={};n=false!==o.validate(j,e,b);b=j[e];if(n){f[e]=b;break}}}debug("OK? %j (%j %j %j)",n,e,b,h[g]);if(!n){delete f[e]}return n}function parse(c,t,m,j,g){debug("parse",c,t,m);var w=null,q=abbrev(Object.keys(j)),s=abbrev(Object.keys(g));for(var r=0;r<c.length;r++){var d=c[r];debug("arg",d);if(d.match(/^-{2,}$/)){m.push.apply(m,c.slice(r+1));c[r]="--";break}var a=false;if(d.charAt(0)==="-"&&d.length>1){var l=d.indexOf("=");if(l>-1){a=true;var h=d.substr(l+1);d=d.substr(0,l);c.splice(r,1,d,h)}var p=resolveShort(d,g,s,q);debug("arg=%j shRes=%j",d,p);if(p){debug(d,p);c.splice.apply(c,[r,1].concat(p));if(d!==p[0]){r--;continue}}d=d.replace(/^-+/,"");var b=null;while(d.toLowerCase().indexOf("no-")===0){b=!b;d=d.substr(3)}if(q[d]){d=q[d]}var o=j[d];var e=Array.isArray(o);if(e&&o.length===1){e=false;o=o[0]}var f=o===Array||e&&o.indexOf(Array)!==-1;if(!j.hasOwnProperty(d)&&t.hasOwnProperty(d)){if(!Array.isArray(t[d])){t[d]=[t[d]]}f=true}var u,n=c[r+1];var k=typeof b==="boolean"||o===Boolean||e&&o.indexOf(Boolean)!==-1||(typeof o==="undefined"&&!a)||(n==="false"&&(o===null||e&&~o.indexOf(null)));if(k){u=!b;if(n==="true"||n==="false"){u=JSON.parse(n);n=null;if(b){u=!u}r++}if(e&&n){if(~o.indexOf(n)){u=n;r++}else{if(n==="null"&&~o.indexOf(null)){u=null;r++}else{if(!n.match(/^-{2,}[^-]/)&&!isNaN(n)&&~o.indexOf(Number)){u=+n;r++}else{if(!n.match(/^-[^-]/)&&~o.indexOf(String)){u=n;r++}}}}}if(f){(t[d]=t[d]||[]).push(u)}else{t[d]=u}continue}if(o===String){if(n===undefined){n=""}else{if(n.match(/^-{1,2}[^-]+/)){n="";r--}}}if(n&&n.match(/^-{2,}$/)){n=undefined;r--}u=n===undefined?true:n;if(f){(t[d]=t[d]||[]).push(u)}else{t[d]=u}r++;continue}m.push(d)}}function resolveShort(b,c,a,f){b=b.replace(/^-+/,"");if(f[b]===b){return null}if(c[b]){if(c[b]&&!Array.isArray(c[b])){c[b]=c[b].split(/\s+/)}return c[b]}var e=c.___singles;if(!e){e=Object.keys(c).filter(function(g){return g.length===1}).reduce(function(g,h){g[h]=true;return g},{});c.___singles=e;debug("shorthand singles",e)}var d=b.split("").filter(function(g){return e[g]});if(d.join("")===b){return d.map(function(g){return c[g]}).reduce(function(g,h){return g.concat(h)},[])}if(f[b]&&!c[b]){return null}if(a[b]){b=a[b]}if(c[b]&&!Array.isArray(c[b])){c[b]=c[b].split(/\s+/)}return c[b]};