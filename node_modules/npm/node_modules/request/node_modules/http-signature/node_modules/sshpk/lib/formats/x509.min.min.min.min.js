module.exports={read:read,verify:verify,sign:sign,signAsync:signAsync,write:write};var assert=require("assert-plus");var asn1=require("asn1");var algs=require("../algs");var utils=require("../utils");var Key=require("../key");var PrivateKey=require("../private-key");var pem=require("./pem");var Identity=require("../identity");var Signature=require("../signature");var Certificate=require("../certificate");var pkcs8=require("./pkcs8");function readMPInt(c,d){assert.strictEqual(c.peek(),asn1.Ber.Integer,d+" is not an Integer");return(utils.mpNormalize(c.readString(asn1.Ber.Integer,true)))}function verify(i,j){var m=i.signatures.x509;assert.object(m,"x509 signature");var h=m.algo.split("-");if(h[0]!==j.type){return(false)}var k=m.cache;if(k===undefined){var n=new asn1.BerWriter();writeTBSCert(i,n);k=n.buffer}var l=j.createVerify(h[1]);l.write(k);return(l.verify(m.signature))}function Local(b){return(asn1.Ber.Context|asn1.Ber.Constructor|b)}function Context(b){return(asn1.Ber.Context|b)}var SIGN_ALGS={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4","ed25519-sha512":"1.3.101.112"};Object.keys(SIGN_ALGS).forEach(function(b){SIGN_ALGS[SIGN_ALGS[b]]=b});SIGN_ALGS["1.3.14.3.2.3"]="rsa-md5";SIGN_ALGS["1.3.14.3.2.29"]="rsa-sha1";var EXTS={issuerKeyId:"2.5.29.35",altName:"2.5.29.17",basicConstraints:"2.5.29.19",keyUsage:"2.5.29.15",extKeyUsage:"2.5.29.37"};function read(v,G){if(typeof(v)==="string"){v=new Buffer(v,"binary")}assert.buffer(v,"buf");var z=new asn1.BerReader(v);z.readSequence();if(Math.abs(z.length-z.remain)>1){throw (new Error("DER sequence does not contain whole byte stream"))}var C=z.offset;z.readSequence();var H=z.offset+z.length;var F=H;if(z.peek()===Local(0)){z.readSequence(Local(0));var B=z.readInt();assert.ok(B<=3,"only x.509 versions up to v3 supported")}var E={};E.signatures={};var r=(E.signatures.x509={});r.extras={};E.serial=readMPInt(z,"serial");z.readSequence();var x=z.offset+z.length;var w=z.readOID();var A=SIGN_ALGS[w];if(A===undefined){throw (new Error("unknown signature algorithm "+w))}z._offset=x;E.issuer=Identity.parseAsn1(z);z.readSequence();E.validFrom=readDate(z);E.validUntil=readDate(z);E.subjects=[Identity.parseAsn1(z)];z.readSequence();x=z.offset+z.length;E.subjectKey=pkcs8.readPkcs8(undefined,"public",z);z._offset=x;if(z.peek()===Local(1)){z.readSequence(Local(1));r.extras.issuerUniqueID=v.slice(z.offset,z.offset+z.length);z._offset+=z.length}if(z.peek()===Local(2)){z.readSequence(Local(2));r.extras.subjectUniqueID=v.slice(z.offset,z.offset+z.length);z._offset+=z.length}if(z.peek()===Local(3)){z.readSequence(Local(3));var y=z.offset+z.length;z.readSequence();while(z.offset<y){readExtension(E,v,z)}assert.strictEqual(z.offset,y)}assert.strictEqual(z.offset,H);z.readSequence();x=z.offset+z.length;var D=z.readOID();var s=SIGN_ALGS[D];if(s===undefined){throw (new Error("unknown signature algorithm "+D))}z._offset=x;var t=z.readString(asn1.Ber.BitString,true);if(t[0]===0){t=t.slice(1)}var u=s.split("-");r.signature=Signature.parse(t,u[0],"asn1");r.signature.hashAlgorithm=u[1];r.algo=s;r.cache=v.slice(C,F);return(new Certificate(E))}function readDate(b){if(b.peek()===asn1.Ber.UTCTime){return(utcTimeToDate(b.readString(asn1.Ber.UTCTime)))}else{if(b.peek()===asn1.Ber.GeneralizedTime){return(gTimeToDate(b.readString(asn1.Ber.GeneralizedTime)))}else{throw (new Error("Unsupported date format"))}}}var ALTNAME={OtherName:Local(0),RFC822Name:Context(1),DNSName:Context(2),X400Address:Local(3),DirectoryName:Local(4),EDIPartyName:Local(5),URI:Context(6),IPAddress:Context(7),OID:Context(8)};var EXTPURPOSE={serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",joyentDocker:"1.3.6.1.4.1.38678.1.4.1",joyentCmon:"1.3.6.1.4.1.38678.1.4.2"};var EXTPURPOSE_REV={};Object.keys(EXTPURPOSE).forEach(function(b){EXTPURPOSE_REV[EXTPURPOSE[b]]=b});var KEYUSEBITS=["signature","identity","keyEncryption","encryption","keyAgreement","ca","crl"];function readExtension(x,z,y){y.readSequence();var C=y.offset+y.length;var G=y.readOID();var t;var E=x.signatures.x509;E.extras.exts=[];var J;if(y.peek()===asn1.Ber.Boolean){J=y.readBoolean()}switch(G){case (EXTS.basicConstraints):y.readSequence(asn1.Ber.OctetString);y.readSequence();var F=y.offset+y.length;var s=false;if(y.peek()===asn1.Ber.Boolean){s=y.readBoolean()}if(x.purposes===undefined){x.purposes=[]}if(s===true){x.purposes.push("ca")}var A={oid:G,critical:J};if(y.offset<F&&y.peek()===asn1.Ber.Integer){A.pathLen=y.readInt()}E.extras.exts.push(A);break;case (EXTS.extKeyUsage):y.readSequence(asn1.Ber.OctetString);y.readSequence();if(x.purposes===undefined){x.purposes=[]}var B=y.offset+y.length;while(y.offset<B){var I=y.readOID();x.purposes.push(EXTPURPOSE_REV[I]||I)}if(x.purposes.indexOf("serverAuth")!==-1&&x.purposes.indexOf("clientAuth")===-1){x.subjects.forEach(function(a){if(a.type!=="host"){a.type="host";a.hostname=a.uid||a.email||a.components[0].value}})}else{if(x.purposes.indexOf("clientAuth")!==-1&&x.purposes.indexOf("serverAuth")===-1){x.subjects.forEach(function(a){if(a.type!=="user"){a.type="user";a.uid=a.hostname||a.email||a.components[0].value}})}}E.extras.exts.push({oid:G,critical:J});break;case (EXTS.keyUsage):y.readSequence(asn1.Ber.OctetString);var D=y.readString(asn1.Ber.BitString,true);var w=readBitField(D,KEYUSEBITS);w.forEach(function(a){if(x.purposes===undefined){x.purposes=[]}if(x.purposes.indexOf(a)===-1){x.purposes.push(a)}});E.extras.exts.push({oid:G,critical:J,bits:D});break;case (EXTS.altName):y.readSequence(asn1.Ber.OctetString);y.readSequence();var v=y.offset+y.length;while(y.offset<v){switch(y.peek()){case ALTNAME.OtherName:case ALTNAME.EDIPartyName:y.readSequence();y._offset+=y.length;break;case ALTNAME.OID:y.readOID(ALTNAME.OID);break;case ALTNAME.RFC822Name:var H=y.readString(ALTNAME.RFC822Name);t=Identity.forEmail(H);if(!x.subjects[0].equals(t)){x.subjects.push(t)}break;case ALTNAME.DirectoryName:y.readSequence(ALTNAME.DirectoryName);t=Identity.parseAsn1(y);if(!x.subjects[0].equals(t)){x.subjects.push(t)}break;case ALTNAME.DNSName:var u=y.readString(ALTNAME.DNSName);t=Identity.forHost(u);if(!x.subjects[0].equals(t)){x.subjects.push(t)}break;default:y.readString(y.peek());break}}E.extras.exts.push({oid:G,critical:J});break;default:E.extras.exts.push({oid:G,critical:J,data:y.readString(asn1.Ber.OctetString,true)});break}y._offset=C}var UTCTIME_RE=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function utcTimeToDate(h){var j=h.match(UTCTIME_RE);assert.ok(j,"timestamps must be in UTC");var l=new Date();var i=l.getUTCFullYear();var k=Math.floor(i/100)*100;var d=parseInt(j[1],10);if(i%100<50&&d>=60){d+=(k-1)}else{d+=k}l.setUTCFullYear(d,parseInt(j[2],10)-1,parseInt(j[3],10));l.setUTCHours(parseInt(j[4],10),parseInt(j[5],10));if(j[6]&&j[6].length>0){l.setUTCSeconds(parseInt(j[6],10))}return(l)}var GTIME_RE=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function gTimeToDate(f){var d=f.match(GTIME_RE);assert.ok(d);var e=new Date();e.setUTCFullYear(parseInt(d[1],10),parseInt(d[2],10)-1,parseInt(d[3],10));e.setUTCHours(parseInt(d[4],10),parseInt(d[5],10));if(d[6]&&d[6].length>0){e.setUTCSeconds(parseInt(d[6],10))}return(e)}function zeroPad(c){var d=""+c;while(d.length<2){d="0"+d}return(d)}function dateToUTCTime(c){var d="";d+=zeroPad(c.getUTCFullYear()%100);d+=zeroPad(c.getUTCMonth()+1);d+=zeroPad(c.getUTCDate());d+=zeroPad(c.getUTCHours());d+=zeroPad(c.getUTCMinutes());d+=zeroPad(c.getUTCSeconds());d+="Z";return(d)}function sign(h,i){if(h.signatures.x509===undefined){h.signatures.x509={}}var k=h.signatures.x509;k.algo=i.type+"-"+i.defaultHashAlgorithm();if(SIGN_ALGS[k.algo]===undefined){return(false)}var g=new asn1.BerWriter();writeTBSCert(h,g);var j=g.buffer;k.cache=j;var l=i.createSign();l.write(j);h.signatures.x509.signature=l.sign();return(true)}function signAsync(h,k,j){if(h.signatures.x509===undefined){h.signatures.x509={}}var l=h.signatures.x509;var g=new asn1.BerWriter();writeTBSCert(h,g);var i=g.buffer;l.cache=i;k(i,function(a,b){if(a){j(a);return}l.algo=b.type+"-"+b.hashAlgorithm;if(SIGN_ALGS[l.algo]===undefined){j(new Error('Invalid signing algorithm "'+l.algo+'"'));return}l.signature=b;j()})}function write(i,j){var k=i.signatures.x509;assert.object(k,"x509 signature");var h=new asn1.BerWriter();h.startSequence();if(k.cache){h._ensure(k.cache.length);k.cache.copy(h._buf,h._offset);h._offset+=k.cache.length}else{writeTBSCert(i,h)}h.startSequence();h.writeOID(SIGN_ALGS[k.algo]);if(k.algo.match(/^rsa-/)){h.writeNull()}h.endSequence();var l=k.signature.toBuffer("asn1");var g=new Buffer(l.length+1);g[0]=0;l.copy(g,1);h.writeBuffer(g,asn1.Ber.BitString);h.endSequence();return(h.buffer)}function writeTBSCert(v,t){var p=v.signatures.x509;assert.object(p,"x509 signature");t.startSequence();t.startSequence(Local(0));t.writeInt(2);t.endSequence();t.writeBuffer(utils.mpNormalize(v.serial),asn1.Ber.Integer);t.startSequence();t.writeOID(SIGN_ALGS[p.algo]);if(p.algo.match(/^rsa-/)){t.writeNull()}t.endSequence();v.issuer.toAsn1(t);t.startSequence();t.writeString(dateToUTCTime(v.validFrom),asn1.Ber.UTCTime);t.writeString(dateToUTCTime(v.validUntil),asn1.Ber.UTCTime);t.endSequence();var s=v.subjects[0];var o=v.subjects.slice(1);s.toAsn1(t);pkcs8.writePkcs8(t,v.subjectKey);if(p.extras&&p.extras.issuerUniqueID){t.writeBuffer(p.extras.issuerUniqueID,Local(1))}if(p.extras&&p.extras.subjectUniqueID){t.writeBuffer(p.extras.subjectUniqueID,Local(2))}if(o.length>0||s.type==="host"||(v.purposes!==undefined&&v.purposes.length>0)||(p.extras&&p.extras.exts)){t.startSequence(Local(3));t.startSequence();var j=[];if(v.purposes!==undefined&&v.purposes.length>0){j.push({oid:EXTS.basicConstraints,critical:true});j.push({oid:EXTS.keyUsage,critical:true});j.push({oid:EXTS.extKeyUsage,critical:true})}j.push({oid:EXTS.altName});if(p.extras&&p.extras.exts){j=p.extras.exts}for(var u=0;u<j.length;++u){t.startSequence();t.writeOID(j[u].oid);if(j[u].critical!==undefined){t.writeBoolean(j[u].critical)}if(j[u].oid===EXTS.altName){t.startSequence(asn1.Ber.OctetString);t.startSequence();if(s.type==="host"){t.writeString(s.hostname,Context(2))}for(var i=0;i<o.length;++i){if(o[i].type==="host"){t.writeString(o[i].hostname,ALTNAME.DNSName)}else{if(o[i].type==="email"){t.writeString(o[i].email,ALTNAME.RFC822Name)}else{t.startSequence(ALTNAME.DirectoryName);o[i].toAsn1(t);t.endSequence()}}}t.endSequence();t.endSequence()}else{if(j[u].oid===EXTS.basicConstraints){t.startSequence(asn1.Ber.OctetString);t.startSequence();var n=(v.purposes.indexOf("ca")!==-1);var r=j[u].pathLen;t.writeBoolean(n);if(r!==undefined){t.writeInt(r)}t.endSequence();t.endSequence()}else{if(j[u].oid===EXTS.extKeyUsage){t.startSequence(asn1.Ber.OctetString);t.startSequence();v.purposes.forEach(function(b){if(b==="ca"){return}if(KEYUSEBITS.indexOf(b)!==-1){return}var a=b;if(EXTPURPOSE[b]!==undefined){a=EXTPURPOSE[b]}t.writeOID(a)});t.endSequence();t.endSequence()}else{if(j[u].oid===EXTS.keyUsage){t.startSequence(asn1.Ber.OctetString);if(j[u].bits!==undefined){t.writeBuffer(j[u].bits,asn1.Ber.BitString)}else{var q=writeBitField(v.purposes,KEYUSEBITS);t.writeBuffer(q,asn1.Ber.BitString)}t.endSequence()}else{t.writeBuffer(j[u].data,asn1.Ber.OctetString)}}}}t.endSequence()}t.endSequence();t.endSequence()}t.endSequence()}function readBitField(o,t){var i=8*(o.length-1)-o[0];var r={};for(var s=0;s<i;++s){var q=1+Math.floor(s/8);var p=7-(s%8);var m=1<<p;var n=((o[q]&m)!==0);var l=t[s];if(n&&typeof(l)==="string"){r[l]=true}}return(Object.keys(r))}function writeBitField(i,p){var q=p.length;var s=Math.ceil(q/8);var o=s*8-q;var v=new Buffer(1+s);v.fill(0);v[0]=o;for(var n=0;n<q;++n){var x=1+Math.floor(n/8);var w=7-(n%8);var t=1<<w;var r=p[n];if(r===undefined){continue}var u=(i.indexOf(r)!==-1);if(u){v[x]|=t}}return(v)};