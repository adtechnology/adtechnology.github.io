module.exports={read:read,verify:verify,sign:sign,signAsync:signAsync,write:write};var assert=require("assert-plus");var asn1=require("asn1");var algs=require("../algs");var utils=require("../utils");var Key=require("../key");var PrivateKey=require("../private-key");var pem=require("./pem");var Identity=require("../identity");var Signature=require("../signature");var Certificate=require("../certificate");var pkcs8=require("./pkcs8");function readMPInt(b,a){assert.strictEqual(b.peek(),asn1.Ber.Integer,a+" is not an Integer");return(utils.mpNormalize(b.readString(asn1.Ber.Integer,true)))}function verify(d,c){var g=d.signatures.x509;assert.object(g,"x509 signature");var e=g.algo.split("-");if(e[0]!==c.type){return(false)}var b=g.cache;if(b===undefined){var f=new asn1.BerWriter();writeTBSCert(d,f);b=f.buffer}var a=c.createVerify(e[1]);a.write(b);return(a.verify(g.signature))}function Local(a){return(asn1.Ber.Context|asn1.Ber.Constructor|a)}function Context(a){return(asn1.Ber.Context|a)}var SIGN_ALGS={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4","ed25519-sha512":"1.3.101.112"};Object.keys(SIGN_ALGS).forEach(function(a){SIGN_ALGS[SIGN_ALGS[a]]=a});SIGN_ALGS["1.3.14.3.2.3"]="rsa-md5";SIGN_ALGS["1.3.14.3.2.29"]="rsa-sha1";var EXTS={issuerKeyId:"2.5.29.35",altName:"2.5.29.17",basicConstraints:"2.5.29.19",keyUsage:"2.5.29.15",extKeyUsage:"2.5.29.37"};function read(b,q){if(typeof(b)==="string"){b=new Buffer(b,"binary")}assert.buffer(b,"buf");var l=new asn1.BerReader(b);l.readSequence();if(Math.abs(l.length-l.remain)>1){throw (new Error("DER sequence does not contain whole byte stream"))}var i=l.offset;l.readSequence();var e=l.offset+l.length;var f=e;if(l.peek()===Local(0)){l.readSequence(Local(0));var j=l.readInt();assert.ok(j<=3,"only x.509 versions up to v3 supported")}var g={};g.signatures={};var p=(g.signatures.x509={});p.extras={};g.serial=readMPInt(l,"serial");l.readSequence();var a=l.offset+l.length;var n=l.readOID();var k=SIGN_ALGS[n];if(k===undefined){throw (new Error("unknown signature algorithm "+n))}l._offset=a;g.issuer=Identity.parseAsn1(l);l.readSequence();g.validFrom=readDate(l);g.validUntil=readDate(l);g.subjects=[Identity.parseAsn1(l)];l.readSequence();a=l.offset+l.length;g.subjectKey=pkcs8.readPkcs8(undefined,"public",l);l._offset=a;if(l.peek()===Local(1)){l.readSequence(Local(1));p.extras.issuerUniqueID=b.slice(l.offset,l.offset+l.length);l._offset+=l.length}if(l.peek()===Local(2)){l.readSequence(Local(2));p.extras.subjectUniqueID=b.slice(l.offset,l.offset+l.length);l._offset+=l.length}if(l.peek()===Local(3)){l.readSequence(Local(3));var m=l.offset+l.length;l.readSequence();while(l.offset<m){readExtension(g,b,l)}assert.strictEqual(l.offset,m)}assert.strictEqual(l.offset,e);l.readSequence();a=l.offset+l.length;var h=l.readOID();var d=SIGN_ALGS[h];if(d===undefined){throw (new Error("unknown signature algorithm "+h))}l._offset=a;var c=l.readString(asn1.Ber.BitString,true);if(c[0]===0){c=c.slice(1)}var o=d.split("-");p.signature=Signature.parse(c,o[0],"asn1");p.signature.hashAlgorithm=o[1];p.algo=d;p.cache=b.slice(i,f);return(new Certificate(g))}function readDate(a){if(a.peek()===asn1.Ber.UTCTime){return(utcTimeToDate(a.readString(asn1.Ber.UTCTime)))}else{if(a.peek()===asn1.Ber.GeneralizedTime){return(gTimeToDate(a.readString(asn1.Ber.GeneralizedTime)))}else{throw (new Error("Unsupported date format"))}}}var ALTNAME={OtherName:Local(0),RFC822Name:Context(1),DNSName:Context(2),X400Address:Local(3),DirectoryName:Local(4),EDIPartyName:Local(5),URI:Context(6),IPAddress:Context(7),OID:Context(8)};var EXTPURPOSE={serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",joyentDocker:"1.3.6.1.4.1.38678.1.4.1",joyentCmon:"1.3.6.1.4.1.38678.1.4.2"};var EXTPURPOSE_REV={};Object.keys(EXTPURPOSE).forEach(function(a){EXTPURPOSE_REV[EXTPURPOSE[a]]=a});var KEYUSEBITS=["signature","identity","keyEncryption","encryption","keyAgreement","ca","crl"];function readExtension(q,p,f){f.readSequence();var d=f.offset+f.length;var b=f.readOID();var i;var c=q.signatures.x509;c.extras.exts=[];var k;if(f.peek()===asn1.Ber.Boolean){k=f.readBoolean()}switch(b){case (EXTS.basicConstraints):f.readSequence(asn1.Ber.OctetString);f.readSequence();var m=f.offset+f.length;var j=false;if(f.peek()===asn1.Ber.Boolean){j=f.readBoolean()}if(q.purposes===undefined){q.purposes=[]}if(j===true){q.purposes.push("ca")}var e={oid:b,critical:k};if(f.offset<m&&f.peek()===asn1.Ber.Integer){e.pathLen=f.readInt()}c.extras.exts.push(e);break;case (EXTS.extKeyUsage):f.readSequence(asn1.Ber.OctetString);f.readSequence();if(q.purposes===undefined){q.purposes=[]}var o=f.offset+f.length;while(f.offset<o){var a=f.readOID();q.purposes.push(EXTPURPOSE_REV[a]||a)}if(q.purposes.indexOf("serverAuth")!==-1&&q.purposes.indexOf("clientAuth")===-1){q.subjects.forEach(function(s){if(s.type!=="host"){s.type="host";s.hostname=s.uid||s.email||s.components[0].value}})}else{if(q.purposes.indexOf("clientAuth")!==-1&&q.purposes.indexOf("serverAuth")===-1){q.subjects.forEach(function(s){if(s.type!=="user"){s.type="user";s.uid=s.hostname||s.email||s.components[0].value}})}}c.extras.exts.push({oid:b,critical:k});break;case (EXTS.keyUsage):f.readSequence(asn1.Ber.OctetString);var n=f.readString(asn1.Ber.BitString,true);var r=readBitField(n,KEYUSEBITS);r.forEach(function(s){if(q.purposes===undefined){q.purposes=[]}if(q.purposes.indexOf(s)===-1){q.purposes.push(s)}});c.extras.exts.push({oid:b,critical:k,bits:n});break;case (EXTS.altName):f.readSequence(asn1.Ber.OctetString);f.readSequence();var g=f.offset+f.length;while(f.offset<g){switch(f.peek()){case ALTNAME.OtherName:case ALTNAME.EDIPartyName:f.readSequence();f._offset+=f.length;break;case ALTNAME.OID:f.readOID(ALTNAME.OID);break;case ALTNAME.RFC822Name:var l=f.readString(ALTNAME.RFC822Name);i=Identity.forEmail(l);if(!q.subjects[0].equals(i)){q.subjects.push(i)}break;case ALTNAME.DirectoryName:f.readSequence(ALTNAME.DirectoryName);i=Identity.parseAsn1(f);if(!q.subjects[0].equals(i)){q.subjects.push(i)}break;case ALTNAME.DNSName:var h=f.readString(ALTNAME.DNSName);i=Identity.forHost(h);if(!q.subjects[0].equals(i)){q.subjects.push(i)}break;default:f.readString(f.peek());break}}c.extras.exts.push({oid:b,critical:k});break;default:c.extras.exts.push({oid:b,critical:k,data:f.readString(asn1.Ber.OctetString,true)});break}f._offset=d}var UTCTIME_RE=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function utcTimeToDate(c){var a=c.match(UTCTIME_RE);assert.ok(a,"timestamps must be in UTC");var f=new Date();var b=f.getUTCFullYear();var g=Math.floor(b/100)*100;var e=parseInt(a[1],10);if(b%100<50&&e>=60){e+=(g-1)}else{e+=g}f.setUTCFullYear(e,parseInt(a[2],10)-1,parseInt(a[3],10));f.setUTCHours(parseInt(a[4],10),parseInt(a[5],10));if(a[6]&&a[6].length>0){f.setUTCSeconds(parseInt(a[6],10))}return(f)}var GTIME_RE=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function gTimeToDate(b){var a=b.match(GTIME_RE);assert.ok(a);var c=new Date();c.setUTCFullYear(parseInt(a[1],10),parseInt(a[2],10)-1,parseInt(a[3],10));c.setUTCHours(parseInt(a[4],10),parseInt(a[5],10));if(a[6]&&a[6].length>0){c.setUTCSeconds(parseInt(a[6],10))}return(c)}function zeroPad(b){var a=""+b;while(a.length<2){a="0"+a}return(a)}function dateToUTCTime(b){var a="";a+=zeroPad(b.getUTCFullYear()%100);a+=zeroPad(b.getUTCMonth()+1);a+=zeroPad(b.getUTCDate());a+=zeroPad(b.getUTCHours());a+=zeroPad(b.getUTCMinutes());a+=zeroPad(b.getUTCSeconds());a+="Z";return(a)}function sign(c,b){if(c.signatures.x509===undefined){c.signatures.x509={}}var f=c.signatures.x509;f.algo=b.type+"-"+b.defaultHashAlgorithm();if(SIGN_ALGS[f.algo]===undefined){return(false)}var d=new asn1.BerWriter();writeTBSCert(c,d);var a=d.buffer;f.cache=a;var e=b.createSign();e.write(a);c.signatures.x509.signature=e.sign();return(true)}function signAsync(c,f,a){if(c.signatures.x509===undefined){c.signatures.x509={}}var e=c.signatures.x509;var d=new asn1.BerWriter();writeTBSCert(c,d);var b=d.buffer;e.cache=b;f(b,function(h,g){if(h){a(h);return}e.algo=g.type+"-"+g.hashAlgorithm;if(SIGN_ALGS[e.algo]===undefined){a(new Error('Invalid signing algorithm "'+e.algo+'"'));return}e.signature=g;a()})}function write(b,a){var f=b.signatures.x509;assert.object(f,"x509 signature");var c=new asn1.BerWriter();c.startSequence();if(f.cache){c._ensure(f.cache.length);f.cache.copy(c._buf,c._offset);c._offset+=f.cache.length}else{writeTBSCert(b,c)}c.startSequence();c.writeOID(SIGN_ALGS[f.algo]);if(f.algo.match(/^rsa-/)){c.writeNull()}c.endSequence();var e=f.signature.toBuffer("asn1");var d=new Buffer(e.length+1);d[0]=0;e.copy(d,1);c.writeBuffer(d,asn1.Ber.BitString);c.endSequence();return(c.buffer)}function writeTBSCert(e,g){var m=e.signatures.x509;assert.object(m,"x509 signature");g.startSequence();g.startSequence(Local(0));g.writeInt(2);g.endSequence();g.writeBuffer(utils.mpNormalize(e.serial),asn1.Ber.Integer);g.startSequence();g.writeOID(SIGN_ALGS[m.algo]);if(m.algo.match(/^rsa-/)){g.writeNull()}g.endSequence();e.issuer.toAsn1(g);g.startSequence();g.writeString(dateToUTCTime(e.validFrom),asn1.Ber.UTCTime);g.writeString(dateToUTCTime(e.validUntil),asn1.Ber.UTCTime);g.endSequence();var h=e.subjects[0];var a=e.subjects.slice(1);h.toAsn1(g);pkcs8.writePkcs8(g,e.subjectKey);if(m.extras&&m.extras.issuerUniqueID){g.writeBuffer(m.extras.issuerUniqueID,Local(1))}if(m.extras&&m.extras.subjectUniqueID){g.writeBuffer(m.extras.subjectUniqueID,Local(2))}if(a.length>0||h.type==="host"||(e.purposes!==undefined&&e.purposes.length>0)||(m.extras&&m.extras.exts)){g.startSequence(Local(3));g.startSequence();var c=[];if(e.purposes!==undefined&&e.purposes.length>0){c.push({oid:EXTS.basicConstraints,critical:true});c.push({oid:EXTS.keyUsage,critical:true});c.push({oid:EXTS.extKeyUsage,critical:true})}c.push({oid:EXTS.altName});if(m.extras&&m.extras.exts){c=m.extras.exts}for(var f=0;f<c.length;++f){g.startSequence();g.writeOID(c[f].oid);if(c[f].critical!==undefined){g.writeBoolean(c[f].critical)}if(c[f].oid===EXTS.altName){g.startSequence(asn1.Ber.OctetString);g.startSequence();if(h.type==="host"){g.writeString(h.hostname,Context(2))}for(var d=0;d<a.length;++d){if(a[d].type==="host"){g.writeString(a[d].hostname,ALTNAME.DNSName)}else{if(a[d].type==="email"){g.writeString(a[d].email,ALTNAME.RFC822Name)}else{g.startSequence(ALTNAME.DirectoryName);a[d].toAsn1(g);g.endSequence()}}}g.endSequence();g.endSequence()}else{if(c[f].oid===EXTS.basicConstraints){g.startSequence(asn1.Ber.OctetString);g.startSequence();var b=(e.purposes.indexOf("ca")!==-1);var k=c[f].pathLen;g.writeBoolean(b);if(k!==undefined){g.writeInt(k)}g.endSequence();g.endSequence()}else{if(c[f].oid===EXTS.extKeyUsage){g.startSequence(asn1.Ber.OctetString);g.startSequence();e.purposes.forEach(function(i){if(i==="ca"){return}if(KEYUSEBITS.indexOf(i)!==-1){return}var j=i;if(EXTPURPOSE[i]!==undefined){j=EXTPURPOSE[i]}g.writeOID(j)});g.endSequence();g.endSequence()}else{if(c[f].oid===EXTS.keyUsage){g.startSequence(asn1.Ber.OctetString);if(c[f].bits!==undefined){g.writeBuffer(c[f].bits,asn1.Ber.BitString)}else{var l=writeBitField(e.purposes,KEYUSEBITS);g.writeBuffer(l,asn1.Ber.BitString)}g.endSequence()}else{g.writeBuffer(c[f].data,asn1.Ber.OctetString)}}}}g.endSequence()}g.endSequence();g.endSequence()}g.endSequence()}function readBitField(h,c){var b=8*(h.length-1)-h[0];var e={};for(var d=0;d<b;++d){var f=1+Math.floor(d/8);var g=7-(d%8);var k=1<<g;var j=((h[f]&k)!==0);var a=c[d];if(j&&typeof(a)==="string"){e[a]=true}}return(Object.keys(e))}function writeBitField(f,c){var b=c.length;var m=Math.ceil(b/8);var d=m*8-b;var j=new Buffer(1+m);j.fill(0);j[0]=d;for(var e=0;e<b;++e){var g=1+Math.floor(e/8);var h=7-(e%8);var l=1<<h;var a=c[e];if(a===undefined){continue}var k=(f.indexOf(a)!==-1);if(k){j[g]|=l}}return(j)};