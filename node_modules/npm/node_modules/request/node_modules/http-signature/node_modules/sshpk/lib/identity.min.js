module.exports=Identity;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var Fingerprint=require("./fingerprint");var Signature=require("./signature");var errs=require("./errors");var util=require("util");var utils=require("./utils");var asn1=require("asn1");var DNS_NAME_RE=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i;var oids={};oids.cn="2.5.4.3";oids.o="2.5.4.10";oids.ou="2.5.4.11";oids.l="2.5.4.7";oids.s="2.5.4.8";oids.c="2.5.4.6";oids.sn="2.5.4.4";oids.dc="0.9.2342.19200300.100.1.25";oids.uid="0.9.2342.19200300.100.1.1";oids.mail="0.9.2342.19200300.100.1.3";var unoids={};Object.keys(oids).forEach(function(a){unoids[oids[a]]=a});function Identity(b){var a=this;assert.object(b,"options");assert.arrayOfObject(b.components,"options.components");this.components=b.components;this.componentLookup={};this.components.forEach(function(d){if(d.name&&!d.oid){d.oid=oids[d.name]}if(d.oid&&!d.name){d.name=unoids[d.oid]}if(a.componentLookup[d.name]===undefined){a.componentLookup[d.name]=[]}a.componentLookup[d.name].push(d)});if(this.componentLookup.cn&&this.componentLookup.cn.length>0){this.cn=this.componentLookup.cn[0].value}assert.optionalString(b.type,"options.type");if(b.type===undefined){if(this.components.length===1&&this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length){this.type="host";this.hostname=this.componentLookup.dc.map(function(d){return(d.value)}).join(".")}else{if(this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.uid&&this.componentLookup.uid.length===1){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.mail&&this.componentLookup.mail.length===1){this.type="email";this.email=this.componentLookup.mail[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1){this.type="user";this.uid=this.componentLookup.cn[0].value}else{this.type="unknown"}}}}}}}}else{this.type=b.type;if(this.type==="host"){this.hostname=b.hostname}else{if(this.type==="user"){this.uid=b.uid}else{if(this.type==="email"){this.email=b.email}else{throw (new Error("Unknown type "+this.type))}}}}}Identity.prototype.toString=function(){return(this.components.map(function(a){return(a.name.toUpperCase()+"="+a.value)}).join(", "))};var NOT_PRINTABLE=/[^a-zA-Z0-9 '(),+.\/:=?-]/;var NOT_IA5=/[^\x00-\x7f]/;Identity.prototype.toAsn1=function(b,a){b.startSequence(a);this.components.forEach(function(f){b.startSequence(asn1.Ber.Constructor|asn1.Ber.Set);b.startSequence();b.writeOID(f.oid);if(f.asn1type===asn1.Ber.Utf8String||f.value.match(NOT_IA5)){var d=new Buffer(f.value,"utf8");b.writeBuffer(d,asn1.Ber.Utf8String)}else{if(f.asn1type===asn1.Ber.IA5String||f.value.match(NOT_PRINTABLE)){b.writeString(f.value,asn1.Ber.IA5String)}else{var e=asn1.Ber.PrintableString;if(f.asn1type!==undefined){e=f.asn1type}b.writeString(f.value,e)}}b.endSequence();b.endSequence()});b.endSequence()};function globMatch(d,c){if(d==="**"||c==="**"){return(true)}var g=d.split(".");var f=c.split(".");if(g.length!==f.length){return(false)}for(var e=0;e<g.length;++e){if(g[e]==="*"||f[e]==="*"){continue}if(g[e]!==f[e]){return(false)}}return(true)}Identity.prototype.equals=function(a){if(!Identity.isIdentity(a,[1,0])){return(false)}if(a.components.length!==this.components.length){return(false)}for(var b=0;b<this.components.length;++b){if(this.components[b].oid!==a.components[b].oid){return(false)}if(!globMatch(this.components[b].value,a.components[b].value)){return(false)}}return(true)};Identity.forHost=function(a){assert.string(a,"hostname");return(new Identity({type:"host",hostname:a,components:[{name:"cn",value:a}]}))};Identity.forUser=function(a){assert.string(a,"uid");return(new Identity({type:"user",uid:a,components:[{name:"uid",value:a}]}))};Identity.forEmail=function(a){assert.string(a,"email");return(new Identity({type:"email",email:a,components:[{name:"mail",value:a}]}))};Identity.parseDN=function(a){assert.string(a,"dn");var c=a.split(",");var b=c.map(function(g){g=g.trim();var f=g.indexOf("=");var d=g.slice(0,f).toLowerCase();var e=g.slice(f+1);return({name:d,value:e})});return(new Identity({components:b}))};Identity.parseAsn1=function(e,g){var d=[];e.readSequence(g);var a=e.offset+e.length;while(e.offset<a){e.readSequence(asn1.Ber.Constructor|asn1.Ber.Set);var h=e.offset+e.length;e.readSequence();var c=e.readOID();var b=e.peek();var f;switch(b){case asn1.Ber.PrintableString:case asn1.Ber.IA5String:case asn1.Ber.OctetString:case asn1.Ber.T61String:f=e.readString(b);break;case asn1.Ber.Utf8String:f=e.readString(b,true);f=f.toString("utf8");break;case asn1.Ber.CharacterString:case asn1.Ber.BMPString:f=e.readString(b,true);f=f.toString("utf16le");break;default:throw (new Error("Unknown asn1 type "+b))}d.push({oid:c,asn1type:b,value:f});e._offset=h}e._offset=a;return(new Identity({components:d}))};Identity.isIdentity=function(b,a){return(utils.isCompatible(b,Identity,a))};Identity.prototype._sshpkApiVersion=[1,0];Identity._oldVersionDetect=function(a){return([1,0])};