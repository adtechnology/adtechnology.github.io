module.exports=Key;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var Fingerprint=require("./fingerprint");var Signature=require("./signature");var DiffieHellman=require("./dhe").DiffieHellman;var errs=require("./errors");var utils=require("./utils");var PrivateKey=require("./private-key");var edCompat;try{edCompat=require("./ed-compat")}catch(e){}var InvalidAlgorithmError=errs.InvalidAlgorithmError;var KeyParseError=errs.KeyParseError;var formats={};formats.auto=require("./formats/auto");formats.pem=require("./formats/pem");formats.pkcs1=require("./formats/pkcs1");formats.pkcs8=require("./formats/pkcs8");formats.rfc4253=require("./formats/rfc4253");formats.ssh=require("./formats/ssh");formats["ssh-private"]=require("./formats/ssh-private");formats.openssh=formats["ssh-private"];formats.dnssec=require("./formats/dnssec");function Key(j){assert.object(j,"options");assert.arrayOfObject(j.parts,"options.parts");assert.string(j.type,"options.type");assert.optionalString(j.comment,"options.comment");var d=algs.info[j.type];if(typeof(d)!=="object"){throw (new InvalidAlgorithmError(j.type))}var b={};for(var h=0;h<j.parts.length;++h){var g=j.parts[h];b[g.name]=g}this.type=j.type;this.parts=j.parts;this.part=b;this.comment=undefined;this.source=j.source;this._rfc4253Cache=j._rfc4253Cache;this._hashCache={};var a;this.curve=undefined;if(this.type==="ecdsa"){var c=this.part.curve.data.toString();this.curve=c;a=algs.curves[c].size}else{if(this.type==="ed25519"||this.type==="curve25519"){a=256;this.curve="curve25519"}else{var f=this.part[d.sizePart];a=f.data.length;a=a*8-utils.countZeros(f.data)}}this.size=a}Key.formats=formats;Key.prototype.toBuffer=function(b,a){if(b===undefined){b="ssh"}assert.string(b,"format");assert.object(formats[b],"formats[format]");assert.optionalObject(a,"options");if(b==="rfc4253"){if(this._rfc4253Cache===undefined){this._rfc4253Cache=formats.rfc4253.write(this)}return(this._rfc4253Cache)}return(formats[b].write(this,a))};Key.prototype.toString=function(b,a){return(this.toBuffer(b,a).toString())};Key.prototype.hash=function(b){assert.string(b,"algorithm");b=b.toLowerCase();if(algs.hashAlgs[b]===undefined){throw (new InvalidAlgorithmError(b))}if(this._hashCache[b]){return(this._hashCache[b])}var a=crypto.createHash(b).update(this.toBuffer("rfc4253")).digest();this._hashCache[b]=a;return(a)};Key.prototype.fingerprint=function(b){if(b===undefined){b="sha256"}assert.string(b,"algorithm");var a={type:"key",hash:this.hash(b),algorithm:b};return(new Fingerprint(a))};Key.prototype.defaultHashAlgorithm=function(){var a="sha1";if(this.type==="rsa"){a="sha256"}if(this.type==="dsa"&&this.size>1024){a="sha256"}if(this.type==="ed25519"){a="sha512"}if(this.type==="ecdsa"){if(this.size<=256){a="sha256"}else{if(this.size<=384){a="sha384"}else{a="sha512"}}}return(a)};Key.prototype.createVerify=function(i){if(i===undefined){i=this.defaultHashAlgorithm()}assert.string(i,"hash algorithm");if(this.type==="ed25519"&&edCompat!==undefined){return(new edCompat.Verifier(this,i))}if(this.type==="curve25519"){throw (new Error("Curve25519 keys are not suitable for signing or verification"))}var f,h,a;try{h=i.toUpperCase();f=crypto.createVerify(h)}catch(b){a=b}if(f===undefined||(a instanceof Error&&a.message.match(/Unknown message digest/))){h="RSA-";h+=i.toUpperCase();f=crypto.createVerify(h)}assert.ok(f,"failed to create verifier");var c=f.verify.bind(f);var d=this.toBuffer("pkcs8");var j=this.curve;var g=this;f.verify=function(l,k){if(Signature.isSignature(l,[2,0])){if(l.type!==g.type){return(false)}if(l.hashAlgorithm&&l.hashAlgorithm!==i){return(false)}if(l.curve&&g.type==="ecdsa"&&l.curve!==j){return(false)}return(c(d,l.toBuffer("asn1")))}else{if(typeof(l)==="string"||Buffer.isBuffer(l)){return(c(d,l,k))}else{if(Signature.isSignature(l,[1,0])){throw (new Error("signature was created by too old a version of sshpk and cannot be verified"))}else{throw (new TypeError("signature must be a string, Buffer, or Signature object"))}}}};return(f)};Key.prototype.createDiffieHellman=function(){if(this.type==="rsa"){throw (new Error("RSA keys do not support Diffie-Hellman"))}return(new DiffieHellman(this))};Key.prototype.createDH=Key.prototype.createDiffieHellman;Key.parse=function(d,a,c){if(typeof(d)!=="string"){assert.buffer(d,"data")}if(a===undefined){a="auto"}assert.string(a,"format");if(typeof(c)==="string"){c={filename:c}}assert.optionalObject(c,"options");if(c===undefined){c={}}assert.optionalString(c.filename,"options.filename");if(c.filename===undefined){c.filename="(unnamed)"}assert.object(formats[a],"formats[format]");try{var b=formats[a].read(d,c);if(b instanceof PrivateKey){b=b.toPublic()}if(!b.comment){b.comment=c.filename}return(b)}catch(f){if(f.name==="KeyEncryptedError"){throw (f)}throw (new KeyParseError(c.filename,a,f))}};Key.isKey=function(b,a){return(utils.isCompatible(b,Key,a))};Key.prototype._sshpkApiVersion=[1,6];Key._oldVersionDetect=function(a){assert.func(a.toBuffer);assert.func(a.fingerprint);if(a.createDH){return([1,4])}if(a.defaultHashAlgorithm){return([1,3])}if(a.formats.auto){return([1,2])}if(a.formats.pkcs1){return([1,1])}return([1,0])};