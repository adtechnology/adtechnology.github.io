module.exports={DiffieHellman:DiffieHellman,generateECDSA:generateECDSA,generateED25519:generateED25519};var assert=require("assert-plus");var crypto=require("crypto");var algs=require("./algs");var utils=require("./utils");var nacl;var Key=require("./key");var PrivateKey=require("./private-key");var CRYPTO_HAVE_ECDH=(crypto.createECDH!==undefined);var ecdh,ec,jsbn;function DiffieHellman(d){utils.assertCompatible(d,Key,[1,4],"key");this._isPriv=PrivateKey.isPrivateKey(d,[1,3]);this._algo=d.type;this._curve=d.curve;this._key=d;if(d.type==="dsa"){if(!CRYPTO_HAVE_ECDH){throw (new Error("Due to bugs in the node 0.10 crypto API, node 0.12.x or later is required to use DH"))}this._dh=crypto.createDiffieHellman(d.part.p.data,undefined,d.part.g.data,undefined);this._p=d.part.p;this._g=d.part.g;if(this._isPriv){this._dh.setPrivateKey(d.part.x.data)}this._dh.setPublicKey(d.part.y.data)}else{if(d.type==="ecdsa"){if(!CRYPTO_HAVE_ECDH){if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}this._ecParams=new X9ECParameters(this._curve);if(this._isPriv){this._priv=new ECPrivate(this._ecParams,d.part.d.data)}return}var c={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[d.curve];this._dh=crypto.createECDH(c);if(typeof(this._dh)!=="object"||typeof(this._dh.setPrivateKey)!=="function"){CRYPTO_HAVE_ECDH=false;DiffieHellman.call(this,d);return}if(this._isPriv){this._dh.setPrivateKey(d.part.d.data)}this._dh.setPublicKey(d.part.Q.data)}else{if(d.type==="curve25519"){if(nacl===undefined){nacl=require("tweetnacl")}if(this._isPriv){utils.assertCompatible(d,PrivateKey,[1,5],"key");this._priv=d.part.k.data}}else{throw (new Error("DH not supported for "+d.type+" keys"))}}}}DiffieHellman.prototype.getPublicKey=function(){if(this._isPriv){return(this._key.toPublic())}return(this._key)};DiffieHellman.prototype.getPrivateKey=function(){if(this._isPriv){return(this._key)}else{return(undefined)}};DiffieHellman.prototype.getKey=DiffieHellman.prototype.getPrivateKey;DiffieHellman.prototype._keyCheck=function(c,d){assert.object(c,"key");if(!d){utils.assertCompatible(c,PrivateKey,[1,3],"key")}utils.assertCompatible(c,Key,[1,4],"key");if(c.type!==this._algo){throw (new Error("A "+c.type+" key cannot be used in "+this._algo+" Diffie-Hellman"))}if(c.curve!==this._curve){throw (new Error("A key from the "+c.curve+" curve cannot be used with a "+this._curve+" Diffie-Hellman"))}if(c.type==="dsa"){assert.deepEqual(c.part.p,this._p,"DSA key prime does not match");assert.deepEqual(c.part.g,this._g,"DSA key generator does not match")}};DiffieHellman.prototype.setKey=function(c){this._keyCheck(c);if(c.type==="dsa"){this._dh.setPrivateKey(c.part.x.data);this._dh.setPublicKey(c.part.y.data)}else{if(c.type==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.setPrivateKey(c.part.d.data);this._dh.setPublicKey(c.part.Q.data)}else{this._priv=new ECPrivate(this._ecParams,c.part.d.data)}}else{if(c.type==="curve25519"){var d=c.part.k;if(!c.part.k){d=c.part.r}this._priv=d.data;if(this._priv[0]===0){this._priv=this._priv.slice(1)}this._priv=this._priv.slice(0,32)}}}this._key=c;this._isPriv=true};DiffieHellman.prototype.setPrivateKey=DiffieHellman.prototype.setKey;DiffieHellman.prototype.computeSecret=function(f){this._keyCheck(f,true);if(!this._isPriv){throw (new Error("DH exchange has not been initialized with a private key yet"))}var e;if(this._algo==="dsa"){return(this._dh.computeSecret(f.part.y.data))}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){return(this._dh.computeSecret(f.part.Q.data))}else{e=new ECPublic(this._ecParams,f.part.Q.data);return(this._priv.deriveSharedSecret(e))}}else{if(this._algo==="curve25519"){e=f.part.A.data;while(e[0]===0&&e.length>32){e=e.slice(1)}var g=this._priv;assert.strictEqual(e.length,32);assert.strictEqual(g.length,32);var h=nacl.box.before(new Uint8Array(e),new Uint8Array(g));return(new Buffer(h))}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKey=function(){var h=[];var l,i;if(this._algo==="dsa"){this._dh.generateKeys();h.push({name:"p",data:this._p.data});h.push({name:"q",data:this._key.part.q.data});h.push({name:"g",data:this._g.data});h.push({name:"y",data:this._dh.getPublicKey()});h.push({name:"x",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"dsa",parts:h});this._isPriv=true;return(this._key)}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.generateKeys();h.push({name:"curve",data:new Buffer(this._curve)});h.push({name:"Q",data:this._dh.getPublicKey()});h.push({name:"d",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:h});this._isPriv=true;return(this._key)}else{var m=this._ecParams.getN();var j=new jsbn(crypto.randomBytes(m.bitLength()));var k=m.subtract(jsbn.ONE);l=j.mod(k).add(jsbn.ONE);i=this._ecParams.getG().multiply(l);l=new Buffer(l.toByteArray());i=new Buffer(this._ecParams.getCurve().encodePointHex(i),"hex");this._priv=new ECPrivate(this._ecParams,l);h.push({name:"curve",data:new Buffer(this._curve)});h.push({name:"Q",data:i});h.push({name:"d",data:l});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:h});this._isPriv=true;return(this._key)}}else{if(this._algo==="curve25519"){var n=nacl.box.keyPair();l=new Buffer(n.secretKey);i=new Buffer(n.publicKey);l=Buffer.concat([l,i]);assert.strictEqual(l.length,64);assert.strictEqual(i.length,32);h.push({name:"A",data:i});h.push({name:"k",data:l});this._key=new PrivateKey({type:"curve25519",parts:h});this._isPriv=true;return(this._key)}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKeys=DiffieHellman.prototype.generateKey;function X9ECParameters(r){var n=algs.curves[r];assert.object(n);var q=new jsbn(n.p);var b=new jsbn(n.a);var h=new jsbn(n.b);var p=new jsbn(n.n);var m=jsbn.ONE;var o=new ec.ECCurveFp(q,b,h);var a=o.decodePointHex(n.G.toString("hex"));this.curve=o;this.g=a;this.n=p;this.h=m}X9ECParameters.prototype.getCurve=function(){return(this.curve)};X9ECParameters.prototype.getG=function(){return(this.g)};X9ECParameters.prototype.getN=function(){return(this.n)};X9ECParameters.prototype.getH=function(){return(this.h)};function ECPublic(c,d){this._params=c;if(d[0]===0){d=d.slice(1)}this._pub=c.getCurve().decodePointHex(d.toString("hex"))}function ECPrivate(c,d){this._params=c;this._priv=new jsbn(utils.mpNormalize(d))}ECPrivate.prototype.deriveSharedSecret=function(d){assert.ok(d instanceof ECPublic);var c=d._pub.multiply(this._priv);return(new Buffer(c.getX().toBigInteger().toByteArray()))};function generateED25519(){if(nacl===undefined){nacl=require("tweetnacl")}var j=nacl.sign.keyPair();var i=new Buffer(j.secretKey);var g=new Buffer(j.publicKey);assert.strictEqual(i.length,64);assert.strictEqual(g.length,32);var f=[];f.push({name:"A",data:g});f.push({name:"k",data:i.slice(0,32)});var h=new PrivateKey({type:"ed25519",parts:f});return(h)}function generateECDSA(q){var o=[];var u;if(CRYPTO_HAVE_ECDH){var c={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[q];var v=crypto.createECDH(c);v.generateKeys();o.push({name:"curve",data:new Buffer(q)});o.push({name:"Q",data:v.getPublicKey()});o.push({name:"d",data:v.getPrivateKey()});u=new PrivateKey({type:"ecdsa",curve:q,parts:o});return(u)}else{if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}var s=new X9ECParameters(q);var r=s.getN();var n=Math.ceil((r.bitLength()+64)/8);var w=new jsbn(crypto.randomBytes(n));var x=r.subtract(jsbn.ONE);var t=w.mod(x).add(jsbn.ONE);var p=s.getG().multiply(t);t=new Buffer(t.toByteArray());p=new Buffer(s.getCurve().encodePointHex(p),"hex");o.push({name:"curve",data:new Buffer(q)});o.push({name:"Q",data:p});o.push({name:"d",data:t});u=new PrivateKey({type:"ecdsa",curve:q,parts:o});return(u)}};