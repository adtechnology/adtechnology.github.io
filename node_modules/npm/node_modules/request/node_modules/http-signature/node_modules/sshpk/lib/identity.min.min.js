module.exports=Identity;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var Fingerprint=require("./fingerprint");var Signature=require("./signature");var errs=require("./errors");var util=require("util");var utils=require("./utils");var asn1=require("asn1");var DNS_NAME_RE=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i;var oids={};oids.cn="2.5.4.3";oids.o="2.5.4.10";oids.ou="2.5.4.11";oids.l="2.5.4.7";oids.s="2.5.4.8";oids.c="2.5.4.6";oids.sn="2.5.4.4";oids.dc="0.9.2342.19200300.100.1.25";oids.uid="0.9.2342.19200300.100.1.1";oids.mail="0.9.2342.19200300.100.1.3";var unoids={};Object.keys(oids).forEach(function(b){unoids[oids[b]]=b});function Identity(c){var d=this;assert.object(c,"options");assert.arrayOfObject(c.components,"options.components");this.components=c.components;this.componentLookup={};this.components.forEach(function(a){if(a.name&&!a.oid){a.oid=oids[a.name]}if(a.oid&&!a.name){a.name=unoids[a.oid]}if(d.componentLookup[a.name]===undefined){d.componentLookup[a.name]=[]}d.componentLookup[a.name].push(a)});if(this.componentLookup.cn&&this.componentLookup.cn.length>0){this.cn=this.componentLookup.cn[0].value}assert.optionalString(c.type,"options.type");if(c.type===undefined){if(this.components.length===1&&this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length){this.type="host";this.hostname=this.componentLookup.dc.map(function(a){return(a.value)}).join(".")}else{if(this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.uid&&this.componentLookup.uid.length===1){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.mail&&this.componentLookup.mail.length===1){this.type="email";this.email=this.componentLookup.mail[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1){this.type="user";this.uid=this.componentLookup.cn[0].value}else{this.type="unknown"}}}}}}}}else{this.type=c.type;if(this.type==="host"){this.hostname=c.hostname}else{if(this.type==="user"){this.uid=c.uid}else{if(this.type==="email"){this.email=c.email}else{throw (new Error("Unknown type "+this.type))}}}}}Identity.prototype.toString=function(){return(this.components.map(function(b){return(b.name.toUpperCase()+"="+b.value)}).join(", "))};var NOT_PRINTABLE=/[^a-zA-Z0-9 '(),+.\/:=?-]/;var NOT_IA5=/[^\x00-\x7f]/;Identity.prototype.toAsn1=function(c,d){c.startSequence(d);this.components.forEach(function(a){c.startSequence(asn1.Ber.Constructor|asn1.Ber.Set);c.startSequence();c.writeOID(a.oid);if(a.asn1type===asn1.Ber.Utf8String||a.value.match(NOT_IA5)){var g=new Buffer(a.value,"utf8");c.writeBuffer(g,asn1.Ber.Utf8String)}else{if(a.asn1type===asn1.Ber.IA5String||a.value.match(NOT_PRINTABLE)){c.writeString(a.value,asn1.Ber.IA5String)}else{var b=asn1.Ber.PrintableString;if(a.asn1type!==undefined){b=a.asn1type}c.writeString(a.value,b)}}c.endSequence();c.endSequence()});c.endSequence()};function globMatch(i,j){if(i==="**"||j==="**"){return(true)}var a=i.split(".");var b=j.split(".");if(a.length!==b.length){return(false)}for(var h=0;h<a.length;++h){if(a[h]==="*"||b[h]==="*"){continue}if(a[h]!==b[h]){return(false)}}return(true)}Identity.prototype.equals=function(d){if(!Identity.isIdentity(d,[1,0])){return(false)}if(d.components.length!==this.components.length){return(false)}for(var c=0;c<this.components.length;++c){if(this.components[c].oid!==d.components[c].oid){return(false)}if(!globMatch(this.components[c].value,d.components[c].value)){return(false)}}return(true)};Identity.forHost=function(b){assert.string(b,"hostname");return(new Identity({type:"host",hostname:b,components:[{name:"cn",value:b}]}))};Identity.forUser=function(b){assert.string(b,"uid");return(new Identity({type:"user",uid:b,components:[{name:"uid",value:b}]}))};Identity.forEmail=function(b){assert.string(b,"email");return(new Identity({type:"email",email:b,components:[{name:"mail",value:b}]}))};Identity.parseDN=function(e){assert.string(e,"dn");var f=e.split(",");var d=f.map(function(a){a=a.trim();var b=a.indexOf("=");var h=a.slice(0,b).toLowerCase();var c=a.slice(b+1);return({name:h,value:c})});return(new Identity({components:d}))};Identity.parseAsn1=function(n,l){var o=[];n.readSequence(l);var j=n.offset+n.length;while(n.offset<j){n.readSequence(asn1.Ber.Constructor|asn1.Ber.Set);var k=n.offset+n.length;n.readSequence();var p=n.readOID();var i=n.peek();var m;switch(i){case asn1.Ber.PrintableString:case asn1.Ber.IA5String:case asn1.Ber.OctetString:case asn1.Ber.T61String:m=n.readString(i);break;case asn1.Ber.Utf8String:m=n.readString(i,true);m=m.toString("utf8");break;case asn1.Ber.CharacterString:case asn1.Ber.BMPString:m=n.readString(i,true);m=m.toString("utf16le");break;default:throw (new Error("Unknown asn1 type "+i))}o.push({oid:p,asn1type:i,value:m});n._offset=k}n._offset=j;return(new Identity({components:o}))};Identity.isIdentity=function(c,d){return(utils.isCompatible(c,Identity,d))};Identity.prototype._sshpkApiVersion=[1,0];Identity._oldVersionDetect=function(b){return([1,0])};