module.exports=Signature;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var errs=require("./errors");var utils=require("./utils");var asn1=require("asn1");var SSHBuffer=require("./ssh-buffer");var InvalidAlgorithmError=errs.InvalidAlgorithmError;var SignatureParseError=errs.SignatureParseError;function Signature(c){assert.object(c,"options");assert.arrayOfObject(c.parts,"options.parts");assert.string(c.type,"options.type");var d={};for(var b=0;b<c.parts.length;++b){var a=c.parts[b];d[a.name]=a}this.type=c.type;this.hashAlgorithm=c.hashAlgo;this.curve=c.curve;this.parts=c.parts;this.part=d}Signature.prototype.toBuffer=function(g){if(g===undefined){g="asn1"}assert.string(g,"format");var b;var f="ssh-"+this.type;switch(this.type){case"rsa":switch(this.hashAlgorithm){case"sha256":f="rsa-sha2-256";break;case"sha512":f="rsa-sha2-512";break;case"sha1":case undefined:break;default:throw (new Error("SSH signature format does not support hash algorithm "+this.hashAlgorithm))}if(g==="ssh"){b=new SSHBuffer({});b.writeString(f);b.writePart(this.part.sig);return(b.toBuffer())}else{return(this.part.sig.data)}break;case"ed25519":if(g==="ssh"){b=new SSHBuffer({});b.writeString(f);b.writePart(this.part.sig);return(b.toBuffer())}else{return(this.part.sig.data)}break;case"dsa":case"ecdsa":var a,h;if(g==="asn1"){var d=new asn1.BerWriter();d.startSequence();a=utils.mpNormalize(this.part.r.data);h=utils.mpNormalize(this.part.s.data);d.writeBuffer(a,asn1.Ber.Integer);d.writeBuffer(h,asn1.Ber.Integer);d.endSequence();return(d.buffer)}else{if(g==="ssh"&&this.type==="dsa"){b=new SSHBuffer({});b.writeString("ssh-dss");a=this.part.r.data;if(a.length>20&&a[0]===0){a=a.slice(1)}h=this.part.s.data;if(h.length>20&&h[0]===0){h=h.slice(1)}if((this.hashAlgorithm&&this.hashAlgorithm!=="sha1")||a.length+h.length!==40){throw (new Error("OpenSSH only supports DSA signatures with SHA1 hash"))}b.writeBuffer(Buffer.concat([a,h]));return(b.toBuffer())}else{if(g==="ssh"&&this.type==="ecdsa"){var i=new SSHBuffer({});a=this.part.r.data;i.writeBuffer(a);i.writePart(this.part.s);b=new SSHBuffer({});var c;if(a[0]===0){a=a.slice(1)}var e=a.length*8;if(e===256){c="nistp256"}else{if(e===384){c="nistp384"}else{if(e===528){c="nistp521"}}}b.writeString("ecdsa-sha2-"+c);b.writeBuffer(i.toBuffer());return(b.toBuffer())}}}throw (new Error("Invalid signature format"));default:throw (new Error("Invalid signature data"))}};Signature.prototype.toString=function(a){assert.optionalString(a,"format");return(this.toBuffer(a).toString("base64"))};Signature.parse=function(d,b,a){if(typeof(d)==="string"){d=new Buffer(d,"base64")}assert.buffer(d,"data");assert.string(a,"format");assert.string(b,"type");var c={};c.type=b.toLowerCase();c.parts=[];try{assert.ok(d.length>0,"signature must not be empty");switch(c.type){case"rsa":return(parseOneNum(d,b,a,c));case"ed25519":return(parseOneNum(d,b,a,c));case"dsa":case"ecdsa":if(a==="asn1"){return(parseDSAasn1(d,b,a,c))}else{if(c.type==="dsa"){return(parseDSA(d,b,a,c))}else{return(parseECDSA(d,b,a,c))}}default:throw (new InvalidAlgorithmError(b))}}catch(f){if(f instanceof InvalidAlgorithmError){throw (f)}throw (new SignatureParseError(b,a,f))}};function parseOneNum(d,g,i,a){if(i==="ssh"){try{var b=new SSHBuffer({buffer:d});var h=b.readString()}catch(f){}if(b!==undefined){var c="SSH signature does not match expected type (expected "+g+", got "+h+")";switch(h){case"ssh-rsa":assert.strictEqual(g,"rsa",c);a.hashAlgo="sha1";break;case"rsa-sha2-256":assert.strictEqual(g,"rsa",c);a.hashAlgo="sha256";break;case"rsa-sha2-512":assert.strictEqual(g,"rsa",c);a.hashAlgo="sha512";break;case"ssh-ed25519":assert.strictEqual(g,"ed25519",c);a.hashAlgo="sha512";break;default:throw (new Error("Unknown SSH signature type: "+h))}var j=b.readPart();assert.ok(b.atEnd(),"extra trailing bytes");j.name="sig";a.parts.push(j);return(new Signature(a))}}a.parts.push({name:"sig",data:d});return(new Signature(a))}function parseDSAasn1(g,c,a,f){var e=new asn1.BerReader(g);e.readSequence();var d=e.readString(asn1.Ber.Integer,true);var b=e.readString(asn1.Ber.Integer,true);f.parts.push({name:"r",data:utils.mpNormalize(d)});f.parts.push({name:"s",data:utils.mpNormalize(b)});return(new Signature(f))}function parseDSA(g,e,a,f){if(g.length!=40){var c=new SSHBuffer({buffer:g});var b=c.readBuffer();if(b.toString("ascii")==="ssh-dss"){b=c.readBuffer()}assert.ok(c.atEnd(),"extra trailing bytes");assert.strictEqual(b.length,40,"invalid inner length");g=b}f.parts.push({name:"r",data:g.slice(0,20)});f.parts.push({name:"s",data:g.slice(20,40)});return(new Signature(f))}function parseECDSA(a,c,d,g){var i=new SSHBuffer({buffer:a});var h,e;var f=i.readBuffer();var b=f.toString("ascii");if(b.slice(0,6)==="ecdsa-"){var j=b.split("-");assert.strictEqual(j[0],"ecdsa");assert.strictEqual(j[1],"sha2");g.curve=j[2];switch(g.curve){case"nistp256":g.hashAlgo="sha256";break;case"nistp384":g.hashAlgo="sha384";break;case"nistp521":g.hashAlgo="sha512";break;default:throw (new Error("Unsupported ECDSA curve: "+g.curve))}f=i.readBuffer();assert.ok(i.atEnd(),"extra trailing bytes on outer");i=new SSHBuffer({buffer:f});h=i.readPart()}else{h={data:f}}e=i.readPart();assert.ok(i.atEnd(),"extra trailing bytes");h.name="r";e.name="s";g.parts.push(h);g.parts.push(e);return(new Signature(g))}Signature.isSignature=function(b,a){return(utils.isCompatible(b,Signature,a))};Signature.prototype._sshpkApiVersion=[2,1];Signature._oldVersionDetect=function(a){assert.func(a.toBuffer);if(a.hasOwnProperty("hashAlgorithm")){return([2,0])}return([1,0])};