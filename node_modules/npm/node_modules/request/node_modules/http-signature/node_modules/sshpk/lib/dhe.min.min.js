module.exports={DiffieHellman:DiffieHellman,generateECDSA:generateECDSA,generateED25519:generateED25519};var assert=require("assert-plus");var crypto=require("crypto");var algs=require("./algs");var utils=require("./utils");var nacl;var Key=require("./key");var PrivateKey=require("./private-key");var CRYPTO_HAVE_ECDH=(crypto.createECDH!==undefined);var ecdh,ec,jsbn;function DiffieHellman(d){utils.assertCompatible(d,Key,[1,4],"key");this._isPriv=PrivateKey.isPrivateKey(d,[1,3]);this._algo=d.type;this._curve=d.curve;this._key=d;if(d.type==="dsa"){if(!CRYPTO_HAVE_ECDH){throw (new Error("Due to bugs in the node 0.10 crypto API, node 0.12.x or later is required to use DH"))}this._dh=crypto.createDiffieHellman(d.part.p.data,undefined,d.part.g.data,undefined);this._p=d.part.p;this._g=d.part.g;if(this._isPriv){this._dh.setPrivateKey(d.part.x.data)}this._dh.setPublicKey(d.part.y.data)}else{if(d.type==="ecdsa"){if(!CRYPTO_HAVE_ECDH){if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}this._ecParams=new X9ECParameters(this._curve);if(this._isPriv){this._priv=new ECPrivate(this._ecParams,d.part.d.data)}return}var c={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[d.curve];this._dh=crypto.createECDH(c);if(typeof(this._dh)!=="object"||typeof(this._dh.setPrivateKey)!=="function"){CRYPTO_HAVE_ECDH=false;DiffieHellman.call(this,d);return}if(this._isPriv){this._dh.setPrivateKey(d.part.d.data)}this._dh.setPublicKey(d.part.Q.data)}else{if(d.type==="curve25519"){if(nacl===undefined){nacl=require("tweetnacl")}if(this._isPriv){utils.assertCompatible(d,PrivateKey,[1,5],"key");this._priv=d.part.k.data}}else{throw (new Error("DH not supported for "+d.type+" keys"))}}}}DiffieHellman.prototype.getPublicKey=function(){if(this._isPriv){return(this._key.toPublic())}return(this._key)};DiffieHellman.prototype.getPrivateKey=function(){if(this._isPriv){return(this._key)}else{return(undefined)}};DiffieHellman.prototype.getKey=DiffieHellman.prototype.getPrivateKey;DiffieHellman.prototype._keyCheck=function(c,d){assert.object(c,"key");if(!d){utils.assertCompatible(c,PrivateKey,[1,3],"key")}utils.assertCompatible(c,Key,[1,4],"key");if(c.type!==this._algo){throw (new Error("A "+c.type+" key cannot be used in "+this._algo+" Diffie-Hellman"))}if(c.curve!==this._curve){throw (new Error("A key from the "+c.curve+" curve cannot be used with a "+this._curve+" Diffie-Hellman"))}if(c.type==="dsa"){assert.deepEqual(c.part.p,this._p,"DSA key prime does not match");assert.deepEqual(c.part.g,this._g,"DSA key generator does not match")}};DiffieHellman.prototype.setKey=function(c){this._keyCheck(c);if(c.type==="dsa"){this._dh.setPrivateKey(c.part.x.data);this._dh.setPublicKey(c.part.y.data)}else{if(c.type==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.setPrivateKey(c.part.d.data);this._dh.setPublicKey(c.part.Q.data)}else{this._priv=new ECPrivate(this._ecParams,c.part.d.data)}}else{if(c.type==="curve25519"){var d=c.part.k;if(!c.part.k){d=c.part.r}this._priv=d.data;if(this._priv[0]===0){this._priv=this._priv.slice(1)}this._priv=this._priv.slice(0,32)}}}this._key=c;this._isPriv=true};DiffieHellman.prototype.setPrivateKey=DiffieHellman.prototype.setKey;DiffieHellman.prototype.computeSecret=function(h){this._keyCheck(h,true);if(!this._isPriv){throw (new Error("DH exchange has not been initialized with a private key yet"))}var g;if(this._algo==="dsa"){return(this._dh.computeSecret(h.part.y.data))}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){return(this._dh.computeSecret(h.part.Q.data))}else{g=new ECPublic(this._ecParams,h.part.Q.data);return(this._priv.deriveSharedSecret(g))}}else{if(this._algo==="curve25519"){g=h.part.A.data;while(g[0]===0&&g.length>32){g=g.slice(1)}var e=this._priv;assert.strictEqual(g.length,32);assert.strictEqual(e.length,32);var f=nacl.box.before(new Uint8Array(g),new Uint8Array(e));return(new Buffer(f))}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKey=function(){var l=[];var i,m;if(this._algo==="dsa"){this._dh.generateKeys();l.push({name:"p",data:this._p.data});l.push({name:"q",data:this._key.part.q.data});l.push({name:"g",data:this._g.data});l.push({name:"y",data:this._dh.getPublicKey()});l.push({name:"x",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"dsa",parts:l});this._isPriv=true;return(this._key)}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.generateKeys();l.push({name:"curve",data:new Buffer(this._curve)});l.push({name:"Q",data:this._dh.getPublicKey()});l.push({name:"d",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:l});this._isPriv=true;return(this._key)}else{var j=this._ecParams.getN();var n=new jsbn(crypto.randomBytes(j.bitLength()));var h=j.subtract(jsbn.ONE);i=n.mod(h).add(jsbn.ONE);m=this._ecParams.getG().multiply(i);i=new Buffer(i.toByteArray());m=new Buffer(this._ecParams.getCurve().encodePointHex(m),"hex");this._priv=new ECPrivate(this._ecParams,i);l.push({name:"curve",data:new Buffer(this._curve)});l.push({name:"Q",data:m});l.push({name:"d",data:i});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:l});this._isPriv=true;return(this._key)}}else{if(this._algo==="curve25519"){var k=nacl.box.keyPair();i=new Buffer(k.secretKey);m=new Buffer(k.publicKey);i=Buffer.concat([i,m]);assert.strictEqual(i.length,64);assert.strictEqual(m.length,32);l.push({name:"A",data:m});l.push({name:"k",data:i});this._key=new PrivateKey({type:"curve25519",parts:l});this._isPriv=true;return(this._key)}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKeys=DiffieHellman.prototype.generateKey;function X9ECParameters(r){var n=algs.curves[r];assert.object(n);var q=new jsbn(n.p);var b=new jsbn(n.a);var h=new jsbn(n.b);var p=new jsbn(n.n);var m=jsbn.ONE;var o=new ec.ECCurveFp(q,b,h);var a=o.decodePointHex(n.G.toString("hex"));this.curve=o;this.g=a;this.n=p;this.h=m}X9ECParameters.prototype.getCurve=function(){return(this.curve)};X9ECParameters.prototype.getG=function(){return(this.g)};X9ECParameters.prototype.getN=function(){return(this.n)};X9ECParameters.prototype.getH=function(){return(this.h)};function ECPublic(c,d){this._params=c;if(d[0]===0){d=d.slice(1)}this._pub=c.getCurve().decodePointHex(d.toString("hex"))}function ECPrivate(c,d){this._params=c;this._priv=new jsbn(utils.mpNormalize(d))}ECPrivate.prototype.deriveSharedSecret=function(d){assert.ok(d instanceof ECPublic);var c=d._pub.multiply(this._priv);return(new Buffer(c.getX().toBigInteger().toByteArray()))};function generateED25519(){if(nacl===undefined){nacl=require("tweetnacl")}var h=nacl.sign.keyPair();var g=new Buffer(h.secretKey);var j=new Buffer(h.publicKey);assert.strictEqual(g.length,64);assert.strictEqual(j.length,32);var i=[];i.push({name:"A",data:j});i.push({name:"k",data:g.slice(0,32)});var f=new PrivateKey({type:"ed25519",parts:i});return(f)}function generateECDSA(w){var u=[];var o;if(CRYPTO_HAVE_ECDH){var s={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[w];var p=crypto.createECDH(s);p.generateKeys();u.push({name:"curve",data:new Buffer(w)});u.push({name:"Q",data:p.getPublicKey()});u.push({name:"d",data:p.getPrivateKey()});o=new PrivateKey({type:"ecdsa",curve:w,parts:u});return(o)}else{if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}var c=new X9ECParameters(w);var x=c.getN();var t=Math.ceil((x.bitLength()+64)/8);var q=new jsbn(crypto.randomBytes(t));var r=x.subtract(jsbn.ONE);var n=q.mod(r).add(jsbn.ONE);var v=c.getG().multiply(n);n=new Buffer(n.toByteArray());v=new Buffer(c.getCurve().encodePointHex(v),"hex");u.push({name:"curve",data:new Buffer(w)});u.push({name:"Q",data:v});u.push({name:"d",data:n});o=new PrivateKey({type:"ecdsa",curve:w,parts:u});return(o)}};