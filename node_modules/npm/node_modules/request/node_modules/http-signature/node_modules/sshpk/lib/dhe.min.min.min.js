module.exports={DiffieHellman:DiffieHellman,generateECDSA:generateECDSA,generateED25519:generateED25519};var assert=require("assert-plus");var crypto=require("crypto");var algs=require("./algs");var utils=require("./utils");var nacl;var Key=require("./key");var PrivateKey=require("./private-key");var CRYPTO_HAVE_ECDH=(crypto.createECDH!==undefined);var ecdh,ec,jsbn;function DiffieHellman(a){utils.assertCompatible(a,Key,[1,4],"key");this._isPriv=PrivateKey.isPrivateKey(a,[1,3]);this._algo=a.type;this._curve=a.curve;this._key=a;if(a.type==="dsa"){if(!CRYPTO_HAVE_ECDH){throw (new Error("Due to bugs in the node 0.10 crypto API, node 0.12.x or later is required to use DH"))}this._dh=crypto.createDiffieHellman(a.part.p.data,undefined,a.part.g.data,undefined);this._p=a.part.p;this._g=a.part.g;if(this._isPriv){this._dh.setPrivateKey(a.part.x.data)}this._dh.setPublicKey(a.part.y.data)}else{if(a.type==="ecdsa"){if(!CRYPTO_HAVE_ECDH){if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}this._ecParams=new X9ECParameters(this._curve);if(this._isPriv){this._priv=new ECPrivate(this._ecParams,a.part.d.data)}return}var b={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[a.curve];this._dh=crypto.createECDH(b);if(typeof(this._dh)!=="object"||typeof(this._dh.setPrivateKey)!=="function"){CRYPTO_HAVE_ECDH=false;DiffieHellman.call(this,a);return}if(this._isPriv){this._dh.setPrivateKey(a.part.d.data)}this._dh.setPublicKey(a.part.Q.data)}else{if(a.type==="curve25519"){if(nacl===undefined){nacl=require("tweetnacl")}if(this._isPriv){utils.assertCompatible(a,PrivateKey,[1,5],"key");this._priv=a.part.k.data}}else{throw (new Error("DH not supported for "+a.type+" keys"))}}}}DiffieHellman.prototype.getPublicKey=function(){if(this._isPriv){return(this._key.toPublic())}return(this._key)};DiffieHellman.prototype.getPrivateKey=function(){if(this._isPriv){return(this._key)}else{return(undefined)}};DiffieHellman.prototype.getKey=DiffieHellman.prototype.getPrivateKey;DiffieHellman.prototype._keyCheck=function(b,a){assert.object(b,"key");if(!a){utils.assertCompatible(b,PrivateKey,[1,3],"key")}utils.assertCompatible(b,Key,[1,4],"key");if(b.type!==this._algo){throw (new Error("A "+b.type+" key cannot be used in "+this._algo+" Diffie-Hellman"))}if(b.curve!==this._curve){throw (new Error("A key from the "+b.curve+" curve cannot be used with a "+this._curve+" Diffie-Hellman"))}if(b.type==="dsa"){assert.deepEqual(b.part.p,this._p,"DSA key prime does not match");assert.deepEqual(b.part.g,this._g,"DSA key generator does not match")}};DiffieHellman.prototype.setKey=function(b){this._keyCheck(b);if(b.type==="dsa"){this._dh.setPrivateKey(b.part.x.data);this._dh.setPublicKey(b.part.y.data)}else{if(b.type==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.setPrivateKey(b.part.d.data);this._dh.setPublicKey(b.part.Q.data)}else{this._priv=new ECPrivate(this._ecParams,b.part.d.data)}}else{if(b.type==="curve25519"){var a=b.part.k;if(!b.part.k){a=b.part.r}this._priv=a.data;if(this._priv[0]===0){this._priv=this._priv.slice(1)}this._priv=this._priv.slice(0,32)}}}this._key=b;this._isPriv=true};DiffieHellman.prototype.setPrivateKey=DiffieHellman.prototype.setKey;DiffieHellman.prototype.computeSecret=function(a){this._keyCheck(a,true);if(!this._isPriv){throw (new Error("DH exchange has not been initialized with a private key yet"))}var b;if(this._algo==="dsa"){return(this._dh.computeSecret(a.part.y.data))}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){return(this._dh.computeSecret(a.part.Q.data))}else{b=new ECPublic(this._ecParams,a.part.Q.data);return(this._priv.deriveSharedSecret(b))}}else{if(this._algo==="curve25519"){b=a.part.A.data;while(b[0]===0&&b.length>32){b=b.slice(1)}var d=this._priv;assert.strictEqual(b.length,32);assert.strictEqual(d.length,32);var c=nacl.box.before(new Uint8Array(b),new Uint8Array(d));return(new Buffer(c))}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKey=function(){var b=[];var e,a;if(this._algo==="dsa"){this._dh.generateKeys();b.push({name:"p",data:this._p.data});b.push({name:"q",data:this._key.part.q.data});b.push({name:"g",data:this._g.data});b.push({name:"y",data:this._dh.getPublicKey()});b.push({name:"x",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"dsa",parts:b});this._isPriv=true;return(this._key)}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.generateKeys();b.push({name:"curve",data:new Buffer(this._curve)});b.push({name:"Q",data:this._dh.getPublicKey()});b.push({name:"d",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:b});this._isPriv=true;return(this._key)}else{var d=this._ecParams.getN();var g=new jsbn(crypto.randomBytes(d.bitLength()));var f=d.subtract(jsbn.ONE);e=g.mod(f).add(jsbn.ONE);a=this._ecParams.getG().multiply(e);e=new Buffer(e.toByteArray());a=new Buffer(this._ecParams.getCurve().encodePointHex(a),"hex");this._priv=new ECPrivate(this._ecParams,e);b.push({name:"curve",data:new Buffer(this._curve)});b.push({name:"Q",data:a});b.push({name:"d",data:e});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:b});this._isPriv=true;return(this._key)}}else{if(this._algo==="curve25519"){var c=nacl.box.keyPair();e=new Buffer(c.secretKey);a=new Buffer(c.publicKey);e=Buffer.concat([e,a]);assert.strictEqual(e.length,64);assert.strictEqual(a.length,32);b.push({name:"A",data:a});b.push({name:"k",data:e});this._key=new PrivateKey({type:"curve25519",parts:b});this._isPriv=true;return(this._key)}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKeys=DiffieHellman.prototype.generateKey;function X9ECParameters(c){var g=algs.curves[c];assert.object(g);var d=new jsbn(g.p);var k=new jsbn(g.a);var j=new jsbn(g.b);var e=new jsbn(g.n);var i=jsbn.ONE;var f=new ec.ECCurveFp(d,k,j);var l=f.decodePointHex(g.G.toString("hex"));this.curve=f;this.g=l;this.n=e;this.h=i}X9ECParameters.prototype.getCurve=function(){return(this.curve)};X9ECParameters.prototype.getG=function(){return(this.g)};X9ECParameters.prototype.getN=function(){return(this.n)};X9ECParameters.prototype.getH=function(){return(this.h)};function ECPublic(b,a){this._params=b;if(a[0]===0){a=a.slice(1)}this._pub=b.getCurve().decodePointHex(a.toString("hex"))}function ECPrivate(b,a){this._params=b;this._priv=new jsbn(utils.mpNormalize(a))}ECPrivate.prototype.deriveSharedSecret=function(a){assert.ok(a instanceof ECPublic);var b=a._pub.multiply(this._priv);return(new Buffer(b.getX().toBigInteger().toByteArray()))};function generateED25519(){if(nacl===undefined){nacl=require("tweetnacl")}var c=nacl.sign.keyPair();var d=new Buffer(c.secretKey);var a=new Buffer(c.publicKey);assert.strictEqual(d.length,64);assert.strictEqual(a.length,32);var b=[];b.push({name:"A",data:a});b.push({name:"k",data:d.slice(0,32)});var e=new PrivateKey({type:"ed25519",parts:b});return(e)}function generateECDSA(i){var k=[];var e;if(CRYPTO_HAVE_ECDH){var m={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[i];var d=crypto.createECDH(m);d.generateKeys();k.push({name:"curve",data:new Buffer(i)});k.push({name:"Q",data:d.getPublicKey()});k.push({name:"d",data:d.getPrivateKey()});e=new PrivateKey({type:"ecdsa",curve:i,parts:k});return(e)}else{if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}var g=new X9ECParameters(i);var h=g.getN();var l=Math.ceil((h.bitLength()+64)/8);var b=new jsbn(crypto.randomBytes(l));var a=h.subtract(jsbn.ONE);var f=b.mod(a).add(jsbn.ONE);var j=g.getG().multiply(f);f=new Buffer(f.toByteArray());j=new Buffer(g.getCurve().encodePointHex(j),"hex");k.push({name:"curve",data:new Buffer(i)});k.push({name:"Q",data:j});k.push({name:"d",data:f});e=new PrivateKey({type:"ecdsa",curve:i,parts:k});return(e)}};