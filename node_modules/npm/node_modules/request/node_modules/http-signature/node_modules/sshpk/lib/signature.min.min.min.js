module.exports=Signature;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var errs=require("./errors");var utils=require("./utils");var asn1=require("asn1");var SSHBuffer=require("./ssh-buffer");var InvalidAlgorithmError=errs.InvalidAlgorithmError;var SignatureParseError=errs.SignatureParseError;function Signature(a){assert.object(a,"options");assert.arrayOfObject(a.parts,"options.parts");assert.string(a.type,"options.type");var b={};for(var d=0;d<a.parts.length;++d){var c=a.parts[d];b[c.name]=c}this.type=a.type;this.hashAlgorithm=a.hashAlgo;this.curve=a.curve;this.parts=a.parts;this.part=b}Signature.prototype.toBuffer=function(g){if(g===undefined){g="asn1"}assert.string(g,"format");var b;var f="ssh-"+this.type;switch(this.type){case"rsa":switch(this.hashAlgorithm){case"sha256":f="rsa-sha2-256";break;case"sha512":f="rsa-sha2-512";break;case"sha1":case undefined:break;default:throw (new Error("SSH signature format does not support hash algorithm "+this.hashAlgorithm))}if(g==="ssh"){b=new SSHBuffer({});b.writeString(f);b.writePart(this.part.sig);return(b.toBuffer())}else{return(this.part.sig.data)}break;case"ed25519":if(g==="ssh"){b=new SSHBuffer({});b.writeString(f);b.writePart(this.part.sig);return(b.toBuffer())}else{return(this.part.sig.data)}break;case"dsa":case"ecdsa":var a,h;if(g==="asn1"){var d=new asn1.BerWriter();d.startSequence();a=utils.mpNormalize(this.part.r.data);h=utils.mpNormalize(this.part.s.data);d.writeBuffer(a,asn1.Ber.Integer);d.writeBuffer(h,asn1.Ber.Integer);d.endSequence();return(d.buffer)}else{if(g==="ssh"&&this.type==="dsa"){b=new SSHBuffer({});b.writeString("ssh-dss");a=this.part.r.data;if(a.length>20&&a[0]===0){a=a.slice(1)}h=this.part.s.data;if(h.length>20&&h[0]===0){h=h.slice(1)}if((this.hashAlgorithm&&this.hashAlgorithm!=="sha1")||a.length+h.length!==40){throw (new Error("OpenSSH only supports DSA signatures with SHA1 hash"))}b.writeBuffer(Buffer.concat([a,h]));return(b.toBuffer())}else{if(g==="ssh"&&this.type==="ecdsa"){var i=new SSHBuffer({});a=this.part.r.data;i.writeBuffer(a);i.writePart(this.part.s);b=new SSHBuffer({});var c;if(a[0]===0){a=a.slice(1)}var e=a.length*8;if(e===256){c="nistp256"}else{if(e===384){c="nistp384"}else{if(e===528){c="nistp521"}}}b.writeString("ecdsa-sha2-"+c);b.writeBuffer(i.toBuffer());return(b.toBuffer())}}}throw (new Error("Invalid signature format"));default:throw (new Error("Invalid signature data"))}};Signature.prototype.toString=function(a){assert.optionalString(a,"format");return(this.toBuffer(a).toString("base64"))};Signature.parse=function(a,d,c){if(typeof(a)==="string"){a=new Buffer(a,"base64")}assert.buffer(a,"data");assert.string(c,"format");assert.string(d,"type");var f={};f.type=d.toLowerCase();f.parts=[];try{assert.ok(a.length>0,"signature must not be empty");switch(f.type){case"rsa":return(parseOneNum(a,d,c,f));case"ed25519":return(parseOneNum(a,d,c,f));case"dsa":case"ecdsa":if(c==="asn1"){return(parseDSAasn1(a,d,c,f))}else{if(f.type==="dsa"){return(parseDSA(a,d,c,f))}else{return(parseECDSA(a,d,c,f))}}default:throw (new InvalidAlgorithmError(d))}}catch(b){if(b instanceof InvalidAlgorithmError){throw (b)}throw (new SignatureParseError(d,c,b))}};function parseOneNum(d,g,i,a){if(i==="ssh"){try{var b=new SSHBuffer({buffer:d});var h=b.readString()}catch(f){}if(b!==undefined){var c="SSH signature does not match expected type (expected "+g+", got "+h+")";switch(h){case"ssh-rsa":assert.strictEqual(g,"rsa",c);a.hashAlgo="sha1";break;case"rsa-sha2-256":assert.strictEqual(g,"rsa",c);a.hashAlgo="sha256";break;case"rsa-sha2-512":assert.strictEqual(g,"rsa",c);a.hashAlgo="sha512";break;case"ssh-ed25519":assert.strictEqual(g,"ed25519",c);a.hashAlgo="sha512";break;default:throw (new Error("Unknown SSH signature type: "+h))}var j=b.readPart();assert.ok(b.atEnd(),"extra trailing bytes");j.name="sig";a.parts.push(j);return(new Signature(a))}}a.parts.push({name:"sig",data:d});return(new Signature(a))}function parseDSAasn1(c,f,d,b){var a=new asn1.BerReader(c);a.readSequence();var g=a.readString(asn1.Ber.Integer,true);var e=a.readString(asn1.Ber.Integer,true);b.parts.push({name:"r",data:utils.mpNormalize(g)});b.parts.push({name:"s",data:utils.mpNormalize(e)});return(new Signature(b))}function parseDSA(b,g,c,a){if(b.length!=40){var f=new SSHBuffer({buffer:b});var e=f.readBuffer();if(e.toString("ascii")==="ssh-dss"){e=f.readBuffer()}assert.ok(f.atEnd(),"extra trailing bytes");assert.strictEqual(e.length,40,"invalid inner length");b=e}a.parts.push({name:"r",data:b.slice(0,20)});a.parts.push({name:"s",data:b.slice(20,40)});return(new Signature(a))}function parseECDSA(c,e,f,i){var a=new SSHBuffer({buffer:c});var j,g;var h=a.readBuffer();var d=h.toString("ascii");if(d.slice(0,6)==="ecdsa-"){var b=d.split("-");assert.strictEqual(b[0],"ecdsa");assert.strictEqual(b[1],"sha2");i.curve=b[2];switch(i.curve){case"nistp256":i.hashAlgo="sha256";break;case"nistp384":i.hashAlgo="sha384";break;case"nistp521":i.hashAlgo="sha512";break;default:throw (new Error("Unsupported ECDSA curve: "+i.curve))}h=a.readBuffer();assert.ok(a.atEnd(),"extra trailing bytes on outer");a=new SSHBuffer({buffer:h});j=a.readPart()}else{j={data:h}}g=a.readPart();assert.ok(a.atEnd(),"extra trailing bytes");j.name="r";g.name="s";i.parts.push(j);i.parts.push(g);return(new Signature(i))}Signature.isSignature=function(b,a){return(utils.isCompatible(b,Signature,a))};Signature.prototype._sshpkApiVersion=[2,1];Signature._oldVersionDetect=function(a){assert.func(a.toBuffer);if(a.hasOwnProperty("hashAlgorithm")){return([2,0])}return([1,0])};