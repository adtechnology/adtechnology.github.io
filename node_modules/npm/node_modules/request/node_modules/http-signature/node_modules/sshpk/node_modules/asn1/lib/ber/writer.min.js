var assert=require("assert");var ASN1=require("./types");var errors=require("./errors");var newInvalidAsn1Error=errors.newInvalidAsn1Error;var DEFAULT_OPTS={size:1024,growthFactor:8};function merge(c,b){assert.ok(c);assert.equal(typeof(c),"object");assert.ok(b);assert.equal(typeof(b),"object");var a=Object.getOwnPropertyNames(c);a.forEach(function(d){if(b[d]){return}var e=Object.getOwnPropertyDescriptor(c,d);Object.defineProperty(b,d,e)});return b}function Writer(a){a=merge(DEFAULT_OPTS,a||{});this._buf=new Buffer(a.size||1024);this._size=this._buf.length;this._offset=0;this._options=a;this._seq=[]}Object.defineProperty(Writer.prototype,"buffer",{get:function(){if(this._seq.length){throw new InvalidAsn1Error(this._seq.length+" unended sequence(s)")}return(this._buf.slice(0,this._offset))}});Writer.prototype.writeByte=function(a){if(typeof(a)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(1);this._buf[this._offset++]=a};Writer.prototype.writeInt=function(b,a){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(a)!=="number"){a=ASN1.Integer}var c=4;while((((b&4286578688)===0)||((b&4286578688)===4286578688>>0))&&(c>1)){c--;b<<=8}if(c>4){throw new InvalidAsn1Error("BER ints cannot be > 0xffffffff")}this._ensure(2+c);this._buf[this._offset++]=a;this._buf[this._offset++]=c;while(c-->0){this._buf[this._offset++]=((b&4278190080)>>>24);b<<=8}};Writer.prototype.writeNull=function(){this.writeByte(ASN1.Null);this.writeByte(0)};Writer.prototype.writeEnumeration=function(b,a){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(a)!=="number"){a=ASN1.Enumeration}return this.writeInt(b,a)};Writer.prototype.writeBoolean=function(c,a){if(typeof(c)!=="boolean"){throw new TypeError("argument must be a Boolean")}if(typeof(a)!=="number"){a=ASN1.Boolean}this._ensure(3);this._buf[this._offset++]=a;this._buf[this._offset++]=1;this._buf[this._offset++]=c?255:0};Writer.prototype.writeString=function(c,b){if(typeof(c)!=="string"){throw new TypeError("argument must be a string (was: "+typeof(c)+")")}if(typeof(b)!=="number"){b=ASN1.OctetString}var a=Buffer.byteLength(c);this.writeByte(b);this.writeLength(a);if(a){this._ensure(a);this._buf.write(c,this._offset);this._offset+=a}};Writer.prototype.writeBuffer=function(b,a){if(typeof(a)!=="number"){throw new TypeError("tag must be a number")}if(!Buffer.isBuffer(b)){throw new TypeError("argument must be a buffer")}this.writeByte(a);this.writeLength(b.length);this._ensure(b.length);b.copy(this._buf,this._offset,0,b.length);this._offset+=b.length};Writer.prototype.writeStringArray=function(a){if((!a instanceof Array)){throw new TypeError("argument must be an Array[String]")}var b=this;a.forEach(function(c){b.writeString(c)})};Writer.prototype.writeOID=function(f,b){if(typeof(f)!=="string"){throw new TypeError("argument must be a string")}if(typeof(b)!=="number"){b=ASN1.OID}if(!/^([0-9]+\.){3,}[0-9]+$/.test(f)){throw new Error("argument is not a valid OID string")}function a(h,g){if(g<128){h.push(g)}else{if(g<16384){h.push((g>>>7)|128);h.push(g&127)}else{if(g<2097152){h.push((g>>>14)|128);h.push(((g>>>7)|128)&255);h.push(g&127)}else{if(g<268435456){h.push((g>>>21)|128);h.push(((g>>>14)|128)&255);h.push(((g>>>7)|128)&255);h.push(g&127)}else{h.push(((g>>>28)|128)&255);h.push(((g>>>21)|128)&255);h.push(((g>>>14)|128)&255);h.push(((g>>>7)|128)&255);h.push(g&127)}}}}}var e=f.split(".");var c=[];c.push(parseInt(e[0],10)*40+parseInt(e[1],10));e.slice(2).forEach(function(g){a(c,parseInt(g,10))});var d=this;this._ensure(2+c.length);this.writeByte(b);this.writeLength(c.length);c.forEach(function(g){d.writeByte(g)})};Writer.prototype.writeLength=function(a){if(typeof(a)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(4);if(a<=127){this._buf[this._offset++]=a}else{if(a<=255){this._buf[this._offset++]=129;this._buf[this._offset++]=a}else{if(a<=65535){this._buf[this._offset++]=130;this._buf[this._offset++]=a>>8;this._buf[this._offset++]=a}else{if(a<=16777215){this._buf[this._offset++]=131;this._buf[this._offset++]=a>>16;this._buf[this._offset++]=a>>8;this._buf[this._offset++]=a}else{throw new InvalidAsn1ERror("Length too long (> 4 bytes)")}}}}};Writer.prototype.startSequence=function(a){if(typeof(a)!=="number"){a=ASN1.Sequence|ASN1.Constructor}this.writeByte(a);this._seq.push(this._offset);this._ensure(3);this._offset+=3};Writer.prototype.endSequence=function(){var b=this._seq.pop();var c=b+3;var a=this._offset-c;if(a<=127){this._shift(c,a,-2);this._buf[b]=a}else{if(a<=255){this._shift(c,a,-1);this._buf[b]=129;this._buf[b+1]=a}else{if(a<=65535){this._buf[b]=130;this._buf[b+1]=a>>8;this._buf[b+2]=a}else{if(a<=16777215){this._shift(c,a,1);this._buf[b]=131;this._buf[b+1]=a>>16;this._buf[b+2]=a>>8;this._buf[b+3]=a}else{throw new InvalidAsn1Error("Sequence too long")}}}}};Writer.prototype._shift=function(c,a,b){assert.ok(c!==undefined);assert.ok(a!==undefined);assert.ok(b);this._buf.copy(this._buf,c+b,c,c+a);this._offset+=b};Writer.prototype._ensure=function(a){assert.ok(a);if(this._size-this._offset<a){var c=this._size*this._options.growthFactor;if(c-this._offset<a){c+=a}var b=new Buffer(c);this._buf.copy(b,0,0,this._offset);this._buf=b;this._size=c}};module.exports=Writer;