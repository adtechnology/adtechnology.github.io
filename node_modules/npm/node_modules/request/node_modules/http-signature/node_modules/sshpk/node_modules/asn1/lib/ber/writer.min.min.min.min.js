var assert=require("assert");var ASN1=require("./types");var errors=require("./errors");var newInvalidAsn1Error=errors.newInvalidAsn1Error;var DEFAULT_OPTS={size:1024,growthFactor:8};function merge(e,f){assert.ok(e);assert.equal(typeof(e),"object");assert.ok(f);assert.equal(typeof(f),"object");var d=Object.getOwnPropertyNames(e);d.forEach(function(b){if(f[b]){return}var a=Object.getOwnPropertyDescriptor(e,b);Object.defineProperty(f,b,a)});return f}function Writer(b){b=merge(DEFAULT_OPTS,b||{});this._buf=new Buffer(b.size||1024);this._size=this._buf.length;this._offset=0;this._options=b;this._seq=[]}Object.defineProperty(Writer.prototype,"buffer",{get:function(){if(this._seq.length){throw new InvalidAsn1Error(this._seq.length+" unended sequence(s)")}return(this._buf.slice(0,this._offset))}});Writer.prototype.writeByte=function(b){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(1);this._buf[this._offset++]=b};Writer.prototype.writeInt=function(f,d){if(typeof(f)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(d)!=="number"){d=ASN1.Integer}var e=4;while((((f&4286578688)===0)||((f&4286578688)===4286578688>>0))&&(e>1)){e--;f<<=8}if(e>4){throw new InvalidAsn1Error("BER ints cannot be > 0xffffffff")}this._ensure(2+e);this._buf[this._offset++]=d;this._buf[this._offset++]=e;while(e-->0){this._buf[this._offset++]=((f&4278190080)>>>24);f<<=8}};Writer.prototype.writeNull=function(){this.writeByte(ASN1.Null);this.writeByte(0)};Writer.prototype.writeEnumeration=function(c,d){if(typeof(c)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(d)!=="number"){d=ASN1.Enumeration}return this.writeInt(c,d)};Writer.prototype.writeBoolean=function(d,b){if(typeof(d)!=="boolean"){throw new TypeError("argument must be a Boolean")}if(typeof(b)!=="number"){b=ASN1.Boolean}this._ensure(3);this._buf[this._offset++]=b;this._buf[this._offset++]=1;this._buf[this._offset++]=d?255:0};Writer.prototype.writeString=function(e,f){if(typeof(e)!=="string"){throw new TypeError("argument must be a string (was: "+typeof(e)+")")}if(typeof(f)!=="number"){f=ASN1.OctetString}var d=Buffer.byteLength(e);this.writeByte(f);this.writeLength(d);if(d){this._ensure(d);this._buf.write(e,this._offset);this._offset+=d}};Writer.prototype.writeBuffer=function(c,d){if(typeof(d)!=="number"){throw new TypeError("tag must be a number")}if(!Buffer.isBuffer(c)){throw new TypeError("argument must be a buffer")}this.writeByte(d);this.writeLength(c.length);this._ensure(c.length);c.copy(this._buf,this._offset,0,c.length);this._offset+=c.length};Writer.prototype.writeStringArray=function(d){if((!d instanceof Array)){throw new TypeError("argument must be an Array[String]")}var c=this;d.forEach(function(a){c.writeString(a)})};Writer.prototype.writeOID=function(k,i){if(typeof(k)!=="string"){throw new TypeError("argument must be a string")}if(typeof(i)!=="number"){i=ASN1.OID}if(!/^([0-9]+\.){3,}[0-9]+$/.test(k)){throw new Error("argument is not a valid OID string")}function j(a,b){if(b<128){a.push(b)}else{if(b<16384){a.push((b>>>7)|128);a.push(b&127)}else{if(b<2097152){a.push((b>>>14)|128);a.push(((b>>>7)|128)&255);a.push(b&127)}else{if(b<268435456){a.push((b>>>21)|128);a.push(((b>>>14)|128)&255);a.push(((b>>>7)|128)&255);a.push(b&127)}else{a.push(((b>>>28)|128)&255);a.push(((b>>>21)|128)&255);a.push(((b>>>14)|128)&255);a.push(((b>>>7)|128)&255);a.push(b&127)}}}}}var l=k.split(".");var h=[];h.push(parseInt(l[0],10)*40+parseInt(l[1],10));l.slice(2).forEach(function(a){j(h,parseInt(a,10))});var g=this;this._ensure(2+h.length);this.writeByte(i);this.writeLength(h.length);h.forEach(function(a){g.writeByte(a)})};Writer.prototype.writeLength=function(b){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(4);if(b<=127){this._buf[this._offset++]=b}else{if(b<=255){this._buf[this._offset++]=129;this._buf[this._offset++]=b}else{if(b<=65535){this._buf[this._offset++]=130;this._buf[this._offset++]=b>>8;this._buf[this._offset++]=b}else{if(b<=16777215){this._buf[this._offset++]=131;this._buf[this._offset++]=b>>16;this._buf[this._offset++]=b>>8;this._buf[this._offset++]=b}else{throw new InvalidAsn1ERror("Length too long (> 4 bytes)")}}}}};Writer.prototype.startSequence=function(b){if(typeof(b)!=="number"){b=ASN1.Sequence|ASN1.Constructor}this.writeByte(b);this._seq.push(this._offset);this._ensure(3);this._offset+=3};Writer.prototype.endSequence=function(){var f=this._seq.pop();var e=f+3;var d=this._offset-e;if(d<=127){this._shift(e,d,-2);this._buf[f]=d}else{if(d<=255){this._shift(e,d,-1);this._buf[f]=129;this._buf[f+1]=d}else{if(d<=65535){this._buf[f]=130;this._buf[f+1]=d>>8;this._buf[f+2]=d}else{if(d<=16777215){this._shift(e,d,1);this._buf[f]=131;this._buf[f+1]=d>>16;this._buf[f+2]=d>>8;this._buf[f+3]=d}else{throw new InvalidAsn1Error("Sequence too long")}}}}};Writer.prototype._shift=function(e,d,f){assert.ok(e!==undefined);assert.ok(d!==undefined);assert.ok(f);this._buf.copy(this._buf,e+f,e,e+d);this._offset+=f};Writer.prototype._ensure=function(d){assert.ok(d);if(this._size-this._offset<d){var e=this._size*this._options.growthFactor;if(e-this._offset<d){e+=d}var f=new Buffer(e);this._buf.copy(f,0,0,this._offset);this._buf=f;this._size=e}};module.exports=Writer;