module.exports={read:read,verify:verify,sign:sign,signAsync:signAsync,write:write};var assert=require("assert-plus");var asn1=require("asn1");var algs=require("../algs");var utils=require("../utils");var Key=require("../key");var PrivateKey=require("../private-key");var pem=require("./pem");var Identity=require("../identity");var Signature=require("../signature");var Certificate=require("../certificate");var pkcs8=require("./pkcs8");function readMPInt(b,a){assert.strictEqual(b.peek(),asn1.Ber.Integer,a+" is not an Integer");return(utils.mpNormalize(b.readString(asn1.Ber.Integer,true)))}function verify(a,g){var d=a.signatures.x509;assert.object(d,"x509 signature");var b=d.algo.split("-");if(b[0]!==g.type){return(false)}var f=d.cache;if(f===undefined){var c=new asn1.BerWriter();writeTBSCert(a,c);f=c.buffer}var e=g.createVerify(b[1]);e.write(f);return(e.verify(d.signature))}function Local(a){return(asn1.Ber.Context|asn1.Ber.Constructor|a)}function Context(a){return(asn1.Ber.Context|a)}var SIGN_ALGS={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4","ed25519-sha512":"1.3.101.112"};Object.keys(SIGN_ALGS).forEach(function(a){SIGN_ALGS[SIGN_ALGS[a]]=a});SIGN_ALGS["1.3.14.3.2.3"]="rsa-md5";SIGN_ALGS["1.3.14.3.2.29"]="rsa-sha1";var EXTS={issuerKeyId:"2.5.29.35",altName:"2.5.29.17",basicConstraints:"2.5.29.19",keyUsage:"2.5.29.15",extKeyUsage:"2.5.29.37"};function read(m,b){if(typeof(m)==="string"){m=new Buffer(m,"binary")}assert.buffer(m,"buf");var i=new asn1.BerReader(m);i.readSequence();if(Math.abs(i.length-i.remain)>1){throw (new Error("DER sequence does not contain whole byte stream"))}var f=i.offset;i.readSequence();var a=i.offset+i.length;var c=a;if(i.peek()===Local(0)){i.readSequence(Local(0));var g=i.readInt();assert.ok(g<=3,"only x.509 versions up to v3 supported")}var d={};d.signatures={};var q=(d.signatures.x509={});q.extras={};d.serial=readMPInt(i,"serial");i.readSequence();var k=i.offset+i.length;var l=i.readOID();var h=SIGN_ALGS[l];if(h===undefined){throw (new Error("unknown signature algorithm "+l))}i._offset=k;d.issuer=Identity.parseAsn1(i);i.readSequence();d.validFrom=readDate(i);d.validUntil=readDate(i);d.subjects=[Identity.parseAsn1(i)];i.readSequence();k=i.offset+i.length;d.subjectKey=pkcs8.readPkcs8(undefined,"public",i);i._offset=k;if(i.peek()===Local(1)){i.readSequence(Local(1));q.extras.issuerUniqueID=m.slice(i.offset,i.offset+i.length);i._offset+=i.length}if(i.peek()===Local(2)){i.readSequence(Local(2));q.extras.subjectUniqueID=m.slice(i.offset,i.offset+i.length);i._offset+=i.length}if(i.peek()===Local(3)){i.readSequence(Local(3));var j=i.offset+i.length;i.readSequence();while(i.offset<j){readExtension(d,m,i)}assert.strictEqual(i.offset,j)}assert.strictEqual(i.offset,a);i.readSequence();k=i.offset+i.length;var e=i.readOID();var p=SIGN_ALGS[e];if(p===undefined){throw (new Error("unknown signature algorithm "+e))}i._offset=k;var o=i.readString(asn1.Ber.BitString,true);if(o[0]===0){o=o.slice(1)}var n=p.split("-");q.signature=Signature.parse(o,n[0],"asn1");q.signature.hashAlgorithm=n[1];q.algo=p;q.cache=m.slice(f,c);return(new Certificate(d))}function readDate(a){if(a.peek()===asn1.Ber.UTCTime){return(utcTimeToDate(a.readString(asn1.Ber.UTCTime)))}else{if(a.peek()===asn1.Ber.GeneralizedTime){return(gTimeToDate(a.readString(asn1.Ber.GeneralizedTime)))}else{throw (new Error("Unsupported date format"))}}}var ALTNAME={OtherName:Local(0),RFC822Name:Context(1),DNSName:Context(2),X400Address:Local(3),DirectoryName:Local(4),EDIPartyName:Local(5),URI:Context(6),IPAddress:Context(7),OID:Context(8)};var EXTPURPOSE={serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",joyentDocker:"1.3.6.1.4.1.38678.1.4.1",joyentCmon:"1.3.6.1.4.1.38678.1.4.2"};var EXTPURPOSE_REV={};Object.keys(EXTPURPOSE).forEach(function(a){EXTPURPOSE_REV[EXTPURPOSE[a]]=a});var KEYUSEBITS=["signature","identity","keyEncryption","encryption","keyAgreement","ca","crl"];function readExtension(m,k,l){l.readSequence();var h=l.offset+l.length;var d=l.readOID();var q;var f=m.signatures.x509;f.extras.exts=[];var a;if(l.peek()===asn1.Ber.Boolean){a=l.readBoolean()}switch(d){case (EXTS.basicConstraints):l.readSequence(asn1.Ber.OctetString);l.readSequence();var e=l.offset+l.length;var r=false;if(l.peek()===asn1.Ber.Boolean){r=l.readBoolean()}if(m.purposes===undefined){m.purposes=[]}if(r===true){m.purposes.push("ca")}var j={oid:d,critical:a};if(l.offset<e&&l.peek()===asn1.Ber.Integer){j.pathLen=l.readInt()}f.extras.exts.push(j);break;case (EXTS.extKeyUsage):l.readSequence(asn1.Ber.OctetString);l.readSequence();if(m.purposes===undefined){m.purposes=[]}var i=l.offset+l.length;while(l.offset<i){var b=l.readOID();m.purposes.push(EXTPURPOSE_REV[b]||b)}if(m.purposes.indexOf("serverAuth")!==-1&&m.purposes.indexOf("clientAuth")===-1){m.subjects.forEach(function(s){if(s.type!=="host"){s.type="host";s.hostname=s.uid||s.email||s.components[0].value}})}else{if(m.purposes.indexOf("clientAuth")!==-1&&m.purposes.indexOf("serverAuth")===-1){m.subjects.forEach(function(s){if(s.type!=="user"){s.type="user";s.uid=s.hostname||s.email||s.components[0].value}})}}f.extras.exts.push({oid:d,critical:a});break;case (EXTS.keyUsage):l.readSequence(asn1.Ber.OctetString);var g=l.readString(asn1.Ber.BitString,true);var n=readBitField(g,KEYUSEBITS);n.forEach(function(s){if(m.purposes===undefined){m.purposes=[]}if(m.purposes.indexOf(s)===-1){m.purposes.push(s)}});f.extras.exts.push({oid:d,critical:a,bits:g});break;case (EXTS.altName):l.readSequence(asn1.Ber.OctetString);l.readSequence();var o=l.offset+l.length;while(l.offset<o){switch(l.peek()){case ALTNAME.OtherName:case ALTNAME.EDIPartyName:l.readSequence();l._offset+=l.length;break;case ALTNAME.OID:l.readOID(ALTNAME.OID);break;case ALTNAME.RFC822Name:var c=l.readString(ALTNAME.RFC822Name);q=Identity.forEmail(c);if(!m.subjects[0].equals(q)){m.subjects.push(q)}break;case ALTNAME.DirectoryName:l.readSequence(ALTNAME.DirectoryName);q=Identity.parseAsn1(l);if(!m.subjects[0].equals(q)){m.subjects.push(q)}break;case ALTNAME.DNSName:var p=l.readString(ALTNAME.DNSName);q=Identity.forHost(p);if(!m.subjects[0].equals(q)){m.subjects.push(q)}break;default:l.readString(l.peek());break}}f.extras.exts.push({oid:d,critical:a});break;default:f.extras.exts.push({oid:d,critical:a,data:l.readString(asn1.Ber.OctetString,true)});break}l._offset=h}var UTCTIME_RE=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function utcTimeToDate(a){var f=a.match(UTCTIME_RE);assert.ok(f,"timestamps must be in UTC");var c=new Date();var g=c.getUTCFullYear();var e=Math.floor(g/100)*100;var b=parseInt(f[1],10);if(g%100<50&&b>=60){b+=(e-1)}else{b+=e}c.setUTCFullYear(b,parseInt(f[2],10)-1,parseInt(f[3],10));c.setUTCHours(parseInt(f[4],10),parseInt(f[5],10));if(f[6]&&f[6].length>0){c.setUTCSeconds(parseInt(f[6],10))}return(c)}var GTIME_RE=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function gTimeToDate(c){var b=c.match(GTIME_RE);assert.ok(b);var a=new Date();a.setUTCFullYear(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10));a.setUTCHours(parseInt(b[4],10),parseInt(b[5],10));if(b[6]&&b[6].length>0){a.setUTCSeconds(parseInt(b[6],10))}return(a)}function zeroPad(b){var a=""+b;while(a.length<2){a="0"+a}return(a)}function dateToUTCTime(b){var a="";a+=zeroPad(b.getUTCFullYear()%100);a+=zeroPad(b.getUTCMonth()+1);a+=zeroPad(b.getUTCDate());a+=zeroPad(b.getUTCHours());a+=zeroPad(b.getUTCMinutes());a+=zeroPad(b.getUTCSeconds());a+="Z";return(a)}function sign(a,f){if(a.signatures.x509===undefined){a.signatures.x509={}}var d=a.signatures.x509;d.algo=f.type+"-"+f.defaultHashAlgorithm();if(SIGN_ALGS[d.algo]===undefined){return(false)}var b=new asn1.BerWriter();writeTBSCert(a,b);var e=b.buffer;d.cache=e;var c=f.createSign();c.write(e);a.signatures.x509.signature=c.sign();return(true)}function signAsync(a,d,e){if(a.signatures.x509===undefined){a.signatures.x509={}}var c=a.signatures.x509;var b=new asn1.BerWriter();writeTBSCert(a,b);var f=b.buffer;c.cache=f;d(f,function(h,g){if(h){e(h);return}c.algo=g.type+"-"+g.hashAlgorithm;if(SIGN_ALGS[c.algo]===undefined){e(new Error('Invalid signing algorithm "'+c.algo+'"'));return}c.signature=g;e()})}function write(f,e){var d=f.signatures.x509;assert.object(d,"x509 signature");var a=new asn1.BerWriter();a.startSequence();if(d.cache){a._ensure(d.cache.length);d.cache.copy(a._buf,a._offset);a._offset+=d.cache.length}else{writeTBSCert(f,a)}a.startSequence();a.writeOID(SIGN_ALGS[d.algo]);if(d.algo.match(/^rsa-/)){a.writeNull()}a.endSequence();var c=d.signature.toBuffer("asn1");var b=new Buffer(c.length+1);b[0]=0;c.copy(b,1);a.writeBuffer(b,asn1.Ber.BitString);a.endSequence();return(a.buffer)}function writeTBSCert(a,c){var g=a.signatures.x509;assert.object(g,"x509 signature");c.startSequence();c.startSequence(Local(0));c.writeInt(2);c.endSequence();c.writeBuffer(utils.mpNormalize(a.serial),asn1.Ber.Integer);c.startSequence();c.writeOID(SIGN_ALGS[g.algo]);if(g.algo.match(/^rsa-/)){c.writeNull()}c.endSequence();a.issuer.toAsn1(c);c.startSequence();c.writeString(dateToUTCTime(a.validFrom),asn1.Ber.UTCTime);c.writeString(dateToUTCTime(a.validUntil),asn1.Ber.UTCTime);c.endSequence();var d=a.subjects[0];var h=a.subjects.slice(1);d.toAsn1(c);pkcs8.writePkcs8(c,a.subjectKey);if(g.extras&&g.extras.issuerUniqueID){c.writeBuffer(g.extras.issuerUniqueID,Local(1))}if(g.extras&&g.extras.subjectUniqueID){c.writeBuffer(g.extras.subjectUniqueID,Local(2))}if(h.length>0||d.type==="host"||(a.purposes!==undefined&&a.purposes.length>0)||(g.extras&&g.extras.exts)){c.startSequence(Local(3));c.startSequence();var l=[];if(a.purposes!==undefined&&a.purposes.length>0){l.push({oid:EXTS.basicConstraints,critical:true});l.push({oid:EXTS.keyUsage,critical:true});l.push({oid:EXTS.extKeyUsage,critical:true})}l.push({oid:EXTS.altName});if(g.extras&&g.extras.exts){l=g.extras.exts}for(var b=0;b<l.length;++b){c.startSequence();c.writeOID(l[b].oid);if(l[b].critical!==undefined){c.writeBoolean(l[b].critical)}if(l[b].oid===EXTS.altName){c.startSequence(asn1.Ber.OctetString);c.startSequence();if(d.type==="host"){c.writeString(d.hostname,Context(2))}for(var m=0;m<h.length;++m){if(h[m].type==="host"){c.writeString(h[m].hostname,ALTNAME.DNSName)}else{if(h[m].type==="email"){c.writeString(h[m].email,ALTNAME.RFC822Name)}else{c.startSequence(ALTNAME.DirectoryName);h[m].toAsn1(c);c.endSequence()}}}c.endSequence();c.endSequence()}else{if(l[b].oid===EXTS.basicConstraints){c.startSequence(asn1.Ber.OctetString);c.startSequence();var k=(a.purposes.indexOf("ca")!==-1);var e=l[b].pathLen;c.writeBoolean(k);if(e!==undefined){c.writeInt(e)}c.endSequence();c.endSequence()}else{if(l[b].oid===EXTS.extKeyUsage){c.startSequence(asn1.Ber.OctetString);c.startSequence();a.purposes.forEach(function(i){if(i==="ca"){return}if(KEYUSEBITS.indexOf(i)!==-1){return}var j=i;if(EXTPURPOSE[i]!==undefined){j=EXTPURPOSE[i]}c.writeOID(j)});c.endSequence();c.endSequence()}else{if(l[b].oid===EXTS.keyUsage){c.startSequence(asn1.Ber.OctetString);if(l[b].bits!==undefined){c.writeBuffer(l[b].bits,asn1.Ber.BitString)}else{var f=writeBitField(a.purposes,KEYUSEBITS);c.writeBuffer(f,asn1.Ber.BitString)}c.endSequence()}else{c.writeBuffer(l[b].data,asn1.Ber.OctetString)}}}}c.endSequence()}c.endSequence();c.endSequence()}c.endSequence()}function readBitField(f,a){var k=8*(f.length-1)-f[0];var c={};for(var b=0;b<k;++b){var d=1+Math.floor(b/8);var e=7-(b%8);var h=1<<e;var g=((f[d]&h)!==0);var j=a[b];if(g&&typeof(j)==="string"){c[j]=true}}return(Object.keys(c))}function writeBitField(m,j){var h=j.length;var f=Math.ceil(h/8);var k=f*8-h;var c=new Buffer(1+f);c.fill(0);c[0]=k;for(var l=0;l<h;++l){var a=1+Math.floor(l/8);var b=7-(l%8);var e=1<<b;var g=j[l];if(g===undefined){continue}var d=(m.indexOf(g)!==-1);if(d){c[a]|=e}}return(c)};