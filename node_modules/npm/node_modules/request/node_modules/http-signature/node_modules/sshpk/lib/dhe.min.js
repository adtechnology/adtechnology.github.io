module.exports={DiffieHellman:DiffieHellman,generateECDSA:generateECDSA,generateED25519:generateED25519};var assert=require("assert-plus");var crypto=require("crypto");var algs=require("./algs");var utils=require("./utils");var nacl;var Key=require("./key");var PrivateKey=require("./private-key");var CRYPTO_HAVE_ECDH=(crypto.createECDH!==undefined);var ecdh,ec,jsbn;function DiffieHellman(a){utils.assertCompatible(a,Key,[1,4],"key");this._isPriv=PrivateKey.isPrivateKey(a,[1,3]);this._algo=a.type;this._curve=a.curve;this._key=a;if(a.type==="dsa"){if(!CRYPTO_HAVE_ECDH){throw (new Error("Due to bugs in the node 0.10 crypto API, node 0.12.x or later is required to use DH"))}this._dh=crypto.createDiffieHellman(a.part.p.data,undefined,a.part.g.data,undefined);this._p=a.part.p;this._g=a.part.g;if(this._isPriv){this._dh.setPrivateKey(a.part.x.data)}this._dh.setPublicKey(a.part.y.data)}else{if(a.type==="ecdsa"){if(!CRYPTO_HAVE_ECDH){if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}this._ecParams=new X9ECParameters(this._curve);if(this._isPriv){this._priv=new ECPrivate(this._ecParams,a.part.d.data)}return}var b={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[a.curve];this._dh=crypto.createECDH(b);if(typeof(this._dh)!=="object"||typeof(this._dh.setPrivateKey)!=="function"){CRYPTO_HAVE_ECDH=false;DiffieHellman.call(this,a);return}if(this._isPriv){this._dh.setPrivateKey(a.part.d.data)}this._dh.setPublicKey(a.part.Q.data)}else{if(a.type==="curve25519"){if(nacl===undefined){nacl=require("tweetnacl")}if(this._isPriv){utils.assertCompatible(a,PrivateKey,[1,5],"key");this._priv=a.part.k.data}}else{throw (new Error("DH not supported for "+a.type+" keys"))}}}}DiffieHellman.prototype.getPublicKey=function(){if(this._isPriv){return(this._key.toPublic())}return(this._key)};DiffieHellman.prototype.getPrivateKey=function(){if(this._isPriv){return(this._key)}else{return(undefined)}};DiffieHellman.prototype.getKey=DiffieHellman.prototype.getPrivateKey;DiffieHellman.prototype._keyCheck=function(b,a){assert.object(b,"key");if(!a){utils.assertCompatible(b,PrivateKey,[1,3],"key")}utils.assertCompatible(b,Key,[1,4],"key");if(b.type!==this._algo){throw (new Error("A "+b.type+" key cannot be used in "+this._algo+" Diffie-Hellman"))}if(b.curve!==this._curve){throw (new Error("A key from the "+b.curve+" curve cannot be used with a "+this._curve+" Diffie-Hellman"))}if(b.type==="dsa"){assert.deepEqual(b.part.p,this._p,"DSA key prime does not match");assert.deepEqual(b.part.g,this._g,"DSA key generator does not match")}};DiffieHellman.prototype.setKey=function(b){this._keyCheck(b);if(b.type==="dsa"){this._dh.setPrivateKey(b.part.x.data);this._dh.setPublicKey(b.part.y.data)}else{if(b.type==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.setPrivateKey(b.part.d.data);this._dh.setPublicKey(b.part.Q.data)}else{this._priv=new ECPrivate(this._ecParams,b.part.d.data)}}else{if(b.type==="curve25519"){var a=b.part.k;if(!b.part.k){a=b.part.r}this._priv=a.data;if(this._priv[0]===0){this._priv=this._priv.slice(1)}this._priv=this._priv.slice(0,32)}}}this._key=b;this._isPriv=true};DiffieHellman.prototype.setPrivateKey=DiffieHellman.prototype.setKey;DiffieHellman.prototype.computeSecret=function(c){this._keyCheck(c,true);if(!this._isPriv){throw (new Error("DH exchange has not been initialized with a private key yet"))}var d;if(this._algo==="dsa"){return(this._dh.computeSecret(c.part.y.data))}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){return(this._dh.computeSecret(c.part.Q.data))}else{d=new ECPublic(this._ecParams,c.part.Q.data);return(this._priv.deriveSharedSecret(d))}}else{if(this._algo==="curve25519"){d=c.part.A.data;while(d[0]===0&&d.length>32){d=d.slice(1)}var b=this._priv;assert.strictEqual(d.length,32);assert.strictEqual(b.length,32);var a=nacl.box.before(new Uint8Array(d),new Uint8Array(b));return(new Buffer(a))}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKey=function(){var e=[];var a,d;if(this._algo==="dsa"){this._dh.generateKeys();e.push({name:"p",data:this._p.data});e.push({name:"q",data:this._key.part.q.data});e.push({name:"g",data:this._g.data});e.push({name:"y",data:this._dh.getPublicKey()});e.push({name:"x",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"dsa",parts:e});this._isPriv=true;return(this._key)}else{if(this._algo==="ecdsa"){if(CRYPTO_HAVE_ECDH){this._dh.generateKeys();e.push({name:"curve",data:new Buffer(this._curve)});e.push({name:"Q",data:this._dh.getPublicKey()});e.push({name:"d",data:this._dh.getPrivateKey()});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:e});this._isPriv=true;return(this._key)}else{var g=this._ecParams.getN();var c=new jsbn(crypto.randomBytes(g.bitLength()));var b=g.subtract(jsbn.ONE);a=c.mod(b).add(jsbn.ONE);d=this._ecParams.getG().multiply(a);a=new Buffer(a.toByteArray());d=new Buffer(this._ecParams.getCurve().encodePointHex(d),"hex");this._priv=new ECPrivate(this._ecParams,a);e.push({name:"curve",data:new Buffer(this._curve)});e.push({name:"Q",data:d});e.push({name:"d",data:a});this._key=new PrivateKey({type:"ecdsa",curve:this._curve,parts:e});this._isPriv=true;return(this._key)}}else{if(this._algo==="curve25519"){var f=nacl.box.keyPair();a=new Buffer(f.secretKey);d=new Buffer(f.publicKey);a=Buffer.concat([a,d]);assert.strictEqual(a.length,64);assert.strictEqual(d.length,32);e.push({name:"A",data:d});e.push({name:"k",data:a});this._key=new PrivateKey({type:"curve25519",parts:e});this._isPriv=true;return(this._key)}}}throw (new Error("Invalid algorithm: "+this._algo))};DiffieHellman.prototype.generateKeys=DiffieHellman.prototype.generateKey;function X9ECParameters(c){var g=algs.curves[c];assert.object(g);var d=new jsbn(g.p);var k=new jsbn(g.a);var j=new jsbn(g.b);var e=new jsbn(g.n);var i=jsbn.ONE;var f=new ec.ECCurveFp(d,k,j);var l=f.decodePointHex(g.G.toString("hex"));this.curve=f;this.g=l;this.n=e;this.h=i}X9ECParameters.prototype.getCurve=function(){return(this.curve)};X9ECParameters.prototype.getG=function(){return(this.g)};X9ECParameters.prototype.getN=function(){return(this.n)};X9ECParameters.prototype.getH=function(){return(this.h)};function ECPublic(b,a){this._params=b;if(a[0]===0){a=a.slice(1)}this._pub=b.getCurve().decodePointHex(a.toString("hex"))}function ECPrivate(b,a){this._params=b;this._priv=new jsbn(utils.mpNormalize(a))}ECPrivate.prototype.deriveSharedSecret=function(a){assert.ok(a instanceof ECPublic);var b=a._pub.multiply(this._priv);return(new Buffer(b.getX().toBigInteger().toByteArray()))};function generateED25519(){if(nacl===undefined){nacl=require("tweetnacl")}var e=nacl.sign.keyPair();var a=new Buffer(e.secretKey);var c=new Buffer(e.publicKey);assert.strictEqual(a.length,64);assert.strictEqual(c.length,32);var d=[];d.push({name:"A",data:c});d.push({name:"k",data:a.slice(0,32)});var b=new PrivateKey({type:"ed25519",parts:d});return(b)}function generateECDSA(b){var e=[];var k;if(CRYPTO_HAVE_ECDH){var g={nistp256:"prime256v1",nistp384:"secp384r1",nistp521:"secp521r1"}[b];var j=crypto.createECDH(g);j.generateKeys();e.push({name:"curve",data:new Buffer(b)});e.push({name:"Q",data:j.getPublicKey()});e.push({name:"d",data:j.getPrivateKey()});k=new PrivateKey({type:"ecdsa",curve:b,parts:e});return(k)}else{if(ecdh===undefined){ecdh=require("ecc-jsbn")}if(ec===undefined){ec=require("ecc-jsbn/lib/ec")}if(jsbn===undefined){jsbn=require("jsbn").BigInteger}var m=new X9ECParameters(b);var a=m.getN();var f=Math.ceil((a.bitLength()+64)/8);var i=new jsbn(crypto.randomBytes(f));var h=a.subtract(jsbn.ONE);var l=i.mod(h).add(jsbn.ONE);var d=m.getG().multiply(l);l=new Buffer(l.toByteArray());d=new Buffer(m.getCurve().encodePointHex(d),"hex");e.push({name:"curve",data:new Buffer(b)});e.push({name:"Q",data:d});e.push({name:"d",data:l});k=new PrivateKey({type:"ecdsa",curve:b,parts:e});return(k)}};