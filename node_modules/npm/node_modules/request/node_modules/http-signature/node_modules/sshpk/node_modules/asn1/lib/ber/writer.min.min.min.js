var assert=require("assert");var ASN1=require("./types");var errors=require("./errors");var newInvalidAsn1Error=errors.newInvalidAsn1Error;var DEFAULT_OPTS={size:1024,growthFactor:8};function merge(a,c){assert.ok(a);assert.equal(typeof(a),"object");assert.ok(c);assert.equal(typeof(c),"object");var b=Object.getOwnPropertyNames(a);b.forEach(function(d){if(c[d]){return}var e=Object.getOwnPropertyDescriptor(a,d);Object.defineProperty(c,d,e)});return c}function Writer(a){a=merge(DEFAULT_OPTS,a||{});this._buf=new Buffer(a.size||1024);this._size=this._buf.length;this._offset=0;this._options=a;this._seq=[]}Object.defineProperty(Writer.prototype,"buffer",{get:function(){if(this._seq.length){throw new InvalidAsn1Error(this._seq.length+" unended sequence(s)")}return(this._buf.slice(0,this._offset))}});Writer.prototype.writeByte=function(a){if(typeof(a)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(1);this._buf[this._offset++]=a};Writer.prototype.writeInt=function(c,b){if(typeof(c)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(b)!=="number"){b=ASN1.Integer}var a=4;while((((c&4286578688)===0)||((c&4286578688)===4286578688>>0))&&(a>1)){a--;c<<=8}if(a>4){throw new InvalidAsn1Error("BER ints cannot be > 0xffffffff")}this._ensure(2+a);this._buf[this._offset++]=b;this._buf[this._offset++]=a;while(a-->0){this._buf[this._offset++]=((c&4278190080)>>>24);c<<=8}};Writer.prototype.writeNull=function(){this.writeByte(ASN1.Null);this.writeByte(0)};Writer.prototype.writeEnumeration=function(b,a){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(a)!=="number"){a=ASN1.Enumeration}return this.writeInt(b,a)};Writer.prototype.writeBoolean=function(c,a){if(typeof(c)!=="boolean"){throw new TypeError("argument must be a Boolean")}if(typeof(a)!=="number"){a=ASN1.Boolean}this._ensure(3);this._buf[this._offset++]=a;this._buf[this._offset++]=1;this._buf[this._offset++]=c?255:0};Writer.prototype.writeString=function(a,c){if(typeof(a)!=="string"){throw new TypeError("argument must be a string (was: "+typeof(a)+")")}if(typeof(c)!=="number"){c=ASN1.OctetString}var b=Buffer.byteLength(a);this.writeByte(c);this.writeLength(b);if(b){this._ensure(b);this._buf.write(a,this._offset);this._offset+=b}};Writer.prototype.writeBuffer=function(b,a){if(typeof(a)!=="number"){throw new TypeError("tag must be a number")}if(!Buffer.isBuffer(b)){throw new TypeError("argument must be a buffer")}this.writeByte(a);this.writeLength(b.length);this._ensure(b.length);b.copy(this._buf,this._offset,0,b.length);this._offset+=b.length};Writer.prototype.writeStringArray=function(a){if((!a instanceof Array)){throw new TypeError("argument must be an Array[String]")}var b=this;a.forEach(function(c){b.writeString(c)})};Writer.prototype.writeOID=function(d,f){if(typeof(d)!=="string"){throw new TypeError("argument must be a string")}if(typeof(f)!=="number"){f=ASN1.OID}if(!/^([0-9]+\.){3,}[0-9]+$/.test(d)){throw new Error("argument is not a valid OID string")}function e(h,g){if(g<128){h.push(g)}else{if(g<16384){h.push((g>>>7)|128);h.push(g&127)}else{if(g<2097152){h.push((g>>>14)|128);h.push(((g>>>7)|128)&255);h.push(g&127)}else{if(g<268435456){h.push((g>>>21)|128);h.push(((g>>>14)|128)&255);h.push(((g>>>7)|128)&255);h.push(g&127)}else{h.push(((g>>>28)|128)&255);h.push(((g>>>21)|128)&255);h.push(((g>>>14)|128)&255);h.push(((g>>>7)|128)&255);h.push(g&127)}}}}}var c=d.split(".");var a=[];a.push(parseInt(c[0],10)*40+parseInt(c[1],10));c.slice(2).forEach(function(g){e(a,parseInt(g,10))});var b=this;this._ensure(2+a.length);this.writeByte(f);this.writeLength(a.length);a.forEach(function(g){b.writeByte(g)})};Writer.prototype.writeLength=function(a){if(typeof(a)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(4);if(a<=127){this._buf[this._offset++]=a}else{if(a<=255){this._buf[this._offset++]=129;this._buf[this._offset++]=a}else{if(a<=65535){this._buf[this._offset++]=130;this._buf[this._offset++]=a>>8;this._buf[this._offset++]=a}else{if(a<=16777215){this._buf[this._offset++]=131;this._buf[this._offset++]=a>>16;this._buf[this._offset++]=a>>8;this._buf[this._offset++]=a}else{throw new InvalidAsn1ERror("Length too long (> 4 bytes)")}}}}};Writer.prototype.startSequence=function(a){if(typeof(a)!=="number"){a=ASN1.Sequence|ASN1.Constructor}this.writeByte(a);this._seq.push(this._offset);this._ensure(3);this._offset+=3};Writer.prototype.endSequence=function(){var c=this._seq.pop();var a=c+3;var b=this._offset-a;if(b<=127){this._shift(a,b,-2);this._buf[c]=b}else{if(b<=255){this._shift(a,b,-1);this._buf[c]=129;this._buf[c+1]=b}else{if(b<=65535){this._buf[c]=130;this._buf[c+1]=b>>8;this._buf[c+2]=b}else{if(b<=16777215){this._shift(a,b,1);this._buf[c]=131;this._buf[c+1]=b>>16;this._buf[c+2]=b>>8;this._buf[c+3]=b}else{throw new InvalidAsn1Error("Sequence too long")}}}}};Writer.prototype._shift=function(a,b,c){assert.ok(a!==undefined);assert.ok(b!==undefined);assert.ok(c);this._buf.copy(this._buf,a+c,a,a+b);this._offset+=c};Writer.prototype._ensure=function(b){assert.ok(b);if(this._size-this._offset<b){var a=this._size*this._options.growthFactor;if(a-this._offset<b){a+=b}var c=new Buffer(a);this._buf.copy(c,0,0,this._offset);this._buf=c;this._size=a}};module.exports=Writer;