var assert=require("assert");var ASN1=require("./types");var errors=require("./errors");var newInvalidAsn1Error=errors.newInvalidAsn1Error;var DEFAULT_OPTS={size:1024,growthFactor:8};function merge(f,d){assert.ok(f);assert.equal(typeof(f),"object");assert.ok(d);assert.equal(typeof(d),"object");var e=Object.getOwnPropertyNames(f);e.forEach(function(b){if(d[b]){return}var a=Object.getOwnPropertyDescriptor(f,b);Object.defineProperty(d,b,a)});return d}function Writer(b){b=merge(DEFAULT_OPTS,b||{});this._buf=new Buffer(b.size||1024);this._size=this._buf.length;this._offset=0;this._options=b;this._seq=[]}Object.defineProperty(Writer.prototype,"buffer",{get:function(){if(this._seq.length){throw new InvalidAsn1Error(this._seq.length+" unended sequence(s)")}return(this._buf.slice(0,this._offset))}});Writer.prototype.writeByte=function(b){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(1);this._buf[this._offset++]=b};Writer.prototype.writeInt=function(d,e){if(typeof(d)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(e)!=="number"){e=ASN1.Integer}var f=4;while((((d&4286578688)===0)||((d&4286578688)===4286578688>>0))&&(f>1)){f--;d<<=8}if(f>4){throw new InvalidAsn1Error("BER ints cannot be > 0xffffffff")}this._ensure(2+f);this._buf[this._offset++]=e;this._buf[this._offset++]=f;while(f-->0){this._buf[this._offset++]=((d&4278190080)>>>24);d<<=8}};Writer.prototype.writeNull=function(){this.writeByte(ASN1.Null);this.writeByte(0)};Writer.prototype.writeEnumeration=function(c,d){if(typeof(c)!=="number"){throw new TypeError("argument must be a Number")}if(typeof(d)!=="number"){d=ASN1.Enumeration}return this.writeInt(c,d)};Writer.prototype.writeBoolean=function(d,b){if(typeof(d)!=="boolean"){throw new TypeError("argument must be a Boolean")}if(typeof(b)!=="number"){b=ASN1.Boolean}this._ensure(3);this._buf[this._offset++]=b;this._buf[this._offset++]=1;this._buf[this._offset++]=d?255:0};Writer.prototype.writeString=function(f,d){if(typeof(f)!=="string"){throw new TypeError("argument must be a string (was: "+typeof(f)+")")}if(typeof(d)!=="number"){d=ASN1.OctetString}var e=Buffer.byteLength(f);this.writeByte(d);this.writeLength(e);if(e){this._ensure(e);this._buf.write(f,this._offset);this._offset+=e}};Writer.prototype.writeBuffer=function(c,d){if(typeof(d)!=="number"){throw new TypeError("tag must be a number")}if(!Buffer.isBuffer(c)){throw new TypeError("argument must be a buffer")}this.writeByte(d);this.writeLength(c.length);this._ensure(c.length);c.copy(this._buf,this._offset,0,c.length);this._offset+=c.length};Writer.prototype.writeStringArray=function(d){if((!d instanceof Array)){throw new TypeError("argument must be an Array[String]")}var c=this;d.forEach(function(a){c.writeString(a)})};Writer.prototype.writeOID=function(i,g){if(typeof(i)!=="string"){throw new TypeError("argument must be a string")}if(typeof(g)!=="number"){g=ASN1.OID}if(!/^([0-9]+\.){3,}[0-9]+$/.test(i)){throw new Error("argument is not a valid OID string")}function h(a,b){if(b<128){a.push(b)}else{if(b<16384){a.push((b>>>7)|128);a.push(b&127)}else{if(b<2097152){a.push((b>>>14)|128);a.push(((b>>>7)|128)&255);a.push(b&127)}else{if(b<268435456){a.push((b>>>21)|128);a.push(((b>>>14)|128)&255);a.push(((b>>>7)|128)&255);a.push(b&127)}else{a.push(((b>>>28)|128)&255);a.push(((b>>>21)|128)&255);a.push(((b>>>14)|128)&255);a.push(((b>>>7)|128)&255);a.push(b&127)}}}}}var j=i.split(".");var l=[];l.push(parseInt(j[0],10)*40+parseInt(j[1],10));j.slice(2).forEach(function(a){h(l,parseInt(a,10))});var k=this;this._ensure(2+l.length);this.writeByte(g);this.writeLength(l.length);l.forEach(function(a){k.writeByte(a)})};Writer.prototype.writeLength=function(b){if(typeof(b)!=="number"){throw new TypeError("argument must be a Number")}this._ensure(4);if(b<=127){this._buf[this._offset++]=b}else{if(b<=255){this._buf[this._offset++]=129;this._buf[this._offset++]=b}else{if(b<=65535){this._buf[this._offset++]=130;this._buf[this._offset++]=b>>8;this._buf[this._offset++]=b}else{if(b<=16777215){this._buf[this._offset++]=131;this._buf[this._offset++]=b>>16;this._buf[this._offset++]=b>>8;this._buf[this._offset++]=b}else{throw new InvalidAsn1ERror("Length too long (> 4 bytes)")}}}}};Writer.prototype.startSequence=function(b){if(typeof(b)!=="number"){b=ASN1.Sequence|ASN1.Constructor}this.writeByte(b);this._seq.push(this._offset);this._ensure(3);this._offset+=3};Writer.prototype.endSequence=function(){var d=this._seq.pop();var f=d+3;var e=this._offset-f;if(e<=127){this._shift(f,e,-2);this._buf[d]=e}else{if(e<=255){this._shift(f,e,-1);this._buf[d]=129;this._buf[d+1]=e}else{if(e<=65535){this._buf[d]=130;this._buf[d+1]=e>>8;this._buf[d+2]=e}else{if(e<=16777215){this._shift(f,e,1);this._buf[d]=131;this._buf[d+1]=e>>16;this._buf[d+2]=e>>8;this._buf[d+3]=e}else{throw new InvalidAsn1Error("Sequence too long")}}}}};Writer.prototype._shift=function(f,e,d){assert.ok(f!==undefined);assert.ok(e!==undefined);assert.ok(d);this._buf.copy(this._buf,f+d,f,f+e);this._offset+=d};Writer.prototype._ensure=function(e){assert.ok(e);if(this._size-this._offset<e){var f=this._size*this._options.growthFactor;if(f-this._offset<e){f+=e}var d=new Buffer(f);this._buf.copy(d,0,0,this._offset);this._buf=d;this._size=f}};module.exports=Writer;