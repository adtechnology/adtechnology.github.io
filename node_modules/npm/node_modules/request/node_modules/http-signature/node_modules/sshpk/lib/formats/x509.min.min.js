module.exports={read:read,verify:verify,sign:sign,signAsync:signAsync,write:write};var assert=require("assert-plus");var asn1=require("asn1");var algs=require("../algs");var utils=require("../utils");var Key=require("../key");var PrivateKey=require("../private-key");var pem=require("./pem");var Identity=require("../identity");var Signature=require("../signature");var Certificate=require("../certificate");var pkcs8=require("./pkcs8");function readMPInt(c,d){assert.strictEqual(c.peek(),asn1.Ber.Integer,d+" is not an Integer");return(utils.mpNormalize(c.readString(asn1.Ber.Integer,true)))}function verify(m,n){var j=m.signatures.x509;assert.object(j,"x509 signature");var l=j.algo.split("-");if(l[0]!==n.type){return(false)}var h=j.cache;if(h===undefined){var k=new asn1.BerWriter();writeTBSCert(m,k);h=k.buffer}var i=n.createVerify(l[1]);i.write(h);return(i.verify(j.signature))}function Local(b){return(asn1.Ber.Context|asn1.Ber.Constructor|b)}function Context(b){return(asn1.Ber.Context|b)}var SIGN_ALGS={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4","ed25519-sha512":"1.3.101.112"};Object.keys(SIGN_ALGS).forEach(function(b){SIGN_ALGS[SIGN_ALGS[b]]=b});SIGN_ALGS["1.3.14.3.2.3"]="rsa-md5";SIGN_ALGS["1.3.14.3.2.29"]="rsa-sha1";var EXTS={issuerKeyId:"2.5.29.35",altName:"2.5.29.17",basicConstraints:"2.5.29.19",keyUsage:"2.5.29.15",extKeyUsage:"2.5.29.37"};function read(G,r){if(typeof(G)==="string"){G=new Buffer(G,"binary")}assert.buffer(G,"buf");var w=new asn1.BerReader(G);w.readSequence();if(Math.abs(w.length-w.remain)>1){throw (new Error("DER sequence does not contain whole byte stream"))}var z=w.offset;w.readSequence();var D=w.offset+w.length;var C=D;if(w.peek()===Local(0)){w.readSequence(Local(0));var y=w.readInt();assert.ok(y<=3,"only x.509 versions up to v3 supported")}var B={};B.signatures={};var s=(B.signatures.x509={});s.extras={};B.serial=readMPInt(w,"serial");w.readSequence();var H=w.offset+w.length;var u=w.readOID();var x=SIGN_ALGS[u];if(x===undefined){throw (new Error("unknown signature algorithm "+u))}w._offset=H;B.issuer=Identity.parseAsn1(w);w.readSequence();B.validFrom=readDate(w);B.validUntil=readDate(w);B.subjects=[Identity.parseAsn1(w)];w.readSequence();H=w.offset+w.length;B.subjectKey=pkcs8.readPkcs8(undefined,"public",w);w._offset=H;if(w.peek()===Local(1)){w.readSequence(Local(1));s.extras.issuerUniqueID=G.slice(w.offset,w.offset+w.length);w._offset+=w.length}if(w.peek()===Local(2)){w.readSequence(Local(2));s.extras.subjectUniqueID=G.slice(w.offset,w.offset+w.length);w._offset+=w.length}if(w.peek()===Local(3)){w.readSequence(Local(3));var v=w.offset+w.length;w.readSequence();while(w.offset<v){readExtension(B,G,w)}assert.strictEqual(w.offset,v)}assert.strictEqual(w.offset,D);w.readSequence();H=w.offset+w.length;var A=w.readOID();var E=SIGN_ALGS[A];if(E===undefined){throw (new Error("unknown signature algorithm "+A))}w._offset=H;var F=w.readString(asn1.Ber.BitString,true);if(F[0]===0){F=F.slice(1)}var t=E.split("-");s.signature=Signature.parse(F,t[0],"asn1");s.signature.hashAlgorithm=t[1];s.algo=E;s.cache=G.slice(z,C);return(new Certificate(B))}function readDate(b){if(b.peek()===asn1.Ber.UTCTime){return(utcTimeToDate(b.readString(asn1.Ber.UTCTime)))}else{if(b.peek()===asn1.Ber.GeneralizedTime){return(gTimeToDate(b.readString(asn1.Ber.GeneralizedTime)))}else{throw (new Error("Unsupported date format"))}}}var ALTNAME={OtherName:Local(0),RFC822Name:Context(1),DNSName:Context(2),X400Address:Local(3),DirectoryName:Local(4),EDIPartyName:Local(5),URI:Context(6),IPAddress:Context(7),OID:Context(8)};var EXTPURPOSE={serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",joyentDocker:"1.3.6.1.4.1.38678.1.4.1",joyentCmon:"1.3.6.1.4.1.38678.1.4.2"};var EXTPURPOSE_REV={};Object.keys(EXTPURPOSE).forEach(function(b){EXTPURPOSE_REV[EXTPURPOSE[b]]=b});var KEYUSEBITS=["signature","identity","keyEncryption","encryption","keyAgreement","ca","crl"];function readExtension(t,u,E){E.readSequence();var G=E.offset+E.length;var I=E.readOID();var B;var H=t.signatures.x509;H.extras.exts=[];var z;if(E.peek()===asn1.Ber.Boolean){z=E.readBoolean()}switch(I){case (EXTS.basicConstraints):E.readSequence(asn1.Ber.OctetString);E.readSequence();var x=E.offset+E.length;var A=false;if(E.peek()===asn1.Ber.Boolean){A=E.readBoolean()}if(t.purposes===undefined){t.purposes=[]}if(A===true){t.purposes.push("ca")}var F={oid:I,critical:z};if(E.offset<x&&E.peek()===asn1.Ber.Integer){F.pathLen=E.readInt()}H.extras.exts.push(F);break;case (EXTS.extKeyUsage):E.readSequence(asn1.Ber.OctetString);E.readSequence();if(t.purposes===undefined){t.purposes=[]}var v=E.offset+E.length;while(E.offset<v){var J=E.readOID();t.purposes.push(EXTPURPOSE_REV[J]||J)}if(t.purposes.indexOf("serverAuth")!==-1&&t.purposes.indexOf("clientAuth")===-1){t.subjects.forEach(function(a){if(a.type!=="host"){a.type="host";a.hostname=a.uid||a.email||a.components[0].value}})}else{if(t.purposes.indexOf("clientAuth")!==-1&&t.purposes.indexOf("serverAuth")===-1){t.subjects.forEach(function(a){if(a.type!=="user"){a.type="user";a.uid=a.hostname||a.email||a.components[0].value}})}}H.extras.exts.push({oid:I,critical:z});break;case (EXTS.keyUsage):E.readSequence(asn1.Ber.OctetString);var w=E.readString(asn1.Ber.BitString,true);var s=readBitField(w,KEYUSEBITS);s.forEach(function(a){if(t.purposes===undefined){t.purposes=[]}if(t.purposes.indexOf(a)===-1){t.purposes.push(a)}});H.extras.exts.push({oid:I,critical:z,bits:w});break;case (EXTS.altName):E.readSequence(asn1.Ber.OctetString);E.readSequence();var D=E.offset+E.length;while(E.offset<D){switch(E.peek()){case ALTNAME.OtherName:case ALTNAME.EDIPartyName:E.readSequence();E._offset+=E.length;break;case ALTNAME.OID:E.readOID(ALTNAME.OID);break;case ALTNAME.RFC822Name:var y=E.readString(ALTNAME.RFC822Name);B=Identity.forEmail(y);if(!t.subjects[0].equals(B)){t.subjects.push(B)}break;case ALTNAME.DirectoryName:E.readSequence(ALTNAME.DirectoryName);B=Identity.parseAsn1(E);if(!t.subjects[0].equals(B)){t.subjects.push(B)}break;case ALTNAME.DNSName:var C=E.readString(ALTNAME.DNSName);B=Identity.forHost(C);if(!t.subjects[0].equals(B)){t.subjects.push(B)}break;default:E.readString(E.peek());break}}H.extras.exts.push({oid:I,critical:z});break;default:H.extras.exts.push({oid:I,critical:z,data:E.readString(asn1.Ber.OctetString,true)});break}E._offset=G}var UTCTIME_RE=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function utcTimeToDate(l){var h=l.match(UTCTIME_RE);assert.ok(h,"timestamps must be in UTC");var j=new Date();var d=j.getUTCFullYear();var i=Math.floor(d/100)*100;var k=parseInt(h[1],10);if(d%100<50&&k>=60){k+=(i-1)}else{k+=i}j.setUTCFullYear(k,parseInt(h[2],10)-1,parseInt(h[3],10));j.setUTCHours(parseInt(h[4],10),parseInt(h[5],10));if(h[6]&&h[6].length>0){j.setUTCSeconds(parseInt(h[6],10))}return(j)}var GTIME_RE=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;function gTimeToDate(d){var e=d.match(GTIME_RE);assert.ok(e);var f=new Date();f.setUTCFullYear(parseInt(e[1],10),parseInt(e[2],10)-1,parseInt(e[3],10));f.setUTCHours(parseInt(e[4],10),parseInt(e[5],10));if(e[6]&&e[6].length>0){f.setUTCSeconds(parseInt(e[6],10))}return(f)}function zeroPad(c){var d=""+c;while(d.length<2){d="0"+d}return(d)}function dateToUTCTime(c){var d="";d+=zeroPad(c.getUTCFullYear()%100);d+=zeroPad(c.getUTCMonth()+1);d+=zeroPad(c.getUTCDate());d+=zeroPad(c.getUTCHours());d+=zeroPad(c.getUTCMinutes());d+=zeroPad(c.getUTCSeconds());d+="Z";return(d)}function sign(l,g){if(l.signatures.x509===undefined){l.signatures.x509={}}var i=l.signatures.x509;i.algo=g.type+"-"+g.defaultHashAlgorithm();if(SIGN_ALGS[i.algo]===undefined){return(false)}var k=new asn1.BerWriter();writeTBSCert(l,k);var h=k.buffer;i.cache=h;var j=g.createSign();j.write(h);l.signatures.x509.signature=j.sign();return(true)}function signAsync(l,i,h){if(l.signatures.x509===undefined){l.signatures.x509={}}var j=l.signatures.x509;var k=new asn1.BerWriter();writeTBSCert(l,k);var g=k.buffer;j.cache=g;i(g,function(a,b){if(a){h(a);return}j.algo=b.type+"-"+b.hashAlgorithm;if(SIGN_ALGS[j.algo]===undefined){h(new Error('Invalid signing algorithm "'+j.algo+'"'));return}j.signature=b;h()})}function write(g,h){var i=g.signatures.x509;assert.object(i,"x509 signature");var l=new asn1.BerWriter();l.startSequence();if(i.cache){l._ensure(i.cache.length);i.cache.copy(l._buf,l._offset);l._offset+=i.cache.length}else{writeTBSCert(g,l)}l.startSequence();l.writeOID(SIGN_ALGS[i.algo]);if(i.algo.match(/^rsa-/)){l.writeNull()}l.endSequence();var j=i.signature.toBuffer("asn1");var k=new Buffer(j.length+1);k[0]=0;j.copy(k,1);l.writeBuffer(k,asn1.Ber.BitString);l.endSequence();return(l.buffer)}function writeTBSCert(r,p){var i=r.signatures.x509;assert.object(i,"x509 signature");p.startSequence();p.startSequence(Local(0));p.writeInt(2);p.endSequence();p.writeBuffer(utils.mpNormalize(r.serial),asn1.Ber.Integer);p.startSequence();p.writeOID(SIGN_ALGS[i.algo]);if(i.algo.match(/^rsa-/)){p.writeNull()}p.endSequence();r.issuer.toAsn1(p);p.startSequence();p.writeString(dateToUTCTime(r.validFrom),asn1.Ber.UTCTime);p.writeString(dateToUTCTime(r.validUntil),asn1.Ber.UTCTime);p.endSequence();var o=r.subjects[0];var v=r.subjects.slice(1);o.toAsn1(p);pkcs8.writePkcs8(p,r.subjectKey);if(i.extras&&i.extras.issuerUniqueID){p.writeBuffer(i.extras.issuerUniqueID,Local(1))}if(i.extras&&i.extras.subjectUniqueID){p.writeBuffer(i.extras.subjectUniqueID,Local(2))}if(v.length>0||o.type==="host"||(r.purposes!==undefined&&r.purposes.length>0)||(i.extras&&i.extras.exts)){p.startSequence(Local(3));p.startSequence();var t=[];if(r.purposes!==undefined&&r.purposes.length>0){t.push({oid:EXTS.basicConstraints,critical:true});t.push({oid:EXTS.keyUsage,critical:true});t.push({oid:EXTS.extKeyUsage,critical:true})}t.push({oid:EXTS.altName});if(i.extras&&i.extras.exts){t=i.extras.exts}for(var q=0;q<t.length;++q){p.startSequence();p.writeOID(t[q].oid);if(t[q].critical!==undefined){p.writeBoolean(t[q].critical)}if(t[q].oid===EXTS.altName){p.startSequence(asn1.Ber.OctetString);p.startSequence();if(o.type==="host"){p.writeString(o.hostname,Context(2))}for(var s=0;s<v.length;++s){if(v[s].type==="host"){p.writeString(v[s].hostname,ALTNAME.DNSName)}else{if(v[s].type==="email"){p.writeString(v[s].email,ALTNAME.RFC822Name)}else{p.startSequence(ALTNAME.DirectoryName);v[s].toAsn1(p);p.endSequence()}}}p.endSequence();p.endSequence()}else{if(t[q].oid===EXTS.basicConstraints){p.startSequence(asn1.Ber.OctetString);p.startSequence();var u=(r.purposes.indexOf("ca")!==-1);var n=t[q].pathLen;p.writeBoolean(u);if(n!==undefined){p.writeInt(n)}p.endSequence();p.endSequence()}else{if(t[q].oid===EXTS.extKeyUsage){p.startSequence(asn1.Ber.OctetString);p.startSequence();r.purposes.forEach(function(b){if(b==="ca"){return}if(KEYUSEBITS.indexOf(b)!==-1){return}var a=b;if(EXTPURPOSE[b]!==undefined){a=EXTPURPOSE[b]}p.writeOID(a)});p.endSequence();p.endSequence()}else{if(t[q].oid===EXTS.keyUsage){p.startSequence(asn1.Ber.OctetString);if(t[q].bits!==undefined){p.writeBuffer(t[q].bits,asn1.Ber.BitString)}else{var j=writeBitField(r.purposes,KEYUSEBITS);p.writeBuffer(j,asn1.Ber.BitString)}p.endSequence()}else{p.writeBuffer(t[q].data,asn1.Ber.OctetString)}}}}p.endSequence()}p.endSequence();p.endSequence()}p.endSequence()}function readBitField(m,r){var s=8*(m.length-1)-m[0];var p={};for(var q=0;q<s;++q){var o=1+Math.floor(q/8);var n=7-(q%8);var i=1<<n;var l=((m[o]&i)!==0);var t=r[q];if(l&&typeof(t)==="string"){p[t]=true}}return(Object.keys(p))}function writeBitField(s,v){var w=v.length;var i=Math.ceil(w/8);var u=i*8-w;var p=new Buffer(1+i);p.fill(0);p[0]=u;for(var t=0;t<w;++t){var r=1+Math.floor(t/8);var q=7-(t%8);var n=1<<q;var x=v[t];if(x===undefined){continue}var o=(s.indexOf(x)!==-1);if(o){p[r]|=n}}return(p)};