module.exports=Identity;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var Fingerprint=require("./fingerprint");var Signature=require("./signature");var errs=require("./errors");var util=require("util");var utils=require("./utils");var asn1=require("asn1");var DNS_NAME_RE=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i;var oids={};oids.cn="2.5.4.3";oids.o="2.5.4.10";oids.ou="2.5.4.11";oids.l="2.5.4.7";oids.s="2.5.4.8";oids.c="2.5.4.6";oids.sn="2.5.4.4";oids.dc="0.9.2342.19200300.100.1.25";oids.uid="0.9.2342.19200300.100.1.1";oids.mail="0.9.2342.19200300.100.1.3";var unoids={};Object.keys(oids).forEach(function(a){unoids[oids[a]]=a});function Identity(b){var a=this;assert.object(b,"options");assert.arrayOfObject(b.components,"options.components");this.components=b.components;this.componentLookup={};this.components.forEach(function(c){if(c.name&&!c.oid){c.oid=oids[c.name]}if(c.oid&&!c.name){c.name=unoids[c.oid]}if(a.componentLookup[c.name]===undefined){a.componentLookup[c.name]=[]}a.componentLookup[c.name].push(c)});if(this.componentLookup.cn&&this.componentLookup.cn.length>0){this.cn=this.componentLookup.cn[0].value}assert.optionalString(b.type,"options.type");if(b.type===undefined){if(this.components.length===1&&this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length){this.type="host";this.hostname=this.componentLookup.dc.map(function(c){return(c.value)}).join(".")}else{if(this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.uid&&this.componentLookup.uid.length===1){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.mail&&this.componentLookup.mail.length===1){this.type="email";this.email=this.componentLookup.mail[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1){this.type="user";this.uid=this.componentLookup.cn[0].value}else{this.type="unknown"}}}}}}}}else{this.type=b.type;if(this.type==="host"){this.hostname=b.hostname}else{if(this.type==="user"){this.uid=b.uid}else{if(this.type==="email"){this.email=b.email}else{throw (new Error("Unknown type "+this.type))}}}}}Identity.prototype.toString=function(){return(this.components.map(function(a){return(a.name.toUpperCase()+"="+a.value)}).join(", "))};var NOT_PRINTABLE=/[^a-zA-Z0-9 '(),+.\/:=?-]/;var NOT_IA5=/[^\x00-\x7f]/;Identity.prototype.toAsn1=function(b,a){b.startSequence(a);this.components.forEach(function(d){b.startSequence(asn1.Ber.Constructor|asn1.Ber.Set);b.startSequence();b.writeOID(d.oid);if(d.asn1type===asn1.Ber.Utf8String||d.value.match(NOT_IA5)){var e=new Buffer(d.value,"utf8");b.writeBuffer(e,asn1.Ber.Utf8String)}else{if(d.asn1type===asn1.Ber.IA5String||d.value.match(NOT_PRINTABLE)){b.writeString(d.value,asn1.Ber.IA5String)}else{var c=asn1.Ber.PrintableString;if(d.asn1type!==undefined){c=d.asn1type}b.writeString(d.value,c)}}b.endSequence();b.endSequence()});b.endSequence()};function globMatch(f,e){if(f==="**"||e==="**"){return(true)}var d=f.split(".");var c=e.split(".");if(d.length!==c.length){return(false)}for(var g=0;g<d.length;++g){if(d[g]==="*"||c[g]==="*"){continue}if(d[g]!==c[g]){return(false)}}return(true)}Identity.prototype.equals=function(a){if(!Identity.isIdentity(a,[1,0])){return(false)}if(a.components.length!==this.components.length){return(false)}for(var b=0;b<this.components.length;++b){if(this.components[b].oid!==a.components[b].oid){return(false)}if(!globMatch(this.components[b].value,a.components[b].value)){return(false)}}return(true)};Identity.forHost=function(a){assert.string(a,"hostname");return(new Identity({type:"host",hostname:a,components:[{name:"cn",value:a}]}))};Identity.forUser=function(a){assert.string(a,"uid");return(new Identity({type:"user",uid:a,components:[{name:"uid",value:a}]}))};Identity.forEmail=function(a){assert.string(a,"email");return(new Identity({type:"email",email:a,components:[{name:"mail",value:a}]}))};Identity.parseDN=function(b){assert.string(b,"dn");var a=b.split(",");var c=a.map(function(e){e=e.trim();var d=e.indexOf("=");var f=e.slice(0,d).toLowerCase();var g=e.slice(d+1);return({name:f,value:g})});return(new Identity({components:c}))};Identity.parseAsn1=function(h,b){var g=[];h.readSequence(b);var d=h.offset+h.length;while(h.offset<d){h.readSequence(asn1.Ber.Constructor|asn1.Ber.Set);var c=h.offset+h.length;h.readSequence();var f=h.readOID();var e=h.peek();var a;switch(e){case asn1.Ber.PrintableString:case asn1.Ber.IA5String:case asn1.Ber.OctetString:case asn1.Ber.T61String:a=h.readString(e);break;case asn1.Ber.Utf8String:a=h.readString(e,true);a=a.toString("utf8");break;case asn1.Ber.CharacterString:case asn1.Ber.BMPString:a=h.readString(e,true);a=a.toString("utf16le");break;default:throw (new Error("Unknown asn1 type "+e))}g.push({oid:f,asn1type:e,value:a});h._offset=c}h._offset=d;return(new Identity({components:g}))};Identity.isIdentity=function(b,a){return(utils.isCompatible(b,Identity,a))};Identity.prototype._sshpkApiVersion=[1,0];Identity._oldVersionDetect=function(a){return([1,0])};