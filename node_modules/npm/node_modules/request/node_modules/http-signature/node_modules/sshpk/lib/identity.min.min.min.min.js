module.exports=Identity;var assert=require("assert-plus");var algs=require("./algs");var crypto=require("crypto");var Fingerprint=require("./fingerprint");var Signature=require("./signature");var errs=require("./errors");var util=require("util");var utils=require("./utils");var asn1=require("asn1");var DNS_NAME_RE=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i;var oids={};oids.cn="2.5.4.3";oids.o="2.5.4.10";oids.ou="2.5.4.11";oids.l="2.5.4.7";oids.s="2.5.4.8";oids.c="2.5.4.6";oids.sn="2.5.4.4";oids.dc="0.9.2342.19200300.100.1.25";oids.uid="0.9.2342.19200300.100.1.1";oids.mail="0.9.2342.19200300.100.1.3";var unoids={};Object.keys(oids).forEach(function(b){unoids[oids[b]]=b});function Identity(c){var d=this;assert.object(c,"options");assert.arrayOfObject(c.components,"options.components");this.components=c.components;this.componentLookup={};this.components.forEach(function(a){if(a.name&&!a.oid){a.oid=oids[a.name]}if(a.oid&&!a.name){a.name=unoids[a.oid]}if(d.componentLookup[a.name]===undefined){d.componentLookup[a.name]=[]}d.componentLookup[a.name].push(a)});if(this.componentLookup.cn&&this.componentLookup.cn.length>0){this.cn=this.componentLookup.cn[0].value}assert.optionalString(c.type,"options.type");if(c.type===undefined){if(this.components.length===1&&this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length){this.type="host";this.hostname=this.componentLookup.dc.map(function(a){return(a.value)}).join(".")}else{if(this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)){this.type="host";this.hostname=this.componentLookup.cn[0].value}else{if(this.componentLookup.uid&&this.componentLookup.uid.length===1){this.type="user";this.uid=this.componentLookup.uid[0].value}else{if(this.componentLookup.mail&&this.componentLookup.mail.length===1){this.type="email";this.email=this.componentLookup.mail[0].value}else{if(this.componentLookup.cn&&this.componentLookup.cn.length===1){this.type="user";this.uid=this.componentLookup.cn[0].value}else{this.type="unknown"}}}}}}}}else{this.type=c.type;if(this.type==="host"){this.hostname=c.hostname}else{if(this.type==="user"){this.uid=c.uid}else{if(this.type==="email"){this.email=c.email}else{throw (new Error("Unknown type "+this.type))}}}}}Identity.prototype.toString=function(){return(this.components.map(function(b){return(b.name.toUpperCase()+"="+b.value)}).join(", "))};var NOT_PRINTABLE=/[^a-zA-Z0-9 '(),+.\/:=?-]/;var NOT_IA5=/[^\x00-\x7f]/;Identity.prototype.toAsn1=function(c,d){c.startSequence(d);this.components.forEach(function(b){c.startSequence(asn1.Ber.Constructor|asn1.Ber.Set);c.startSequence();c.writeOID(b.oid);if(b.asn1type===asn1.Ber.Utf8String||b.value.match(NOT_IA5)){var a=new Buffer(b.value,"utf8");c.writeBuffer(a,asn1.Ber.Utf8String)}else{if(b.asn1type===asn1.Ber.IA5String||b.value.match(NOT_PRINTABLE)){c.writeString(b.value,asn1.Ber.IA5String)}else{var f=asn1.Ber.PrintableString;if(b.asn1type!==undefined){f=b.asn1type}c.writeString(b.value,f)}}c.endSequence();c.endSequence()});c.endSequence()};function globMatch(b,h){if(b==="**"||h==="**"){return(true)}var i=b.split(".");var j=h.split(".");if(i.length!==j.length){return(false)}for(var a=0;a<i.length;++a){if(i[a]==="*"||j[a]==="*"){continue}if(i[a]!==j[a]){return(false)}}return(true)}Identity.prototype.equals=function(d){if(!Identity.isIdentity(d,[1,0])){return(false)}if(d.components.length!==this.components.length){return(false)}for(var c=0;c<this.components.length;++c){if(this.components[c].oid!==d.components[c].oid){return(false)}if(!globMatch(this.components[c].value,d.components[c].value)){return(false)}}return(true)};Identity.forHost=function(b){assert.string(b,"hostname");return(new Identity({type:"host",hostname:b,components:[{name:"cn",value:b}]}))};Identity.forUser=function(b){assert.string(b,"uid");return(new Identity({type:"user",uid:b,components:[{name:"uid",value:b}]}))};Identity.forEmail=function(b){assert.string(b,"email");return(new Identity({type:"email",email:b,components:[{name:"mail",value:b}]}))};Identity.parseDN=function(d){assert.string(d,"dn");var e=d.split(",");var f=e.map(function(c){c=c.trim();var h=c.indexOf("=");var b=c.slice(0,h).toLowerCase();var a=c.slice(h+1);return({name:b,value:a})});return(new Identity({components:f}))};Identity.parseAsn1=function(k,i){var l=[];k.readSequence(i);var o=k.offset+k.length;while(k.offset<o){k.readSequence(asn1.Ber.Constructor|asn1.Ber.Set);var p=k.offset+k.length;k.readSequence();var m=k.readOID();var n=k.peek();var j;switch(n){case asn1.Ber.PrintableString:case asn1.Ber.IA5String:case asn1.Ber.OctetString:case asn1.Ber.T61String:j=k.readString(n);break;case asn1.Ber.Utf8String:j=k.readString(n,true);j=j.toString("utf8");break;case asn1.Ber.CharacterString:case asn1.Ber.BMPString:j=k.readString(n,true);j=j.toString("utf16le");break;default:throw (new Error("Unknown asn1 type "+n))}l.push({oid:m,asn1type:n,value:j});k._offset=p}k._offset=o;return(new Identity({components:l}))};Identity.isIdentity=function(c,d){return(utils.isCompatible(c,Identity,d))};Identity.prototype._sshpkApiVersion=[1,0];Identity._oldVersionDetect=function(b){return([1,0])};