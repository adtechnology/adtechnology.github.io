var util=require("util");var Stream=require("stream").Stream;var DelayedStream=require("delayed-stream");var defer=require("./defer.js");module.exports=CombinedStream;function CombinedStream(){this.writable=false;this.readable=true;this.dataSize=0;this.maxDataSize=2*1024*1024;this.pauseStreams=true;this._released=false;this._streams=[];this._currentStream=null}util.inherits(CombinedStream,Stream);CombinedStream.create=function(b){var a=new this();b=b||{};for(var c in b){a[c]=b[c]}return a};CombinedStream.isStreamLike=function(a){return(typeof a!=="function")&&(typeof a!=="string")&&(typeof a!=="boolean")&&(typeof a!=="number")&&(!Buffer.isBuffer(a))};CombinedStream.prototype.append=function(b){var a=CombinedStream.isStreamLike(b);if(a){if(!(b instanceof DelayedStream)){var c=DelayedStream.create(b,{maxDataSize:Infinity,pauseStream:this.pauseStreams});b.on("data",this._checkDataSize.bind(this));b=c}this._handleErrors(b);if(this.pauseStreams){b.pause()}}this._streams.push(b);return this};CombinedStream.prototype.pipe=function(b,a){Stream.prototype.pipe.call(this,b,a);this.resume();return b};CombinedStream.prototype._getNext=function(){this._currentStream=null;var b=this._streams.shift();if(typeof b=="undefined"){this.end();return}if(typeof b!=="function"){this._pipeNext(b);return}var a=b;a(function(d){var c=CombinedStream.isStreamLike(d);if(c){d.on("data",this._checkDataSize.bind(this));this._handleErrors(d)}defer(this._pipeNext.bind(this,d))}.bind(this))};CombinedStream.prototype._pipeNext=function(c){this._currentStream=c;var a=CombinedStream.isStreamLike(c);if(a){c.on("end",this._getNext.bind(this));c.pipe(this,{end:false});return}var b=c;this.write(b);this._getNext()};CombinedStream.prototype._handleErrors=function(b){var a=this;b.on("error",function(c){a._emitError(c)})};CombinedStream.prototype.write=function(a){this.emit("data",a)};CombinedStream.prototype.pause=function(){if(!this.pauseStreams){return}if(this.pauseStreams&&this._currentStream&&typeof(this._currentStream.pause)=="function"){this._currentStream.pause()}this.emit("pause")};CombinedStream.prototype.resume=function(){if(!this._released){this._released=true;this.writable=true;this._getNext()}if(this.pauseStreams&&this._currentStream&&typeof(this._currentStream.resume)=="function"){this._currentStream.resume()}this.emit("resume")};CombinedStream.prototype.end=function(){this._reset();this.emit("end")};CombinedStream.prototype.destroy=function(){this._reset();this.emit("close")};CombinedStream.prototype._reset=function(){this.writable=false;this._streams=[];this._currentStream=null};CombinedStream.prototype._checkDataSize=function(){this._updateDataSize();if(this.dataSize<=this.maxDataSize){return}var a="DelayedStream#maxDataSize of "+this.maxDataSize+" bytes exceeded.";this._emitError(new Error(a))};CombinedStream.prototype._updateDataSize=function(){this.dataSize=0;var a=this;this._streams.forEach(function(b){if(!b.dataSize){return}a.dataSize+=b.dataSize});if(this._currentStream&&this._currentStream.dataSize){this.dataSize+=this._currentStream.dataSize}};CombinedStream.prototype._emitError=function(a){this._reset();this.emit("error",a)};