var test=require("tap").test;var lockFile=require("../lockfile.js");var path=require("path");var fs=require("fs");var touch=require("touch");lockFile.filetime="mtime";test("setup",function(a){try{lockFile.unlockSync("basic-lock")}catch(b){}try{lockFile.unlockSync("sync-lock")}catch(b){}try{lockFile.unlockSync("never-forget")}catch(b){}try{lockFile.unlockSync("stale-lock")}catch(b){}try{lockFile.unlockSync("watch-lock")}catch(b){}try{lockFile.unlockSync("retry-lock")}catch(b){}try{lockFile.unlockSync("contentious-lock")}catch(b){}try{lockFile.unlockSync("stale-wait-lock")}catch(b){}try{lockFile.unlockSync("stale-windows-lock")}catch(b){}a.end()});test("lock contention",function(e){var c=0;var g=200;var b=10;var a=200;var f=g*a+b;lockFile.lock("contentious-lock",function(i,h){e.ifError(i,"acquiring starter");if(i){throw i}e.pass("acquired starter lock");setTimeout(function(){lockFile.unlock("contentious-lock",function(j){e.ifError(j,"unlocking starter");if(j){throw j}e.pass("unlocked starter")})},b)});for(var d=0;d<g;d++){lockFile.lock("contentious-lock",{wait:f},function(i,h){if(i){throw i}lockFile.unlock("contentious-lock",function(j){if(j){throw j}c++;e.pass("locked and unlocked #"+c);if(c===g){e.pass("got all locks");e.end()}})})}});test("basic test",function(a){lockFile.check("basic-lock",function(c,b){if(c){throw c}a.notOk(b);lockFile.lock("basic-lock",function(d){if(d){throw d}lockFile.lock("basic-lock",function(e){a.ok(e);lockFile.check("basic-lock",function(g,f){if(g){throw g}a.ok(f);lockFile.unlock("basic-lock",function(h){if(h){throw h}lockFile.check("basic-lock",function(j,i){if(j){throw j}a.notOk(i);a.end()})})})})})})});test("sync test",function(b){var a;a=lockFile.checkSync("sync-lock");b.notOk(a);lockFile.lockSync("sync-lock");a=lockFile.checkSync("sync-lock");b.ok(a);lockFile.unlockSync("sync-lock");a=lockFile.checkSync("sync-lock");b.notOk(a);b.end()});test("exit cleanup test",function(a){var d=require.resolve("./fixtures/child.js");var c=process.execPath;var b=require("child_process").spawn;b(c,[d]).on("exit",function(){setTimeout(function(){var e=lockFile.checkSync("never-forget");a.notOk(e);a.end()},100)})});test("error exit cleanup test",function(a){var d=require.resolve("./fixtures/bad-child.js");var c=process.execPath;var b=require("child_process").spawn;b(c,[d]).on("exit",function(){setTimeout(function(){var e=lockFile.checkSync("never-forget");a.notOk(e);a.end()},100)})});test("staleness test",function(a){lockFile.lock("stale-lock",function(c){if(c){throw c}touch.sync("stale-lock",{time:new Date(Date.now()-2000)});var b={stale:1};lockFile.check("stale-lock",b,function(e,d){if(e){throw e}a.notOk(d);lockFile.lock("stale-lock",b,function(f){if(f){throw f}lockFile.unlock("stale-lock",function(g){if(g){throw g}a.end()})})})})});test("staleness sync test",function(b){var c={stale:1};lockFile.lockSync("stale-lock");touch.sync("stale-lock",{time:new Date(Date.now()-2000)});var a;a=lockFile.checkSync("stale-lock",c);b.notOk(a);lockFile.lockSync("stale-lock",c);lockFile.unlockSync("stale-lock");b.end()});test("retries",function(a){var b=5;fs._open=fs.open;fs.open=function(d,e,c){if(--b===0){fs.open=fs._open;return fs.open(d,e,c)}var f=new Error("bogus");f.code=b%2?"EEXIST":"ENOENT";process.nextTick(c.bind(null,f))};lockFile.lock("retry-lock",{retries:b},function(c){if(c){throw c}a.equal(b,0);lockFile.unlockSync("retry-lock");a.end()})});test("retryWait",function(a){var c=5;fs._open=fs.open;fs.open=function(e,f,d){if(--c===0){fs.open=fs._open;return fs.open(e,f,d)}var g=new Error("bogus");g.code=c%2?"EEXIST":"ENOENT";process.nextTick(d.bind(null,g))};var b={retries:c,retryWait:100};lockFile.lock("retry-lock",b,function(d){if(d){throw d}a.equal(c,0);lockFile.unlockSync("retry-lock");a.end()})});test("retry sync",function(a){var c=5;fs._openSync=fs.openSync;fs.openSync=function(d,e){if(--c===0){fs.openSync=fs._openSync;return fs.openSync(d,e)}var f=new Error("bogus");f.code=c%2?"EEXIST":"ENOENT";throw f};var b={retries:c};lockFile.lockSync("retry-lock",b);a.equal(c,0);lockFile.unlockSync("retry-lock");a.end()});test("wait and stale together",function(b){var a;lockFile.lock("stale-wait-lock",function(d){a=setInterval(function(){touch.sync("stale-wait-lock")},10);var c={stale:1000,wait:2000,pollInterval:1000};lockFile.lock("stale-wait-lock",c,function(e){if(!e){b.fail("got second lock?  that unpossible!")}else{b.pass("second lock failed, as i have foreseen it")}clearInterval(a);b.end()})})});test("stale windows file tunneling test",function(b){var c={stale:1000};lockFile.lockSync("stale-windows-lock");touch.sync("stale-windows-lock",{time:new Date(Date.now()-3000)});var a;lockFile.unlockSync("stale-windows-lock");lockFile.lockSync("stale-windows-lock",c);a=lockFile.checkSync("stale-windows-lock",c);b.ok(a,"should be locked and not stale");lockFile.lock("stale-windows-lock",c,function(d){if(!d){b.fail("got second lock?  impossible, windows file tunneling problem!")}else{b.pass("second lock failed, windows file tunneling problem fixed")}b.end()})});test("cleanup",function(a){try{lockFile.unlockSync("basic-lock")}catch(b){}try{lockFile.unlockSync("sync-lock")}catch(b){}try{lockFile.unlockSync("never-forget")}catch(b){}try{lockFile.unlockSync("stale-lock")}catch(b){}try{lockFile.unlockSync("watch-lock")}catch(b){}try{lockFile.unlockSync("retry-lock")}catch(b){}try{lockFile.unlockSync("contentious-lock")}catch(b){}try{lockFile.unlockSync("stale-wait-lock")}catch(b){}try{lockFile.unlockSync("stale-windows-lock")}catch(b){}a.end()});