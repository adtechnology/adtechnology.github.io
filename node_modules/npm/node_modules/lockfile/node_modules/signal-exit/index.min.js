var assert=require("assert");var signals=require("./signals.js");var EE=require("events");if(typeof EE!=="function"){EE=EE.EventEmitter}var emitter;if(process.__signal_exit_emitter__){emitter=process.__signal_exit_emitter__}else{emitter=process.__signal_exit_emitter__=new EE();emitter.count=0;emitter.emitted={}}if(!emitter.infinite){emitter.setMaxListeners(Infinity);emitter.infinite=true}module.exports=function(b,d){assert.equal(typeof b,"function","a callback must be provided for exit handler");if(loaded===false){load()}var c="exit";if(d&&d.alwaysLast){c="afterexit"}var a=function(){emitter.removeListener(c,b);if(emitter.listeners("exit").length===0&&emitter.listeners("afterexit").length===0){unload()}};emitter.on(c,b);return a};module.exports.unload=unload;function unload(){if(!loaded){return}loaded=false;signals.forEach(function(a){try{process.removeListener(a,sigListeners[a])}catch(b){}});process.emit=originalProcessEmit;process.reallyExit=originalProcessReallyExit;emitter.count-=1}function emit(b,a,c){if(emitter.emitted[b]){return}emitter.emitted[b]=true;emitter.emit(b,a,c)}var sigListeners={};signals.forEach(function(b){sigListeners[b]=function a(){var c=process.listeners(b);if(c.length===emitter.count){unload();emit("exit",null,b);emit("afterexit",null,b);process.kill(process.pid,b)}}});module.exports.signals=function(){return signals};module.exports.load=load;var loaded=false;function load(){if(loaded){return}loaded=true;emitter.count+=1;signals=signals.filter(function(a){try{process.on(a,sigListeners[a]);return true}catch(b){return false}});process.emit=processEmit;process.reallyExit=processReallyExit}var originalProcessReallyExit=process.reallyExit;function processReallyExit(a){process.exitCode=a||0;emit("exit",process.exitCode,null);emit("afterexit",process.exitCode,null);originalProcessReallyExit.call(process,process.exitCode)}var originalProcessEmit=process.emit;function processEmit(c,a){if(c==="exit"){if(a!==undefined){process.exitCode=a}var b=originalProcessEmit.apply(this,arguments);emit("exit",process.exitCode,null);emit("afterexit",process.exitCode,null);return b}else{return originalProcessEmit.apply(this,arguments)}};