var fs=require("fs"),path=require("path"),symlink=path.resolve(__dirname,"fixtures/symlink");try{fs.unlinkSync(symlink)}catch(e){}fs.symlinkSync("./hardlink-1",symlink);process.on("exit",function(){fs.unlinkSync(symlink)});var tap=require("tap"),tar=require("../tar.js"),pkg=require("../package.json"),Pack=tar.Pack,fstream=require("fstream"),Reader=fstream.Reader,Writer=fstream.Writer,input=path.resolve(__dirname,"fixtures/"),target=path.resolve(__dirname,"tmp/pack.tar"),uid=process.getuid?process.getuid():0,gid=process.getgid?process.getgid():0,entries=[["entry",{path:"fixtures/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["extendedHeader",{path:"PaxHeader/fixtures/200cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",mode:420,uid:uid,gid:gid,type:"x",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{path:"fixtures/200ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",uid:uid,gid:gid,size:200}],["entry",{path:"fixtures/200ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",mode:420,uid:uid,gid:gid,size:200,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/a.txt",mode:420,uid:uid,gid:gid,size:257,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/b.txt",mode:420,uid:uid,gid:gid,size:512,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/c.txt",mode:420,uid:uid,gid:gid,size:513,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/cc.txt",mode:420,uid:uid,gid:gid,size:513,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/dir/",mode:488,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/dir/sub/",mode:488,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/foo.js",mode:420,uid:uid,gid:gid,size:4,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/hardlink-1",mode:420,uid:uid,gid:gid,size:200,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/hardlink-2",mode:420,uid:uid,gid:gid,size:0,type:"1",linkpath:"fixtures/hardlink-1",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/omega.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/packtest/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/packtest/omega.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/packtest/star.4.html",mode:420,uid:uid,gid:gid,size:54081,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["extendedHeader",{path:"PaxHeader/fixtures/packtest/Ω.txt",mode:420,uid:uid,gid:gid,type:"x",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{path:"fixtures/packtest/Ω.txt",uid:uid,gid:gid,size:2}],["entry",{path:"fixtures/packtest/Ω.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/t/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/t/h/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/t/h/cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",mode:420,uid:uid,gid:gid,size:100,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/symlink",uid:uid,gid:gid,size:0,type:"2",linkpath:"hardlink-1",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["extendedHeader",{path:"PaxHeader/fixtures/Ω.txt",mode:420,uid:uid,gid:gid,type:"x",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{path:"fixtures/Ω.txt",uid:uid,gid:gid,size:2}],["entry",{path:"fixtures/Ω.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}]];var hard1=path.resolve(__dirname,"fixtures/hardlink-1"),hard2=path.resolve(__dirname,"fixtures/hardlink-2"),fs=require("fs");try{fs.unlinkSync(hard2)}catch(e){}fs.linkSync(hard1,hard2);tap.test("with global header",{timeout:10000},function(a){runTest(a,true)});tap.test("without global header",{timeout:10000},function(a){runTest(a,false)});function alphasort(d,c){return d===c?0:d.toLowerCase()>c.toLowerCase()?1:d.toLowerCase()<c.toLowerCase()?-1:d>c?1:-1}function runTest(c,h){var a=Reader({path:input,filter:function(){return !this.path.match(/\.(tar|hex)$/)},sort:alphasort});var d=h?pkg:{};d.noProprietary=true;var b=Pack(d);var g=Writer(target);var f=0;c.ok(a,"reader ok");c.ok(b,"pack ok");c.ok(g,"writer ok");b.pipe(g);var i=tar.Parse();c.ok(i,"parser should be ok");b.on("data",function(j){if(j.length!==512){c.equal(j.length,512,"parser should emit data in 512byte blocks")}i.write(j)});b.on("end",function(){c.pass("parser ends");i.end()});b.on("error",function(j){c.fail("pack error",j)});i.on("error",function(j){c.fail("parse error",j)});g.on("error",function(j){c.fail("writer error",j)});a.on("error",function(j){c.fail("reader error",j)});i.on("*",function(k,l){var j=entries[f++];if(!j){c.fail("unexpected event: "+k);return}c.equal(k,j[0],"event type should be "+j[0]);if(k!==j[0]||l.path!==j[1].path){console.error("wanted",j);console.error([k,l.props]);l.on("end",function(){console.error(l.fields);throw"break"})}c.has(l.props,j[1],"properties "+j[1].path);if(j[2]){l.on("end",function(){if(!l.fields){c.ok(l.fields,"should get fields")}else{c.has(l.fields,j[2],"should get expected fields")}})}});a.pipe(b);g.on("close",function(){c.equal(f,entries.length,"should get all expected entries");c.pass("it finished");c.end()})};