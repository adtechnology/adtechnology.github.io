var fs=require("fs"),path=require("path"),symlink=path.resolve(__dirname,"fixtures/symlink");try{fs.unlinkSync(symlink)}catch(e){}fs.symlinkSync("./hardlink-1",symlink);process.on("exit",function(){fs.unlinkSync(symlink)});var tap=require("tap"),tar=require("../tar.js"),pkg=require("../package.json"),Pack=tar.Pack,fstream=require("fstream"),Reader=fstream.Reader,Writer=fstream.Writer,input=path.resolve(__dirname,"fixtures/"),target=path.resolve(__dirname,"tmp/pack.tar"),uid=process.getuid?process.getuid():0,gid=process.getgid?process.getgid():0,entries=[["globalExtendedHeader",{path:"PaxHeader/",mode:438,uid:0,gid:0,type:"g",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{"NODETAR.author":pkg.author,"NODETAR.name":pkg.name,"NODETAR.description":pkg.description,"NODETAR.version":pkg.version,"NODETAR.repository.type":pkg.repository.type,"NODETAR.repository.url":pkg.repository.url,"NODETAR.main":pkg.main,"NODETAR.scripts.test":pkg.scripts.test}],["entry",{path:"fixtures/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["extendedHeader",{path:"PaxHeader/fixtures/200cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",mode:420,uid:uid,gid:gid,type:"x",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{path:"fixtures/200ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc","NODETAR.depth":"1","NODETAR.type":"File",nlink:1,uid:uid,gid:gid,size:200,"NODETAR.blksize":"4096","NODETAR.blocks":"8"}],["entry",{path:"fixtures/200ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",mode:420,uid:uid,gid:gid,size:200,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:"","NODETAR.depth":"1","NODETAR.type":"File",nlink:1,"NODETAR.blksize":"4096","NODETAR.blocks":"8"}],["entry",{path:"fixtures/a.txt",mode:420,uid:uid,gid:gid,size:257,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/b.txt",mode:420,uid:uid,gid:gid,size:512,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/c.txt",mode:420,uid:uid,gid:gid,size:513,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/cc.txt",mode:420,uid:uid,gid:gid,size:513,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/dir/",mode:488,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/dir/sub/",mode:488,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/foo.js",mode:420,uid:uid,gid:gid,size:4,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/hardlink-1",mode:420,uid:uid,gid:gid,size:200,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/hardlink-2",mode:420,uid:uid,gid:gid,size:0,type:"1",linkpath:"fixtures/hardlink-1",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/omega.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/packtest/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/packtest/omega.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/packtest/star.4.html",mode:420,uid:uid,gid:gid,size:54081,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["extendedHeader",{path:"PaxHeader/fixtures/packtest/Ω.txt",mode:420,uid:uid,gid:gid,type:"x",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{path:"fixtures/packtest/Ω.txt","NODETAR.depth":"2","NODETAR.type":"File",nlink:1,uid:uid,gid:gid,size:2,"NODETAR.blksize":"4096","NODETAR.blocks":"8"}],["entry",{path:"fixtures/packtest/Ω.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:"","NODETAR.depth":"2","NODETAR.type":"File",nlink:1,"NODETAR.blksize":"4096","NODETAR.blocks":"8"}],["entry",{path:"fixtures/r/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/t/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/t/h/",mode:493,uid:uid,gid:gid,size:0,type:"5",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/r/e/a/l/l/y/-/d/e/e/p/-/f/o/l/d/e/r/-/p/a/t/h/cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc",mode:420,uid:uid,gid:gid,size:100,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["entry",{path:"fixtures/symlink",uid:uid,gid:gid,size:0,type:"2",linkpath:"hardlink-1",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""}],["extendedHeader",{path:"PaxHeader/fixtures/Ω.txt",mode:420,uid:uid,gid:gid,type:"x",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:""},{path:"fixtures/Ω.txt","NODETAR.depth":"1","NODETAR.type":"File",nlink:1,uid:uid,gid:gid,size:2,"NODETAR.blksize":"4096","NODETAR.blocks":"8"}],["entry",{path:"fixtures/Ω.txt",mode:420,uid:uid,gid:gid,size:2,type:"0",linkpath:"",ustar:"ustar\u0000",ustarver:"00",uname:"",gname:"",devmaj:0,devmin:0,fill:"","NODETAR.depth":"1","NODETAR.type":"File",nlink:1,"NODETAR.blksize":"4096","NODETAR.blocks":"8"}]];var hard1=path.resolve(__dirname,"fixtures/hardlink-1"),hard2=path.resolve(__dirname,"fixtures/hardlink-2"),fs=require("fs");try{fs.unlinkSync(hard2)}catch(e){}fs.linkSync(hard1,hard2);tap.test("with global header",{timeout:10000},function(a){runTest(a,true)});tap.test("without global header",{timeout:10000},function(a){runTest(a,false)});tap.test("with from base",{timeout:10000},function(a){runTest(a,true,true)});function alphasort(d,c){return d===c?0:d.toLowerCase()>c.toLowerCase()?1:d.toLowerCase()<c.toLowerCase()?-1:d>c?1:-1}function runTest(j,a,d){var f=Reader({path:input,filter:function(){return !this.path.match(/\.(tar|hex)$/)},sort:alphasort});var g=a?pkg:{};if(d){g.fromBase=true}var h=Pack(g);var b=Writer(target);var i=a?0:1;j.ok(f,"reader ok");j.ok(h,"pack ok");j.ok(b,"writer ok");h.pipe(b);var c=tar.Parse();j.ok(c,"parser should be ok");h.on("data",function(k){if(k.length!==512){j.equal(k.length,512,"parser should emit data in 512byte blocks")}c.write(k)});h.on("end",function(){j.pass("parser ends");c.end()});h.on("error",function(k){j.fail("pack error",k)});c.on("error",function(k){j.fail("parse error",k)});b.on("error",function(k){j.fail("writer error",k)});f.on("error",function(k){j.fail("reader error",k)});c.on("*",function(l,m){var k=entries[i++];if(!k){j.fail("unexpected event: "+l);return}j.equal(l,k[0],"event type should be "+k[0]);if(d){if(k[1].path.indexOf("fixtures/")&&k[1].path.length==100){k[1].path=k[1].path.replace("fixtures/","")+"ccccccccc"}if(k[1]){k[1].path=k[1].path.replace("fixtures/","").replace("//","/")}if(k[1].path==""){k[1].path="/"}if(k[2]&&k[2].path){k[2].path=k[2].path.replace("fixtures","").replace(/^\//,"")}k[1].linkpath=k[1].linkpath.replace("fixtures/","")}if(l!==k[0]||m.path!==k[1].path){console.error("wanted",k);console.error([l,m.props]);m.on("end",function(){console.error(m.fields);throw"break"})}j.has(m.props,k[1],"properties "+k[1].path);if(k[2]){m.on("end",function(){if(!m.fields){j.ok(m.fields,"should get fields")}else{j.has(m.fields,k[2],"should get expected fields")}})}});f.pipe(h);b.on("close",function(){j.equal(i,entries.length,"should get all expected entries");j.pass("it finished");j.end()})};