process.umask(parseInt("22",8));var tap=require("tap"),tar=require("../tar.js"),fs=require("fs"),gfs=require("graceful-fs"),path=require("path"),file=path.resolve(__dirname,"fixtures/dir.tar"),target=path.resolve(__dirname,"tmp/extract-test"),index=0,fstream=require("fstream"),rimraf=require("rimraf"),mkdirp=require("mkdirp"),ee=0,expectEntries=[{path:"dir/",mode:"750",type:"5",depth:undefined,size:0,linkpath:"",nlink:undefined,dev:undefined,ino:undefined},{path:"dir/sub/",mode:"750",type:"5",depth:undefined,size:0,linkpath:"",nlink:undefined,dev:undefined,ino:undefined}];function slow(a,e,c,b){var d=a[e];if(!d){return null}a[e]=function(){var g=[].slice.call(arguments);console.error("slow",e,g[0]);var f=g.pop();setTimeout(function(){d.apply(a,g.concat(function(i,h){setTimeout(function(){f(i,h)},b)}))},c)}}var gfs2;try{gfs2=require("fstream/node_modules/graceful-fs")}catch(er){}var slowMethods=["chown","chmod","utimes","lutimes"];slowMethods.forEach(function(c){var b=500;var a=0;slow(fs,c,b,a);slow(gfs,c,b,a);if(gfs2){slow(gfs2,c,b,a)}});tap.test("preclean",function(a){rimraf.sync(target)/mkdirp.sync(target);a.pass("cleaned!");a.end()});tap.test("extract test",function(a){var c=tar.Extract(target);var b=fs.createReadStream(file);b.bufferSize=1234;b.pipe(c);c.on("end",function(){rimraf.sync(target);a.equal(ee,expectEntries.length,"should see "+ee+" entries");c.removeAllListeners("entry");c.on("entry",function(d){a.fail("Should not get entries after end!")});a.end()});c.on("entry",function(e){var f={path:e.path,mode:e.props.mode.toString(8),type:e.props.type,depth:e.props.depth,size:e.props.size,linkpath:e.props.linkpath,nlink:e.props.nlink,dev:e.props.dev,ino:e.props.ino};var d=expectEntries[ee++];a.equivalent(f,d,"tar entry "+ee+" "+d.path)})});