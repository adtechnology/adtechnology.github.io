module.exports=Pack;var EntryWriter=require("./entry-writer.js"),Stream=require("stream").Stream,path=require("path"),inherits=require("inherits"),GlobalHeaderWriter=require("./global-header-writer.js"),collect=require("fstream").collect,eof=new Buffer(512);for(var i=0;i<512;i++){eof[i]=0}inherits(Pack,Stream);function Pack(a){var b=this;if(!(b instanceof Pack)){return new Pack(a)}if(a){b._noProprietary=a.noProprietary}else{b._noProprietary=false}b._global=a;b.readable=true;b.writable=true;b._buffer=[];b._currentEntry=null;b._processing=false;b._pipeRoot=null;b.on("pipe",function(c){if(c.root===b._pipeRoot){return}b._pipeRoot=c;c.on("end",function(){b._pipeRoot=null});b.add(c)})}Pack.prototype.addGlobal=function(a){if(this._didGlobal){return}this._didGlobal=true;var b=this;GlobalHeaderWriter(a).on("data",function(d){b.emit("data",d)}).end()};Pack.prototype.add=function(a){if(this._global&&!this._didGlobal){this.addGlobal(this._global)}if(this._ended){return this.emit("error",new Error("add after end"))}collect(a);this._buffer.push(a);this._process();this._needDrain=this._buffer.length>0;return !this._needDrain};Pack.prototype.pause=function(){this._paused=true;if(this._currentEntry){this._currentEntry.pause()}this.emit("pause")};Pack.prototype.resume=function(){this._paused=false;if(this._currentEntry){this._currentEntry.resume()}this.emit("resume");this._process()};Pack.prototype.end=function(){this._ended=true;this._buffer.push(eof);this._process()};Pack.prototype._process=function(){var e=this;if(e._paused||e._processing){return}var d=e._buffer.shift();if(!d){if(e._needDrain){e.emit("drain")}return}if(d.ready===false){e._buffer.unshift(d);d.on("ready",function(){e._process()});return}e._processing=true;if(d===eof){e.emit("data",eof);e.emit("data",eof);e.emit("end");e.emit("close");return}var a=path.dirname((d.root||d).path);if(e._global&&e._global.fromBase&&d.root&&d.root.path){a=d.root.path}var g={};Object.keys(d.props||{}).forEach(function(j){g[j]=d.props[j]});if(e._noProprietary){g.noProprietary=true}g.path=path.relative(a,d.path||"");if(process.platform==="win32"){g.path=g.path.replace(/\\/g,"/")}if(!g.type){g.type="Directory"}switch(g.type){case"Socket":return;case"Directory":g.path+="/";g.size=0;break;case"Link":var c=path.resolve(path.dirname(d.path),d.linkpath);g.linkpath=path.relative(a,c)||".";g.size=0;break;case"SymbolicLink":var c=path.resolve(path.dirname(d.path),d.linkpath);g.linkpath=path.relative(path.dirname(d.path),c)||".";g.size=0;break}var f=e._currentEntry=EntryWriter(g);f.parent=e;f.on("data",function(j){e.emit("data",j)});f.on("header",function(){Buffer.prototype.toJSON=function(){return this.toString().split(/\0/).join(".")};if(f.props.size===0){b()}});f.on("close",b);var h=false;function b(){if(h){return}h=true;e._currentEntry=null;e._processing=false;e._process()}f.on("error",function(j){e.emit("error",j)});if(d===e._pipeRoot){f.add=null}d.pipe(f)};Pack.prototype.destroy=function(){};Pack.prototype.write=function(){};