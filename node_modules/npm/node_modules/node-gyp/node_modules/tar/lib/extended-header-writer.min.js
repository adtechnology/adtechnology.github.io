module.exports=ExtendedHeaderWriter;var inherits=require("inherits"),EntryWriter=require("./entry-writer.js");inherits(ExtendedHeaderWriter,EntryWriter);var tar=require("../tar.js"),path=require("path"),TarHeader=require("./header.js");function ExtendedHeaderWriter(a){var b=this;if(!(b instanceof ExtendedHeaderWriter)){return new ExtendedHeaderWriter(a)}b.fields=a;var c={path:("PaxHeader"+path.join("/",a.path||"")).replace(/\\/g,"/").substr(0,100),mode:a.mode||438,uid:a.uid||0,gid:a.gid||0,size:0,mtime:a.mtime||Date.now()/1000,type:"x",linkpath:"",ustar:"ustar\0",ustarver:"00",uname:a.uname||"",gname:a.gname||"",devmaj:a.devmaj||0,devmin:a.devmin||0};EntryWriter.call(b,c);b.props=c;b._meta=true}ExtendedHeaderWriter.prototype.end=function(){var a=this;if(a._ended){return}a._ended=true;a._encodeFields();if(a.props.size===0){a._ready=true;a._stream.end();return}a._stream.write(TarHeader.encode(a.props));a.body.forEach(function(b){a._stream.write(b)});a._ready=true;this._stream.end()};ExtendedHeaderWriter.prototype._encodeFields=function(){this.body=[];if(this.fields.prefix){this.fields.path=this.fields.prefix+"/"+this.fields.path;this.fields.prefix=""}encodeFields(this.fields,"",this.body,this.fields.noProprietary);var a=this;this.body.forEach(function(b){a.props.size+=b.length})};function encodeFields(b,c,a,d){Object.keys(b).forEach(function(e){var g=b[e],f=tar.numeric[e];if(c){e=c+"."+e}if(e===b.type&&g===true){return}switch(e){case"mode":case"cksum":case"ustar":case"ustarver":case"prefix":case"basename":case"dirname":case"needExtended":case"block":case"filter":return;case"rdev":if(g===0){return}break;case"nlink":case"dev":case"ino":e="SCHILY."+e;break;default:break}if(g&&typeof g==="object"&&!Buffer.isBuffer(g)){encodeFields(g,e,a,d)}else{if(g===null||g===undefined){return}else{a.push.apply(a,encodeField(e,g,d))}}});return a}function encodeField(d,c,h){if(d.charAt(0)===d.charAt(0).toLowerCase()){var b=d.split(".")[0];if(!tar.knownExtended[b]){d="NODETAR."+d}}if(h&&d.charAt(0)!==d.charAt(0).toLowerCase()){return[]}if(typeof val==="number"){val=val.toString(10)}var f=new Buffer(" "+d+"="+c+"\n"),g=Math.floor(Math.log(f.length)/Math.log(10))+1;if(f.length+g>=Math.pow(10,g)){g+=1}var a=g+f.length;var e=new Buffer(""+a);if(e.length+f.length!==a){throw new Error("Bad length calculation\nlen="+a+"\nlenBuf="+JSON.stringify(e.toString())+"\nlenBuf.length="+e.length+"\ndigits="+g+"\ns="+JSON.stringify(f.toString())+"\ns.length="+f.length)}return[e,f]};