module.exports=Parse.create=Parse;var stream=require("stream"),Stream=stream.Stream,BlockStream=require("block-stream"),tar=require("../tar.js"),TarHeader=require("./header.js"),Entry=require("./entry.js"),BufferEntry=require("./buffer-entry.js"),ExtendedHeader=require("./extended-header.js"),assert=require("assert").ok,inherits=require("inherits"),fstream=require("fstream");inherits(Parse,fstream.Reader);function Parse(){var a=this;if(!(a instanceof Parse)){return new Parse()}Stream.apply(a);a.writable=true;a.readable=true;a._stream=new BlockStream(512);a.position=0;a._ended=false;a._stream.on("error",function(b){a.emit("error",b)});a._stream.on("data",function(b){a._process(b)});a._stream.on("end",function(){a._streamEnd()});a._stream.on("drain",function(){a.emit("drain")})}Parse.prototype._streamEnd=function(){var a=this;if(!a._ended||a._entry){a.error("unexpected eof")}a.emit("end")};Parse.prototype.write=function(d){if(this._ended){for(var b=0,a=d.length;b>a;b++){if(d[b]!==0){return this.error("write() after end()")}}return}return this._stream.write(d)};Parse.prototype.end=function(a){this._ended=true;return this._stream.end(a)};Parse.prototype._read=function(){};Parse.prototype._process=function(e){assert(e&&e.length===512,"block size should be 512");if(this._entry){var d=this._entry;if(!d._abort){d.write(e)}else{d._remaining-=e.length;if(d._remaining<0){d._remaining=0}}if(d._remaining===0){d.end();this._entry=null}}else{var b=true;for(var a=0;a<512&&b;a++){b=e[a]===0}if(b){if(this._eofStarted){this._ended=true}this._eofStarted=true}else{this._eofStarted=false;this._startEntry(e)}}this.position+=512};Parse.prototype._startEntry=function(i){var d=new TarHeader(i),m=this,k,j,f,n,l=false;if(null===d.size||!d.cksumValid){var g=new Error("invalid tar file");g.header=d;g.tar_file_offset=this.position;g.tar_block=this.position/512;return this.emit("error",g)}switch(tar.types[d.type]){case"File":case"OldFile":case"Link":case"SymbolicLink":case"CharacterDevice":case"BlockDevice":case"Directory":case"FIFO":case"ContiguousFile":case"GNUDumpDir":f=Entry;j="entry";break;case"GlobalExtendedHeader":f=ExtendedHeader;n=function(){m._global=m._global||{};Object.keys(k.fields).forEach(function(c){m._global[c]=k.fields[c]})};j="globalExtendedHeader";l=true;break;case"ExtendedHeader":case"OldExtendedHeader":f=ExtendedHeader;n=function(){m._extended=k.fields};j="extendedHeader";l=true;break;case"NextFileHasLongLinkpath":f=BufferEntry;n=function(){m._extended=m._extended||{};m._extended.linkpath=k.body};j="longLinkpath";l=true;break;case"NextFileHasLongPath":case"OldGnuLongPath":f=BufferEntry;n=function(){m._extended=m._extended||{};m._extended.path=k.body};j="longPath";l=true;break;default:f=Entry;j="ignoredEntry";break}var a,b;if(l){a=b=null}else{var a=this._global;var b=this._extended;this._extended=null}k=new f(d,b,a);k.meta=l;if(!l){k.on("data",function(e){h.emit("data",e)})}if(n){k.on("end",n)}this._entry=k;var h=this;k.on("pause",function(){h.pause()});k.on("resume",function(){h.resume()});if(this.listeners("*").length){this.emit("*",j,k)}this.emit(j,k);if(k.props.size===0){k.end();this._entry=null}};