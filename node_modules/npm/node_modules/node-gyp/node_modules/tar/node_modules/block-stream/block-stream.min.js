module.exports=BlockStream;var Stream=require("stream").Stream,inherits=require("inherits"),assert=require("assert").ok,debug=process.env.DEBUG?console.error:function(){};function BlockStream(c,b){this.writable=this.readable=true;this._opt=b||{};this._chunkSize=c||512;this._offset=0;this._buffer=[];this._bufferLength=0;if(this._opt.nopad){this._zeroes=false}else{this._zeroes=new Buffer(this._chunkSize);for(var a=0;a<this._chunkSize;a++){this._zeroes[a]=0}}}inherits(BlockStream,Stream);BlockStream.prototype.write=function(a){if(this._ended){throw new Error("BlockStream: write after end")}if(a&&!Buffer.isBuffer(a)){a=new Buffer(a+"")}if(a.length){this._buffer.push(a);this._bufferLength+=a.length}if(this._bufferLength>=this._chunkSize){if(this._paused){this._needDrain=true;return false}this._emitChunk()}return true};BlockStream.prototype.pause=function(){this._paused=true};BlockStream.prototype.resume=function(){this._paused=false;return this._emitChunk()};BlockStream.prototype.end=function(a){if(typeof a==="function"){cb=a,a=null}if(a){this.write(a)}this._ended=true;this.flush()};BlockStream.prototype.flush=function(){this._emitChunk(true)};BlockStream.prototype._emitChunk=function(j){if(j&&this._zeroes){var k=(this._bufferLength%this._chunkSize);if(k!==0){k=this._chunkSize-k}if(k>0){this._buffer.push(this._zeroes.slice(0,k));this._bufferLength+=k}}if(this._emitting||this._paused){return}this._emitting=true;var b=0;while(this._bufferLength>=this._chunkSize&&(j||!this._paused)){var d,f=0,g=this._chunkSize;while(g>0&&(j||!this._paused)){var h=this._buffer[b],c=h.length-this._offset;if(d||c<g){d=d||new Buffer(this._chunkSize);h.copy(d,f,this._offset,this._offset+Math.min(c,g))}else{if(h.length===g&&this._offset===0){d=h}else{d=h.slice(this._offset,this._offset+g)}}if(c>g){this._offset+=g;g=0}else{g-=c;f+=c;b++;this._offset=0}}this._bufferLength-=this._chunkSize;assert(d.length===this._chunkSize);this.emit("data",d);d=null}this._buffer=this._buffer.slice(b);if(this._paused){this._needsDrain=true;this._emitting=false;return}var a=this._buffer.length;if(j&&!this._zeroes&&a){if(a===1){if(this._offset){this.emit("data",this._buffer[0].slice(this._offset))}else{this.emit("data",this._buffer[0])}}else{var g=this._bufferLength,d=new Buffer(g),f=0;for(var e=0;e<a;e++){var h=this._buffer[e],c=h.length-this._offset;h.copy(d,f,this._offset);this._offset=0;f+=c;this._bufferLength-=c}this.emit("data",d)}this._buffer.length=0;this._bufferLength=0;this._offset=0}if(this._needDrain){this._needDrain=false;this.emit("drain")}if((this._bufferLength===0)&&this._ended&&!this._endEmitted){this._endEmitted=true;this.emit("end")}this._emitting=false};