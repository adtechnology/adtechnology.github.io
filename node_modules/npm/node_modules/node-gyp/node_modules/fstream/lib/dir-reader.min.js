module.exports=DirReader;var fs=require("graceful-fs");var inherits=require("inherits");var path=require("path");var Reader=require("./reader.js");var assert=require("assert").ok;inherits(DirReader,Reader);function DirReader(b){var a=this;if(!(a instanceof DirReader)){throw new Error("DirReader must be called as constructor.")}if(b.type!=="Directory"||!b.Directory){throw new Error("Non-directory type "+b.type)}a.entries=null;a._index=-1;a._paused=false;a._length=-1;if(b.sort){this.sort=b.sort}Reader.call(this,b)}DirReader.prototype._getEntries=function(){var a=this;if(a._gotEntries){return}a._gotEntries=true;fs.readdir(a._path,function(d,b){if(d){return a.error(d)}a.entries=b;a.emit("entries",b);if(a._paused){a.once("resume",c)}else{c()}function c(){a._length=a.entries.length;if(typeof a.sort==="function"){a.entries=a.entries.sort(a.sort.bind(a))}a._read()}})};DirReader.prototype._read=function(){var a=this;if(!a.entries){return a._getEntries()}if(a._paused||a._currentEntry||a._aborted){return}a._index++;if(a._index>=a.entries.length){if(!a._ended){a._ended=true;a.emit("end");a.emit("close")}return}var b=path.resolve(a._path,a.entries[a._index]);assert(b!==a._path);assert(a.entries[a._index]);a._currentEntry=b;fs[a.props.follow?"stat":"lstat"](b,function(j,f){if(j){return a.error(j)}var e=a._proxy||a;f.path=b;f.basename=path.basename(b);f.dirname=path.dirname(b);var c=a.getChildProps.call(e,f);c.path=b;c.basename=path.basename(b);c.dirname=path.dirname(b);var g=Reader(c,f);a._currentEntry=g;g.on("pause",function(k){if(!a._paused&&!g._disowned){a.pause(k)}});g.on("resume",function(k){if(a._paused&&!g._disowned){a.resume(k)}});g.on("stat",function(k){a.emit("_entryStat",g,k);if(g._aborted){return}if(g._paused){g.once("resume",function(){a.emit("entryStat",g,k)})}else{a.emit("entryStat",g,k)}});g.on("ready",function d(){if(a._paused){g.pause(a);return a.once("resume",d)}if(g.type==="Socket"){a.emit("socket",g)}else{a.emitEntry(g)}});var i=false;g.on("close",h);g.on("disown",h);function h(){if(i){return}i=true;a.emit("childEnd",g);a.emit("entryEnd",g);a._currentEntry=null;if(!a._paused){a._read()}}g.on("error",function(k){if(g._swallowErrors){a.warn(k);g.emit("end");g.emit("close")}else{a.emit("error",k)}});["child","childEnd","warn"].forEach(function(k){g.on(k,a.emit.bind(a,k))})})};DirReader.prototype.disown=function(a){a.emit("beforeDisown");a._disowned=true;a.parent=a.root=null;if(a===this._currentEntry){this._currentEntry=null}a.emit("disown")};DirReader.prototype.getChildProps=function(){return{depth:this.depth+1,root:this.root||this,parent:this,follow:this.follow,filter:this.filter,sort:this.props.sort,hardlinks:this.props.hardlinks}};DirReader.prototype.pause=function(b){var a=this;if(a._paused){return}b=b||a;a._paused=true;if(a._currentEntry&&a._currentEntry.pause){a._currentEntry.pause(b)}a.emit("pause",b)};DirReader.prototype.resume=function(b){var a=this;if(!a._paused){return}b=b||a;a._paused=false;a.emit("resume",b);if(a._paused){return}if(a._currentEntry){if(a._currentEntry.resume){a._currentEntry.resume(b)}}else{a._read()}};DirReader.prototype.emitEntry=function(a){this.emit("entry",a);this.emit("child",a)};