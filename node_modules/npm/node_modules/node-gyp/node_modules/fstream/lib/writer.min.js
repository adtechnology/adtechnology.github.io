module.exports=Writer;var fs=require("graceful-fs");var inherits=require("inherits");var rimraf=require("rimraf");var mkdir=require("mkdirp");var path=require("path");var umask=process.platform==="win32"?0:process.umask();var getType=require("./get-type.js");var Abstract=require("./abstract.js");inherits(Writer,Abstract);Writer.dirmode=parseInt("0777",8)&(~umask);Writer.filemode=parseInt("0666",8)&(~umask);var DirWriter=require("./dir-writer.js");var LinkWriter=require("./link-writer.js");var FileWriter=require("./file-writer.js");var ProxyWriter=require("./proxy-writer.js");function Writer(c,e){var a=this;if(typeof c==="string"){c={path:c}}var b=getType(c);var d=Writer;switch(b){case"Directory":d=DirWriter;break;case"File":d=FileWriter;break;case"Link":case"SymbolicLink":d=LinkWriter;break;case null:default:d=ProxyWriter;break}if(!(a instanceof d)){return new d(c)}Abstract.call(a);if(!c.path){a.error("Must provide a path",null,true)}a.type=c.type;a.props=c;a.depth=c.depth||0;a.clobber=c.clobber===false?c.clobber:true;a.parent=c.parent||null;a.root=c.root||(c.parent&&c.parent.root)||a;a._path=a.path=path.resolve(c.path);if(process.platform==="win32"){a.path=a._path=a.path.replace(/\?/g,"_");if(a._path.length>=260){a._swallowErrors=true;a._path="\\\\?\\"+a.path.replace(/\//g,"\\")}}a.basename=path.basename(c.path);a.dirname=path.dirname(c.path);a.linkpath=c.linkpath||null;c.parent=c.root=null;a.size=c.size;if(typeof c.mode==="string"){c.mode=parseInt(c.mode,8)}a.readable=false;a.writable=true;a._buffer=[];a.ready=false;a.filter=typeof c.filter==="function"?c.filter:null;a._stat(e)}Writer.prototype._create=function(){var a=this;fs[a.props.follow?"stat":"lstat"](a._path,function(b){if(b){return a.warn("Cannot create "+a._path+"\nUnsupported type: "+a.type,"ENOTSUP")}a._finish()})};Writer.prototype._stat=function(f){var a=this;var d=a.props;var c=d.follow?"stat":"lstat";var b=a._proxy||a;if(f){e(null,f)}else{fs[c](a._path,e)}function e(i,h){if(a.filter&&!a.filter.call(b,b,h)){a._aborted=true;a.emit("end");a.emit("close");return}if(i||!h){return create(a)}a._old=h;var g=getType(h);if(g!==a.type){return rimraf(a._path,function(j){if(j){return a.error(j)}a._old=null;create(a)})}create(a)}};function create(a){mkdir(path.dirname(a._path),Writer.dirmode,function(c,b){if(c){return a.error(c)}a._madeDir=b;return a._create()})}function endChmod(c,d,g,f,b){var h=d.mode;var a=d.follow||c.type!=="SymbolicLink"?"chmod":"lchmod";if(!fs[a]){return b()}if(typeof h!=="number"){return b()}var e=g.mode&parseInt("0777",8);h=h&parseInt("0777",8);if(h===e){return b()}fs[a](f,h,b)}function endChown(b,c,e,d,a){if(process.platform==="win32"){return a()}if(!process.getuid||process.getuid()!==0){return a()}if(typeof c.uid!=="number"&&typeof c.gid!=="number"){return a()}if(e.uid===c.uid&&e.gid===c.gid){return a()}var f=(b.props.follow||b.type!=="SymbolicLink")?"chown":"lchown";if(!fs[f]){return a()}if(typeof c.uid!=="number"){c.uid=e.uid}if(typeof c.gid!=="number"){c.gid=e.gid}fs[f](d,c.uid,c.gid,a)}function endUtimes(i,g,d,j,c){if(!fs.utimes||process.platform==="win32"){return c()}var h=(g.follow||i.type!=="SymbolicLink")?"utimes":"lutimes";if(h==="lutimes"&&!fs[h]){h="utimes"}if(!fs[h]){return c()}var a=d.atime;var e=d.mtime;var f=g.atime;var b=g.mtime;if(f===undefined){f=a}if(b===undefined){b=e}if(!isDate(f)){f=new Date(f)}if(!isDate(b)){f=new Date(b)}if(f.getTime()===a.getTime()&&b.getTime()===e.getTime()){return c()}fs[h](j,f,b,c)}Writer.prototype._finish=function(){var c=this;if(c._finishing){return}c._finishing=true;var a=0;var g=null;var b=false;if(c._old){c._old.atime=new Date(0);c._old.mtime=new Date(0);f(c._old)}else{var e=c.props.follow?"stat":"lstat";fs[e](c._path,function(i,h){if(i){if(i.code==="ENOENT"&&(c.type==="Link"||c.type==="SymbolicLink")&&process.platform==="win32"){c.ready=true;c.emit("ready");c.emit("end");c.emit("close");c.end=c._finish=function(){};return}else{return c.error(i)}}f(c._old=h)})}return;function f(h){a+=3;endChmod(c,c.props,h,c._path,d("chmod"));endChown(c,c.props,h,c._path,d("chown"));endUtimes(c,c.props,h,c._path,d("utimes"))}function d(h){return function(j){if(g){return}if(j){j.fstream_finish_call=h;return c.error(g=j)}if(--a>0){return}if(b){return}b=true;if(!c._madeDir){return i()}else{endMadeDir(c,c._path,i)}function i(k){if(k){k.fstream_finish_call="setupMadeDir";return c.error(k)}c.emit("end");c.emit("close")}}}};function endMadeDir(b,c,a){var f=b._madeDir;var e=path.dirname(c);endMadeDir_(b,e,function(d){if(d){return a(d)}if(e===f){return a()}endMadeDir(b,e,a)})}function endMadeDir_(c,f,b){var e={};Object.keys(c.props).forEach(function(h){e[h]=c.props[h];if(h==="mode"&&c.type!=="Directory"){e[h]=e[h]|parseInt("0111",8)}});var a=3;var g=null;fs.stat(f,function(i,h){if(i){return b(g=i)}endChmod(c,e,h,f,d);endChown(c,e,h,f,d);endUtimes(c,e,h,f,d)});function d(h){if(g){return}if(h){return b(g=h)}if(--a===0){return b()}}}Writer.prototype.pipe=function(){this.error("Can't pipe from writable stream")};Writer.prototype.add=function(){this.error("Can't add to non-Directory type")};Writer.prototype.write=function(){return true};function objectToString(a){return Object.prototype.toString.call(a)}function isDate(a){return typeof a==="object"&&objectToString(a)==="[object Date]"};