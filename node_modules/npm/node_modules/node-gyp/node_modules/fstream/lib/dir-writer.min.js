module.exports=DirWriter;var Writer=require("./writer.js");var inherits=require("inherits");var mkdir=require("mkdirp");var path=require("path");var collect=require("./collect.js");inherits(DirWriter,Writer);function DirWriter(b){var a=this;if(!(a instanceof DirWriter)){a.error("DirWriter must be called as constructor.",null,true)}if(b.type!=="Directory"||!b.Directory){a.error("Non-directory type "+b.type+" "+JSON.stringify(b),null,true)}Writer.call(this,b)}DirWriter.prototype._create=function(){var a=this;mkdir(a._path,Writer.dirmode,function(b){if(b){return a.error(b)}a.ready=true;a.emit("ready");a._process()})};DirWriter.prototype.write=function(){return true};DirWriter.prototype.end=function(){this._ended=true;this._process()};DirWriter.prototype.add=function(b){var a=this;collect(b);if(!a.ready||a._currentEntry){a._buffer.push(b);return false}if(a._ended){return a.error("add after end")}a._buffer.push(b);a._process();return this._buffer.length===0};DirWriter.prototype._process=function(){var b=this;if(b._processing){return}var d=b._buffer.shift();if(!d){b.emit("drain");if(b._ended){b._finish()}return}b._processing=true;b.emit("entry",d);var f=d;var a;do{a=f._path||f.path;if(a===b.root._path||a===b._path||(a&&a.indexOf(b._path)===0)){b._processing=false;if(d._collected){d.pipe()}return b._process()}f=f.parent}while(f);var c={parent:b,root:b.root||b,type:d.type,depth:b.depth+1};a=d._path||d.path||d.props.path;if(d.parent){a=a.substr(d.parent._path.length+1)}c.path=path.join(b.path,path.join("/",a));c.filter=b.filter;Object.keys(d.props).forEach(function(i){if(!c.hasOwnProperty(i)){c[i]=d.props[i]}});var h=b._currentChild=new Writer(c);h.on("ready",function(){d.pipe(h);d.resume()});h.on("error",function(i){if(h._swallowErrors){b.warn(i);h.emit("end");h.emit("close")}else{b.emit("error",i)}});h.on("close",e);var g=false;function e(){if(g){return}g=true;b._currentChild=null;b._processing=false;b._process()}};