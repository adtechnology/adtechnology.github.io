var debug=process.env.DEBUG_NOPT||process.env.NOPT_DEBUG?function(){console.error.apply(console,arguments)}:function(){};var url=require("url"),path=require("path"),Stream=require("stream").Stream,abbrev=require("abbrev");module.exports=exports=nopt;exports.clean=clean;exports.typeDefs={String:{type:String,validate:validateString},Boolean:{type:Boolean,validate:validateBoolean},url:{type:url,validate:validateUrl},Number:{type:Number,validate:validateNumber},path:{type:path,validate:validatePath},Stream:{type:Stream,validate:validateStream},Date:{type:Date,validate:validateDate}};function nopt(f,c,g,h){g=g||process.argv;f=f||{};c=c||{};if(typeof h!=="number"){h=2}debug(f,c,g,h);g=g.slice(h);var b={},i,d=[],e=g,a=g.slice(0);parse(g,b,d,f,c);clean(b,f,exports.typeDefs);b.argv={remain:d,cooked:e,original:a};Object.defineProperty(b.argv,"toString",{value:function(){return this.original.map(JSON.stringify).join(" ")},enumerable:false});return b}function clean(c,b,e){e=e||exports.typeDefs;var a={},d=[false,true,null,String,Array];Object.keys(c).forEach(function(g){if(g==="argv"){return}var i=c[g],f=Array.isArray(i),h=b[g];if(!f){i=[i]}if(!h){h=d}if(h===Array){h=d.concat(Array)}if(!Array.isArray(h)){h=[h]}debug("val=%j",i);debug("types=",h);i=i.map(function(k){if(typeof k==="string"){debug("string %j",k);k=k.trim();if((k==="null"&&~h.indexOf(null))||(k==="true"&&(~h.indexOf(true)||~h.indexOf(Boolean)))||(k==="false"&&(~h.indexOf(false)||~h.indexOf(Boolean)))){k=JSON.parse(k);debug("jsonable %j",k)}else{if(~h.indexOf(Number)&&!isNaN(k)){debug("convert to number",k);k=+k}else{if(~h.indexOf(Date)&&!isNaN(Date.parse(k))){debug("convert to date",k);k=new Date(k)}}}}if(!b.hasOwnProperty(g)){return k}if(k===false&&~h.indexOf(null)&&!(~h.indexOf(false)||~h.indexOf(Boolean))){k=null}var j={};j[g]=k;debug("prevalidated val",j,k,b[g]);if(!validate(j,g,k,b[g],e)){if(exports.invalidHandler){exports.invalidHandler(g,k,b[g],c)}else{if(exports.invalidHandler!==false){debug("invalid: "+g+"="+k,b[g])}}return a}debug("validated val",j,k,b[g]);return j[g]}).filter(function(j){return j!==a});if(!i.length){delete c[g]}else{if(f){debug(f,c[g],i);c[g]=i}else{c[g]=i[0]}}debug("k=%s val=%j",g,i,c[g])})}function validateString(b,a,c){b[a]=String(c)}function validatePath(b,a,c){if(c===true){return false}if(c===null){return true}c=String(c);var d=process.platform==="win32"?/^~(\/|\\)/:/^~\//;if(c.match(d)&&process.env.HOME){c=path.resolve(process.env.HOME,c.substr(2))}b[a]=path.resolve(String(c));return true}function validateNumber(b,a,c){debug("validate Number %j %j %j",a,c,isNaN(c));if(isNaN(c)){return false}b[a]=+c}function validateDate(c,a,d){debug("validate Date %j %j %j",a,d,Date.parse(d));var b=Date.parse(d);if(isNaN(b)){return false}c[a]=new Date(d)}function validateBoolean(b,a,c){if(c instanceof Boolean){c=c.valueOf()}else{if(typeof c==="string"){if(!isNaN(c)){c=!!(+c)}else{if(c==="null"||c==="false"){c=false}else{c=true}}}else{c=!!c}}b[a]=c}function validateUrl(b,a,c){c=url.parse(String(c));if(!c.host){return false}b[a]=c.href}function validateStream(b,a,c){if(!(c instanceof Stream)){return false}b[a]=c}function validate(f,e,b,m,a){if(Array.isArray(m)){for(var g=0,c=m.length;g<c;g++){if(m[g]===Array){continue}if(validate(f,e,b,m[g],a)){return true}}delete f[e];return false}if(m===Array){return true}if(m!==m){debug("Poison NaN",e,b,m);delete f[e];return false}if(b===m){debug("Explicitly allowed %j",b);f[e]=b;return true}var n=false,h=Object.keys(a);for(var g=0,c=h.length;g<c;g++){debug("test type %j %j %j",e,b,h[g]);var o=a[h[g]];if(o&&((m&&m.name&&o.type&&o.type.name)?(m.name===o.type.name):(m===o.type))){var j={};n=false!==o.validate(j,e,b);b=j[e];if(n){f[e]=b;break}}}debug("OK? %j (%j %j %j)",n,e,b,h[g]);if(!n){delete f[e]}return n}function parse(c,q,k,h,f){debug("parse",c,q,k);var r=null,n=abbrev(Object.keys(h)),p=abbrev(Object.keys(f));for(var o=0;o<c.length;o++){var d=c[o];debug("arg",d);if(d.match(/^-{2,}$/)){k.push.apply(k,c.slice(o+1));c[o]="--";break}var a=false;if(d.charAt(0)==="-"&&d.length>1){if(d.indexOf("=")!==-1){a=true;var g=d.split("=");d=g.shift();g=g.join("=");c.splice.apply(c,[o,1].concat([d,g]))}var m=resolveShort(d,f,p,n);debug("arg=%j shRes=%j",d,m);if(m){debug(d,m);c.splice.apply(c,[o,1].concat(m));if(d!==m[0]){o--;continue}}d=d.replace(/^-+/,"");var b=null;while(d.toLowerCase().indexOf("no-")===0){b=!b;d=d.substr(3)}if(n[d]){d=n[d]}var e=h[d]===Array||Array.isArray(h[d])&&h[d].indexOf(Array)!==-1;if(!h.hasOwnProperty(d)&&q.hasOwnProperty(d)){if(!Array.isArray(q[d])){q[d]=[q[d]]}e=true}var s,l=c[o+1];var j=typeof b==="boolean"||h[d]===Boolean||Array.isArray(h[d])&&h[d].indexOf(Boolean)!==-1||(typeof h[d]==="undefined"&&!a)||(l==="false"&&(h[d]===null||Array.isArray(h[d])&&~h[d].indexOf(null)));if(j){s=!b;if(l==="true"||l==="false"){s=JSON.parse(l);l=null;if(b){s=!s}o++}if(Array.isArray(h[d])&&l){if(~h[d].indexOf(l)){s=l;o++}else{if(l==="null"&&~h[d].indexOf(null)){s=null;o++}else{if(!l.match(/^-{2,}[^-]/)&&!isNaN(l)&&~h[d].indexOf(Number)){s=+l;o++}else{if(!l.match(/^-[^-]/)&&~h[d].indexOf(String)){s=l;o++}}}}}if(e){(q[d]=q[d]||[]).push(s)}else{q[d]=s}continue}if(h[d]===String&&l===undefined){l=""}if(l&&l.match(/^-{2,}$/)){l=undefined;o--}s=l===undefined?true:l;if(e){(q[d]=q[d]||[]).push(s)}else{q[d]=s}o++;continue}k.push(d)}}function resolveShort(b,c,a,f){b=b.replace(/^-+/,"");if(f[b]===b){return null}if(c[b]){if(c[b]&&!Array.isArray(c[b])){c[b]=c[b].split(/\s+/)}return c[b]}var e=c.___singles;if(!e){e=Object.keys(c).filter(function(g){return g.length===1}).reduce(function(g,h){g[h]=true;return g},{});c.___singles=e;debug("shorthand singles",e)}var d=b.split("").filter(function(g){return e[g]});if(d.join("")===b){return d.map(function(g){return c[g]}).reduce(function(g,h){return g.concat(h)},[])}if(f[b]&&!c[b]){return null}if(a[b]){b=a[b]}if(c[b]&&!Array.isArray(c[b])){c[b]=c[b].split(/\s+/)}return c[b]};