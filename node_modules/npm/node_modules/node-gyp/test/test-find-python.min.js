"use strict";var test=require("tape");var path=require("path");var configure=require("../lib/configure");var execFile=require("child_process").execFile;var PythonFinder=configure.test.PythonFinder;test("find python",function(a){a.plan(4);configure.test.findPython("python",function(c,d){a.strictEqual(c,null);var b=execFile(d,["-V"],function(g,e,f){a.strictEqual(g,null);a.strictEqual(e,"");a.ok(/Python 2/.test(f))});b.stdout.setEncoding("utf-8");b.stderr.setEncoding("utf-8")})});function poison(b,c){function a(){throw new Error("Property "+c+" should not have been accessed.")}var d={configurable:true,enumerable:false,writable:true,getter:a,setter:a};Object.defineProperty(b,c,d)}var resolve=path.win32&&path.win32.resolve||function(){function a(b){return b.replace(/\\+$/,"")}return[].slice.call(arguments).map(a).join("\\")};function TestPythonFinder(){PythonFinder.apply(this,arguments)}TestPythonFinder.prototype=Object.create(PythonFinder.prototype);poison(TestPythonFinder.prototype,"env");poison(TestPythonFinder.prototype,"execFile");poison(TestPythonFinder.prototype,"resolve");poison(TestPythonFinder.prototype,"stat");poison(TestPythonFinder.prototype,"which");poison(TestPythonFinder.prototype,"win");test("find python - python",function(b){b.plan(5);var c=new TestPythonFinder("python",a);c.which=function(e,d){b.strictEqual(e,"python");d(null,e)};c.execFile=function(e,f,g,d){b.strictEqual(e,"python");b.ok(/import platform/.test(f[1]));d(null,"2.7.0")};c.checkPython();function a(d,e){b.strictEqual(d,null);b.strictEqual(e,"python")}});test("find python - python too old",function(b){b.plan(4);var c=new TestPythonFinder("python",a);c.which=function(e,d){b.strictEqual(e,"python");d(null,e)};c.execFile=function(e,f,g,d){b.strictEqual(e,"python");b.ok(/import platform/.test(f[1]));d(null,"2.3.4")};c.checkPython();function a(d,e){b.ok(/is not supported by gyp/.test(d))}});test("find python - python too new",function(b){b.plan(4);var c=new TestPythonFinder("python",a);c.which=function(e,d){b.strictEqual(e,"python");d(null,e)};c.execFile=function(e,f,g,d){b.strictEqual(e,"python");b.ok(/import platform/.test(f[1]));d(null,"3.0.0")};c.checkPython();function a(d,e){b.ok(/is not supported by gyp/.test(d))}});test("find python - no python",function(b){b.plan(2);var c=new TestPythonFinder("python",a);c.which=function(e,d){b.strictEqual(e,"python");d(new Error("not found"))};c.checkPython();function a(d,e){b.ok(/Can't find Python executable/.test(d))}});test("find python - no python2",function(b){b.plan(6);var c=new TestPythonFinder("python2",a);c.which=function(e,d){c.which=function(g,f){b.strictEqual(g,"python");f(null,g)};b.strictEqual(e,"python2");d(new Error("not found"))};c.execFile=function(e,f,g,d){b.strictEqual(e,"python");b.ok(/import platform/.test(f[1]));d(null,"2.7.0")};c.checkPython();function a(d,e){b.strictEqual(d,null);b.strictEqual(e,"python")}});test("find python - no python2, no python, unix",function(b){b.plan(3);var c=new TestPythonFinder("python2",a);poison(c,"checkPythonLauncher");c.win=false;c.which=function(e,d){c.which=function(g,f){b.strictEqual(g,"python");f(new Error("not found"))};b.strictEqual(e,"python2");d(new Error("not found"))};c.checkPython();function a(d,e){b.ok(/Can't find Python executable/.test(d))}});test("find python - no python, use python launcher",function(b){b.plan(8);var c=new TestPythonFinder("python",a);c.env={};c.win=true;c.which=function(e,d){b.strictEqual(e,"python");d(new Error("not found"))};c.execFile=function(e,f,g,d){c.execFile=function(i,j,k,h){b.strictEqual(i,"Z:\\snake.exe");b.ok(/import platform/.test(j[1]));h(null,"2.7.0")};b.strictEqual(e,"py.exe");b.notEqual(f.indexOf("-2"),-1);b.notEqual(f.indexOf("-c"),-1);d(null,"Z:\\snake.exe")};c.checkPython();function a(d,e){b.strictEqual(d,null);b.strictEqual(e,"Z:\\snake.exe")}});test("find python - python 3, use python launcher",function(b){b.plan(10);var c=new TestPythonFinder("python",a);c.env={};c.win=true;c.which=function(e,d){b.strictEqual(e,"python");d(null,e)};c.execFile=function(e,f,g,d){c.execFile=function(i,j,k,h){c.execFile=function(m,n,o,l){b.strictEqual(m,"Z:\\snake.exe");b.ok(/import platform/.test(n[1]));l(null,"2.7.0")};b.strictEqual(i,"py.exe");b.notEqual(j.indexOf("-2"),-1);b.notEqual(j.indexOf("-c"),-1);h(null,"Z:\\snake.exe")};b.strictEqual(e,"python");b.ok(/import platform/.test(f[1]));d(null,"3.0.0")};c.checkPython();function a(d,e){b.strictEqual(d,null);b.strictEqual(e,"Z:\\snake.exe")}});test("find python - python 3, use python launcher, python 2 too old",function(b){b.plan(9);var c=new TestPythonFinder("python",a);c.checkedPythonLauncher=false;c.env={};c.win=true;c.which=function(e,d){b.strictEqual(e,"python");d(null,e)};c.execFile=function(e,f,g,d){c.execFile=function(i,j,k,h){c.execFile=function(m,n,o,l){b.strictEqual(m,"Z:\\snake.exe");b.ok(/import platform/.test(n[1]));l(null,"2.3.4")};b.strictEqual(i,"py.exe");b.notEqual(j.indexOf("-2"),-1);b.notEqual(j.indexOf("-c"),-1);h(null,"Z:\\snake.exe")};b.strictEqual(e,"python");b.ok(/import platform/.test(f[1]));d(null,"3.0.0")};c.checkPython();function a(d,e){b.ok(/is not supported by gyp/.test(d))}});test("find python - no python, no python launcher, good guess",function(b){b.plan(6);var c=/C:[\\\/]Python27[\\\/]python[.]exe/;var d=new TestPythonFinder("python",a);d.env={};d.win=true;d.which=function(f,e){b.strictEqual(f,"python");e(new Error("not found"))};d.execFile=function(f,g,h,e){d.execFile=function(j,k,l,i){b.ok(c.test(j));b.ok(/import platform/.test(k[1]));i(null,"2.7.0")};b.strictEqual(f,"py.exe");e(new Error("not found"))};d.resolve=resolve;d.stat=function(f,e){b.ok(c.test(f));e(null,{})};d.checkPython();function a(e,f){b.ok(c.test(f))}});test("find python - no python, no python launcher, bad guess",function(b){b.plan(4);var c=new TestPythonFinder("python",a);c.env={SystemDrive:"Z:\\"};c.win=true;c.which=function(e,d){b.strictEqual(e,"python");d(new Error("not found"))};c.execFile=function(e,f,g,d){b.strictEqual(e,"py.exe");d(new Error("not found"))};c.resolve=resolve;c.stat=function(f,d){b.ok(/Z:[\\\/]Python27[\\\/]python.exe/.test(f));var e=new Error("not found");e.code="ENOENT";d(e)};c.checkPython();function a(d,e){b.ok(/Can't find Python executable/.test(d))}});