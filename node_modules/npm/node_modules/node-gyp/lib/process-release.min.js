var semver=require("semver"),url=require("url"),path=require("path"),log=require("npmlog"),headersTarballRange=">= 3.0.0 || ~0.12.10 || ~0.10.42",bitsre=/\/win-(x86|x64)\//,bitsreV3=/\/win-(x86|ia32|x64)\//;function processRelease(i,h,p,e){var k=(semver.valid(i[0])&&i[0])||h.opts.target||p,a=semver.parse(k),m=h.opts["dist-url"]||h.opts.disturl,b,g,d,f,j,c,o,l,n;if(!a){return{version:k}}k=a.version;b=k===semver.parse(p).version;if(!b){e=null}if(e){d=e.name.replace(/io\.js/,"iojs");g=d==="iojs"}else{g=a.major>=1&&a.major<4;d=g?"iojs":"node"}if(!m){if(g){if(process.env.IOJS_ORG_MIRROR){m=process.env.IOJS_ORG_MIRROR}else{if(process.env.NVM_IOJS_ORG_MIRROR){m=process.env.NVM_IOJS_ORG_MIRROR;log.warn("download","NVM_IOJS_ORG_MIRROR is deprecated and will be removed in node-gyp v4, please use IOJS_ORG_MIRROR")}}}else{if(process.env.NODEJS_ORG_MIRROR){m=process.env.NODEJS_ORG_MIRROR}else{if(process.env.NVM_NODEJS_ORG_MIRROR){m=process.env.NVM_NODEJS_ORG_MIRROR;log.warn("download","NVM_NODEJS_ORG_MIRROR is deprecated and will be removed in node-gyp v4, please use NODEJS_ORG_MIRROR")}}}}if(m){log.verbose("download","using dist-url",m)}if(m){f=m.replace(/\/+$/,"")}else{f=g?"https://iojs.org/download/release":"https://nodejs.org/dist"}f+="/v"+k+"/";if(e&&e.headersUrl&&!m){j=url.resolve(e.headersUrl,"./");c=resolveLibUrl(d,e.libUrl||j||f,"x86",a.major);o=resolveLibUrl(d,e.libUrl||j||f,"x64",a.major);return{version:k,semver:a,name:d,baseUrl:j,tarballUrl:e.headersUrl,shasumsUrl:url.resolve(j,"SHASUMS256.txt"),versionDir:(d!=="node"?d+"-":"")+k,libUrl32:c,libUrl64:o,libPath32:normalizePath(path.relative(url.parse(j).path,url.parse(c).path)),libPath64:normalizePath(path.relative(url.parse(j).path,url.parse(o).path))}}j=f;c=resolveLibUrl(d,j,"x86",a.major);o=resolveLibUrl(d,j,"x64",a.major);n=semver.satisfies(a,headersTarballRange);l=url.resolve(j,d+"-v"+k+(n?"-headers":"")+".tar.gz");return{version:k,semver:a,name:d,baseUrl:j,tarballUrl:l,shasumsUrl:url.resolve(j,"SHASUMS256.txt"),versionDir:(d!=="node"?d+"-":"")+k,libUrl32:c,libUrl64:o,libPath32:normalizePath(path.relative(url.parse(j).path,url.parse(c).path)),libPath64:normalizePath(path.relative(url.parse(j).path,url.parse(o).path))}}function normalizePath(a){return path.normalize(a).replace(/\\/g,"/")}function resolveLibUrl(a,c,d,f){var e=url.resolve(c,"./"),b=bitsre.test(c)||(f===3&&bitsreV3.test(c));if(!b){if(f>=1){return url.resolve(e,"win-"+d+"/"+a+".lib")}return url.resolve(e,(d==="x64"?"x64/":"")+a+".lib")}return c.replace(f===3?bitsreV3:bitsre,"/win-"+d+"/")}module.exports=processRelease;