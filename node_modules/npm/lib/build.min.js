var npm=require("./npm.js");var log=require("npmlog");var chain=require("slide").chain;var path=require("path");var fs=require("graceful-fs");var lifecycle=require("./utils/lifecycle.js");var readJson=require("read-package-json");var binLinks=require("bin-links");var binLinksConfig=require("./config/bin-links.js");var ini=require("ini");var writeFile=require("write-file-atomic");module.exports=build;build.usage="npm build [<folder>]";build._didBuild={};build._noLC={};function build(c,f,e,d,a){if(typeof a!=="function"){a=d;d=false}if(typeof a!=="function"){a=e;e=false}if(typeof a!=="function"){a=f;f=npm.config.get("global")}if(!c.length){readJson(path.resolve(npm.localPrefix,"package.json"),function(h,g){if(!c.length&&g&&g.scripts&&g.scripts.build){log.warn("build","`npm build` called with no arguments. Did you mean to `npm run-script build`?")}a()})}else{var b=build_(f,e,d);chain(c.map(function(g){return function(h){b(g,h)}}),a)}}function build_(c,b,a){return function(e,d){e=path.resolve(e);if(build._didBuild[e]){log.info("build","already built",e)}build._didBuild[e]=true;log.info("build",e);readJson(path.resolve(e,"package.json"),function(g,f){if(g){return d(g)}chain([!b&&[lifecycle,f,"preinstall",e],[linkStuff,f,e,c],!a&&[rebuildBundles,f,e],[writeBuiltinConf,f,e],b!==build._noLC&&[lifecycle,f,"install",e],b!==build._noLC&&[lifecycle,f,"postinstall",e]],d)})}}var writeBuiltinConf=build.writeBuiltinConf=function(c,e,a){var d=path.dirname(e);var b=npm.globalDir;if((c.name!=="npm"&&c.name!=="npmc")||!npm.config.get("global")||!npm.config.usingBuiltin||b!==d){return a()}var f=ini.stringify(npm.config.sources.builtin.data);writeFile(path.resolve(e,"npmrc"),f,a)};var linkStuff=build.linkStuff=function(b,d,c,a){if(npm.config.get("bin-links")===false){return a()}return binLinks(b,d,c,binLinksConfig(b),a)};function rebuildBundles(c,d,a){if(!npm.config.get("rebuild-bundle")){return a()}var e=Object.keys(c.dependencies||{}).concat(Object.keys(c.devDependencies||{}));var b=c.bundleDependencies||c.bundledDependencies||[];fs.readdir(path.resolve(d,"node_modules"),function(g,f){if(g){return a()}log.verbose("rebuildBundles",f);chain(f.filter(function(h){return !h.match(/^[._-]/)&&h.indexOf("@")===-1&&(e.indexOf(h)===-1||b.indexOf(h)!==-1)}).map(function(h){h=path.resolve(d,"node_modules",h);return function(i){if(build._didBuild[h]){return i()}log.verbose("rebuild bundle",h);fs.lstat(path.resolve(h,"package.json"),function(j){if(j){return i()}build_(false)(h,i)})}}),a)})};