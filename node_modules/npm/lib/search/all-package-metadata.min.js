"use strict";var fs=require("graceful-fs");var path=require("path");var mkdir=require("mkdirp");var chownr=require("chownr");var npm=require("../npm.js");var log=require("npmlog");var cacheFile=require("npm-cache-filename");var correctMkdir=require("../utils/correct-mkdir.js");var mapToRegistry=require("../utils/map-to-registry.js");var jsonstream=require("JSONStream");var writeStreamAtomic=require("fs-write-stream-atomic");var ms=require("mississippi");var sortedUnionStream=require("sorted-union-stream");var once=require("once");var gunzip=require("../utils/gunzip-maybe");module.exports=allPackageMetadata;function allPackageMetadata(b){var a=ms.through.obj();mapToRegistry("-/all",npm.config,function(g,f,e){if(g){return a.emit("error",g)}var c=cacheFile(npm.config.get("cache"))(f);var d=path.join(c,".cache.json");createEntryStream(d,f,e,b,function(k,i,h,j){if(k){return a.emit("error",k)}log.silly("all-package-metadata","entry stream created");if(i&&j){createCacheWriteStream(d,h,function(m,l){if(m){return a.emit("error",m)}log.silly("all-package-metadata","output stream created");ms.pipeline.obj(i,l,a)})}else{if(i){ms.pipeline.obj(i,a)}else{a.emit("error",new Error("No search sources available"))}}})});return a}module.exports._createEntryStream=createEntryStream;function createEntryStream(b,d,c,e,a){createCacheEntryStream(b,function(h,f,g){g=g||0;if(h){log.warn("","Failed to read search cache. Rebuilding");log.silly("all-package-metadata","cache read error: ",h)}createEntryUpdateStream(d,c,e,g,function(j,k,l){l=l||0;var i=l||g;if(!f&&!k){return a(new Error("No search sources available"))}if(j){log.warn("","Search data request failed, search might be stale");log.silly("all-package-metadata","update request error: ",j)}if(f&&k){a(null,createMergedStream(f,k),i,!!l)}else{a(null,f||k,i,!!l)}})})}module.exports._createMergedStream=createMergedStream;function createMergedStream(d,c){linkStreams(d,c);return sortedUnionStream(c,d,function(a){return a.name})}module.exports._createCacheEntryStream=createCacheEntryStream;function createCacheEntryStream(b,a){log.verbose("all-package-metadata","creating entry stream from local cache");log.verbose("all-package-metadata",b);fs.stat(b,function(e,d){if(e){return a(e)}var c=ms.pipeline.obj(fs.createReadStream(b),jsonstream.parse("*"),ms.through.obj());extractUpdated(c,"cached-entry-stream",a)})}module.exports._createEntryUpdateStream=createEntryUpdateStream;function createEntryUpdateStream(c,e,g,b,a){log.verbose("all-package-metadata","creating remote entry stream");var f={timeout:600,follow:true,staleOk:true,auth:e,streaming:true};var d=false;if(b&&(Date.now()-b<(g*1000))){log.verbose("all-package-metadata","Local data up to date, skipping update");return a(null)}else{if(b===0){log.warn("","Building the local index for the first time, please be patient");log.verbose("all-package-metadata","No cached data: requesting full metadata db")}else{log.verbose("all-package-metadata","Cached data present with timestamp:",b,"requesting partial index update");c+="/since?stale=update_after&startkey="+b;d=true}}npm.registry.request(c,f,function(j,i){if(j){return a(j)}log.silly("all-package-metadata","request stream opened, code:",i.statusCode);var h=ms.pipeline.obj(i,ms.through(function(m,l,k){k(null,m)}),gunzip(),jsonstream.parse("*",function(k,l){if(l[0]==="_updated"||l[0][0]!=="_"){return k}}));if(d){a(null,h,Date.parse(i.headers.date))}else{extractUpdated(h,"entry-update-stream",a)}})}function extractUpdated(d,c,a){a=once(a);log.silly("all-package-metadata","extracting latest");function f(g){return function(){log.warn("all-package-metadata",c,g);d.removeAllListeners();d.destroy();a(new Error(g))}}var e=f("Failed to read stream");var b=f("Empty or invalid stream");d.on("error",e);d.on("end",b);d.once("data",function(g){log.silly("all-package-metadata","got first stream entry for",c,g);d.removeListener("error",e);d.removeListener("end",b);d.pause();if(typeof g==="number"){a(null,ms.pipeline.obj(d,ms.through.obj()),g)}else{a(new Error("expected first entry to be _updated"))}})}module.exports._createCacheWriteStream=createCacheWriteStream;function createCacheWriteStream(c,b,a){_ensureCacheDirExists(c,function(h){if(h){return a(h)}log.silly("all-package-metadata","creating output stream");var g=_createCacheOutStream();var d=writeStreamAtomic(c);var f=_createCacheInStream(d,g,b);var e=false;linkStreams(f,g,function(){e=true});d.on("close",function(){!e&&g.end()});a(null,ms.duplex.obj(f,g))})}function _ensureCacheDirExists(c,a){var b=path.dirname(c);log.silly("all-package-metadata","making sure cache dir exists at",b);correctMkdir(npm.cache,function(e,d){if(e){return a(e)}mkdir(b,function(g,f){if(g){return a(g)}chownr(f||b,d.uid,d.gid,a)})})}function _createCacheOutStream(){return ms.pipeline.obj(ms.through(),jsonstream.parse("*",function(b,a){if(typeof b==="object"){return b}}),ms.through.obj())}function _createCacheInStream(e,d,b){var a=false;var c=ms.pipeline.obj(ms.through.obj(function(h,g,f){if(!a&&typeof h==="number"){a=true;return f(null,["_updated",h])}else{if(typeof h!=="object"){this.emit("error",new Error("invalid value written to input stream"))}else{f(null,[h.name,h])}}}),jsonstream.stringifyObject("{",",","}"),ms.through(function(h,g,f){d.write(h,g,function(){f(null,h)})}),e);c.write(b);return c}function linkStreams(e,d,c){var f=null;e.on("error",function(a){if(a!==f){f=a;d.emit("error",a);c(a)}});d.on("error",function(a){if(a!==f){f=a;e.emit("error",a);c(a)}})};