"use strict";var npm=require("../npm.js");var log=require("npmlog");var mapToRegistry=require("../utils/map-to-registry.js");var jsonstream=require("JSONStream");var ms=require("mississippi");var gunzip=require("../utils/gunzip-maybe");module.exports=esearch;function esearch(a){var b=ms.through.obj();mapToRegistry("-/v1/search",npm.config,function(e,d,c){if(e){return b.emit("error",e)}createResultStream(d,c,a,function(g,f){if(g){return b.emit("error",g)}ms.pipeline.obj(f,b)})});return b}function createResultStream(d,c,b,a){log.verbose("esearch","creating remote entry stream");var f={timeout:600,follow:true,staleOk:true,auth:c,streaming:true};var e=buildQuery(b);npm.registry.request(d+"?text="+encodeURIComponent(e)+"&size="+b.limit,f,function(i,h){if(i){return a(i)}log.silly("esearch","request stream opened, code:",h.statusCode);var g=ms.pipeline.obj(h,ms.through(function(l,k,j){j(null,l)}),gunzip(),jsonstream.parse("objects.*.package",function(j){return{name:j.name,description:j.description,maintainers:j.maintainers,keywords:j.keywords,version:j.version,date:j.date?new Date(j.date):null}}));return a(null,g)})}function buildQuery(a){return a.include.join(" ")};