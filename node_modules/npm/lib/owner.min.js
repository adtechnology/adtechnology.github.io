module.exports=owner;var npm=require("./npm.js");var log=require("npmlog");var mapToRegistry=require("./utils/map-to-registry.js");var readLocalPkg=require("./utils/read-local-package.js");var usage=require("./utils/usage");var output=require("./utils/output.js");owner.usage=usage("owner","npm owner add <user> [<@scope>/]<pkg>\nnpm owner rm <user> [<@scope>/]<pkg>\nnpm owner ls [<@scope>/]<pkg>");owner.completion=function(d,b){var a=d.conf.argv.remain;if(a.length>4){return b()}if(a.length<=2){var c=["add","rm"];if(d.partialWord==="l"){c.push("ls")}else{c.push("ls","list")}return b(null,c)}npm.commands.whoami([],true,function(i,h){if(i){return b()}var f=encodeURIComponent(h);var e,g;switch(a[2]){case"ls":return b();case"rm":if(a.length>3){g=encodeURIComponent(a[3]);e="-/by-user/"+g+"|"+f;return mapToRegistry(e,npm.config,function(l,k,j){if(l){return b(l)}console.error(k);npm.registry.get(k,{auth:j},function(n,m){if(n){return b(n)}return b(null,m[g].filter(function(o){return f==="isaacs"||m[f].indexOf(o)===-1}))})})}case"add":if(a.length>3){g=encodeURIComponent(a[3]);e="-/by-user/"+g+"|"+f;return mapToRegistry(e,npm.config,function(l,k,j){if(l){return b(l)}console.error(k);npm.registry.get(k,{auth:j},function(p,o){console.error(k,p||o);if(p){return b(p)}var n=o[f]||[];var m=o[g]||[];return b(null,n.filter(function(q){return m.indexOf(q)===-1}))})})}return mapToRegistry("-/users",npm.config,function(l,k,j){if(l){return b(l)}npm.registry.get(k,{auth:j},function(n,m){if(n){return b()}return b(null,Object.keys(m).filter(function(o){return o!==f}))})});default:return b()}})};function owner(b,a){var c=b.shift();switch(c){case"ls":case"list":return ls(b[0],a);case"add":return add(b[0],b[1],a);case"rm":case"remove":return rm(b[0],b[1],a);default:return unknown(c,a)}}function ls(b,a){if(!b){return readLocalPkg(function(d,c){if(d){return a(d)}if(!c){return a(owner.usage)}ls(c,a)})}mapToRegistry(b,npm.config,function(e,d,c){if(e){return a(e)}npm.registry.get(d,{auth:c},function(i,g){var h="";if(i){log.error("owner ls","Couldn't get owner data",b);return a(i)}var f=g.maintainers;if(!f||!f.length){h="admin party!"}else{h=f.map(function(j){return j.name+" <"+j.email+">"}).join("\n")}output(h);a(i,f)})})}function add(b,c,a){if(!b){return a(owner.usage)}if(!c){return readLocalPkg(function(e,d){if(e){return a(e)}if(!d){return a(new Error(owner.usage))}add(b,d,a)})}log.verbose("owner add","%s to %s",b,c);mutate(c,b,function(e,g){if(!g){g=[]}for(var f=0,d=g.length;f<d;f++){var h=g[f];if(h.name===e.name){log.info("owner add","Already a package owner: "+h.name+" <"+h.email+">");return false}}g.push(e);return g},a)}function rm(b,c,a){if(!c){return readLocalPkg(function(e,d){if(e){return a(e)}if(!d){return a(new Error(owner.usage))}rm(b,d,a)})}log.verbose("owner rm","%s from %s",b,c);mutate(c,b,function(e,f){var g=false;var d=f.filter(function(i){var h=(i.name===b);g=g||h;return !h});if(!g){log.info("owner rm","Not a package owner: "+b);return false}if(!d.length){return new Error("Cannot remove all owners of a package.  Add someone else first.")}return d},a)}function mutate(e,d,c,a){if(d){var b="-/user/org.couchdb.user:"+d;mapToRegistry(b,npm.config,function(i,h,g){if(i){return a(i)}npm.registry.get(h,{auth:g},f)})}else{f(null,null)}function f(h,g){if(!h&&d&&(!g||g.error)){h=new Error("Couldn't get user data for "+d+": "+JSON.stringify(g))}if(h){log.error("owner mutate","Error getting user data for %s",d);return a(h)}if(g){g={name:g.name,email:g.email}}mapToRegistry(e,npm.config,function(k,j,i){if(k){return a(k)}npm.registry.get(j,{auth:i},function(q,o){if(q){log.error("owner mutate","Error getting package data for %s",e);return a(q)}var p=o.maintainers.length;var l=c(g,o.maintainers);if(!l){return a()}if(l instanceof Error){return a(l)}o={_id:o._id,_rev:o._rev,maintainers:l};var n=e.replace("/","%2f")+"/-rev/"+o._rev;mapToRegistry(n,npm.config,function(t,r,m){if(t){return a(t)}var s={method:"PUT",body:o,auth:m};npm.registry.request(r,s,function(v,u){if(!v&&u.error){v=new Error("Failed to update package metadata: "+JSON.stringify(u))}if(v){log.error("owner mutate","Failed to update package metadata")}else{if(l.length>p){output("+ %s (%s)",d,e)}else{if(l.length<p){output("- %s (%s)",d,e)}}}a(v,u)})})})})}}function unknown(b,a){a("Usage: \n"+owner.usage)};