module.exports=distTag;var log=require("npmlog");var npa=require("npm-package-arg");var semver=require("semver");var npm=require("./npm.js");var mapToRegistry=require("./utils/map-to-registry.js");var readLocalPkg=require("./utils/read-local-package.js");var usage=require("./utils/usage");var output=require("./utils/output.js");distTag.usage=usage("dist-tag","npm dist-tag add <pkg>@<version> [<tag>]\nnpm dist-tag rm <pkg> <tag>\nnpm dist-tag ls [<pkg>]");distTag.completion=function(c,b){var a=c.conf.argv.remain;if(a.length===2){return b(null,["add","rm","ls"])}switch(a[2]){default:return b()}};function distTag(b,a){var c=b.shift();switch(c){case"add":case"a":case"set":case"s":return add(b[0],b[1],a);case"rm":case"r":case"del":case"d":case"remove":return remove(b[1],b[0],a);case"ls":case"l":case"sl":case"list":return list(b[0],a);default:return a("Usage:\n"+distTag.usage)}}function add(d,b,a){var f=npa(d||"");var e=f.name;var c=f.rawSpec;var g=(b||npm.config.get("tag")).trim();log.verbose("dist-tag add",g,"to",e+"@"+c);if(!e||!c||!g){return a("Usage:\n"+distTag.usage)}if(semver.validRange(g)){var h=new Error("Tag name must not be a valid SemVer range: "+g);return a(h)}fetchTags(e,function(j,i){if(j){return a(j)}if(i[g]===c){log.warn("dist-tag add",g,"is already set to version",c);return a()}i[g]=c;mapToRegistry(e,npm.config,function(o,l,k,m){var n={"package":e,distTag:g,version:c,auth:k};npm.registry.distTags.add(m,n,function(p){if(p){return a(p)}output("+"+g+": "+e+"@"+c);a()})})})}function remove(b,c,a){log.verbose("dist-tag del",b,"from",c);fetchTags(c,function(f,e){if(f){return a(f)}if(!e[b]){log.info("dist-tag del",b,"is not a dist-tag on",c);return a(new Error(b+" is not a dist-tag on "+c))}var d=e[b];delete e[b];mapToRegistry(c,npm.config,function(k,h,g,i){var j={"package":c,distTag:b,auth:g};npm.registry.distTags.rm(i,j,function(l){if(l){return a(l)}output("-"+b+": "+c+"@"+d);a()})})})}function list(b,a){if(!b){return readLocalPkg(function(d,c){if(d){return a(d)}if(!c){return a(distTag.usage)}list(c,a)})}fetchTags(b,function(e,c){if(e){log.error("dist-tag ls","Couldn't get dist-tag data for",b);return a(e)}var d=Object.keys(c).map(function(f){return f+": "+c[f]}).sort().join("\n");output(d);a(e,c)})}function fetchTags(b,a){mapToRegistry(b,npm.config,function(g,d,c,e){if(g){return a(g)}var f={"package":b,auth:c};npm.registry.distTags.fetch(e,f,function(i,h){if(i){return a(i)}if(!h||!Object.keys(h).length){return a(new Error("No dist-tags found for "+b))}a(null,h)})})};