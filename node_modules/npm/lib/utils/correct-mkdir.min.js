var chownr=require("chownr");var dezalgo=require("dezalgo");var fs=require("graceful-fs");var inflight=require("inflight");var log=require("npmlog");var mkdirp=require("mkdirp");var stats={};var effectiveOwner;module.exports=function correctMkdir(b,a){a=dezalgo(a);a=inflight("correctMkdir:"+b,a);if(!a){return log.verbose("correctMkdir",b,"correctMkdir already in flight; waiting")}else{log.verbose("correctMkdir",b,"correctMkdir not in flight; initializing")}if(stats[b]){return a(null,stats[b])}fs.stat(b,function(e,c){if(e){return makeDirectory(b,a)}if(!c.isDirectory()){log.error("correctMkdir","invalid dir %s",b);return a(e)}var d=calculateOwner();if(c.uid!==d.uid){stats[b]=d;setPermissions(b,d,a)}else{stats[b]=c;a(null,stats[b])}})};function calculateOwner(){if(!effectiveOwner){effectiveOwner={uid:0,gid:0};if(!process.getuid){return effectiveOwner}effectiveOwner.uid=+process.getuid();effectiveOwner.gid=+process.getgid();if(effectiveOwner.uid===0){if(process.env.SUDO_UID){effectiveOwner.uid=+process.env.SUDO_UID}if(process.env.SUDO_GID){effectiveOwner.gid=+process.env.SUDO_GID}}}return effectiveOwner}function makeDirectory(d,b){b=inflight("makeDirectory:"+d,b);if(!b){return log.verbose("makeDirectory",d,"creation already in flight; waiting")}else{log.verbose("makeDirectory",d,"creation not in flight; initializing")}var a=calculateOwner();if(!process.getuid){return mkdirp(d,function(e){log.verbose("makeCacheDir","UID & GID are irrelevant on",process.platform);stats[d]=a;return b(e,stats[d])})}if(a.uid!==0||!process.env.HOME){log.silly("makeDirectory",d,"uid:",a.uid,"gid:",a.gid);stats[d]=a;mkdirp(d,c)}else{fs.stat(process.env.HOME,function(f,e){if(f){log.error("makeDirectory","homeless?");return b(f)}log.silly("makeDirectory",d,"uid:",e.uid,"gid:",e.gid);stats[d]=e;mkdirp(d,c)})}function c(f,e){if(f||!stats[d]||isNaN(stats[d].uid)||isNaN(stats[d].gid)){return b(f,stats[d])}if(!e){return b(f,stats[d])}setPermissions(e,stats[d],b)}}function setPermissions(c,b,a){chownr(c,b.uid,b.gid,function(d){if(d&&d.code==="ENOENT"){return a(null,b)}return a(d,b)})};