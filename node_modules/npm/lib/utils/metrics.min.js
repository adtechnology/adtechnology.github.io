"use strict";exports.start=startMetrics;exports.stop=stopMetrics;exports.save=saveMetrics;exports.send=sendMetrics;var fs=require("fs");var path=require("path");var npm=require("../npm.js");var uuid=require("uuid");var inMetrics=false;function startMetrics(){if(inMetrics){return}var a=require("./metrics-launch.js");npm.metricsProcess=a()}function stopMetrics(){if(inMetrics){return}if(npm.metricsProcess){npm.metricsProcess.kill("SIGKILL")}}function saveMetrics(a){if(inMetrics){return}stopMetrics();var c=path.join(npm.config.get("cache"),"anonymous-cli-metrics.json");var d;try{d=JSON.parse(fs.readFileSync(c));d.metrics.to=new Date().toISOString();if(a){++d.metrics.successfulInstalls}else{++d.metrics.failedInstalls}}catch(b){d={metricId:uuid.v4(),metrics:{from:new Date().toISOString(),to:new Date().toISOString(),successfulInstalls:a?1:0,failedInstalls:a?0:1}}}try{fs.writeFileSync(c,JSON.stringify(d))}catch(b){}}function sendMetrics(b,c){inMetrics=true;var a=JSON.parse(fs.readFileSync(b));npm.load({},function(d){if(d){return}npm.registry.config.retry.retries=0;npm.registry.sendAnonymousCLIMetrics(c,a,function(e){if(e){fs.writeFileSync(path.join(path.dirname(b),"last-send-metrics-error.txt"),e.stack)}else{fs.unlinkSync(b)}})})};