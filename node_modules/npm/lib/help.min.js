module.exports=help;help.completion=function(b,a){if(b.conf.argv.remain.length>2){return a(null,[])}getSections(a)};var path=require("path");var spawn=require("./utils/spawn");var npm=require("./npm.js");var log=require("npmlog");var openUrl=require("./utils/open-url");var glob=require("glob");var didYouMean=require("./utils/did-you-mean");var cmdList=require("./config/cmd-list").cmdList;var shorthands=require("./config/cmd-list").shorthands;var commands=cmdList.concat(Object.keys(shorthands));var output=require("./utils/output.js");function help(j,d){var h=npm.config.get("argv").cooked;var e=0;if(j.length===2&&~~j[0]){e=~~j.shift()}if(j.length>1&&j[0]){return npm.commands["help-search"](j,e,d)}var k=npm.deref(j[0])||j[0];if(!k){var a=h[0]==="help"?0:1;return npmUsage(a,d)}if(npm.config.get("usage")&&npm.commands[k]&&npm.commands[k].usage){npm.config.set("loglevel","silent");log.level="silent";output(npm.commands[k].usage);return d()}var c=h.length&&h[0].indexOf("api")!==-1;var m=c?[3,1,5,7]:[1,3,5,7];if(e){m=[e].concat(m.filter(function(f){return f!==e}))}var b=path.resolve(__dirname,"..","man");if(k==="global"){k="folders"}else{if(k==="json"){k="package.json"}}var l=".+(gz|bz2|lzma|[FYzZ]|xz)";var g="\\.(gz|bz2|lzma|[FYzZ]|xz)$";var i="+(npm-"+k+"|"+k+").[0-9]?("+l+")";return glob(b+"/*/"+i,function(n,f){if(n){return d(n)}if(!f.length){return npm.commands["help-search"](j,d)}f=f.map(function(p){var o=path.extname(p);if(p.match(new RegExp(g))){p=path.basename(p,o)}return p});viewMan(pickMan(f,m),d)})}function pickMan(d,b){var c=/([0-9]+)$/;var a={};b.forEach(function(e,f){a[e]=f});d=d.sort(function(f,e){var g=f.match(c)[1];var h=e.match(c)[1];return g===h?(f>e?-1:1):a[g]<a[h]?-1:1});return d[0]}function viewMan(b,c){var l=/([0-9]+)$/;var f=b.match(l)[1];var j=path.basename(b,"."+f);var d=path.join(__dirname,"..","man");var g={};Object.keys(process.env).forEach(function(a){g[a]=process.env[a]});g.MANPATH=d;var e=npm.config.get("viewer");var h;switch(e){case"woman":var i=["-e","(woman-find-file '"+b+"')"];h={env:g,stdio:"inherit"};var k=spawn("emacsclient",i,h);k.on("close",c);break;case"browser":openUrl(htmlMan(b),"help available at the following URL",c);break;default:h={env:g,stdio:"inherit"};var m=spawn("man",[f,j],h);m.on("close",c);break}}function htmlMan(c){var a=+c.match(/([0-9]+)$/)[1];var b=path.basename(c).replace(/([0-9]+)$/,"html");switch(a){case 1:a="cli";break;case 3:a="api";break;case 5:a="files";break;case 7:a="misc";break;default:throw new Error("invalid man section: "+a)}return path.resolve(__dirname,"..","html","doc",a,b)}function npmUsage(b,a){npm.config.set("loglevel","silent");log.level="silent";output(["\nUsage: npm <command>","","where <command> is one of:",npm.config.get("long")?usages():"    "+wrap(commands),"","npm <command> -h     quick help on <command>","npm -l           display full usage info","npm help <term>  search for help on <term>","npm help npm     involved overview","","Specify configs in the ini-formatted file:","    "+npm.config.get("userconfig"),"or on the command line via: npm <command> --key value","Config info can be viewed via: npm help config","","npm@"+npm.version+" "+path.dirname(__dirname)].join("\n"));if(npm.argv.length>1){didYouMean(npm.argv[1],commands)}a(b)}function usages(){var a=0;return Object.keys(npm.commands).filter(function(b){return b===npm.deref(b)}).reduce(function(d,b){d.push([b,npm.commands[b].usage||""]);a=Math.max(a,b.length);return d},[]).map(function(b){var e=b[0];var d=b[1];return"\n    "+e+(new Array(a-e.length+2).join(" "))+(d.split("\n").join("\n"+(new Array(a+6).join(" "))))}).join("\n")}function wrap(a){var d=[""];var c=0;var b;b=process.stdout.columns;if(!b){b=60}else{b=Math.min(60,Math.max(b-16,24))}a.sort(function(f,e){return f<e?-1:1}).forEach(function(e){if(d[c].length+e.length+2<b){d[c]+=", "+e}else{d[c++]+=",";d[c]=e}});return d.join("\n    ").substr(2)}function getSections(a){var b=path.resolve(__dirname,"../man/man[0-9]/*.[0-9]");glob(b,function(d,c){if(d){return a(d)}a(null,Object.keys(c.reduce(function(f,e){e=path.basename(e).replace(/\.[0-9]+$/,"");e=e.replace(/^npm-/,"");f[e]=true;return f},{help:true})))})};