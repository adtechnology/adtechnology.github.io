module.exports=completion;completion.usage="source <(npm completion)";var npm=require("./npm.js");var npmconf=require("./config/core.js");var configDefs=npmconf.defs;var configTypes=configDefs.types;var shorthands=configDefs.shorthands;var nopt=require("nopt");var configNames=Object.keys(configTypes).filter(function(a){return a.charAt(0)!=="_"});var shorthandNames=Object.keys(shorthands);var allConfs=configNames.concat(shorthandNames);var once=require("once");var isWindowsShell=require("./utils/is-windows-shell.js");var output=require("./utils/output.js");completion.completion=function(f,b){if(f.w>3){return b()}var a=require("graceful-fs");var g=require("path");var c=null;var e=null;a.stat(g.resolve(process.env.HOME,".bashrc"),function(h){c=!h;d()});a.stat(g.resolve(process.env.HOME,".zshrc"),function(h){e=!h;d()});function d(){if(e===null||c===null){return}var h=[];if(e){h.push("~/.zshrc")}if(c){h.push("~/.bashrc")}if(f.w===2){h=h.map(function(i){return[">>",i]})}b(null,h)}};function completion(j,f){if(isWindowsShell){var h=new Error("npm completion supported only in MINGW / Git bash on Windows");h.code="ENOTSUP";h.errno=require("constants").ENOTSUP;return f(h)}if(process.env.COMP_CWORD===undefined||process.env.COMP_LINE===undefined||process.env.COMP_POINT===undefined){return dumpScript(f)}console.error(process.env.COMP_CWORD);console.error(process.env.COMP_LINE);console.error(process.env.COMP_POINT);var o=+process.env.COMP_CWORD;var l=j.map(unescape);var b=l[o];var q=process.env.COMP_LINE;var p=+process.env.COMP_POINT;var m=q.substr(0,p);var c=l.slice(0,o);var n=j[o];var g=n.length;while(n.substr(0,g)!==m.substr(-1*g)&&g>0){g--}n=unescape(n.substr(0,g));c.push(n);var a={words:l,w:o,word:b,line:q,lineLength:q.length,point:p,partialLine:m,partialWords:c,partialWord:n,raw:j};f=wrapCb(f,a);console.error(a);if(c.slice(0,-1).indexOf("--")===-1){if(b.charAt(0)==="-"){return configCompl(a,f)}if(l[o-1]&&l[o-1].charAt(0)==="-"&&!isFlag(l[o-1])){console.error("configValueCompl");return configValueCompl(a,f)}}var k=a.conf=nopt(configTypes,shorthands,c.slice(0,-1),0);console.error(k);var d=k.argv.remain[1];if(!d){return cmdCompl(a,f)}Object.keys(k).forEach(function(e){npm.config.set(e,k[e])});d=npm.commands[d];if(d&&d.completion){return d.completion(a,f)}f()}function dumpScript(b){var a=require("graceful-fs");var d=require("path");var c=d.resolve(__dirname,"utils/completion.sh");b=once(b);a.readFile(c,"utf8",function(f,e){if(f){return b(f)}e=e.replace(/^#!.*?\n/,"");process.stdout.write(e,function(){b()});process.stdout.on("error",function(g){if(g.errno==="EPIPE"){g=null}b(g)})})}function unescape(a){if(a.charAt(0)==="'"){return a.replace(/^'|'$/g,"")}else{return a.replace(/\\ /g," ")}}function escape(a){if(!a.match(/\s+/)){return a}return"'"+a+"'"}function wrapCb(a,b){return function(d,c){if(!Array.isArray(c)){c=c?[c]:[]}c=c.map(function(e){if(Array.isArray(e)){e=e.map(escape).join(" ")}else{e=escape(e)}return e});if(b.partialWord){c=c.filter(function(e){return e.indexOf(b.partialWord)===0})}console.error([d&&d.stack,c,b.partialWord]);if(d||c.length===0){return a(d)}output(c.join("\n"));a()}}function configCompl(d,a){var f=d.word;var c=f.match(/^(-+)((?:no-)*)(.*)$/);var e=c[1];var g=c[2];var b=configNames.filter(isFlag);console.error(b);return a(null,allConfs.map(function(h){return e+h}).concat(b.map(function(h){return e+(g||"no-")+h})))}function configValueCompl(b,a){console.error("configValue",b);return a(null,[])}function isFlag(c){var b=c.match(/^(-*)((?:no-)+)?(.*)$/);var d=b[2];var a=b[3];return d||configTypes[a]===Boolean||shorthands[a]}function cmdCompl(b,a){return a(null,npm.fullList)};