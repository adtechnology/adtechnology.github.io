module.exports=unbuild;module.exports.rmStuff=rmStuff;unbuild.usage="npm unbuild <folder>\n(this is plumbing)";var readJson=require("read-package-json");var gentlyRm=require("./utils/gently-rm.js");var npm=require("./npm.js");var path=require("path");var isInside=require("path-is-inside");var lifecycle=require("./utils/lifecycle.js");var asyncMap=require("slide").asyncMap;var chain=require("slide").chain;var log=require("npmlog");var build=require("./build.js");var output=require("./utils/output.js");function unbuild(c,b,a){if(typeof b==="function"){a=b;b=false}asyncMap(c,unbuild_(b),a)}function unbuild_(a){return function(d,c){function b(f){c(f,path.relative(npm.root,d))}d=path.resolve(d);var e=isInside(d,npm.prefix)?npm.prefix:d;delete build._didBuild[d];log.verbose("unbuild",d.substr(npm.prefix.length+1));readJson(path.resolve(d,"package.json"),function(g,f){if(g){return gentlyRm(d,false,e,b)}chain([[lifecycle,f,"preuninstall",d,{failOk:true}],[lifecycle,f,"uninstall",d,{failOk:true}],!a&&function(h){output("unbuild "+f._id);h()},[rmStuff,f,d],[lifecycle,f,"postuninstall",d,{failOk:true}],[gentlyRm,d,false,e]],b)})}}function rmStuff(b,e,a){var c=b.name[0]==="@"?path.dirname(path.dirname(e)):path.dirname(e);var d=npm.dir;var f=path.relative(d,c)==="";log.verbose("unbuild rmStuff",b._id,"from",d);if(!f){log.verbose("unbuild rmStuff","in",c)}asyncMap([rmBins,rmMans],function(h,g){h(b,e,c,f,g)},a)}function rmBins(c,f,d,g,b){if(!c.bin){return b()}var e=g?npm.bin:path.resolve(d,".bin");asyncMap(Object.keys(c.bin),function(i,h){if(process.platform==="win32"){chain([[gentlyRm,path.resolve(e,i)+".cmd",true,f],[gentlyRm,path.resolve(e,i),true,f]],h)}else{gentlyRm(path.resolve(e,i),true,f,h)}},a);function a(h){if(h||g){return b(h)}return gentlyRm(e,true,d,b)}}function rmMans(c,e,d,f,a){if(!c.man||!f||process.platform==="win32"||!npm.config.get("global")){return a()}var b=path.resolve(npm.config.get("prefix"),"share","man");log.verbose("rmMans","man files are",c.man,"in",b);asyncMap(c.man,function(i,h){if(Array.isArray(i)){i.forEach(g)}else{g(i)}function g(p){log.silly("rmMan","preparing to remove",p);var l=p.match(/(.*\.([0-9]+)(\.gz)?)$/);if(!l){log.error("rmMan",p,"is not a valid name for a man file.","Man files must end with a number, and optionally a .gz suffix if they are compressed.");return h()}var n=l[1];var o=l[2];var k=l[3]||"";var m=path.basename(n);var j=path.join(b,"man"+o,(m.indexOf(c.name)===0?m:c.name+"-"+m)+"."+o+k);gentlyRm(j,true,h)}},a)};