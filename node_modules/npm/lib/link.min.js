var npm=require("./npm.js");var symlink=require("./utils/link.js");var fs=require("graceful-fs");var log=require("npmlog");var asyncMap=require("slide").asyncMap;var chain=require("slide").chain;var path=require("path");var build=require("./build.js");var npa=require("npm-package-arg");var usage=require("./utils/usage");var output=require("./utils/output.js");module.exports=link;link.usage=usage("link","npm link (in package dir)\nnpm link [<@scope>/]<pkg>[@<version>]");link.completion=function(c,a){var b=npm.globalDir;fs.readdir(b,function(e,d){a(e,d.filter(function(g){return !g.match(/^[._-]/)}))})};function link(c,a){if(process.platform==="win32"){var b=require("semver");if(!b.gte(process.version,"0.7.9")){var f="npm link not supported on windows prior to node 0.7.9";var d=new Error(f);d.code="ENOTSUP";d.errno=require("constants").ENOTSUP;return a(d)}}if(npm.config.get("global")){return a(new Error("link should never be --global.\nPlease re-run this command with --local"))}if(c.length===1&&c[0]==="."){c=[]}if(c.length){return linkInstall(c,a)}linkPkg(npm.prefix,a)}function parentFolder(b,a){if(b[0]==="@"){return path.resolve(a,"..","..")}else{return path.resolve(a,"..")}}function linkInstall(b,a){asyncMap(b,function(e,c){var f=path.resolve(npm.globalDir,"..");var d=path.resolve(npm.globalDir,e);var h=null;var i=path.resolve(npm.dir,e);function j(o,l){if(o){return c(o,l)}var k=l.filter(function(q){var r=q[0];var p=q[1];return parentFolder(r,p)===npm.globalDir});var n=k[0][0];d=k[0][1];var m=npa(n);e=m.name;i=path.resolve(npm.dir,e);g()}if(e[0]!=="@"&&(e.indexOf("/")!==-1||e.indexOf("\\")!==-1)){return fs.lstat(path.resolve(e),function(l,k){if(l||!k.isDirectory()){npm.commands.install(f,e,j)}else{h=path.resolve(e);linkPkg(h,j)}})}fs.lstat(d,function(l,k){if(l){h=d;return npm.commands.install(f,[e],j)}else{if(!k.isSymbolicLink()){h=d;g()}else{return fs.realpath(d,function(n,m){if(n){log.warn("invalid symbolic link",e)}else{h=m}g()})}}});function g(){if(npm.config.get("dry-run")){return resultPrinter(e,d,i,h,c)}chain([[function(k){log.verbose("link","symlinking %s to %s",d,i);k()}],[symlink,d,i,false,false],h&&[build,[i],npm.config.get("global"),build._noLC,true],[resultPrinter,e,d,i,h]],c)}},a)}function linkPkg(d,b){var c=d||npm.prefix;var a=require("read-package-json");log.verbose("linkPkg",d);a(path.resolve(c,"package.json"),function(h,g){function e(i){return b(i,[[g&&g._id,f,null,null]])}if(h){return e(h)}if(!g.name){h=new Error("Package must have a name field to be linked");return e(h)}var f=path.resolve(npm.globalDir,g.name);if(npm.config.get("dry-run")){return resultPrinter(path.basename(c),c,f,e)}symlink(c,f,false,true,function(i){if(i){return e(i)}log.verbose("link","build target",f);npm.commands.install(c,[],function(j){if(j){return e(j)}build([f],true,build._noLC,true,function(k){if(k){return e(k)}resultPrinter(path.basename(c),c,f,e)})})})})}function resultPrinter(d,f,c,e,a){if(typeof a!=="function"){a=e;e=null}var b=c;e=(e||"").trim();f=(f||"").trim();if(npm.config.get("parseable")){return parseableOutput(c,e||f,a)}if(e===f){e=null}output(b+" -> "+f+(e?" -> "+e:""));a()}function parseableOutput(b,c,a){output(b+"::"+c);a()};