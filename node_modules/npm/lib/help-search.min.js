module.exports=helpSearch;var fs=require("graceful-fs");var path=require("path");var asyncMap=require("slide").asyncMap;var npm=require("./npm.js");var glob=require("glob");var color=require("ansicolors");var output=require("./utils/output.js");helpSearch.usage="npm help-search <text>";function helpSearch(d,c,a){if(typeof a!=="function"){a=c;c=false}if(!d.length){return a(helpSearch.usage)}var b=path.resolve(__dirname,"..","doc");return glob(b+"/*/*.md",function(f,e){if(f){return a(f)}readFiles(e,function(h,g){if(h){return a(h)}searchFiles(d,g,function(j,i){if(j){return a(j)}formatResults(d,i,a)})})})}function readFiles(c,a){var b={};asyncMap(c,function(e,d){fs.readFile(e,"utf8",function(g,f){b[e]=f;return d(g)})},function(d){return a(d,b)})}function searchFiles(b,d,a){var c=[];Object.keys(d).forEach(function(h){var k=d[h];var n;for(var p=0,j=b.length;p<j&&!n;p++){n=k.toLowerCase().indexOf(b[p].toLowerCase())!==-1}if(!n){return}var r=k.split(/\n+/);j=r.length;for(var m=0;m<j;m++){var s=r[m];var e=r[m+1];var o;n=false;if(e){for(p=0,o=b.length;p<o&&!n;p++){n=e.toLowerCase().indexOf(b[p].toLowerCase())!==-1}if(n){m+=2;continue}}n=false;for(p=0,o=b.length;p<o&&!n;p++){n=s.toLowerCase().indexOf(b[p].toLowerCase())!==-1}if(n){m++;continue}r[m]=null}r=r.reduce(function(i,t){if(!(t===null&&i[i.length-1]===null)){i.push(t)}return i},[]);if(r[r.length-1]===null){r.pop()}if(r[0]===null){r.shift()}var q={};var f=0;r.forEach(function(i){b.forEach(function(l){var t=(i||"").toLowerCase().split(l.toLowerCase()).length-1;if(t>0){q[l]=(q[l]||0)+t;f+=t}})});var g="npm help ";if(path.basename(path.dirname(h))==="api"){g="npm apihelp "}g+=path.basename(h,".md").replace(/^npm-/,"");c.push({file:h,cmd:g,lines:r,found:Object.keys(q),hits:q,totalHits:f})});if(c.length===1){return npm.commands.help([c[0].file.replace(/\.md$/,"")],a)}if(c.length===0){output("No results for "+b.map(JSON.stringify).join(" "));return a()}c=c.sort(function(f,e){return f.found.length>e.found.length?-1:f.found.length<e.found.length?1:f.totalHits>e.totalHits?-1:f.totalHits<e.totalHits?1:f.lines.length>e.lines.length?-1:f.lines.length<e.lines.length?1:0});a(null,c)}function formatResults(c,d,a){if(!d){return a(null)}var e=Math.min(process.stdout.columns||Infinity,80)+1;var b=d.map(function(g){var f=g.cmd;var h=Object.keys(g.hits).map(function(i){return i+":"+g.hits[i]}).sort(function(j,i){return j>i?1:-1}).join(" ");f+=((new Array(Math.max(1,e-f.length-h.length))).join(" "))+h;if(!npm.config.get("long")){return f}f="\n\n"+f+"\n"+(new Array(e)).join("—")+"\n"+g.lines.map(function(m,o){if(m===null||o>3){return""}for(var n=m,k=0,j=c.length;k<j;k++){var s=n.toLowerCase().split(c[k].toLowerCase());var r="";var q=0;s.forEach(function(l){r+=n.substr(q,l.length);var i=n.substr(q+l.length,c[k].length);if(npm.color){i=color.bgBlack(color.red(i))}r+=i;q+=l.length+c[k].length})}return r}).join("\n").trim();return f}).join("\n");if(d.length&&!npm.config.get("long")){b="Top hits for "+(c.map(JSON.stringify).join(" "))+"\n"+(new Array(e)).join("—")+"\n"+b+"\n"+(new Array(e)).join("—")+"\n(run with -l or --long to see more context)"}output(b.trim());a(null,d)};