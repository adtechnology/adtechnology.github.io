var CC=require("config-chain").ConfigChain;var inherits=require("inherits");var configDefs=require("./defaults.js");var types=configDefs.types;var once=require("once");var fs=require("fs");var path=require("path");var nopt=require("nopt");var ini=require("ini");var Umask=configDefs.Umask;var mkdirp=require("mkdirp");var umask=require("../utils/umask");var isWindows=require("../utils/is-windows.js");exports.load=load;exports.Conf=Conf;exports.loaded=false;exports.rootConf=null;exports.usingBuiltin=false;exports.defs=configDefs;Object.defineProperty(exports,"defaults",{get:function(){return configDefs.defaults},enumerable:true});Object.defineProperty(exports,"types",{get:function(){return configDefs.types},enumerable:true});exports.validate=validate;var myUid=process.env.SUDO_UID!==undefined?process.env.SUDO_UID:(process.getuid&&process.getuid());var myGid=process.env.SUDO_GID!==undefined?process.env.SUDO_GID:(process.getgid&&process.getgid());var loading=false;var loadCbs=[];function load(){var b,e,a;for(var d=0;d<arguments.length;d++){switch(typeof arguments[d]){case"string":e=arguments[d];break;case"object":b=arguments[d];break;case"function":a=arguments[d];break}}if(!a){a=function(){}}if(exports.loaded){var c=exports.loaded;if(b){c=new Conf(c);c.unshift(b)}return process.nextTick(a.bind(null,null,c))}if(!b){b={}}else{b=Object.keys(b).reduce(function(h,g){h[g]=b[g];return h},{})}loadCbs.push(a);if(loading){return}loading=true;a=once(function(h,g){if(!h){exports.loaded=g;loading=false}loadCbs.forEach(function(i){i(h,g)});loadCbs.length=0});exports.usingBuiltin=!!e;var f=exports.rootConf=new Conf();if(e){f.addFile(e,"builtin")}else{f.add({},"builtin")}f.on("load",function(){load_(e,f,b,a)});f.on("error",a)}function load_(j,a,f,c){var d=configDefs.defaults;var g=new Conf(a);g.usingBuiltin=!!j;g.add(f,"cli");g.addEnv();g.loadPrefix(function(n){if(n){return c(n)}var l=path.resolve(g.localPrefix,".npmrc");var m=a.get("userconfig");var k=g.get("userconfig");if(!g.get("global")&&l!==m&&l!==k){g.addFile(l,"project");g.once("load",b)}else{g.add({},"project");b()}});function b(){g.addFile(g.get("userconfig"),"user");g.once("error",c);g.once("load",e)}function e(){if(g.get("prefix")){var k=path.resolve(g.get("prefix"),"etc");d.globalconfig=path.resolve(k,"npmrc");d.globalignorefile=path.resolve(k,"npmignore")}g.addFile(g.get("globalconfig"),"global");g.root=d;g.add(a.shift(),"builtin");g.once("load",function(){g.loadExtras(i)})}function i(l){if(l){return c(l)}validate(g);var k=g.get("cafile");if(k){return g.loadCAFile(k,h)}h()}function h(k){if(k){return c(k)}exports.loaded=g;c(k,g)}}inherits(Conf,CC);function Conf(a){if(!(this instanceof Conf)){return new Conf(a)}CC.call(this);if(a){if(a instanceof Conf){this.root=a.list[0]||a.root}else{this.root=a}}else{this.root=configDefs.defaults}}Conf.prototype.loadPrefix=require("./load-prefix.js");Conf.prototype.loadCAFile=require("./load-cafile.js");Conf.prototype.loadUid=require("./load-uid.js");Conf.prototype.setUser=require("./set-user.js");Conf.prototype.getCredentialsByURI=require("./get-credentials-by-uri.js");Conf.prototype.setCredentialsByURI=require("./set-credentials-by-uri.js");Conf.prototype.clearCredentialsByURI=require("./clear-credentials-by-uri.js");Conf.prototype.loadExtras=function(a){this.setUser(function(b){if(b){return a(b)}this.loadUid(function(c){if(c){return a(c)}mkdirp(this.prefix,a)}.bind(this))}.bind(this))};Conf.prototype.save=function(e,a){var g=this.sources[e];if(!g||!(g.path||g.source)||!g.data){var h;if(e!=="builtin"){h=new Error("bad save target: "+e)}if(a){process.nextTick(a.bind(null,h));return this}return this.emit("error",h)}if(g.source){var i=g.prefix||"";Object.keys(g.data).forEach(function(j){g.source[i+j]=g.data[j]});if(a){process.nextTick(a)}return this}var d=ini.stringify(g.data);var c=function c(j){if(j){return b(j)}fs.chmod(g.path,f,b)};var b=function b(j){if(j){if(a){return a(j)}else{return this.emit("error",j)}}this._saving--;if(this._saving===0){if(a){a()}this.emit("save")}};c=c.bind(this);b=b.bind(this);this._saving++;var f=e==="user"?"0600":"0666";if(!d.trim()){fs.unlink(g.path,function(){b(null)})}else{mkdirp(path.dirname(g.path),function(j){if(j){return c(j)}fs.writeFile(g.path,d,"utf8",function(k){if(k){return c(k)}if(e==="user"&&myUid&&myGid){fs.chown(g.path,+myUid,+myGid,c)}else{c()}})})}return this};Conf.prototype.addFile=function(c,b){b=b||c;var a={__source__:b};this.sources[b]={path:c,type:"ini"};this.push(a);this._await();fs.readFile(c,"utf8",function(e,d){if(e){return this.add({},a)}this.addString(d,c,"ini",a)}.bind(this));return this};Conf.prototype.parse=function(b,a){return CC.prototype.parse.call(this,b,a,"ini")};Conf.prototype.add=function(b,a){try{Object.keys(b).forEach(function(d){const f=envReplace(d);const e=parseField(b[d],f);delete b[d];b[f]=e})}catch(c){this.emit("error",c);return this}return CC.prototype.add.call(this,b,a)};Conf.prototype.addEnv=function(b){b=b||process.env;var a={};Object.keys(b).filter(function(c){return c.match(/^npm_config_/i)}).forEach(function(c){if(!b[c]){return}var d=c.toLowerCase().replace(/^npm_config_/,"").replace(/(?!^)_/g,"-");a[d]=b[c]});return CC.prototype.addEnv.call(this,"",a,"env")};function parseField(g,c){if(typeof g!=="string"&&!(g instanceof String)){return g}var b=[].concat(types[c]);var d=b.indexOf(path)!==-1;var l=b.indexOf(Boolean)!==-1;var a=b.indexOf(String)!==-1;var j=b.indexOf(Umask)!==-1;var m=b.indexOf(Number)!==-1;g=(""+g).trim();if(g.match(/^".*"$/)){try{g=JSON.parse(g)}catch(h){throw new Error("Failed parsing JSON config key "+c+": "+g)}}if(l&&!a&&g===""){return true}switch(g){case"true":return true;case"false":return false;case"null":return null;case"undefined":return undefined}g=envReplace(g);if(d){var i=isWindows?/^~(\/|\\)/:/^~\//;if(g.match(i)&&process.env.HOME){g=path.resolve(process.env.HOME,g.substr(2))}g=path.resolve(g)}if(j){g=umask.fromString(g)}if(m&&!isNaN(g)){g=+g}return g}function envReplace(b){if(typeof b!=="string"||!b){return b}var a=/(\\*)\$\{([^}]+)\}/g;return b.replace(a,function(e,c,d){c=c.length&&c.length%2;if(c){return e}if(undefined===process.env[d]){throw new Error("Failed to replace env in config: "+e)}return process.env[d]})}function validate(a){a.list.forEach(function(b){nopt.clean(b,configDefs.types)});nopt.clean(a.root,configDefs.types)};