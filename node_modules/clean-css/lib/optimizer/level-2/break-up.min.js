var InvalidPropertyError=require("./invalid-property-error");var wrapSingle=require("../wrap-for-optimizing").single;var Token=require("../../tokenizer/token");var Marker=require("../../tokenizer/marker");var formatPosition=require("../../utils/format-position");function _anyIsInherit(b){var c,a;for(c=0,a=b.length;c<a;c++){if(b[c][1]=="inherit"){return true}}return false}function _colorFilter(a){return function(b){return b[1]=="invert"||a.isColor(b[1])||a.isPrefixed(b[1])}}function _styleFilter(a){return function(b){return b[1]!="inherit"&&a.isStyleKeyword(b[1])&&!a.isColorFunction(b[1])}}function _wrapDefault(b,c,a){var d=a[b];if(d.doubleValues&&d.defaultValue.length==2){return wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,b],[Token.PROPERTY_VALUE,d.defaultValue[0]],[Token.PROPERTY_VALUE,d.defaultValue[1]]])}else{if(d.doubleValues&&d.defaultValue.length==1){return wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,b],[Token.PROPERTY_VALUE,d.defaultValue[0]]])}else{return wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,b],[Token.PROPERTY_VALUE,d.defaultValue]])}}}function _widthFilter(a){return function(b){return b[1]!="inherit"&&(a.isWidth(b[1])||a.isUnit(b[1])&&!a.isDynamicUnit(b[1]))&&!a.isStyleKeyword(b[1])&&!a.isColorFunction(b[1])}}function animation(f,k,e){var a=_wrapDefault(f.name+"-duration",f,k);var n=_wrapDefault(f.name+"-timing-function",f,k);var x=_wrapDefault(f.name+"-delay",f,k);var b=_wrapDefault(f.name+"-iteration-count",f,k);var w=_wrapDefault(f.name+"-direction",f,k);var r=_wrapDefault(f.name+"-fill-mode",f,k);var v=_wrapDefault(f.name+"-play-state",f,k);var z=_wrapDefault(f.name+"-name",f,k);var j=[a,n,x,b,w,r,v,z];var d=f.value;var o;var y=false;var c=false;var u=false;var h=false;var m=false;var t=false;var q=false;var g=false;var s;var p;if(f.value.length==1&&f.value[0][1]=="inherit"){a.value=n.value=x.value=b.value=w.value=r.value=v.value=z.value=f.value;return j}if(d.length>1&&_anyIsInherit(d)){throw new InvalidPropertyError("Invalid animation values at "+formatPosition(d[0][2][0])+". Ignoring.")}for(s=0,p=d.length;s<p;s++){o=d[s];if(e.isTime(o[1])&&!y){a.value=[o];y=true}else{if(e.isTime(o[1])&&!u){x.value=[o];u=true}else{if((e.isGlobal(o[1])||e.isAnimationTimingFunction(o[1]))&&!c){n.value=[o];c=true}else{if((e.isAnimationIterationCountKeyword(o[1])||e.isPositiveNumber(o[1]))&&!h){b.value=[o];h=true}else{if(e.isAnimationDirectionKeyword(o[1])&&!m){w.value=[o];m=true}else{if(e.isAnimationFillModeKeyword(o[1])&&!t){r.value=[o];t=true}else{if(e.isAnimationPlayStateKeyword(o[1])&&!q){v.value=[o];q=true}else{if((e.isAnimationNameKeyword(o[1])||e.isIdentifier(o[1]))&&!g){z.value=[o];g=true}else{throw new InvalidPropertyError("Invalid animation value at "+formatPosition(o[2][0])+". Ignoring.")}}}}}}}}}return j}function background(c,h,b){var k=_wrapDefault("background-image",c,h);var v=_wrapDefault("background-position",c,h);var j=_wrapDefault("background-size",c,h);var e=_wrapDefault("background-repeat",c,h);var f=_wrapDefault("background-attachment",c,h);var u=_wrapDefault("background-origin",c,h);var s=_wrapDefault("background-clip",c,h);var q=_wrapDefault("background-color",c,h);var g=[k,v,j,e,f,u,s,q];var a=c.value;var p=false;var m=false;var n=false;var t=false;var d=false;if(c.value.length==1&&c.value[0][1]=="inherit"){q.value=k.value=e.value=v.value=j.value=u.value=s.value=c.value;return g}if(c.value.length==1&&c.value[0][1]=="0 0"){return g}for(var r=a.length-1;r>=0;r--){var o=a[r];if(b.isBackgroundAttachmentKeyword(o[1])){f.value=[o];d=true}else{if(b.isBackgroundClipKeyword(o[1])||b.isBackgroundOriginKeyword(o[1])){if(m){u.value=[o];n=true}else{s.value=[o];m=true}d=true}else{if(b.isBackgroundRepeatKeyword(o[1])){if(t){e.value.unshift(o)}else{e.value=[o];t=true}d=true}else{if(b.isBackgroundPositionKeyword(o[1])||b.isBackgroundSizeKeyword(o[1])||b.isUnit(o[1])||b.isDynamicUnit(o[1])){if(r>0){var l=a[r-1];if(l[1]==Marker.FORWARD_SLASH){j.value=[o]}else{if(r>1&&a[r-2][1]==Marker.FORWARD_SLASH){j.value=[l,o];r-=2}else{if(!p){v.value=[]}v.value.unshift(o);p=true}}}else{if(!p){v.value=[]}v.value.unshift(o);p=true}d=true}else{if((q.value[0][1]==h[q.name].defaultValue||q.value[0][1]=="none")&&(b.isColor(o[1])||b.isPrefixed(o[1]))){q.value=[o];d=true}else{if(b.isUrl(o[1])||b.isFunction(o[1])){k.value=[o];d=true}}}}}}}if(m&&!n){u.value=s.value.slice(0)}if(!d){throw new InvalidPropertyError("Invalid background value at "+formatPosition(a[0][2][0])+". Ignoring.")}return g}function borderRadius(g,f){var h=g.value;var e=-1;for(var c=0,a=h.length;c<a;c++){if(h[c][1]==Marker.FORWARD_SLASH){e=c;break}}if(e===0||e===h.length-1){throw new InvalidPropertyError("Invalid border-radius value at "+formatPosition(h[0][2][0])+". Ignoring.")}var d=_wrapDefault(g.name,g,f);d.value=e>-1?h.slice(0,e):h.slice(0);d.components=fourValues(d,f);var k=_wrapDefault(g.name,g,f);k.value=e>-1?h.slice(e+1):h.slice(0);k.components=fourValues(k,f);for(var b=0;b<4;b++){d.components[b].multiplex=true;d.components[b].value=d.components[b].value.concat(k.components[b].value)}return d.components}function font(g,q,f){var t=_wrapDefault("font-style",g,q);var i=_wrapDefault("font-variant",g,q);var n=_wrapDefault("font-weight",g,q);var w=_wrapDefault("font-stretch",g,q);var r=_wrapDefault("font-size",g,q);var s=_wrapDefault("line-height",g,q);var v=_wrapDefault("font-family",g,q);var p=[t,i,n,w,r,s,v];var c=g.value;var m=4;var h=0;var k=false;var o;var d=false;var x;var j=false;var u;var b=false;var l;var a=false;var e=false;if(!c[h]){throw new InvalidPropertyError("Missing font values at "+formatPosition(g.all[g.position][1][2][0])+". Ignoring.")}if(c.length==1&&c[0][1]=="inherit"){t.value=i.value=n.value=w.value=r.value=s.value=v.value=c;return p}if(c.length==1&&(f.isFontKeyword(c[0][1])||f.isGlobal(c[0][1])||f.isPrefixed(c[0][1]))){c[0][1]=Marker.INTERNAL+c[0][1];t.value=i.value=n.value=w.value=r.value=s.value=v.value=c;return p}if(c.length<2||!_anyIsFontSize(c,f)||!_anyIsFontFamily(c,f)){throw new InvalidPropertyError("Invalid font values at "+formatPosition(g.all[g.position][1][2][0])+". Ignoring.")}if(c.length>1&&_anyIsInherit(c)){throw new InvalidPropertyError("Invalid font values at "+formatPosition(c[0][2][0])+". Ignoring.")}while(h<m){o=f.isFontStretchKeyword(c[h][1])||f.isGlobal(c[h][1]);x=f.isFontStyleKeyword(c[h][1])||f.isGlobal(c[h][1]);u=f.isFontVariantKeyword(c[h][1])||f.isGlobal(c[h][1]);l=f.isFontWeightKeyword(c[h][1])||f.isGlobal(c[h][1]);if(x&&!d){t.value=[c[h]];d=true}else{if(u&&!j){i.value=[c[h]];j=true}else{if(l&&!b){n.value=[c[h]];b=true}else{if(o&&!k){w.value=[c[h]];k=true}else{if(x&&d||u&&j||l&&b||o&&k){throw new InvalidPropertyError("Invalid font style / variant / weight / stretch value at "+formatPosition(c[0][2][0])+". Ignoring.")}else{break}}}}}h++}if(f.isFontSizeKeyword(c[h][1])||f.isUnit(c[h][1])&&!f.isDynamicUnit(c[h][1])){r.value=[c[h]];a=true;h++}else{throw new InvalidPropertyError("Missing font size at "+formatPosition(c[0][2][0])+". Ignoring.")}if(!c[h]){throw new InvalidPropertyError("Missing font family at "+formatPosition(c[0][2][0])+". Ignoring.")}if(a&&c[h]&&c[h][1]==Marker.FORWARD_SLASH&&c[h+1]&&(f.isLineHeightKeyword(c[h+1][1])||f.isUnit(c[h+1][1])||f.isNumber(c[h+1][1]))){s.value=[c[h+1]];h++;h++}v.value=[];while(c[h]){if(c[h][1]==Marker.COMMA){e=false}else{if(e){v.value[v.value.length-1][1]+=Marker.SPACE+c[h][1]}else{v.value.push(c[h])}e=true}h++}if(v.value.length===0){throw new InvalidPropertyError("Missing font family at "+formatPosition(c[0][2][0])+". Ignoring.")}return p}function _anyIsFontSize(b,d){var e;var c,a;for(c=0,a=b.length;c<a;c++){e=b[c];if(d.isFontSizeKeyword(e[1])||d.isUnit(e[1])&&!d.isDynamicUnit(e[1])||d.isFunction(e[1])){return true}}return false}function _anyIsFontFamily(b,d){var e;var c,a;for(c=0,a=b.length;c<a;c++){e=b[c];if(d.isIdentifier(e[1])){return true}}return false}function fourValues(g,a){var d=a[g.name].components;var e=[];var f=g.value;if(f.length<1){return[]}if(f.length<2){f[1]=f[0].slice(0)}if(f.length<3){f[2]=f[0].slice(0)}if(f.length<4){f[3]=f[1].slice(0)}for(var c=d.length-1;c>=0;c--){var b=wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,d[c]]]);b.value=[f[c]];e.unshift(b)}return e}function multiplex(a){return function(q,n,b){var d=[];var r=q.value;var g,f,e,c;for(g=0,e=r.length;g<e;g++){if(r[g][1]==","){d.push(g)}}if(d.length===0){return a(q,n,b)}var k=[];for(g=0,e=d.length;g<=e;g++){var p=g===0?0:d[g-1]+1;var o=g<e?d[g]:r.length;var s=_wrapDefault(q.name,q,n);s.value=r.slice(p,o);k.push(a(s,n,b))}var h=k[0];for(g=0,e=h.length;g<e;g++){h[g].multiplex=true;for(f=1,c=k.length;f<c;f++){h[g].value.push([Token.PROPERTY_VALUE,Marker.COMMA]);Array.prototype.push.apply(h[g].value,k[f][g].value)}}return h}}function listStyle(i,f,a){var g=_wrapDefault("list-style-type",i,f);var c=_wrapDefault("list-style-position",i,f);var b=_wrapDefault("list-style-image",i,f);var d=[g,c,b];if(i.value.length==1&&i.value[0][1]=="inherit"){g.value=c.value=b.value=[i.value[0]];return d}var j=i.value.slice(0);var h=j.length;var e=0;for(e=0,h=j.length;e<h;e++){if(a.isUrl(j[e][1])||j[e][1]=="0"){b.value=[j[e]];j.splice(e,1);break}}for(e=0,h=j.length;e<h;e++){if(a.isListStylePositionKeyword(j[e][1])){c.value=[j[e]];j.splice(e,1);break}}if(j.length>0&&(a.isListStyleTypeKeyword(j[0][1])||a.isIdentifier(j[0][1]))){g.value=[j[0]]}return d}function widthStyleColor(n,k,c){var a=k[n.name];var j=[_wrapDefault(a.components[0],n,k),_wrapDefault(a.components[1],n,k),_wrapDefault(a.components[2],n,k)];var e,b,d;for(var f=0;f<3;f++){var l=j[f];if(l.name.indexOf("color")>0){e=l}else{if(l.name.indexOf("style")>0){b=l}else{d=l}}}if((n.value.length==1&&n.value[0][1]=="inherit")||(n.value.length==3&&n.value[0][1]=="inherit"&&n.value[1][1]=="inherit"&&n.value[2][1]=="inherit")){e.value=b.value=d.value=[n.value[0]];return j}var m=n.value.slice(0);var h,g;if(m.length>0){g=m.filter(_widthFilter(c));h=g.length>1&&(g[0][1]=="none"||g[0][1]=="auto")?g[1]:g[0];if(h){d.value=[h];m.splice(m.indexOf(h),1)}}if(m.length>0){h=m.filter(_styleFilter(c))[0];if(h){b.value=[h];m.splice(m.indexOf(h),1)}}if(m.length>0){h=m.filter(_colorFilter(c))[0];if(h){e.value=[h];m.splice(m.indexOf(h),1)}}return j}module.exports={animation:animation,background:background,border:widthStyleColor,borderRadius:borderRadius,font:font,fourValues:fourValues,listStyle:listStyle,multiplex:multiplex,outline:widthStyleColor};