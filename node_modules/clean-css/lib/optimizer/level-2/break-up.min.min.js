var InvalidPropertyError=require("./invalid-property-error");var wrapSingle=require("../wrap-for-optimizing").single;var Token=require("../../tokenizer/token");var Marker=require("../../tokenizer/marker");var formatPosition=require("../../utils/format-position");function _anyIsInherit(d){var f,e;for(f=0,e=d.length;f<e;f++){if(d[f][1]=="inherit"){return true}}return false}function _colorFilter(b){return function(a){return a[1]=="invert"||b.isColor(a[1])||b.isPrefixed(a[1])}}function _styleFilter(b){return function(a){return a[1]!="inherit"&&b.isStyleKeyword(a[1])&&!b.isColorFunction(a[1])}}function _wrapDefault(e,h,f){var g=f[e];if(g.doubleValues&&g.defaultValue.length==2){return wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,e],[Token.PROPERTY_VALUE,g.defaultValue[0]],[Token.PROPERTY_VALUE,g.defaultValue[1]]])}else{if(g.doubleValues&&g.defaultValue.length==1){return wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,e],[Token.PROPERTY_VALUE,g.defaultValue[0]]])}else{return wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,e],[Token.PROPERTY_VALUE,g.defaultValue]])}}}function _widthFilter(b){return function(a){return a[1]!="inherit"&&(b.isWidth(a[1])||b.isUnit(a[1])&&!b.isDynamicUnit(a[1]))&&!b.isStyleKeyword(a[1])&&!b.isColorFunction(a[1])}}function animation(Q,M,R){var V=_wrapDefault(Q.name+"-duration",Q,M);var K=_wrapDefault(Q.name+"-timing-function",Q,M);var A=_wrapDefault(Q.name+"-delay",Q,M);var U=_wrapDefault(Q.name+"-iteration-count",Q,M);var B=_wrapDefault(Q.name+"-direction",Q,M);var G=_wrapDefault(Q.name+"-fill-mode",Q,M);var C=_wrapDefault(Q.name+"-play-state",Q,M);var i=_wrapDefault(Q.name+"-name",Q,M);var N=[V,K,A,U,B,G,C,i];var S=Q.value;var J;var l=false;var T=false;var D=false;var O=false;var L=false;var E=false;var H=false;var P=false;var F;var I;if(Q.value.length==1&&Q.value[0][1]=="inherit"){V.value=K.value=A.value=U.value=B.value=G.value=C.value=i.value=Q.value;return N}if(S.length>1&&_anyIsInherit(S)){throw new InvalidPropertyError("Invalid animation values at "+formatPosition(S[0][2][0])+". Ignoring.")}for(F=0,I=S.length;F<I;F++){J=S[F];if(R.isTime(J[1])&&!l){V.value=[J];l=true}else{if(R.isTime(J[1])&&!D){A.value=[J];D=true}else{if((R.isGlobal(J[1])||R.isAnimationTimingFunction(J[1]))&&!T){K.value=[J];T=true}else{if((R.isAnimationIterationCountKeyword(J[1])||R.isPositiveNumber(J[1]))&&!O){U.value=[J];O=true}else{if(R.isAnimationDirectionKeyword(J[1])&&!L){B.value=[J];L=true}else{if(R.isAnimationFillModeKeyword(J[1])&&!E){G.value=[J];E=true}else{if(R.isAnimationPlayStateKeyword(J[1])&&!H){C.value=[J];H=true}else{if((R.isAnimationNameKeyword(J[1])||R.isIdentifier(J[1]))&&!P){i.value=[J];P=true}else{throw new InvalidPropertyError("Invalid animation value at "+formatPosition(J[2][0])+". Ignoring.")}}}}}}}}}return N}function background(N,I,O){var G=_wrapDefault("background-image",N,I);var i=_wrapDefault("background-position",N,I);var H=_wrapDefault("background-size",N,I);var L=_wrapDefault("background-repeat",N,I);var K=_wrapDefault("background-attachment",N,I);var w=_wrapDefault("background-origin",N,I);var y=_wrapDefault("background-clip",N,I);var A=_wrapDefault("background-color",N,I);var J=[G,i,H,L,K,w,y,A];var P=N.value;var B=false;var E=false;var D=false;var x=false;var M=false;if(N.value.length==1&&N.value[0][1]=="inherit"){A.value=G.value=L.value=i.value=H.value=w.value=y.value=N.value;return J}if(N.value.length==1&&N.value[0][1]=="0 0"){return J}for(var z=P.length-1;z>=0;z--){var C=P[z];if(O.isBackgroundAttachmentKeyword(C[1])){K.value=[C];M=true}else{if(O.isBackgroundClipKeyword(C[1])||O.isBackgroundOriginKeyword(C[1])){if(E){w.value=[C];D=true}else{y.value=[C];E=true}M=true}else{if(O.isBackgroundRepeatKeyword(C[1])){if(x){L.value.unshift(C)}else{L.value=[C];x=true}M=true}else{if(O.isBackgroundPositionKeyword(C[1])||O.isBackgroundSizeKeyword(C[1])||O.isUnit(C[1])||O.isDynamicUnit(C[1])){if(z>0){var F=P[z-1];if(F[1]==Marker.FORWARD_SLASH){H.value=[C]}else{if(z>1&&P[z-2][1]==Marker.FORWARD_SLASH){H.value=[F,C];z-=2}else{if(!B){i.value=[]}i.value.unshift(C);B=true}}}else{if(!B){i.value=[]}i.value.unshift(C);B=true}M=true}else{if((A.value[0][1]==I[A.name].defaultValue||A.value[0][1]=="none")&&(O.isColor(C[1])||O.isPrefixed(C[1]))){A.value=[C];M=true}else{if(O.isUrl(C[1])||O.isFunction(C[1])){G.value=[C];M=true}}}}}}}if(E&&!D){w.value=y.value.slice(0)}if(!M){throw new InvalidPropertyError("Invalid background value at "+formatPosition(P[0][2][0])+". Ignoring.")}return J}function borderRadius(l,m){var j=l.value;var n=-1;for(var p=0,r=j.length;p<r;p++){if(j[p][1]==Marker.FORWARD_SLASH){n=p;break}}if(n===0||n===j.length-1){throw new InvalidPropertyError("Invalid border-radius value at "+formatPosition(j[0][2][0])+". Ignoring.")}var o=_wrapDefault(l.name,l,m);o.value=n>-1?j.slice(0,n):j.slice(0);o.components=fourValues(o,m);var i=_wrapDefault(l.name,l,m);i.value=n>-1?j.slice(n+1):j.slice(0);i.components=fourValues(i,m);for(var q=0;q<4;q++){o.components[q].multiplex=true;o.components[q].value=o.components[q].value.concat(i.components[q].value)}return o.components}function font(P,F,Q){var C=_wrapDefault("font-style",P,F);var N=_wrapDefault("font-variant",P,F);var I=_wrapDefault("font-weight",P,F);var z=_wrapDefault("font-stretch",P,F);var E=_wrapDefault("font-size",P,F);var D=_wrapDefault("line-height",P,F);var A=_wrapDefault("font-family",P,F);var G=[C,N,I,z,E,D,A];var T=P.value;var J=4;var O=0;var L=false;var H;var S=false;var y;var M=false;var B;var U=false;var K;var V=false;var R=false;if(!T[O]){throw new InvalidPropertyError("Missing font values at "+formatPosition(P.all[P.position][1][2][0])+". Ignoring.")}if(T.length==1&&T[0][1]=="inherit"){C.value=N.value=I.value=z.value=E.value=D.value=A.value=T;return G}if(T.length==1&&(Q.isFontKeyword(T[0][1])||Q.isGlobal(T[0][1])||Q.isPrefixed(T[0][1]))){T[0][1]=Marker.INTERNAL+T[0][1];C.value=N.value=I.value=z.value=E.value=D.value=A.value=T;return G}if(T.length<2||!_anyIsFontSize(T,Q)||!_anyIsFontFamily(T,Q)){throw new InvalidPropertyError("Invalid font values at "+formatPosition(P.all[P.position][1][2][0])+". Ignoring.")}if(T.length>1&&_anyIsInherit(T)){throw new InvalidPropertyError("Invalid font values at "+formatPosition(T[0][2][0])+". Ignoring.")}while(O<J){H=Q.isFontStretchKeyword(T[O][1])||Q.isGlobal(T[O][1]);y=Q.isFontStyleKeyword(T[O][1])||Q.isGlobal(T[O][1]);B=Q.isFontVariantKeyword(T[O][1])||Q.isGlobal(T[O][1]);K=Q.isFontWeightKeyword(T[O][1])||Q.isGlobal(T[O][1]);if(y&&!S){C.value=[T[O]];S=true}else{if(B&&!M){N.value=[T[O]];M=true}else{if(K&&!U){I.value=[T[O]];U=true}else{if(H&&!L){z.value=[T[O]];L=true}else{if(y&&S||B&&M||K&&U||H&&L){throw new InvalidPropertyError("Invalid font style / variant / weight / stretch value at "+formatPosition(T[0][2][0])+". Ignoring.")}else{break}}}}}O++}if(Q.isFontSizeKeyword(T[O][1])||Q.isUnit(T[O][1])&&!Q.isDynamicUnit(T[O][1])){E.value=[T[O]];V=true;O++}else{throw new InvalidPropertyError("Missing font size at "+formatPosition(T[0][2][0])+". Ignoring.")}if(!T[O]){throw new InvalidPropertyError("Missing font family at "+formatPosition(T[0][2][0])+". Ignoring.")}if(V&&T[O]&&T[O][1]==Marker.FORWARD_SLASH&&T[O+1]&&(Q.isLineHeightKeyword(T[O+1][1])||Q.isUnit(T[O+1][1])||Q.isNumber(T[O+1][1]))){D.value=[T[O+1]];O++;O++}A.value=[];while(T[O]){if(T[O][1]==Marker.COMMA){R=false}else{if(R){A.value[A.value.length-1][1]+=Marker.SPACE+T[O][1]}else{A.value.push(T[O])}R=true}O++}if(A.value.length===0){throw new InvalidPropertyError("Missing font family at "+formatPosition(T[0][2][0])+". Ignoring.")}return G}function _anyIsFontSize(f,i){var h;var j,g;for(j=0,g=f.length;j<g;j++){h=f[j];if(i.isFontSizeKeyword(h[1])||i.isUnit(h[1])&&!i.isDynamicUnit(h[1])||i.isFunction(h[1])){return true}}return false}function _anyIsFontFamily(f,i){var h;var j,g;for(j=0,g=f.length;j<g;j++){h=f[j];if(i.isIdentifier(h[1])){return true}}return false}function fourValues(j,i){var m=i[j.name].components;var l=[];var k=j.value;if(k.length<1){return[]}if(k.length<2){k[1]=k[0].slice(0)}if(k.length<3){k[2]=k[0].slice(0)}if(k.length<4){k[3]=k[1].slice(0)}for(var n=m.length-1;n>=0;n--){var h=wrapSingle([Token.PROPERTY,[Token.PROPERTY_NAME,m[n]]]);h.value=[k[n]];l.unshift(h)}return l}function multiplex(b){return function(i,m,A){var y=[];var a=i.value;var v,w,x,z;for(v=0,x=a.length;v<x;v++){if(a[v][1]==","){y.push(v)}}if(y.length===0){return b(i,m,A)}var t=[];for(v=0,x=y.length;v<=x;v++){var j=v===0?0:y[v-1]+1;var l=v<x?y[v]:a.length;var B=_wrapDefault(i.name,i,m);B.value=a.slice(j,l);t.push(b(B,m,A))}var u=t[0];for(v=0,x=u.length;v<x;v++){u[v].multiplex=true;for(w=1,z=t.length;w<z;w++){u[v].value.push([Token.PROPERTY_VALUE,Marker.COMMA]);Array.prototype.push.apply(u[v].value,t[w][v].value)}}return u}}function listStyle(l,o,t){var n=_wrapDefault("list-style-type",l,o);var r=_wrapDefault("list-style-position",l,o);var s=_wrapDefault("list-style-image",l,o);var q=[n,r,s];if(l.value.length==1&&l.value[0][1]=="inherit"){n.value=r.value=s.value=[l.value[0]];return q}var k=l.value.slice(0);var m=k.length;var p=0;for(p=0,m=k.length;p<m;p++){if(t.isUrl(k[p][1])||k[p][1]=="0"){s.value=[k[p]];k.splice(p,1);break}}for(p=0,m=k.length;p<m;p++){if(t.isListStylePositionKeyword(k[p][1])){r.value=[k[p]];k.splice(p,1);break}}if(k.length>0&&(t.isListStyleTypeKeyword(k[0][1])||t.isIdentifier(k[0][1]))){n.value=[k[0]]}return q}function widthStyleColor(i,q,x){var z=q[i.name];var r=[_wrapDefault(z.components[0],i,q),_wrapDefault(z.components[1],i,q),_wrapDefault(z.components[2],i,q)];var v,y,w;for(var u=0;u<3;u++){var p=r[u];if(p.name.indexOf("color")>0){v=p}else{if(p.name.indexOf("style")>0){y=p}else{w=p}}}if((i.value.length==1&&i.value[0][1]=="inherit")||(i.value.length==3&&i.value[0][1]=="inherit"&&i.value[1][1]=="inherit"&&i.value[2][1]=="inherit")){v.value=y.value=w.value=[i.value[0]];return r}var o=i.value.slice(0);var s,t;if(o.length>0){t=o.filter(_widthFilter(x));s=t.length>1&&(t[0][1]=="none"||t[0][1]=="auto")?t[1]:t[0];if(s){w.value=[s];o.splice(o.indexOf(s),1)}}if(o.length>0){s=o.filter(_styleFilter(x))[0];if(s){y.value=[s];o.splice(o.indexOf(s),1)}}if(o.length>0){s=o.filter(_colorFilter(x))[0];if(s){v.value=[s];o.splice(o.indexOf(s),1)}}return r}module.exports={animation:animation,background:background,border:widthStyleColor,borderRadius:borderRadius,font:font,fourValues:fourValues,listStyle:listStyle,multiplex:multiplex,outline:widthStyleColor};