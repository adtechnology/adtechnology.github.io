var Marker=require("../../tokenizer/marker");var split=require("../../utils/split");var DEEP_SELECTOR_PATTERN=/\/deep\//;var DOUBLE_COLON_PATTERN=/^::/;var NOT_PSEUDO=":not";var PSEUDO_CLASSES_WITH_ARGUMENTS=[":dir",":lang",":not",":nth-child",":nth-last-child",":nth-last-of-type",":nth-of-type"];var RELATION_PATTERN=/[>\+~]/;var UNMIXABLE_PSEUDO_CLASSES=[":after",":before",":first-letter",":first-line",":lang"];var UNMIXABLE_PSEUDO_ELEMENTS=["::after","::before","::first-letter","::first-line"];var Level={DOUBLE_QUOTE:"double-quote",SINGLE_QUOTE:"single-quote",ROOT:"root"};function isMergeable(j,l,k,o){var p=split(j,Marker.COMMA);var m;var n,i;for(n=0,i=p.length;n<i;n++){m=p[n];if(m.length===0||isDeepSelector(m)||(m.indexOf(Marker.COLON)>-1&&!areMergeable(m,extractPseudoFrom(m),l,k,o))){return false}}return true}function isDeepSelector(b){return DEEP_SELECTOR_PATTERN.test(b)}function extractPseudoFrom(x){var q=[];var s;var w=[];var y=Level.ROOT;var z=0;var o;var r;var v=false;var p;var n=false;var t;var u;for(t=0,u=x.length;t<u;t++){s=x[t];p=!r&&RELATION_PATTERN.test(s);o=y==Level.DOUBLE_QUOTE||y==Level.SINGLE_QUOTE;if(r){w.push(s)}else{if(s==Marker.DOUBLE_QUOTE&&y==Level.ROOT){w.push(s);y=Level.DOUBLE_QUOTE}else{if(s==Marker.DOUBLE_QUOTE&&y==Level.DOUBLE_QUOTE){w.push(s);y=Level.ROOT}else{if(s==Marker.SINGLE_QUOTE&&y==Level.ROOT){w.push(s);y=Level.SINGLE_QUOTE}else{if(s==Marker.SINGLE_QUOTE&&y==Level.SINGLE_QUOTE){w.push(s);y=Level.ROOT}else{if(o){w.push(s)}else{if(s==Marker.OPEN_ROUND_BRACKET){w.push(s);z++}else{if(s==Marker.CLOSE_ROUND_BRACKET&&z==1&&v){w.push(s);q.push(w.join(""));z--;w=[];v=false}else{if(s==Marker.CLOSE_ROUND_BRACKET){w.push(s);z--}else{if(s==Marker.COLON&&z===0&&v&&!n){q.push(w.join(""));w=[];w.push(s)}else{if(s==Marker.COLON&&z===0&&!n){w=[];w.push(s);v=true}else{if(s==Marker.SPACE&&z===0&&v){q.push(w.join(""));w=[];v=false}else{if(p&&z===0&&v){q.push(w.join(""));w=[];v=false}else{w.push(s)}}}}}}}}}}}}}r=s==Marker.BACK_SLASH;n=s==Marker.COLON}if(w.length>0&&v){q.push(w.join(""))}return q}function areMergeable(g,i,j,h,f){return areAllowed(i,j,h)&&needArguments(i)&&(i.length<2||!someIncorrectlyChained(g,i))&&(i.length<2||f&&allMixable(i))}function areAllowed(k,l,j){var n;var h;var m,i;for(m=0,i=k.length;m<i;m++){n=k[m];h=n.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?n.substring(0,n.indexOf(Marker.OPEN_ROUND_BRACKET)):n;if(l.indexOf(h)===-1&&j.indexOf(h)===-1){return false}}return true}function needArguments(j){var m;var n;var h;var k;var l,i;for(l=0,i=j.length;l<i;l++){m=j[l];h=m.indexOf(Marker.OPEN_ROUND_BRACKET);k=h>-1;n=k?m.substring(0,h):m;if(k&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(n)==-1){return false}if(!k&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(n)>-1){return false}}return true}function someIncorrectlyChained(u,r){var o=0;var q;var i;var t;var p;var x;var w;var l;var s,v;for(s=0,v=r.length;s<v;s++){q=r[s];t=r[s+1];if(!t){break}i=u.indexOf(q,o);p=u.indexOf(q,i+1);o=p;l=i+q.length==p;if(l){x=q.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?q.substring(0,q.indexOf(Marker.OPEN_ROUND_BRACKET)):q;w=t.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?t.substring(0,t.indexOf(Marker.OPEN_ROUND_BRACKET)):t;if(x!=NOT_PSEUDO||w!=NOT_PSEUDO){return true}}}return false}function allMixable(h){var i=0;var f;var j,g;for(j=0,g=h.length;j<g;j++){f=h[j];if(isPseudoElement(f)){i+=UNMIXABLE_PSEUDO_ELEMENTS.indexOf(f)>-1?1:0}else{i+=UNMIXABLE_PSEUDO_CLASSES.indexOf(f)>-1?1:0}if(i>1){return false}}return true}function isPseudoElement(b){return DOUBLE_COLON_PATTERN.test(b)}module.exports=isMergeable;