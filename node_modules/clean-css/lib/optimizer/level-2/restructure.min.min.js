var canReorderSingle=require("./reorderable").canReorderSingle;var extractProperties=require("./extract-properties");var isMergeable=require("./is-mergeable");var tidyRuleDuplicates=require("./tidy-rule-duplicates");var Token=require("../../tokenizer/token");var cloneArray=require("../../utils/clone-array");var serializeBody=require("../../writer/one-time").body;var serializeRules=require("../../writer/one-time").rules;function naturalSorter(a,b){return a>b?1:-1}function cloneAndMergeSelectors(f,d){var e=cloneArray(f);e[5]=e[5].concat(d[5]);return e}function restructure(ar,j){var aA=j.options;var af=aA.compatibility.selectors.mergeablePseudoClasses;var aC=aA.compatibility.selectors.mergeablePseudoElements;var aN=aA.compatibility.selectors.mergeLimit;var aM=aA.compatibility.selectors.multiplePseudoMerging;var aO=j.cache.specificity;var aB={};var ah=[];var az={};var ai=[];var aJ=2;var ak="%";function aK(b,c,f){for(var e=f.length-1;e>=0;e--){var a=f[e][0];var d=aP(c,a);if(az[d].length>1&&aL(b,az[d])){ao(d);break}}}function aP(c,b){var a=aE(b);az[a]=az[a]||[];az[a].push([c,b]);return a}function ao(d){var c=d.split(ak);var f=[];var a;for(var e in az){var b=e.split(ak);for(a=b.length-1;a>=0;a--){if(c.indexOf(b[a])>-1){f.push(e);break}}}for(a=f.length-1;a>=0;a--){delete az[f[a]]}}function aE(b){var d=[];for(var a=0,c=b.length;a<c;a++){d.push(serializeRules(b[a][1]))}return d.join(ak)}function am(a){var c=[];var d=[];for(var b=a.length-1;b>=0;b--){if(!isMergeable(serializeRules(a[b][1]),af,aC,aM)){continue}d.unshift(a[b]);if(a[b][2].length>0&&c.indexOf(a[b])==-1){c.push(a[b])}}return c.length>1?d:[]}function ad(a,d){var e=d[0];var l=d[1];var h=d[4];var n=e.length+l.length+1;var g=[];var f=[];var o=am(aB[h]);if(o.length<2){return}var p=aa(o,n,1);var b=p[0];if(b[1]>0){return aK(a,d,p)}for(var c=b[0].length-1;c>=0;c--){g=b[0][c][1].concat(g);f.unshift(b[0][c])}g=tidyRuleDuplicates(g);au(a,[d],g,f)}function aq(a,b){return a[1]>b[1]?1:(a[1]==b[1]?0:-1)}function aa(a,d,b){var c=al(a,d,b,aJ-1);return c.sort(aq)}function al(g,b,f,d){var e=[[g,an(g,b,f)]];if(g.length>2&&d>0){for(var a=g.length-1;a>=0;a--){var c=Array.prototype.slice.call(g,0);c.splice(a,1);e=e.concat(al(c,b,f,d-1))}}return e}function an(e,c,a){var d=0;for(var b=e.length-1;b>=0;b--){d+=e[b][2].length>a?serializeRules(e[b][1]).length:-1}return d-(e.length-1)*c+1}function au(q,l,d,n){var r,s,t,a;var f=[];for(r=n.length-1;r>=0;r--){var h=n[r];for(s=h[2].length-1;s>=0;s--){var g=h[2][s];for(t=0,a=l.length;t<a;t++){var e=l[t];var b=g[1][1];var p=e[0];var c=e[4];if(b==p&&serializeBody([g])==c){h[2].splice(s,1);break}}}}for(r=l.length-1;r>=0;r--){f.unshift(l[r][3])}var o=[Token.RULE,d,f];ar.splice(q,0,o)}function k(b,c){var a=c[4];var d=aB[a];if(d&&d.length>1){if(!aw(b,c)){ad(b,c)}}}function aw(l,c){var n=[];var h=[];var e=c[4];var a,b;var g=am(aB[e]);if(g.length<2){return}movableLoop:for(var f in aB){var d=aB[f];for(a=g.length-1;a>=0;a--){if(d.indexOf(g[a])==-1){continue movableLoop}}n.push(f)}if(n.length<2){return false}for(a=n.length-1;a>=0;a--){for(b=ah.length-1;b>=0;b--){if(ah[b][4]==n[a]){h.unshift([ah[b],g]);break}}}return aL(l,h)}function aL(c,b){var n=0;var l=[];var g;for(var d=b.length-1;d>=0;d--){g=b[d][0];var a=g[4];n+=a.length+(d>0?1:0);l.push(g)}var o=b[0][1];var e=aa(o,n,l.length)[0];if(e[1]>0){return false}var h=[];var f=[];for(d=e[0].length-1;d>=0;d--){h=e[0][d][1].concat(h);f.unshift(e[0][d])}h=tidyRuleDuplicates(h);au(c,l,h,f);for(d=l.length-1;d>=0;d--){g=l[d];var p=ah.indexOf(g);delete aB[g[4]];if(p>-1&&ai.indexOf(p)==-1){ai.push(p)}}return true}function aH(e,c,g){var b=e[0];var f=c[0];if(b!=f){return false}var a=c[4];var d=aB[a];return d&&d.indexOf(g)>-1}for(var Z=ar.length-1;Z>=0;Z--){var aG=ar[Z];var ay;var ab,ac,ae;var m;if(aG[0]==Token.RULE){ay=true}else{if(aG[0]==Token.NESTED_BLOCK){ay=false}else{continue}}var av=ah.length;var aQ=extractProperties(aG);ai=[];var i=[];for(ab=aQ.length-1;ab>=0;ab--){for(ac=ab-1;ac>=0;ac--){if(!canReorderSingle(aQ[ab],aQ[ac],aO)){i.push(ab);break}}}for(ab=aQ.length-1;ab>=0;ab--){var ag=aQ[ab];var at=false;for(ac=0;ac<av;ac++){var ap=ah[ac];if(ai.indexOf(ac)==-1&&(!canReorderSingle(ag,ap,aO)&&!aH(ag,ap,aG)||aB[ap[4]]&&aB[ap[4]].length===aN)){k(Z+1,ap,aG);if(ai.indexOf(ac)==-1){ai.push(ac);delete aB[ap[4]]}}if(!at){at=ag[0]==ap[0]&&ag[1]==ap[1];if(at){m=ac}}}if(!ay||i.indexOf(ab)>-1){continue}var aD=ag[4];if(at&&ah[m][5].length+ag[5].length>aN){k(Z+1,ah[m]);ah.splice(m,1);aB[aD]=[aG];at=false}else{aB[aD]=aB[aD]||[];aB[aD].push(aG)}if(at){ah[m]=cloneAndMergeSelectors(ah[m],ag)}else{ah.push(ag)}}ai=ai.sort(naturalSorter);for(ab=0,ae=ai.length;ab<ae;ab++){var ax=ai[ab]-ab;ah.splice(ax,1)}}var aj=ar[0]&&ar[0][0]==Token.AT_RULE&&ar[0][1].indexOf("@charset")===0?1:0;for(;aj<ar.length-1;aj++){var aF=ar[aj][0]===Token.AT_RULE&&ar[aj][1].indexOf("@import")===0;var aI=ar[aj][0]===Token.COMMENT;if(!(aF||aI)){break}}for(Z=0;Z<ah.length;Z++){k(aj,ah[Z])}}module.exports=restructure;