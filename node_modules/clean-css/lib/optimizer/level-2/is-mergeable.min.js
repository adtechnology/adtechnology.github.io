var Marker=require("../../tokenizer/marker");var split=require("../../utils/split");var DEEP_SELECTOR_PATTERN=/\/deep\//;var DOUBLE_COLON_PATTERN=/^::/;var NOT_PSEUDO=":not";var PSEUDO_CLASSES_WITH_ARGUMENTS=[":dir",":lang",":not",":nth-child",":nth-last-child",":nth-last-of-type",":nth-of-type"];var RELATION_PATTERN=/[>\+~]/;var UNMIXABLE_PSEUDO_CLASSES=[":after",":before",":first-letter",":first-line",":lang"];var UNMIXABLE_PSEUDO_ELEMENTS=["::after","::before","::first-letter","::first-line"];var Level={DOUBLE_QUOTE:"double-quote",SINGLE_QUOTE:"single-quote",ROOT:"root"};function isMergeable(a,g,h,d){var c=split(a,Marker.COMMA);var f;var e,b;for(e=0,b=c.length;e<b;e++){f=c[e];if(f.length===0||isDeepSelector(f)||(f.indexOf(Marker.COLON)>-1&&!areMergeable(f,extractPseudoFrom(f),g,h,d))){return false}}return true}function isDeepSelector(a){return DEEP_SELECTOR_PATTERN.test(a)}function extractPseudoFrom(c){var j=[];var h;var d=[];var b=Level.ROOT;var a=0;var l;var i;var e=false;var k;var m=false;var g;var f;for(g=0,f=c.length;g<f;g++){h=c[g];k=!i&&RELATION_PATTERN.test(h);l=b==Level.DOUBLE_QUOTE||b==Level.SINGLE_QUOTE;if(i){d.push(h)}else{if(h==Marker.DOUBLE_QUOTE&&b==Level.ROOT){d.push(h);b=Level.DOUBLE_QUOTE}else{if(h==Marker.DOUBLE_QUOTE&&b==Level.DOUBLE_QUOTE){d.push(h);b=Level.ROOT}else{if(h==Marker.SINGLE_QUOTE&&b==Level.ROOT){d.push(h);b=Level.SINGLE_QUOTE}else{if(h==Marker.SINGLE_QUOTE&&b==Level.SINGLE_QUOTE){d.push(h);b=Level.ROOT}else{if(l){d.push(h)}else{if(h==Marker.OPEN_ROUND_BRACKET){d.push(h);a++}else{if(h==Marker.CLOSE_ROUND_BRACKET&&a==1&&e){d.push(h);j.push(d.join(""));a--;d=[];e=false}else{if(h==Marker.CLOSE_ROUND_BRACKET){d.push(h);a--}else{if(h==Marker.COLON&&a===0&&e&&!m){j.push(d.join(""));d=[];d.push(h)}else{if(h==Marker.COLON&&a===0&&!m){d=[];d.push(h);e=true}else{if(h==Marker.SPACE&&a===0&&e){j.push(d.join(""));d=[];e=false}else{if(k&&a===0&&e){j.push(d.join(""));d=[];e=false}else{d.push(h)}}}}}}}}}}}}}i=h==Marker.BACK_SLASH;m=h==Marker.COLON}if(d.length>0&&e){j.push(d.join(""))}return j}function areMergeable(a,d,c,e,b){return areAllowed(d,c,e)&&needArguments(d)&&(d.length<2||!someIncorrectlyChained(a,d))&&(d.length<2||b&&allMixable(d))}function areAllowed(f,e,g){var c;var b;var d,a;for(d=0,a=f.length;d<a;d++){c=f[d];b=c.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?c.substring(0,c.indexOf(Marker.OPEN_ROUND_BRACKET)):c;if(e.indexOf(b)===-1&&g.indexOf(b)===-1){return false}}return true}function needArguments(g){var d;var c;var b;var f;var e,a;for(e=0,a=g.length;e<a;e++){d=g[e];b=d.indexOf(Marker.OPEN_ROUND_BRACKET);f=b>-1;c=f?d.substring(0,b):d;if(f&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(c)==-1){return false}if(!f&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(c)>-1){return false}}return true}function someIncorrectlyChained(d,g){var k=0;var h;var n;var e;var j;var a;var b;var m;var f,c;for(f=0,c=g.length;f<c;f++){h=g[f];e=g[f+1];if(!e){break}n=d.indexOf(h,k);j=d.indexOf(h,n+1);k=j;m=n+h.length==j;if(m){a=h.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?h.substring(0,h.indexOf(Marker.OPEN_ROUND_BRACKET)):h;b=e.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?e.substring(0,e.indexOf(Marker.OPEN_ROUND_BRACKET)):e;if(a!=NOT_PSEUDO||b!=NOT_PSEUDO){return true}}}return false}function allMixable(e){var d=0;var b;var c,a;for(c=0,a=e.length;c<a;c++){b=e[c];if(isPseudoElement(b)){d+=UNMIXABLE_PSEUDO_ELEMENTS.indexOf(b)>-1?1:0}else{d+=UNMIXABLE_PSEUDO_CLASSES.indexOf(b)>-1?1:0}if(d>1){return false}}return true}function isPseudoElement(a){return DOUBLE_COLON_PATTERN.test(a)}module.exports=isMergeable;