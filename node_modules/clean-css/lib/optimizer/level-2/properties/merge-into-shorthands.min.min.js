var everyValuesPair=require("./every-values-pair");var hasInherit=require("./has-inherit");var populateComponents=require("./populate-components");var compactable=require("../compactable");var deepClone=require("../clone").deep;var restoreWithComponents=require("../restore-with-components");var restoreFromOptimizing=require("../../restore-from-optimizing");var wrapSingle=require("../../wrap-for-optimizing").single;var serializeBody=require("../../../writer/one-time").body;var Token=require("../../../tokenizer/token");function mergeIntoShorthands(j,s){var m={};var t;var l;var i;var o,q;var p,r;if(j.length<3){return}for(o=0,q=j.length;o<q;o++){i=j[o];t=compactable[i.name];if(i.unused){continue}if(i.hack){continue}if(i.block){continue}invalidateOrCompact(j,o,m,s);if(t&&t.componentOf){for(p=0,r=t.componentOf.length;p<r;p++){l=t.componentOf[p];m[l]=m[l]||{};m[l][i.name]=i}}}invalidateOrCompact(j,o,m,s)}function invalidateOrCompact(m,j,k,n){var o=m[j];var i;var p;var l;for(i in k){if(undefined!==o&&i==o.name){continue}p=compactable[i];l=k[i];if(o&&invalidates(k,i,o)){delete k[i];continue}if(p.components.length>Object.keys(l).length){continue}if(mixedImportance(l)){continue}if(!overridable(l,i,n)){continue}if(!mergeable(l)){continue}if(mixedInherit(l)){replaceWithInheritBestFit(m,l,i,n)}else{replaceWithShorthand(m,l,i,n)}}}function invalidates(i,g,k){var l=compactable[g];var j=compactable[k.name];var h;if("overridesShorthands" in l&&l.overridesShorthands.indexOf(k.name)>-1){return true}if(j&&"componentOf" in j){for(h in i[g]){if(j.componentOf.indexOf(h)>-1){return true}}}return false}function mixedImportance(f){var d;var e;for(e in f){if(undefined!==d&&f[e].important!=d){return true}d=f[e].important}return false}function overridable(o,q,s){var t=compactable[q];var i=[Token.PROPERTY,[Token.PROPERTY_NAME,q],[Token.PROPERTY_VALUE,t.defaultValue]];var l=wrapSingle(i);var m;var n;var p,r;populateComponents([l],s,[]);for(p=0,r=t.components.length;p<r;p++){m=o[t.components[p]];n=compactable[m.name].canOverride;if(!everyValuesPair(n.bind(null,s),l.components[p],m)){return false}}return true}function mergeable(k){var n=null;var l;var i;var m;var j;var h;for(i in k){m=k[i];j=compactable[i];if(!("restore" in j)){continue}restoreFromOptimizing([m.all[m.position]],restoreWithComponents);h=j.restore(m,compactable);l=h.length;if(n!==null&&l!==n){return false}n=l}return true}function mixedInherit(g){var f;var e=null;var h;for(f in g){h=hasInherit(g[f]);if(e!==null&&e!==h){return true}e=h}return false}function replaceWithInheritBestFit(y,s,F,H){var u=buildSequenceWithInheritLonghands(s,F,H);var B=buildSequenceWithInheritShorthand(s,F,H);var G=u[0];var D=B[0];var E=serializeBody(G).length<serializeBody(D).length;var w=E?G:D;var t=E?u[1]:B[1];var C=E?u[2]:B[2];var v=s[Object.keys(s)[0]].all;var z;var r;var x;var A;t.position=v.length;t.shorthand=true;t.dirty=true;t.all=v;t.all.push(w[0]);y.push(t);for(z in s){r=s[z];r.unused=true;if(r.name in C){x=C[r.name];A=findTokenIn(w,z);x.position=v.length;x.all=v;x.all.push(A);y.push(x)}}}function buildSequenceWithInheritLonghands(u,x,A){var z=[];var s={};var v={};var B=compactable[x];var C=[Token.PROPERTY,[Token.PROPERTY_NAME,x],[Token.PROPERTY_VALUE,B.defaultValue]];var i=wrapSingle(C);var l;var t;var r;var D;var w,y;populateComponents([i],A,[]);for(w=0,y=B.components.length;w<y;w++){l=u[B.components[w]];if(hasInherit(l)){t=l.all[l.position].slice(0,2);Array.prototype.push.apply(t,l.value);z.push(t);r=deepClone(l);r.value=inferComponentValue(u,r.name);i.components[w]=r;s[l.name]=deepClone(l)}else{r=deepClone(l);r.all=l.all;i.components[w]=r;v[l.name]=l}}D=joinMetadata(v,1);C[1].push(D);restoreFromOptimizing([i],restoreWithComponents);C=C.slice(0,2);Array.prototype.push.apply(C,i.value);z.unshift(C);return[z,i,s]}function inferComponentValue(d,e){var f=compactable[e];if("oppositeTo" in f){return d[f.oppositeTo].value}else{return[[Token.PROPERTY_VALUE,f.defaultValue]]}}function joinMetadata(j,i){var k=[];var l;var n;var m;var h;for(h in j){l=j[h];n=l.all[l.position];m=n[i][n[i].length-1];Array.prototype.push.apply(k,m)}return k.sort(metadataSorter)}function metadataSorter(i,j){var g=i[0];var h=j[0];var k=i[1];var l=j[1];if(g<h){return -1}else{if(g===h){return k<l?-1:1}else{return 1}}}function buildSequenceWithInheritShorthand(t,w,A){var y=[];var r={};var u={};var B=compactable[w];var C=[Token.PROPERTY,[Token.PROPERTY_NAME,w],[Token.PROPERTY_VALUE,"inherit"]];var i=wrapSingle(C);var l;var s;var D;var z;var v,x;populateComponents([i],A,[]);for(v=0,x=B.components.length;v<x;v++){l=t[B.components[v]];if(hasInherit(l)){r[l.name]=l}else{s=l.all[l.position].slice(0,2);Array.prototype.push.apply(s,l.value);y.push(s);u[l.name]=deepClone(l)}}D=joinMetadata(r,1);C[1].push(D);z=joinMetadata(r,2);C[2].push(z);y.unshift(C);return[y,i,u]}function findTokenIn(g,e){var h,f;for(h=0,f=g.length;h<f;h++){if(g[h][1][1]==e){return g[h]}}}function replaceWithShorthand(t,l,w,z){var A=compactable[w];var B;var y;var i=[Token.PROPERTY,[Token.PROPERTY_NAME,w],[Token.PROPERTY_VALUE,A.defaultValue]];var r;var q=wrapSingle(i);q.shorthand=true;q.dirty=true;populateComponents([q],z,[]);for(var v=0,x=A.components.length;v<x;v++){var s=l[A.components[v]];q.components[v]=deepClone(s);q.important=s.important;r=s.all}for(var u in l){l[u].unused=true}B=joinMetadata(l,1);i[1].push(B);y=joinMetadata(l,2);i[2].push(y);q.position=r.length;q.all=r;q.all.push(i);t.push(q)}module.exports=mergeIntoShorthands;