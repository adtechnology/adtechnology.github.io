var everyValuesPair=require("./every-values-pair");var hasInherit=require("./has-inherit");var populateComponents=require("./populate-components");var compactable=require("../compactable");var deepClone=require("../clone").deep;var restoreWithComponents=require("../restore-with-components");var restoreFromOptimizing=require("../../restore-from-optimizing");var wrapSingle=require("../../wrap-for-optimizing").single;var serializeBody=require("../../../writer/one-time").body;var Token=require("../../../tokenizer/token");function mergeIntoShorthands(k,b){var g={};var a;var h;var n;var f,d;var e,c;if(k.length<3){return}for(f=0,d=k.length;f<d;f++){n=k[f];a=compactable[n.name];if(n.unused){continue}if(n.hack){continue}if(n.block){continue}invalidateOrCompact(k,f,g,b);if(a&&a.componentOf){for(e=0,c=a.componentOf.length;e<c;e++){h=a.componentOf[e];g[h]=g[h]||{};g[h][n.name]=n}}}invalidateOrCompact(k,f,g,b)}function invalidateOrCompact(f,a,h,e){var d=f[a];var b;var c;var g;for(b in h){if(undefined!==d&&b==d.name){continue}c=compactable[b];g=h[b];if(d&&invalidates(h,b,d)){delete h[b];continue}if(c.components.length>Object.keys(g).length){continue}if(mixedImportance(g)){continue}if(!overridable(g,b,e)){continue}if(!mergeable(g)){continue}if(mixedInherit(g)){replaceWithInheritBestFit(f,g,b,e)}else{replaceWithShorthand(f,g,b,e)}}}function invalidates(f,b,d){var c=compactable[b];var e=compactable[d.name];var a;if("overridesShorthands" in c&&c.overridesShorthands.indexOf(d.name)>-1){return true}if(e&&"componentOf" in e){for(a in f[b]){if(e.componentOf.indexOf(a)>-1){return true}}}return false}function mixedImportance(c){var b;var a;for(a in c){if(undefined!==b&&c[a].important!=b){return true}b=c[a].important}return false}function overridable(f,d,b){var a=compactable[d];var k=[Token.PROPERTY,[Token.PROPERTY_NAME,d],[Token.PROPERTY_VALUE,a.defaultValue]];var j=wrapSingle(k);var h;var g;var e,c;populateComponents([j],b,[]);for(e=0,c=a.components.length;e<c;e++){h=f[a.components[e]];g=compactable[h.name].canOverride;if(!everyValuesPair(g.bind(null,b),j.components[e],h)){return false}}return true}function mergeable(f){var c=null;var e;var a;var d;var g;var b;for(a in f){d=f[a];g=compactable[a];if(!("restore" in g)){continue}restoreFromOptimizing([d.all[d.position]],restoreWithComponents);b=g.restore(d,compactable);e=b.length;if(c!==null&&e!==c){return false}c=e}return true}function mixedInherit(d){var a;var b=null;var c;for(a in d){c=hasInherit(d[a]);if(b!==null&&b!==c){return true}b=c}return false}function replaceWithInheritBestFit(j,p,c,a){var n=buildSequenceWithInheritLonghands(p,c,a);var g=buildSequenceWithInheritShorthand(p,c,a);var b=n[0];var e=g[0];var d=serializeBody(b).length<serializeBody(e).length;var l=d?b:e;var o=d?n[1]:g[1];var f=d?n[2]:g[2];var m=p[Object.keys(p)[0]].all;var i;var q;var k;var h;o.position=m.length;o.shorthand=true;o.dirty=true;o.all=m;o.all.push(l[0]);j.push(o);for(i in p){q=p[i];q.unused=true;if(q.name in f){k=f[q.name];h=findTokenIn(l,i);k.position=m.length;k.all=m;k.all.push(h);j.push(k)}}}function buildSequenceWithInheritLonghands(k,g,d){var e=[];var n={};var j={};var c=compactable[g];var b=[Token.PROPERTY,[Token.PROPERTY_NAME,g],[Token.PROPERTY_VALUE,c.defaultValue]];var q=wrapSingle(b);var p;var m;var o;var a;var h,f;populateComponents([q],d,[]);for(h=0,f=c.components.length;h<f;h++){p=k[c.components[h]];if(hasInherit(p)){m=p.all[p.position].slice(0,2);Array.prototype.push.apply(m,p.value);e.push(m);o=deepClone(p);o.value=inferComponentValue(k,o.name);q.components[h]=o;n[p.name]=deepClone(p)}else{o=deepClone(p);o.all=p.all;q.components[h]=o;j[p.name]=p}}a=joinMetadata(j,1);b[1].push(a);restoreFromOptimizing([q],restoreWithComponents);b=b.slice(0,2);Array.prototype.push.apply(b,q.value);e.unshift(b);return[e,q,n]}function inferComponentValue(b,a){var c=compactable[a];if("oppositeTo" in c){return b[c.oppositeTo].value}else{return[[Token.PROPERTY_VALUE,c.defaultValue]]}}function joinMetadata(g,a){var f=[];var e;var c;var d;var b;for(b in g){e=g[b];c=e.all[e.position];d=c[a][c[a].length-1];Array.prototype.push.apply(f,d)}return f.sort(metadataSorter)}function metadataSorter(f,e){var b=f[0];var a=e[0];var d=f[1];var c=e[1];if(b<a){return -1}else{if(b===a){return d<c?-1:1}else{return 1}}}function buildSequenceWithInheritShorthand(m,h,d){var f=[];var o={};var k={};var c=compactable[h];var b=[Token.PROPERTY,[Token.PROPERTY_NAME,h],[Token.PROPERTY_VALUE,"inherit"]];var q=wrapSingle(b);var p;var n;var a;var e;var j,g;populateComponents([q],d,[]);for(j=0,g=c.components.length;j<g;j++){p=m[c.components[j]];if(hasInherit(p)){o[p.name]=p}else{n=p.all[p.position].slice(0,2);Array.prototype.push.apply(n,p.value);f.push(n);k[p.name]=deepClone(p)}}a=joinMetadata(o,1);b[1].push(a);e=joinMetadata(o,2);b[2].push(e);f.unshift(b);return[f,q,k]}function findTokenIn(d,b){var c,a;for(c=0,a=d.length;c<a;c++){if(d[c][1][1]==b){return d[c]}}}function replaceWithShorthand(j,o,f,c){var b=compactable[f];var a;var d;var p=[Token.PROPERTY,[Token.PROPERTY_NAME,f],[Token.PROPERTY_VALUE,b.defaultValue]];var m;var n=wrapSingle(p);n.shorthand=true;n.dirty=true;populateComponents([n],c,[]);for(var g=0,e=b.components.length;g<e;g++){var k=o[b.components[g]];n.components[g]=deepClone(k);n.important=k.important;m=k.all}for(var h in o){o[h].unused=true}a=joinMetadata(o,1);p[1].push(a);d=joinMetadata(o,2);p[2].push(d);n.position=m.length;n.all=m;n.all.push(p);j.push(n)}module.exports=mergeIntoShorthands;