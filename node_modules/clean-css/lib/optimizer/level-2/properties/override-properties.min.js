var hasInherit=require("./has-inherit");var everyValuesPair=require("./every-values-pair");var findComponentIn=require("./find-component-in");var isComponentOf=require("./is-component-of");var isMergeableShorthand=require("./is-mergeable-shorthand");var overridesNonComponentShorthand=require("./overrides-non-component-shorthand");var sameVendorPrefixesIn=require("./vendor-prefixes").same;var compactable=require("../compactable");var deepClone=require("../clone").deep;var deepClone=require("../clone").deep;var restoreWithComponents=require("../restore-with-components");var shallowClone=require("../clone").shallow;var restoreFromOptimizing=require("../../restore-from-optimizing");var Token=require("../../../tokenizer/token");var Marker=require("../../../tokenizer/marker");var serializeProperty=require("../../../writer/one-time").property;function wouldBreakCompatibility(f,d){for(var c=0;c<f.components.length;c++){var b=f.components[c];var g=compactable[b.name];var e=g&&g.canOverride||e.sameValue;var a=shallowClone(b);a.value=[[Token.PROPERTY_VALUE,g.defaultValue]];if(!everyValuesPair(e.bind(null,d),a,b)){return true}}return false}function overrideIntoMultiplex(a,b){b.unused=true;turnIntoMultiplex(b,multiplexSize(a));a.value=b.value}function overrideByMultiplex(a,b){b.unused=true;a.multiplex=true;a.value=b.value}function overrideSimple(a,b){b.unused=true;a.value=b.value}function override(a,b){if(b.multiplex){overrideByMultiplex(a,b)}else{if(a.multiplex){overrideIntoMultiplex(a,b)}else{overrideSimple(a,b)}}}function overrideShorthand(c,d){d.unused=true;for(var b=0,a=c.components.length;b<a;b++){override(c.components[b],d.components[b],c.multiplex)}}function turnIntoMultiplex(b,a){b.multiplex=true;if(compactable[b.name].shorthand){turnShorthandValueIntoMultiplex(b,a)}else{turnLonghandValueIntoMultiplex(b,a)}}function turnShorthandValueIntoMultiplex(e,d){var b;var c,a;for(c=0,a=e.components.length;c<a;c++){b=e.components[c];if(!b.multiplex){turnLonghandValueIntoMultiplex(b,d)}}}function turnLonghandValueIntoMultiplex(e,d){var g=compactable[e.name].intoMultiplexMode=="real";var f=g?e.value.slice(0):compactable[e.name].defaultValue;var c=multiplexSize(e);var b;var a=f.length;for(;c<d;c++){e.value.push([Token.PROPERTY_VALUE,Marker.COMMA]);if(Array.isArray(f)){for(b=0;b<a;b++){e.value.push(g?f[b]:[Token.PROPERTY_VALUE,f[b]])}}else{e.value.push(g?f:[Token.PROPERTY_VALUE,f])}}}function multiplexSize(b){var d=0;for(var c=0,a=b.value.length;c<a;c++){if(b.value[c][1]==Marker.COMMA){d++}}return d+1}function lengthOf(a){var b=[Token.PROPERTY,[Token.PROPERTY_NAME,a.name]].concat(a.value);return serializeProperty([b],0).length}function moreSameShorthands(d,a,b){var e=0;for(var c=a;c>=0;c--){if(d[c].name==b&&!d[c].unused){e++}if(e>1){break}}return e>1}function overridingFunction(b,d){for(var c=0,a=b.components.length;c<a;c++){if(!anyValue(d.isUrl,b.components[c])&&anyValue(d.isFunction,b.components[c])){return true}}return false}function anyValue(c,d){for(var b=0,a=d.value.length;b<a;b++){if(d.value[b][1]==Marker.COMMA){continue}if(c(d.value[b][1])){return true}}return false}function wouldResultInLongerValue(d,h){if(!d.multiplex&&!h.multiplex||d.multiplex&&h.multiplex){return false}var b=d.multiplex?d:h;var a=d.multiplex?h:d;var f;var g=deepClone(b);restoreFromOptimizing([g],restoreWithComponents);var c=deepClone(a);restoreFromOptimizing([c],restoreWithComponents);var e=lengthOf(g)+1+lengthOf(c);if(d.multiplex){f=findComponentIn(g,c);overrideIntoMultiplex(f,c)}else{f=findComponentIn(c,g);turnIntoMultiplex(c,multiplexSize(g));overrideByMultiplex(f,g)}restoreFromOptimizing([c],restoreWithComponents);var i=lengthOf(c);return e<=i}function isCompactable(a){return a.name in compactable}function noneOverrideHack(b,a){return !b.multiplex&&(b.name=="background"||b.name=="background-image")&&a.multiplex&&(a.name=="background"||a.name=="background-image")&&anyLayerIsNone(a.value)}function anyLayerIsNone(b){var d=intoLayers(b);for(var c=0,a=d.length;c<a;c++){if(d[c].length==1&&d[c][0][1]=="none"){return true}}return false}function intoLayers(b){var f=[];for(var d=0,c=[],a=b.length;d<a;d++){var e=b[d];if(e[1]==Marker.COMMA){f.push(c);c=[]}else{c.push(e)}}f.push(c);return f}function overrideProperties(h,u,a,f){var g,w,d,p;var l;var n;var b;var c;var t,s,r;propertyLoop:for(t=h.length-1;t>=0;t--){w=h[t];if(!isCompactable(w)){continue}if(w.block){continue}g=compactable[w.name].canOverride;traverseLoop:for(s=t-1;s>=0;s--){d=h[s];if(!isCompactable(d)){continue}if(d.block){continue}if(d.unused||w.unused){continue}if(d.hack&&!w.hack&&!w.important||!d.hack&&!d.important&&w.hack){continue}if(d.important==w.important&&d.hack[0]!=w.hack[0]){continue}if(d.important==w.important&&(d.hack[0]!=w.hack[0]||(d.hack[1]&&d.hack[1]!=w.hack[1]))){continue}if(hasInherit(w)){continue}if(noneOverrideHack(d,w)){continue}if(w.shorthand&&isComponentOf(w,d)){if(!w.important&&d.important){continue}if(!sameVendorPrefixesIn([d],w.components)){continue}if(!anyValue(f.isFunction,d)&&overridingFunction(w,f)){continue}if(!isMergeableShorthand(w)){d.unused=true;continue}p=findComponentIn(w,d);g=compactable[d.name].canOverride;if(everyValuesPair(g.bind(null,f),d,p)){d.unused=true}}else{if(w.shorthand&&overridesNonComponentShorthand(w,d)){if(!w.important&&d.important){continue}if(!sameVendorPrefixesIn([d],w.components)){continue}if(!anyValue(f.isFunction,d)&&overridingFunction(w,f)){continue}l=d.shorthand?d.components:[d];for(r=l.length-1;r>=0;r--){n=l[r];b=findComponentIn(w,n);g=compactable[n.name].canOverride;if(!everyValuesPair(g.bind(null,f),d,b)){continue traverseLoop}}d.unused=true}else{if(u&&d.shorthand&&!w.shorthand&&isComponentOf(d,w,true)){if(w.important&&!d.important){continue}if(!w.important&&d.important){w.unused=true;continue}if(moreSameShorthands(h,t-1,d.name)){continue}if(overridingFunction(d,f)){continue}if(!isMergeableShorthand(d)){continue}p=findComponentIn(d,w);if(everyValuesPair(g.bind(null,f),p,w)){var v=!a.properties.backgroundClipMerging&&p.name.indexOf("background-clip")>-1||!a.properties.backgroundOriginMerging&&p.name.indexOf("background-origin")>-1||!a.properties.backgroundSizeMerging&&p.name.indexOf("background-size")>-1;var o=compactable[w.name].nonMergeableValue===w.value[0][1];if(v||o){continue}if(!a.properties.merging&&wouldBreakCompatibility(d,f)){continue}if(p.value[0][1]!=w.value[0][1]&&(hasInherit(d)||hasInherit(w))){continue}if(wouldResultInLongerValue(d,w)){continue}if(!d.multiplex&&w.multiplex){turnIntoMultiplex(d,multiplexSize(w))}override(p,w);d.dirty=true}}else{if(u&&d.shorthand&&w.shorthand&&d.name==w.name){if(!d.multiplex&&w.multiplex){continue}if(!w.important&&d.important){w.unused=true;continue propertyLoop}if(w.important&&!d.important){d.unused=true;continue}if(!isMergeableShorthand(w)){d.unused=true;continue}for(r=d.components.length-1;r>=0;r--){var e=d.components[r];var q=w.components[r];g=compactable[e.name].canOverride;if(!everyValuesPair(g.bind(null,f),e,q)){continue propertyLoop}}overrideShorthand(d,w);d.dirty=true}else{if(u&&d.shorthand&&w.shorthand&&isComponentOf(d,w)){if(!d.important&&w.important){continue}p=findComponentIn(d,w);g=compactable[w.name].canOverride;if(!everyValuesPair(g.bind(null,f),p,w)){continue}if(d.important&&!w.important){w.unused=true;continue}var m=compactable[w.name].restore(w,compactable);if(m.length>1){continue}p=findComponentIn(d,w);override(p,w);w.dirty=true}else{if(d.name==w.name){c=true;if(w.shorthand){for(r=w.components.length-1;r>=0&&c;r--){n=d.components[r];b=w.components[r];g=compactable[b.name].canOverride;c=c&&everyValuesPair(g.bind(null,f),n,b)}}else{g=compactable[w.name].canOverride;c=everyValuesPair(g.bind(null,f),d,w)}if(d.important&&!w.important&&c){w.unused=true;continue}if(!d.important&&w.important&&c){d.unused=true;continue}if(!c){continue}d.unused=true}}}}}}}}}module.exports=overrideProperties;