var hasInherit=require("./has-inherit");var everyValuesPair=require("./every-values-pair");var findComponentIn=require("./find-component-in");var isComponentOf=require("./is-component-of");var isMergeableShorthand=require("./is-mergeable-shorthand");var overridesNonComponentShorthand=require("./overrides-non-component-shorthand");var sameVendorPrefixesIn=require("./vendor-prefixes").same;var compactable=require("../compactable");var deepClone=require("../clone").deep;var deepClone=require("../clone").deep;var restoreWithComponents=require("../restore-with-components");var shallowClone=require("../clone").shallow;var restoreFromOptimizing=require("../../restore-from-optimizing");var Token=require("../../../tokenizer/token");var Marker=require("../../../tokenizer/marker");var serializeProperty=require("../../../writer/one-time").property;function wouldBreakCompatibility(k,m){for(var n=0;n<k.components.length;n++){var h=k.components[n];var j=compactable[h.name];var l=j&&j.canOverride||l.sameValue;var i=shallowClone(h);i.value=[[Token.PROPERTY_VALUE,j.defaultValue]];if(!everyValuesPair(l.bind(null,m),i,h)){return true}}return false}function overrideIntoMultiplex(d,c){c.unused=true;turnIntoMultiplex(c,multiplexSize(d));d.value=c.value}function overrideByMultiplex(d,c){c.unused=true;d.multiplex=true;d.value=c.value}function overrideSimple(d,c){c.unused=true;d.value=c.value}function override(d,c){if(c.multiplex){overrideByMultiplex(d,c)}else{if(d.multiplex){overrideIntoMultiplex(d,c)}else{overrideSimple(d,c)}}}function overrideShorthand(h,g){g.unused=true;for(var e=0,f=h.components.length;e<f;e++){override(h.components[e],g.components[e],h.multiplex)}}function turnIntoMultiplex(c,d){c.multiplex=true;if(compactable[c.name].shorthand){turnShorthandValueIntoMultiplex(c,d)}else{turnLonghandValueIntoMultiplex(c,d)}}function turnShorthandValueIntoMultiplex(h,i){var f;var j,g;for(j=0,g=h.components.length;j<g;j++){f=h.components[j];if(!f.multiplex){turnLonghandValueIntoMultiplex(f,i)}}}function turnLonghandValueIntoMultiplex(l,m){var j=compactable[l.name].intoMultiplexMode=="real";var k=j?l.value.slice(0):compactable[l.name].defaultValue;var n=multiplexSize(l);var h;var i=k.length;for(;n<m;n++){l.value.push([Token.PROPERTY_VALUE,Marker.COMMA]);if(Array.isArray(k)){for(h=0;h<i;h++){l.value.push(j?k[h]:[Token.PROPERTY_VALUE,k[h]])}}else{l.value.push(j?k:[Token.PROPERTY_VALUE,k])}}}function multiplexSize(e){var g=0;for(var h=0,f=e.value.length;h<f;h++){if(e.value[h][1]==Marker.COMMA){g++}}return g+1}function lengthOf(d){var c=[Token.PROPERTY,[Token.PROPERTY_NAME,d.name]].concat(d.value);return serializeProperty([c],0).length}function moreSameShorthands(i,g,f){var h=0;for(var j=g;j>=0;j--){if(i[j].name==f&&!i[j].unused){h++}if(h>1){break}}return h>1}function overridingFunction(e,g){for(var h=0,f=e.components.length;h<f;h++){if(!anyValue(g.isUrl,e.components[h])&&anyValue(g.isFunction,e.components[h])){return true}}return false}function anyValue(h,g){for(var e=0,f=g.value.length;e<f;e++){if(g.value[e][1]==Marker.COMMA){continue}if(h(g.value[e][1])){return true}}return false}function wouldResultInLongerValue(o,k){if(!o.multiplex&&!k.multiplex||o.multiplex&&k.multiplex){return false}var q=o.multiplex?o:k;var r=o.multiplex?k:o;var m;var l=deepClone(q);restoreFromOptimizing([l],restoreWithComponents);var p=deepClone(r);restoreFromOptimizing([p],restoreWithComponents);var n=lengthOf(l)+1+lengthOf(p);if(o.multiplex){m=findComponentIn(l,p);overrideIntoMultiplex(m,p)}else{m=findComponentIn(p,l);turnIntoMultiplex(p,multiplexSize(l));overrideByMultiplex(m,l)}restoreFromOptimizing([p],restoreWithComponents);var j=lengthOf(p);return n<=j}function isCompactable(b){return b.name in compactable}function noneOverrideHack(c,d){return !c.multiplex&&(c.name=="background"||c.name=="background-image")&&d.multiplex&&(d.name=="background"||d.name=="background-image")&&anyLayerIsNone(d.value)}function anyLayerIsNone(e){var g=intoLayers(e);for(var h=0,f=g.length;h<f;h++){if(g[h].length==1&&g[h][0][1]=="none"){return true}}return false}function intoLayers(g){var i=[];for(var k=0,l=[],h=g.length;k<h;k++){var j=g[k];if(j[1]==Marker.COMMA){i.push(l);l=[]}else{l.push(j)}}i.push(l);return i}function overrideProperties(G,k,N,I){var H,i,K,B;var F;var D;var M;var L;var x,y,z;propertyLoop:for(x=G.length-1;x>=0;x--){i=G[x];if(!isCompactable(i)){continue}if(i.block){continue}H=compactable[i.name].canOverride;traverseLoop:for(y=x-1;y>=0;y--){K=G[y];if(!isCompactable(K)){continue}if(K.block){continue}if(K.unused||i.unused){continue}if(K.hack&&!i.hack&&!i.important||!K.hack&&!K.important&&i.hack){continue}if(K.important==i.important&&K.hack[0]!=i.hack[0]){continue}if(K.important==i.important&&(K.hack[0]!=i.hack[0]||(K.hack[1]&&K.hack[1]!=i.hack[1]))){continue}if(hasInherit(i)){continue}if(noneOverrideHack(K,i)){continue}if(i.shorthand&&isComponentOf(i,K)){if(!i.important&&K.important){continue}if(!sameVendorPrefixesIn([K],i.components)){continue}if(!anyValue(I.isFunction,K)&&overridingFunction(i,I)){continue}if(!isMergeableShorthand(i)){K.unused=true;continue}B=findComponentIn(i,K);H=compactable[K.name].canOverride;if(everyValuesPair(H.bind(null,I),K,B)){K.unused=true}}else{if(i.shorthand&&overridesNonComponentShorthand(i,K)){if(!i.important&&K.important){continue}if(!sameVendorPrefixesIn([K],i.components)){continue}if(!anyValue(I.isFunction,K)&&overridingFunction(i,I)){continue}F=K.shorthand?K.components:[K];for(z=F.length-1;z>=0;z--){D=F[z];M=findComponentIn(i,D);H=compactable[D.name].canOverride;if(!everyValuesPair(H.bind(null,I),K,M)){continue traverseLoop}}K.unused=true}else{if(k&&K.shorthand&&!i.shorthand&&isComponentOf(K,i,true)){if(i.important&&!K.important){continue}if(!i.important&&K.important){i.unused=true;continue}if(moreSameShorthands(G,x-1,K.name)){continue}if(overridingFunction(K,I)){continue}if(!isMergeableShorthand(K)){continue}B=findComponentIn(K,i);if(everyValuesPair(H.bind(null,I),B,i)){var j=!N.properties.backgroundClipMerging&&B.name.indexOf("background-clip")>-1||!N.properties.backgroundOriginMerging&&B.name.indexOf("background-origin")>-1||!N.properties.backgroundSizeMerging&&B.name.indexOf("background-size")>-1;var C=compactable[i.name].nonMergeableValue===i.value[0][1];if(j||C){continue}if(!N.properties.merging&&wouldBreakCompatibility(K,I)){continue}if(B.value[0][1]!=i.value[0][1]&&(hasInherit(K)||hasInherit(i))){continue}if(wouldResultInLongerValue(K,i)){continue}if(!K.multiplex&&i.multiplex){turnIntoMultiplex(K,multiplexSize(i))}override(B,i);K.dirty=true}}else{if(k&&K.shorthand&&i.shorthand&&K.name==i.name){if(!K.multiplex&&i.multiplex){continue}if(!i.important&&K.important){i.unused=true;continue propertyLoop}if(i.important&&!K.important){K.unused=true;continue}if(!isMergeableShorthand(i)){K.unused=true;continue}for(z=K.components.length-1;z>=0;z--){var J=K.components[z];var A=i.components[z];H=compactable[J.name].canOverride;if(!everyValuesPair(H.bind(null,I),J,A)){continue propertyLoop}}overrideShorthand(K,i);K.dirty=true}else{if(k&&K.shorthand&&i.shorthand&&isComponentOf(K,i)){if(!K.important&&i.important){continue}B=findComponentIn(K,i);H=compactable[i.name].canOverride;if(!everyValuesPair(H.bind(null,I),B,i)){continue}if(K.important&&!i.important){i.unused=true;continue}var E=compactable[i.name].restore(i,compactable);if(E.length>1){continue}B=findComponentIn(K,i);override(B,i);i.dirty=true}else{if(K.name==i.name){L=true;if(i.shorthand){for(z=i.components.length-1;z>=0&&L;z--){D=K.components[z];M=i.components[z];H=compactable[M.name].canOverride;L=L&&everyValuesPair(H.bind(null,I),D,M)}}else{H=compactable[i.name].canOverride;L=everyValuesPair(H.bind(null,I),K,i)}if(K.important&&!i.important&&L){i.unused=true;continue}if(!K.important&&i.important&&L){K.unused=true;continue}if(!L){continue}K.unused=true}}}}}}}}}module.exports=overrideProperties;