var isMergeable=require("./is-mergeable");var optimizeProperties=require("./properties/optimize");var cloneArray=require("../../utils/clone-array");var Token=require("../../tokenizer/token");var serializeBody=require("../../writer/one-time").body;var serializeRules=require("../../writer/one-time").rules;function reduceNonAdjacent(o,c){var t=c.options;var r=t.compatibility.selectors.mergeablePseudoClasses;var l=t.compatibility.selectors.mergeablePseudoElements;var s=t.compatibility.selectors.multiplePseudoMerging;var n={};var e=[];for(var k=o.length-1;k>=0;k--){var g=o[k];if(g[0]!=Token.RULE){continue}else{if(g[2].length===0){continue}}var b=serializeRules(g[1]);var q=g[1].length>1&&isMergeable(b,r,l,s);var a=wrappedSelectorsFrom(g[1]);var p=q?[b].concat(a):[b];for(var h=0,d=p.length;h<d;h++){var f=p[h];if(!n[f]){n[f]=[]}else{e.push(f)}n[f].push({where:k,list:a,isPartial:q&&h>0,isComplex:q&&h===0})}}reduceSimpleNonAdjacentCases(o,e,n,t,c);reduceComplexNonAdjacentCases(o,n,t,c)}function wrappedSelectorsFrom(c){var a=[];for(var b=0;b<c.length;b++){a.push([c[b][1]])}return a}function reduceSimpleNonAdjacentCases(k,b,h,m,a){function e(i,l){return f[i].isPartial&&l.length===0}function j(l,o,i,n){if(!f[i-n-1].isPartial){l[2]=o}}for(var g=0,d=b.length;g<d;g++){var c=b[g];var f=h[c];reduceSelector(k,f,{filterOut:e,callback:j},m,a)}}function reduceComplexNonAdjacentCases(o,l,h,e){var b=h.compatibility.selectors.mergeablePseudoClasses;var i=h.compatibility.selectors.mergeablePseudoElements;var n=h.compatibility.selectors.multiplePseudoMerging;var d={};function q(j){return d.data[j].where<d.intoPosition}function f(m,x,j,w){if(w===0){d.reducedBodies.push(x)}}allSelectors:for(var a in l){var p=l[a];if(!p[0].isComplex){continue}var v=p[p.length-1].where;var g=o[v];var c=[];var k=isMergeable(a,b,i,n)?p[0].list:[a];d.intoPosition=v;d.reducedBodies=c;for(var t=0,r=k.length;t<r;t++){var s=k[t];var u=l[s];if(u.length<2){continue allSelectors}d.data=u;reduceSelector(o,u,{filterOut:q,callback:f},h,e);if(serializeBody(c[c.length-1])!=serializeBody(c[0])){continue allSelectors}}g[2]=c[0]}}function reduceSelector(p,m,d,q,f){var b=[];var g=[];var o=[];for(var k=m.length-1;k>=0;k--){if(d.filterOut(k,b)){continue}var l=m[k].where;var h=p[l];var e=cloneArray(h[2]);b=b.concat(e);g.push(e);o.push(l)}optimizeProperties(b,true,false,f);var a=o.length;var i=b.length-1;var n=a-1;while(n>=0){if((n===0||(b[i]&&g[n].indexOf(b[i])>-1))&&i>-1){i--;continue}var c=b.splice(i+1);d.callback(p[o[n]],c,a,n);n--}}module.exports=reduceNonAdjacent;