var canReorderSingle=require("./reorderable").canReorderSingle;var extractProperties=require("./extract-properties");var isMergeable=require("./is-mergeable");var tidyRuleDuplicates=require("./tidy-rule-duplicates");var Token=require("../../tokenizer/token");var cloneArray=require("../../utils/clone-array");var serializeBody=require("../../writer/one-time").body;var serializeRules=require("../../writer/one-time").rules;function naturalSorter(d,c){return d>c?1:-1}function cloneAndMergeSelectors(c,b){var a=cloneArray(c);a[5]=a[5].concat(b[5]);return a}function restructure(C,X){var u=X.options;var O=u.compatibility.selectors.mergeablePseudoClasses;var s=u.compatibility.selectors.mergeablePseudoElements;var d=u.compatibility.selectors.mergeLimit;var e=u.compatibility.selectors.multiplePseudoMerging;var c=X.cache.specificity;var t={};var M=[];var v={};var L=[];var h=2;var J="%";function g(k,j,aa){for(var Z=aa.length-1;Z>=0;Z--){var m=aa[Z][0];var ab=b(j,m);if(v[ab].length>1&&f(k,v[ab])){F(ab);break}}}function b(i,j){var k=q(j);v[k]=v[k]||[];v[k].push([i,j]);return k}function F(ab){var j=ab.split(J);var aa=[];var m;for(var Z in v){var k=Z.split(J);for(m=k.length-1;m>=0;m--){if(j.indexOf(k[m])>-1){aa.push(Z);break}}}for(m=aa.length-1;m>=0;m--){delete v[aa[m]]}}function q(k){var Z=[];for(var m=0,j=k.length;m<j;m++){Z.push(serializeRules(k[m][1]))}return Z.join(J)}function H(m){var j=[];var Z=[];for(var k=m.length-1;k>=0;k--){if(!isMergeable(serializeRules(m[k][1]),O,s,e)){continue}Z.unshift(m[k]);if(m[k][2].length>0&&j.indexOf(m[k])==-1){j.push(m[k])}}return j.length>1?Z:[]}function Q(aa,k){var j=k[0];var ae=k[1];var af=k[4];var ad=j.length+ae.length+1;var ag=[];var ah=[];var ac=H(t[af]);if(ac.length<2){return}var ab=T(ac,ad,1);var Z=ab[0];if(Z[1]>0){return g(aa,k,ab)}for(var m=Z[0].length-1;m>=0;m--){ag=Z[0][m][1].concat(ag);ah.unshift(Z[0][m])}ag=tidyRuleDuplicates(ag);A(aa,[k],ag,ah)}function D(j,i){return j[1]>i[1]?1:(j[1]==i[1]?0:-1)}function T(m,i,k){var j=I(m,i,k,h-1);return j.sort(D)}function I(aa,k,Z,ac){var ab=[[aa,G(aa,k,Z)]];if(aa.length>2&&ac>0){for(var m=aa.length-1;m>=0;m--){var j=Array.prototype.slice.call(aa,0);j.splice(m,1);ab=ab.concat(I(j,k,Z,ac-1))}}return ab}function G(Z,j,m){var aa=0;for(var k=Z.length-1;k>=0;k--){aa+=Z[k][2].length>m?serializeRules(Z[k][1]).length:-1}return aa-(Z.length-1)*j+1}function A(ae,ai,an,ah){var ad,ac,ab,aa;var al=[];for(ad=ah.length-1;ad>=0;ad--){var aj=ah[ad];for(ac=aj[2].length-1;ac>=0;ac--){var ak=aj[2][ac];for(ab=0,aa=ai.length;ab<aa;ab++){var am=ai[ab];var Z=ak[1][1];var af=am[0];var ao=am[4];if(Z==af&&serializeBody([ak])==ao){aj[2].splice(ac,1);break}}}}for(ad=ai.length-1;ad>=0;ad--){al.unshift(ai[ad][3])}var ag=[Token.RULE,an,al];C.splice(ae,0,ag)}function W(k,j){var m=j[4];var i=t[m];if(i&&i.length>1){if(!y(k,j)){Q(k,j)}}}function y(ac,m){var ab=[];var ad=[];var ag=m[4];var aa,Z;var ae=H(t[ag]);if(ae.length<2){return}movableLoop:for(var af in t){var i=t[af];for(aa=ae.length-1;aa>=0;aa--){if(i.indexOf(ae[aa])==-1){continue movableLoop}}ab.push(af)}if(ab.length<2){return false}for(aa=ab.length-1;aa>=0;aa--){for(Z=M.length-1;Z>=0;Z--){if(M[Z][4]==ab[aa]){ad.unshift([M[Z],ae]);break}}}return f(ac,ad)}function f(m,Z){var ad=0;var ae=[];var ag;for(var k=Z.length-1;k>=0;k--){ag=Z[k][0];var aa=ag[4];ad+=aa.length+(k>0?1:0);ae.push(ag)}var ac=Z[0][1];var j=T(ac,ad,ae.length)[0];if(j[1]>0){return false}var af=[];var ah=[];for(k=j[0].length-1;k>=0;k--){af=j[0][k][1].concat(af);ah.unshift(j[0][k])}af=tidyRuleDuplicates(af);A(m,ae,af,ah);for(k=ae.length-1;k>=0;k--){ag=ae[k];var ab=M.indexOf(ag);delete t[ag[4]];if(ab>-1&&L.indexOf(ab)==-1){L.push(ab)}}return true}function n(ab,j,aa){var k=ab[0];var Z=j[0];if(k!=Z){return false}var m=j[4];var i=t[m];return i&&i.indexOf(aa)>-1}for(var U=C.length-1;U>=0;U--){var o=C[U];var w;var S,R,P;var V;if(o[0]==Token.RULE){w=true}else{if(o[0]==Token.NESTED_BLOCK){w=false}else{continue}}var z=M.length;var a=extractProperties(o);L=[];var Y=[];for(S=a.length-1;S>=0;S--){for(R=S-1;R>=0;R--){if(!canReorderSingle(a[S],a[R],c)){Y.push(S);break}}}for(S=a.length-1;S>=0;S--){var N=a[S];var B=false;for(R=0;R<z;R++){var E=M[R];if(L.indexOf(R)==-1&&(!canReorderSingle(N,E,c)&&!n(N,E,o)||t[E[4]]&&t[E[4]].length===d)){W(U+1,E,o);if(L.indexOf(R)==-1){L.push(R);delete t[E[4]]}}if(!B){B=N[0]==E[0]&&N[1]==E[1];if(B){V=R}}}if(!w||Y.indexOf(S)>-1){continue}var r=N[4];if(B&&M[V][5].length+N[5].length>d){W(U+1,M[V]);M.splice(V,1);t[r]=[o];B=false}else{t[r]=t[r]||[];t[r].push(o)}if(B){M[V]=cloneAndMergeSelectors(M[V],N)}else{M.push(N)}}L=L.sort(naturalSorter);for(S=0,P=L.length;S<P;S++){var x=L[S]-S;M.splice(x,1)}}var K=C[0]&&C[0][0]==Token.AT_RULE&&C[0][1].indexOf("@charset")===0?1:0;for(;K<C.length-1;K++){var p=C[K][0]===Token.AT_RULE&&C[K][1].indexOf("@import")===0;var l=C[K][0]===Token.COMMENT;if(!(p||l)){break}}for(U=0;U<M.length;U++){W(K,M[U])}}module.exports=restructure;