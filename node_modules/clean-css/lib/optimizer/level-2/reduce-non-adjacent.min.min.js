var isMergeable=require("./is-mergeable");var optimizeProperties=require("./properties/optimize");var cloneArray=require("../../utils/clone-array");var Token=require("../../tokenizer/token");var serializeBody=require("../../writer/one-time").body;var serializeRules=require("../../writer/one-time").rules;function reduceNonAdjacent(u,D){var G=D.options;var i=G.compatibility.selectors.mergeablePseudoClasses;var w=G.compatibility.selectors.mergeablePseudoElements;var H=G.compatibility.selectors.multiplePseudoMerging;var v={};var B=[];for(var x=u.length-1;x>=0;x--){var z=u[x];if(z[0]!=Token.RULE){continue}else{if(z[2].length===0){continue}}var E=serializeRules(z[1]);var j=z[1].length>1&&isMergeable(E,i,w,H);var F=wrappedSelectorsFrom(z[1]);var m=j?[E].concat(F):[E];for(var y=0,C=m.length;y<C;y++){var A=m[y];if(!v[A]){v[A]=[]}else{B.push(A)}v[A].push({where:x,list:F,isPartial:j&&y>0,isComplex:j&&y===0})}}reduceSimpleNonAdjacentCases(u,B,v,G,D);reduceComplexNonAdjacentCases(u,v,G,D)}function wrappedSelectorsFrom(f){var e=[];for(var d=0;d<f.length;d++){e.push([f[d][1]])}return e}function reduceSimpleNonAdjacentCases(l,u,o,i,v){function r(b,a){return q[b].isPartial&&a.length===0}function n(a,c,b,d){if(!q[b-d-1].isPartial){a[2]=c}}for(var p=0,s=u.length;p<s;p++){var t=u[p];var q=o[t];reduceSelector(l,q,{filterOut:r,callback:n},i,v)}}function reduceComplexNonAdjacentCases(B,D,G,J){var M=G.compatibility.selectors.mergeablePseudoClasses;var F=G.compatibility.selectors.mergeablePseudoElements;var C=G.compatibility.selectors.multiplePseudoMerging;var K={};function z(a){return K.data[a].where<K.intoPosition}function I(b,a,d,c){if(c===0){K.reducedBodies.push(a)}}allSelectors:for(var N in D){var A=D[N];if(!A[0].isComplex){continue}var j=A[A.length-1].where;var H=B[j];var L=[];var E=isMergeable(N,M,F,C)?A[0].list:[N];K.intoPosition=j;K.reducedBodies=L;for(var w=0,y=E.length;w<y;w++){var x=E[w];var m=D[x];if(m.length<2){continue allSelectors}K.data=m;reduceSelector(B,m,{filterOut:z,callback:I},G,J);if(serializeBody(L[L.length-1])!=serializeBody(L[0])){continue allSelectors}}H[2]=L[0]}}function reduceSelector(r,u,C,j,A){var E=[];var z=[];var s=[];for(var w=u.length-1;w>=0;w--){if(C.filterOut(w,E)){continue}var v=u[w].where;var y=r[v];var B=cloneArray(y[2]);E=E.concat(B);z.push(B);s.push(v)}optimizeProperties(E,true,false,A);var F=s.length;var x=E.length-1;var t=F-1;while(t>=0){if((t===0||(E[x]&&z[t].indexOf(E[x])>-1))&&x>-1){x--;continue}var D=E.splice(x+1);C.callback(r[s[t]],D,F,t);t--}}module.exports=reduceNonAdjacent;