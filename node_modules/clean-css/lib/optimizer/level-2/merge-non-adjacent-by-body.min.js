var isMergeable=require("./is-mergeable");var sortSelectors=require("../level-1/sort-selectors");var tidyRules=require("../level-1/tidy-rules");var OptimizationLevel=require("../../options/optimization-level").OptimizationLevel;var serializeBody=require("../../writer/one-time").body;var serializeRules=require("../../writer/one-time").rules;var Token=require("../../tokenizer/token");function unsafeSelector(a){return/\.|\*| :/.test(a)}function isBemElement(b){var a=serializeRules(b[1]);return a.indexOf("__")>-1||a.indexOf("--")>-1}function withoutModifier(a){return a.replace(/--[^ ,>\+~:]+/g,"")}function removeAnyUnsafeElements(f,d){var c=withoutModifier(serializeRules(f[1]));for(var a in d){var b=d[a];var e=withoutModifier(serializeRules(b[1]));if(e.indexOf(c)>-1||c.indexOf(e)>-1){delete d[a]}}}function mergeNonAdjacentByBody(h,a){var o=a.options;var k=o.level[OptimizationLevel.Two].mergeSemantically;var b=o.compatibility.selectors.adjacentSpace;var m=o.level[OptimizationLevel.One].selectorsSortingMethod;var l=o.compatibility.selectors.mergeablePseudoClasses;var f=o.compatibility.selectors.mergeablePseudoElements;var n=o.compatibility.selectors.multiplePseudoMerging;var e={};for(var d=h.length-1;d>=0;d--){var c=h[d];if(c[0]!=Token.RULE){continue}if(c[2].length>0&&(!k&&unsafeSelector(serializeRules(c[1])))){e={}}if(c[2].length>0&&k&&isBemElement(c)){removeAnyUnsafeElements(c,e)}var j=serializeBody(c[2]);var g=e[j];if(g&&isMergeable(serializeRules(c[1]),l,f,n)&&isMergeable(serializeRules(g[1]),l,f,n)){if(c[2].length>0){c[1]=tidyRules(g[1].concat(c[1]),false,b,false,a.warnings);c[1]=c[1].length>1?sortSelectors(c[1],m):c[1]}else{c[1]=g[1].concat(c[1])}g[2]=[];e[j]=null}e[serializeBody(c[2])]=c}}module.exports=mergeNonAdjacentByBody;