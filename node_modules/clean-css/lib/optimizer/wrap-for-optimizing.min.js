var Hack=require("./hack");var Marker=require("../tokenizer/marker");var Token=require("../tokenizer/token");var Match={ASTERISK:"*",BACKSLASH:"\\",BANG:"!",BANG_SUFFIX_PATTERN:/!\w+$/,IMPORTANT_TOKEN:"!important",IMPORTANT_TOKEN_PATTERN:new RegExp("!important$","i"),IMPORTANT_WORD:"important",IMPORTANT_WORD_PATTERN:new RegExp("important$","i"),SUFFIX_BANG_PATTERN:/!$/,UNDERSCORE:"_",VARIABLE_REFERENCE_PATTERN:/var\(--.+\)$/};function wrapAll(c,g,e){var a=[];var f;var d;var b;for(b=c.length-1;b>=0;b--){d=c[b];if(d[0]!=Token.PROPERTY){continue}if(!g&&someVariableReferences(d)){continue}if(e&&e.indexOf(d[1][1])>-1){continue}f=wrapSingle(d);f.all=c;f.position=b;a.unshift(f)}return a}function someVariableReferences(d){var b,a;var c;for(b=2,a=d.length;b<a;b++){c=d[b];if(c[0]!=Token.PROPERTY_VALUE){continue}if(isVariableReference(c[1])){return true}}return false}function isVariableReference(a){return Match.VARIABLE_REFERENCE_PATTERN.test(a)}function isMultiplex(d){var c;var b,a;for(b=3,a=d.length;b<a;b++){c=d[b];if(c[0]==Token.PROPERTY_VALUE&&(c[1]==Marker.COMMA||c[1]==Marker.FORWARD_SLASH)){return true}}return false}function hackFrom(d){var c=false;var b=d[1][1];var a=d[d.length-1];if(b[0]==Match.UNDERSCORE){c=[Hack.UNDERSCORE]}else{if(b[0]==Match.ASTERISK){c=[Hack.ASTERISK]}else{if(a[1][0]==Match.BANG&&!a[1].match(Match.IMPORTANT_WORD_PATTERN)){c=[Hack.BANG]}else{if(a[1].indexOf(Match.BANG)>0&&!a[1].match(Match.IMPORTANT_WORD_PATTERN)&&Match.BANG_SUFFIX_PATTERN.test(a[1])){c=[Hack.BANG]}else{if(a[1].indexOf(Match.BACKSLASH)>0&&a[1].indexOf(Match.BACKSLASH)==a[1].length-Match.BACKSLASH.length-1){c=[Hack.BACKSLASH,a[1].substring(a[1].indexOf(Match.BACKSLASH)+1)]}else{if(a[1].indexOf(Match.BACKSLASH)===0&&a[1].length==2){c=[Hack.BACKSLASH,a[1].substring(1)]}}}}}}return c}function isImportant(b){if(b.length<3){return false}var a=b[b.length-1];if(Match.IMPORTANT_TOKEN_PATTERN.test(a[1])){return true}else{if(Match.IMPORTANT_WORD_PATTERN.test(a[1])&&Match.SUFFIX_BANG_PATTERN.test(b[b.length-2][1])){return true}}return false}function stripImportant(b){var a=b[b.length-1];var c=b[b.length-2];if(Match.IMPORTANT_TOKEN_PATTERN.test(a[1])){a[1]=a[1].replace(Match.IMPORTANT_TOKEN_PATTERN,"")}else{a[1]=a[1].replace(Match.IMPORTANT_WORD_PATTERN,"");c[1]=c[1].replace(Match.SUFFIX_BANG_PATTERN,"")}if(a[1].length===0){b.pop()}if(c[1].length===0){b.pop()}}function stripPrefixHack(a){a[1][1]=a[1][1].substring(1)}function stripSuffixHack(c,b){var a=c[c.length-1];a[1]=a[1].substring(0,a[1].indexOf(b[0]==Hack.BACKSLASH?Match.BACKSLASH:Match.BANG)).trim();if(a[1].length===0){c.pop()}}function wrapSingle(c){var b=isImportant(c);if(b){stripImportant(c)}var a=hackFrom(c);if(a[0]==Hack.ASTERISK||a[0]==Hack.UNDERSCORE){stripPrefixHack(c)}else{if(a[0]==Hack.BACKSLASH||a[0]==Hack.BANG){stripSuffixHack(c,a)}}return{block:c[2]&&c[2][0]==Token.PROPERTY_BLOCK,components:[],dirty:false,hack:a,important:b,name:c[1][1],multiplex:c.length>3?isMultiplex(c):false,position:0,shorthand:false,unused:false,value:c.slice(2)}}module.exports={all:wrapAll,single:wrapSingle};