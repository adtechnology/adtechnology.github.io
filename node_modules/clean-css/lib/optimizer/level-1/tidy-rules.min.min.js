var Spaces=require("../../options/format").Spaces;var Marker=require("../../tokenizer/marker");var formatPosition=require("../../utils/format-position");var CASE_ATTRIBUTE_PATTERN=/[\s"'][iI]\s*\]/;var CASE_RESTORE_PATTERN=/([\d\w])([iI])\]/g;var DOUBLE_QUOTE_CASE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"([iI])/g;var DOUBLE_QUOTE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"(\s|\])/g;var HTML_COMMENT_PATTERN=/^(?:(?:<!--|-->)\s*)+/;var SINGLE_QUOTE_CASE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'([iI])/g;var SINGLE_QUOTE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'(\s|\])/g;var RELATION_PATTERN=/[>\+~]/;var WHITESPACE_PATTERN=/\s/;var ASTERISK_PLUS_HTML_HACK="*+html ";var ASTERISK_FIRST_CHILD_PLUS_HTML_HACK="*:first-child+html ";var LESS_THAN="<";function hasInvalidCharacters(j){var n;var i=false;var k;var l=false;var m,h;for(m=0,h=j.length;m<h;m++){k=j[m];if(n){}else{if(k==Marker.SINGLE_QUOTE||k==Marker.DOUBLE_QUOTE){l=!l}else{if(!l&&(k==Marker.CLOSE_CURLY_BRACKET||k==Marker.EXCLAMATION||k==LESS_THAN||k==Marker.SEMICOLON)){i=true;break}else{if(!l&&m===0&&RELATION_PATTERN.test(k)){i=true;break}}}}n=k==Marker.BACK_SLASH}return i}function removeWhitespace(A,l){var B=[];var P;var L;var H;var I;var y;var G;var E;var M;var i;var O;var J;var K=0;var F=false;var D=false;var C=CASE_ATTRIBUTE_PATTERN.test(A);var N=l&&l.spaces[Spaces.AroundSelectorRelation];var x,z;for(x=0,z=A.length;x<z;x++){P=A[x];L=P==Marker.NEW_LINE_NIX;H=P==Marker.NEW_LINE_NIX&&A[x-1]==Marker.NEW_LINE_WIN;G=E||M;O=!i&&!I&&K===0&&RELATION_PATTERN.test(P);J=WHITESPACE_PATTERN.test(P);if(y&&G&&H){B.pop();B.pop()}else{if(I&&G&&L){B.pop()}else{if(I){B.push(P)}else{if(P==Marker.OPEN_SQUARE_BRACKET&&!G){B.push(P);i=true}else{if(P==Marker.CLOSE_SQUARE_BRACKET&&!G){B.push(P);i=false}else{if(P==Marker.OPEN_ROUND_BRACKET&&!G){B.push(P);K++}else{if(P==Marker.CLOSE_ROUND_BRACKET&&!G){B.push(P);K--}else{if(P==Marker.SINGLE_QUOTE&&!G){B.push(P);E=true}else{if(P==Marker.DOUBLE_QUOTE&&!G){B.push(P);M=true}else{if(P==Marker.SINGLE_QUOTE&&G){B.push(P);E=false}else{if(P==Marker.DOUBLE_QUOTE&&G){B.push(P);M=false}else{if(J&&F&&!N){continue}else{if(!J&&F&&N){B.push(Marker.SPACE);B.push(P)}else{if(J&&(i||K>0)&&!G){}else{if(J&&D&&!G){}else{if((H||L)&&(i||K>0)&&G){}else{if(O&&D&&!N){B.pop();B.push(P)}else{if(O&&!D&&N){B.push(Marker.SPACE);B.push(P)}else{if(J){B.push(Marker.SPACE)}else{B.push(P)}}}}}}}}}}}}}}}}}}}y=I;I=P==Marker.BACK_SLASH;F=O;D=J}return C?B.join("").replace(CASE_RESTORE_PATTERN,"$1 $2]"):B.join("")}function removeQuotes(b){if(b.indexOf("'")==-1&&b.indexOf('"')==-1){return b}return b.replace(SINGLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(SINGLE_QUOTE_PATTERN,"=$1$2").replace(DOUBLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(DOUBLE_QUOTE_PATTERN,"=$1$2")}function tidyRules(i,u,w,o,s){var r=[];var x=[];function l(a,b){s.push("HTML comment '"+b+"' at "+formatPosition(a[2][0])+". Removing.");return""}for(var t=0,v=i.length;t<v;t++){var p=i[t];var q=p[1];q=q.replace(HTML_COMMENT_PATTERN,l.bind(null,p));if(hasInvalidCharacters(q)){s.push("Invalid selector '"+p[1]+"' at "+formatPosition(p[2][0])+". Ignoring.");continue}q=removeWhitespace(q,o);q=removeQuotes(q);if(w&&q.indexOf("nav")>0){q=q.replace(/\+nav(\S|$)/,"+ nav$1")}if(u&&q.indexOf(ASTERISK_PLUS_HTML_HACK)>-1){continue}if(u&&q.indexOf(ASTERISK_FIRST_CHILD_PLUS_HTML_HACK)>-1){continue}if(q.indexOf("*")>-1){q=q.replace(/\*([:#\.\[])/g,"$1").replace(/^(\:first\-child)?\+html/,"*$1+html")}if(x.indexOf(q)>-1){continue}p[1]=q;x.push(q);r.push(p)}if(r.length==1&&r[0][1].length===0){s.push("Empty selector '"+r[0][1]+"' at "+formatPosition(r[0][2][0])+". Ignoring.");r=[]}return r}module.exports=tidyRules;