var Spaces=require("../../options/format").Spaces;var Marker=require("../../tokenizer/marker");var formatPosition=require("../../utils/format-position");var CASE_ATTRIBUTE_PATTERN=/[\s"'][iI]\s*\]/;var CASE_RESTORE_PATTERN=/([\d\w])([iI])\]/g;var DOUBLE_QUOTE_CASE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"([iI])/g;var DOUBLE_QUOTE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"(\s|\])/g;var HTML_COMMENT_PATTERN=/^(?:(?:<!--|-->)\s*)+/;var SINGLE_QUOTE_CASE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'([iI])/g;var SINGLE_QUOTE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'(\s|\])/g;var RELATION_PATTERN=/[>\+~]/;var WHITESPACE_PATTERN=/\s/;var ASTERISK_PLUS_HTML_HACK="*+html ";var ASTERISK_FIRST_CHILD_PLUS_HTML_HACK="*:first-child+html ";var LESS_THAN="<";function hasInvalidCharacters(g){var c;var a=false;var f;var e=false;var d,b;for(d=0,b=g.length;d<b;d++){f=g[d];if(c){}else{if(f==Marker.SINGLE_QUOTE||f==Marker.DOUBLE_QUOTE){e=!e}else{if(!e&&(f==Marker.CLOSE_CURLY_BRACKET||f==Marker.EXCLAMATION||f==LESS_THAN||f==Marker.SEMICOLON)){a=true;break}else{if(!e&&d===0&&RELATION_PATTERN.test(f)){a=true;break}}}}c=f==Marker.BACK_SLASH}return a}function removeWhitespace(r,v){var q=[];var a;var e;var j;var h;var t;var k;var n;var d;var w;var b;var g;var f=0;var m=false;var o=false;var p=CASE_ATTRIBUTE_PATTERN.test(r);var c=v&&v.spaces[Spaces.AroundSelectorRelation];var u,s;for(u=0,s=r.length;u<s;u++){a=r[u];e=a==Marker.NEW_LINE_NIX;j=a==Marker.NEW_LINE_NIX&&r[u-1]==Marker.NEW_LINE_WIN;k=n||d;b=!w&&!h&&f===0&&RELATION_PATTERN.test(a);g=WHITESPACE_PATTERN.test(a);if(t&&k&&j){q.pop();q.pop()}else{if(h&&k&&e){q.pop()}else{if(h){q.push(a)}else{if(a==Marker.OPEN_SQUARE_BRACKET&&!k){q.push(a);w=true}else{if(a==Marker.CLOSE_SQUARE_BRACKET&&!k){q.push(a);w=false}else{if(a==Marker.OPEN_ROUND_BRACKET&&!k){q.push(a);f++}else{if(a==Marker.CLOSE_ROUND_BRACKET&&!k){q.push(a);f--}else{if(a==Marker.SINGLE_QUOTE&&!k){q.push(a);n=true}else{if(a==Marker.DOUBLE_QUOTE&&!k){q.push(a);d=true}else{if(a==Marker.SINGLE_QUOTE&&k){q.push(a);n=false}else{if(a==Marker.DOUBLE_QUOTE&&k){q.push(a);d=false}else{if(g&&m&&!c){continue}else{if(!g&&m&&c){q.push(Marker.SPACE);q.push(a)}else{if(g&&(w||f>0)&&!k){}else{if(g&&o&&!k){}else{if((j||e)&&(w||f>0)&&k){}else{if(b&&o&&!c){q.pop();q.push(a)}else{if(b&&!o&&c){q.push(Marker.SPACE);q.push(a)}else{if(g){q.push(Marker.SPACE)}else{q.push(a)}}}}}}}}}}}}}}}}}}}t=h;h=a==Marker.BACK_SLASH;m=b;o=g}return p?q.join("").replace(CASE_RESTORE_PATTERN,"$1 $2]"):q.join("")}function removeQuotes(a){if(a.indexOf("'")==-1&&a.indexOf('"')==-1){return a}return a.replace(SINGLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(SINGLE_QUOTE_PATTERN,"=$1$2").replace(DOUBLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(DOUBLE_QUOTE_PATTERN,"=$1$2")}function tidyRules(n,d,b,k,f){var g=[];var a=[];function m(l,i){f.push("HTML comment '"+i+"' at "+formatPosition(l[2][0])+". Removing.");return""}for(var e=0,c=n.length;e<c;e++){var j=n[e];var h=j[1];h=h.replace(HTML_COMMENT_PATTERN,m.bind(null,j));if(hasInvalidCharacters(h)){f.push("Invalid selector '"+j[1]+"' at "+formatPosition(j[2][0])+". Ignoring.");continue}h=removeWhitespace(h,k);h=removeQuotes(h);if(b&&h.indexOf("nav")>0){h=h.replace(/\+nav(\S|$)/,"+ nav$1")}if(d&&h.indexOf(ASTERISK_PLUS_HTML_HACK)>-1){continue}if(d&&h.indexOf(ASTERISK_FIRST_CHILD_PLUS_HTML_HACK)>-1){continue}if(h.indexOf("*")>-1){h=h.replace(/\*([:#\.\[])/g,"$1").replace(/^(\:first\-child)?\+html/,"*$1+html")}if(a.indexOf(h)>-1){continue}j[1]=h;a.push(h);g.push(j)}if(g.length==1&&g[0][1].length===0){f.push("Empty selector '"+g[0][1]+"' at "+formatPosition(g[0][2][0])+". Ignoring.");g=[]}return g}module.exports=tidyRules;