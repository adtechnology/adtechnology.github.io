var fs=require("fs");var path=require("path");var applySourceMaps=require("./apply-source-maps");var extractImportUrlAndMedia=require("./extract-import-url-and-media");var isAllowedResource=require("./is-allowed-resource");var loadOriginalSources=require("./load-original-sources");var normalizePath=require("./normalize-path");var rebase=require("./rebase");var rebaseLocalMap=require("./rebase-local-map");var rebaseRemoteMap=require("./rebase-remote-map");var restoreImport=require("./restore-import");var tokenize=require("../tokenizer/tokenize");var Token=require("../tokenizer/token");var Marker=require("../tokenizer/marker");var hasProtocol=require("../utils/has-protocol");var isImport=require("../utils/is-import");var isRemoteResource=require("../utils/is-remote-resource");var UNKNOWN_URI="uri:unknown";function readSources(a,b,c){return doReadSources(a,b,function(d){return applySourceMaps(d,b,function(){return loadOriginalSources(b,function(){return c(d)})})})}function doReadSources(a,b,c){if(typeof a=="string"){return fromString(a,b,c)}else{if(Buffer.isBuffer(a)){return fromString(a.toString(),b,c)}else{if(Array.isArray(a)){return fromArray(a,b,c)}else{if(typeof a=="object"){return fromHash(a,b,c)}}}}}function fromString(a,b,c){b.source=undefined;b.sourcesContent[undefined]=a;b.stats.originalSize+=a.length;return fromStyles(a,b,{inline:b.options.inline},c)}function fromArray(a,b,d){var c=a.reduce(function(e,f){if(typeof f==="string"){return addStringSource(f,e)}else{return addHashSource(f,b,e)}},[]);return fromStyles(c.join(""),b,{inline:["all"]},d)}function fromHash(a,b,d){var c=addHashSource(a,b,[]);return fromStyles(c.join(""),b,{inline:["all"]},d)}function addStringSource(b,a){a.push(restoreAsImport(normalizeUri(b)));return a}function addHashSource(b,c,a){var d;var f;var e;for(d in b){e=b[d];f=normalizeUri(d);a.push(restoreAsImport(f));c.sourcesContent[f]=e.styles;if(e.sourceMap){trackSourceMap(e.sourceMap,f,c)}}return a}function normalizeUri(c){var b=path.resolve("");var e;var a;var d;if(isRemoteResource(c)){return c}e=path.isAbsolute(c)?c:path.resolve(c);a=path.relative(b,e);d=normalizePath(a);return d}function trackSourceMap(e,c,b){var a=typeof e=="string"?JSON.parse(e):e;var d=isRemoteResource(c)?rebaseRemoteMap(a,c):rebaseLocalMap(a,c||UNKNOWN_URI,b.options.rebaseTo);b.inputSourceMapTracker.track(c,d)}function restoreAsImport(a){return restoreImport("url("+a+")","")+Marker.SEMICOLON}function fromStyles(d,b,a,f){var e;var c={};if(!b.source){c.fromBase=path.resolve("");c.toBase=b.options.rebaseTo}else{if(isRemoteResource(b.source)){c.fromBase=b.source;c.toBase=b.source}else{if(path.isAbsolute(b.source)){c.fromBase=path.dirname(b.source);c.toBase=b.options.rebaseTo}else{c.fromBase=path.dirname(path.resolve(b.source));c.toBase=b.options.rebaseTo}}}e=tokenize(d,b);e=rebase(e,b.options.rebase,b.validator,c);return allowsAnyImports(a.inline)?inline(e,b,a,f):f(e)}function allowsAnyImports(a){return !(a.length==1&&a[0]=="none")}function inline(d,c,b,e){var a={afterContent:false,callback:e,errors:c.errors,externalContext:c,fetch:c.options.fetch,inlinedStylesheets:b.inlinedStylesheets||c.inlinedStylesheets,inline:b.inline,inlineRequest:c.options.inlineRequest,inlineTimeout:c.options.inlineTimeout,isRemote:b.isRemote||false,localOnly:c.localOnly,outputTokens:[],rebaseTo:c.options.rebaseTo,sourceTokens:d,warnings:c.warnings};return doInlineImports(a)}function doInlineImports(b){var d;var c,a;for(c=0,a=b.sourceTokens.length;c<a;c++){d=b.sourceTokens[c];if(d[0]==Token.AT_RULE&&isImport(d[1])){b.sourceTokens.splice(0,c);return inlineStylesheet(d,b)}else{if(d[0]==Token.AT_RULE||d[0]==Token.COMMENT){b.outputTokens.push(d)}else{b.outputTokens.push(d);b.afterContent=true}}}b.sourceTokens=[];return b.callback(b.outputTokens)}function inlineStylesheet(d,a){var b=extractImportUrlAndMedia(d[1]);var e=b[0];var f=b[1];var c=d[2];return isRemoteResource(e)?inlineRemoteStylesheet(e,f,c,a):inlineLocalStylesheet(e,f,c,a)}function inlineRemoteStylesheet(c,e,h,g){var d=isAllowedResource(c,true,g.inline);var i=c;var a=c in g.externalContext.sourcesContent;var f=!hasProtocol(c);if(g.inlinedStylesheets.indexOf(c)>-1){g.warnings.push('Ignoring remote @import of "'+c+'" as it has already been imported.');g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)}else{if(g.localOnly&&g.afterContent){g.warnings.push('Ignoring remote @import of "'+c+'" as no callback given and after other content.');g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)}else{if(f){g.warnings.push('Skipping remote @import of "'+c+'" as no protocol given.');g.outputTokens=g.outputTokens.concat(g.sourceTokens.slice(0,1));g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)}else{if(g.localOnly&&!a){g.warnings.push('Skipping remote @import of "'+c+'" as no callback given.');g.outputTokens=g.outputTokens.concat(g.sourceTokens.slice(0,1));g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)}else{if(!d&&g.afterContent){g.warnings.push('Ignoring remote @import of "'+c+'" as resource is not allowed and after other content.');g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)}else{if(!d){g.warnings.push('Skipping remote @import of "'+c+'" as resource is not allowed.');g.outputTokens=g.outputTokens.concat(g.sourceTokens.slice(0,1));g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)}}}}}}g.inlinedStylesheets.push(c);function b(j,k){if(j){g.errors.push('Broken @import declaration of "'+c+'" - '+j);return process.nextTick(function(){g.outputTokens=g.outputTokens.concat(g.sourceTokens.slice(0,1));g.sourceTokens=g.sourceTokens.slice(1);doInlineImports(g)})}g.inline=g.externalContext.options.inline;g.isRemote=true;g.externalContext.source=i;g.externalContext.sourcesContent[c]=k;g.externalContext.stats.originalSize+=k.length;return fromStyles(k,g.externalContext,g,function(l){l=wrapInMedia(l,e,h);g.outputTokens=g.outputTokens.concat(l);g.sourceTokens=g.sourceTokens.slice(1);return doInlineImports(g)})}return a?b(null,g.externalContext.sourcesContent[c]):g.fetch(c,g.inlineRequest,g.inlineTimeout,b)}function inlineLocalStylesheet(c,g,i,h){var j=path.resolve("");var b=path.isAbsolute(c)?path.resolve(j,c[0]=="/"?c.substring(1):c):path.resolve(h.rebaseTo,c);var k=path.relative(j,b);var f;var d=isAllowedResource(c,false,h.inline);var e=normalizePath(k);var a=e in h.externalContext.sourcesContent;if(h.inlinedStylesheets.indexOf(b)>-1){h.warnings.push('Ignoring local @import of "'+c+'" as it has already been imported.')}else{if(!a&&(!fs.existsSync(b)||!fs.statSync(b).isFile())){h.errors.push('Ignoring local @import of "'+c+'" as resource is missing.')}else{if(!d&&h.afterContent){h.warnings.push('Ignoring local @import of "'+c+'" as resource is not allowed and after other content.')}else{if(h.afterContent){h.warnings.push('Ignoring local @import of "'+c+'" as after other content.')}else{if(!d){h.warnings.push('Skipping local @import of "'+c+'" as resource is not allowed.');h.outputTokens=h.outputTokens.concat(h.sourceTokens.slice(0,1))}else{f=a?h.externalContext.sourcesContent[e]:fs.readFileSync(b,"utf-8");h.inlinedStylesheets.push(b);h.inline=h.externalContext.options.inline;h.externalContext.source=e;h.externalContext.sourcesContent[e]=f;h.externalContext.stats.originalSize+=f.length;return fromStyles(f,h.externalContext,h,function(l){l=wrapInMedia(l,g,i);h.outputTokens=h.outputTokens.concat(l);h.sourceTokens=h.sourceTokens.slice(1);return doInlineImports(h)})}}}}}h.sourceTokens=h.sourceTokens.slice(1);return doInlineImports(h)}function wrapInMedia(b,c,a){if(c){return[[Token.NESTED_BLOCK,[[Token.NESTED_BLOCK_SCOPE,"@media "+c,a]],b]]}else{return b}}module.exports=readSources;