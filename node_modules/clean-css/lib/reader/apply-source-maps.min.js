var fs=require("fs");var path=require("path");var isAllowedResource=require("./is-allowed-resource");var matchDataUri=require("./match-data-uri");var rebaseLocalMap=require("./rebase-local-map");var rebaseRemoteMap=require("./rebase-remote-map");var Token=require("../tokenizer/token");var hasProtocol=require("../utils/has-protocol");var isDataUriResource=require("../utils/is-data-uri-resource");var isRemoteResource=require("../utils/is-remote-resource");var MAP_MARKER_PATTERN=/^\/\*# sourceMappingURL=(\S+) \*\/$/;function applySourceMaps(b,a,d){var c={callback:d,fetch:a.options.fetch,index:0,inline:a.options.inline,inlineRequest:a.options.inlineRequest,inlineTimeout:a.options.inlineTimeout,inputSourceMapTracker:a.inputSourceMapTracker,localOnly:a.localOnly,processedTokens:[],rebaseTo:a.options.rebaseTo,sourceTokens:b,warnings:a.warnings};return a.options.sourceMap&&b.length>0?doApplySourceMaps(c):d(b)}function doApplySourceMaps(f){var e=[];var b=findTokenSource(f.sourceTokens[0]);var d;var c;var a;for(a=f.sourceTokens.length;f.index<a;f.index++){c=f.sourceTokens[f.index];d=findTokenSource(c);if(d!=b){e=[];b=d}e.push(c);f.processedTokens.push(c);if(c[0]==Token.COMMENT&&MAP_MARKER_PATTERN.test(c[1])){return fetchAndApplySourceMap(c[1],d,e,f)}}return f.callback(f.processedTokens)}function findTokenSource(b){var c;var a;if(b[0]==Token.AT_RULE||b[0]==Token.COMMENT){a=b[2][0]}else{c=b[1][0];a=c[2][0]}return a[2]}function fetchAndApplySourceMap(a,b,c,d){return extractInputSourceMapFrom(a,d,function(e){if(e){d.inputSourceMapTracker.track(b,e);applySourceMapRecursively(c,d.inputSourceMapTracker)}d.index++;return doApplySourceMaps(d)})}function extractInputSourceMapFrom(a,f,d){var b=MAP_MARKER_PATTERN.exec(a)[1];var g;var e;var c;if(isDataUriResource(b)){e=extractInputSourceMapFromDataUri(b);return d(e)}else{if(isRemoteResource(b)){return loadInputSourceMapFromRemoteUri(b,f,function(i){var h;if(i){h=JSON.parse(i);c=rebaseRemoteMap(h,b);d(c)}else{d(null)}})}else{g=path.resolve(f.rebaseTo,b);e=loadInputSourceMapFromLocalUri(g,f);if(e){c=rebaseLocalMap(e,g,f.rebaseTo);return d(c)}else{return d(null)}}}}function extractInputSourceMapFromDataUri(d){var b=matchDataUri(d);var f=b[2]?b[2].split(/[=;]/)[2]:"us-ascii";var c=b[3]?b[3].split(";")[1]:"utf8";var e=c=="utf8"?global.unescape(b[4]):b[4];var a=new Buffer(e,c);a.charset=f;return JSON.parse(a.toString())}function loadInputSourceMapFromRemoteUri(d,e,c){var b=isAllowedResource(d,true,e.inline);var a=!hasProtocol(d);if(e.localOnly){e.warnings.push('Cannot fetch remote resource from "'+d+'" as no callback given.');return c(null)}else{if(a){e.warnings.push('Cannot fetch "'+d+'" as no protocol given.');return c(null)}else{if(!b){e.warnings.push('Cannot fetch "'+d+'" as resource is not allowed.');return c(null)}}}e.fetch(d,e.inlineRequest,e.inlineTimeout,function(g,f){if(g){e.warnings.push('Missing source map at "'+d+'" - '+g);return c(null)}c(f)})}function loadInputSourceMapFromLocalUri(b,d){var a=isAllowedResource(b,false,d.inline);var c;if(!fs.existsSync(b)||!fs.statSync(b).isFile()){d.warnings.push('Ignoring local source map at "'+b+'" as resource is missing.');return null}else{if(!a){d.warnings.push('Cannot fetch "'+b+'" as resource is not allowed.');return null}}c=fs.readFileSync(b,"utf-8");return JSON.parse(c)}function applySourceMapRecursively(e,b){var d;var c,a;for(c=0,a=e.length;c<a;c++){d=e[c];switch(d[0]){case Token.AT_RULE:applySourceMapTo(d,b);break;case Token.AT_RULE_BLOCK:applySourceMapRecursively(d[1],b);applySourceMapRecursively(d[2],b);break;case Token.AT_RULE_BLOCK_SCOPE:applySourceMapTo(d,b);break;case Token.NESTED_BLOCK:applySourceMapRecursively(d[1],b);applySourceMapRecursively(d[2],b);break;case Token.NESTED_BLOCK_SCOPE:applySourceMapTo(d,b);break;case Token.COMMENT:applySourceMapTo(d,b);break;case Token.PROPERTY:applySourceMapRecursively(d,b);break;case Token.PROPERTY_BLOCK:applySourceMapRecursively(d[1],b);break;case Token.PROPERTY_NAME:applySourceMapTo(d,b);break;case Token.PROPERTY_VALUE:applySourceMapTo(d,b);break;case Token.RULE:applySourceMapRecursively(d[1],b);applySourceMapRecursively(d[2],b);break;case Token.RULE_SCOPE:applySourceMapTo(d,b)}}return e}function applySourceMapTo(e,b){var f=e[1];var d=e[2];var g=[];var c,a;for(c=0,a=d.length;c<a;c++){g.push(b.originalPositionFor(d[c],f.length))}e[2]=g}module.exports=applySourceMaps;