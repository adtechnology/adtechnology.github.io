var Marker=require("./marker");var Token=require("./token");var formatPosition=require("../utils/format-position");var Level={BLOCK:"block",COMMENT:"comment",DOUBLE_QUOTE:"double-quote",RULE:"rule",SINGLE_QUOTE:"single-quote"};var AT_RULES=["@charset","@import"];var BLOCK_RULES=["@-moz-document","@document","@-moz-keyframes","@-ms-keyframes","@-o-keyframes","@-webkit-keyframes","@keyframes","@media","@supports"];var PAGE_MARGIN_BOXES=["@bottom-center","@bottom-left","@bottom-left-corner","@bottom-right","@bottom-right-corner","@left-bottom","@left-middle","@left-top","@right-bottom","@right-middle","@right-top","@top-center","@top-left","@top-left-corner","@top-right","@top-right-corner"];var EXTRA_PAGE_BOXES=["@footnote","@footnotes","@left","@page-float-bottom","@page-float-top","@right"];var REPEAT_PATTERN=/^\[\s{0,31}\d+\s{0,31}\]$/;var RULE_WORD_SEPARATOR_PATTERN=/[\s\(]/;var TAIL_BROKEN_VALUE_PATTERN=/[\s|\}]*$/;function tokenize(d,e){var f={level:Level.BLOCK,position:{source:e.source||undefined,line:1,column:0,index:0}};return intoTokens(d,e,f,false)}function intoTokens(Q,aj,S,H){var W=[];var R=W;var Y;var K;var ae=[];var Z;var ab;var al=[];var am=S.level;var af=[];var J=[];var V=[];var M;var ah=0;var ac;var O;var ak;var ad;var U;var X=false;var ai;var aa=false;var L;var ag;var N=false;var I=false;var T=false;var P=S.position;for(;P.index<Q.length;P.index++){var an=Q[P.index];ac=am==Level.SINGLE_QUOTE||am==Level.DOUBLE_QUOTE;O=an==Marker.SPACE||an==Marker.TAB;ak=an==Marker.NEW_LINE_NIX;ad=an==Marker.NEW_LINE_NIX&&Q[P.index-1]==Marker.NEW_LINE_WIN;U=!aa&&am!=Level.COMMENT&&!ac&&an==Marker.ASTERISK&&Q[P.index-1]==Marker.FORWARD_SLASH;L=!X&&!ac&&an==Marker.FORWARD_SLASH&&Q[P.index-1]==Marker.ASTERISK;ai=am==Level.COMMENT&&L;ah=Math.max(ah,0);ab=J.length===0?[P.line,P.column,P.source]:ab;if(ag){J.push(an)}else{if(!ai&&am==Level.COMMENT){J.push(an)}else{if(U&&(am==Level.BLOCK||am==Level.RULE)&&J.length>1){al.push(ab);J.push(an);V.push(J.slice(0,J.length-2));J=J.slice(J.length-2);ab=[P.line,P.column-1,P.source];af.push(am);am=Level.COMMENT}else{if(U){af.push(am);am=Level.COMMENT;J.push(an)}else{if(ai){M=J.join("").trim()+an;Y=[Token.COMMENT,M,[originalMetadata(ab,M,aj)]];R.push(Y);am=af.pop();ab=al.pop()||null;J=V.pop()||[]}else{if(L&&Q[P.index+1]!=Marker.ASTERISK){aj.warnings.push("Unexpected '*/' at "+formatPosition([P.line,P.column,P.source])+".");J=[]}else{if(an==Marker.SINGLE_QUOTE&&!ac){af.push(am);am=Level.SINGLE_QUOTE;J.push(an)}else{if(an==Marker.SINGLE_QUOTE&&am==Level.SINGLE_QUOTE){am=af.pop();J.push(an)}else{if(an==Marker.DOUBLE_QUOTE&&!ac){af.push(am);am=Level.DOUBLE_QUOTE;J.push(an)}else{if(an==Marker.DOUBLE_QUOTE&&am==Level.DOUBLE_QUOTE){am=af.pop();J.push(an)}else{if(!U&&!ai&&an!=Marker.CLOSE_ROUND_BRACKET&&an!=Marker.OPEN_ROUND_BRACKET&&am!=Level.COMMENT&&!ac&&ah>0){J.push(an)}else{if(an==Marker.OPEN_ROUND_BRACKET&&!ac&&am!=Level.COMMENT&&!I){J.push(an);ah++}else{if(an==Marker.CLOSE_ROUND_BRACKET&&!ac&&am!=Level.COMMENT&&!I){J.push(an);ah--}else{if(an==Marker.SEMICOLON&&am==Level.BLOCK&&J[0]==Marker.AT){M=J.join("").trim();W.push([Token.AT_RULE,M,[originalMetadata(ab,M,aj)]]);J=[]}else{if(an==Marker.COMMA&&am==Level.BLOCK&&K){M=J.join("").trim();K[1].push([tokenScopeFrom(K[0]),M,[originalMetadata(ab,M,aj,K[1].length)]]);J=[]}else{if(an==Marker.COMMA&&am==Level.BLOCK&&tokenTypeFrom(J)==Token.AT_RULE){J.push(an)}else{if(an==Marker.COMMA&&am==Level.BLOCK){K=[tokenTypeFrom(J),[],[]];M=J.join("").trim();K[1].push([tokenScopeFrom(K[0]),M,[originalMetadata(ab,M,aj,0)]]);J=[]}else{if(an==Marker.OPEN_CURLY_BRACKET&&am==Level.BLOCK&&K&&K[0]==Token.NESTED_BLOCK){M=J.join("").trim();K[1].push([Token.NESTED_BLOCK_SCOPE,M,[originalMetadata(ab,M,aj)]]);W.push(K);af.push(am);P.column++;P.index++;J=[];K[2]=intoTokens(Q,aj,S,true);K=null}else{if(an==Marker.OPEN_CURLY_BRACKET&&am==Level.BLOCK&&tokenTypeFrom(J)==Token.NESTED_BLOCK){M=J.join("").trim();K=K||[Token.NESTED_BLOCK,[],[]];K[1].push([Token.NESTED_BLOCK_SCOPE,M,[originalMetadata(ab,M,aj)]]);W.push(K);af.push(am);P.column++;P.index++;J=[];K[2]=intoTokens(Q,aj,S,true);K=null}else{if(an==Marker.OPEN_CURLY_BRACKET&&am==Level.BLOCK){M=J.join("").trim();K=K||[tokenTypeFrom(J),[],[]];K[1].push([tokenScopeFrom(K[0]),M,[originalMetadata(ab,M,aj,K[1].length)]]);R=K[2];W.push(K);af.push(am);am=Level.RULE;J=[]}else{if(an==Marker.OPEN_CURLY_BRACKET&&am==Level.RULE&&I){ae.push(K);K=[Token.PROPERTY_BLOCK,[]];Z.push(K);R=K[1];af.push(am);am=Level.RULE;I=false}else{if(an==Marker.OPEN_CURLY_BRACKET&&am==Level.RULE&&isPageMarginBox(J)){M=J.join("").trim();ae.push(K);K=[Token.AT_RULE_BLOCK,[],[]];K[1].push([Token.AT_RULE_BLOCK_SCOPE,M,[originalMetadata(ab,M,aj)]]);R.push(K);R=K[2];af.push(am);am=Level.RULE;J=[]}else{if(an==Marker.COLON&&am==Level.RULE&&!I){M=J.join("").trim();Z=[Token.PROPERTY,[Token.PROPERTY_NAME,M,[originalMetadata(ab,M,aj)]]];R.push(Z);I=true;J=[]}else{if(an==Marker.SEMICOLON&&am==Level.RULE&&Z&&ae.length>0&&J.length>0&&J[0]==Marker.AT){M=J.join("").trim();K[1].push([Token.AT_RULE,M,[originalMetadata(ab,M,aj)]]);J=[]}else{if(an==Marker.SEMICOLON&&am==Level.RULE&&Z&&J.length>0){M=J.join("").trim();Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);Z=null;I=false;J=[]}else{if(an==Marker.SEMICOLON&&am==Level.RULE&&Z&&J.length===0){Z=null;I=false}else{if(an==Marker.SEMICOLON&&am==Level.RULE&&J.length>0&&J[0]==Marker.AT){M=J.join("");R.push([Token.AT_RULE,M,[originalMetadata(ab,M,aj)]]);I=false;J=[]}else{if(an==Marker.SEMICOLON&&am==Level.RULE&&T){T=false;J=[]}else{if(an==Marker.SEMICOLON&&am==Level.RULE&&J.length===0){}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE&&Z&&I&&J.length>0&&ae.length>0){M=J.join("");Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);Z=null;K=ae.pop();R=K[2];am=af.pop();I=false;J=[]}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE&&Z&&J.length>0&&J[0]==Marker.AT&&ae.length>0){M=J.join("");K[1].push([Token.AT_RULE,M,[originalMetadata(ab,M,aj)]]);Z=null;K=ae.pop();R=K[2];am=af.pop();I=false;J=[]}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE&&Z&&ae.length>0){Z=null;K=ae.pop();R=K[2];am=af.pop();I=false}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE&&Z&&J.length>0){M=J.join("");Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);Z=null;K=ae.pop();R=W;am=af.pop();I=false;J=[]}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE&&J.length>0&&J[0]==Marker.AT){Z=null;K=null;M=J.join("").trim();R.push([Token.AT_RULE,M,[originalMetadata(ab,M,aj)]]);R=W;am=af.pop();I=false;J=[]}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE&&af[af.length-1]==Level.RULE){Z=null;K=ae.pop();R=K[2];am=af.pop();I=false;T=true;J=[]}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.RULE){Z=null;K=null;R=W;am=af.pop();I=false}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.BLOCK&&!H&&P.index<=Q.length-1){aj.warnings.push("Unexpected '}' at "+formatPosition([P.line,P.column,P.source])+".");J.push(an)}else{if(an==Marker.CLOSE_CURLY_BRACKET&&am==Level.BLOCK){break}else{if(an==Marker.OPEN_ROUND_BRACKET&&am==Level.RULE&&I){J.push(an);ah++}else{if(an==Marker.CLOSE_ROUND_BRACKET&&am==Level.RULE&&I&&ah==1){J.push(an);M=J.join("").trim();Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);ah--;J=[]}else{if(an==Marker.CLOSE_ROUND_BRACKET&&am==Level.RULE&&I){J.push(an);ah--}else{if(an==Marker.FORWARD_SLASH&&Q[P.index+1]!=Marker.ASTERISK&&am==Level.RULE&&I&&J.length>0){M=J.join("").trim();Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);Z.push([Token.PROPERTY_VALUE,an,[[P.line,P.column,P.source]]]);J=[]}else{if(an==Marker.FORWARD_SLASH&&Q[P.index+1]!=Marker.ASTERISK&&am==Level.RULE&&I){Z.push([Token.PROPERTY_VALUE,an,[[P.line,P.column,P.source]]]);J=[]}else{if(an==Marker.COMMA&&am==Level.RULE&&I&&J.length>0){M=J.join("").trim();Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);Z.push([Token.PROPERTY_VALUE,an,[[P.line,P.column,P.source]]]);J=[]}else{if(an==Marker.COMMA&&am==Level.RULE&&I){Z.push([Token.PROPERTY_VALUE,an,[[P.line,P.column,P.source]]]);J=[]}else{if(an==Marker.CLOSE_SQUARE_BRACKET&&Z&&Z.length>1&&J.length>0&&isRepeatToken(J)){J.push(an);M=J.join("").trim();Z[Z.length-1][1]+=M;J=[]}else{if((O||(ak&&!ad))&&am==Level.RULE&&I&&Z&&J.length>0){M=J.join("").trim();Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);J=[]}else{if(ad&&am==Level.RULE&&I&&Z&&J.length>1){M=J.join("").trim();Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);J=[]}else{if(ad&&am==Level.RULE&&I){J=[]}else{if(J.length==1&&ad){J.pop()}else{if(J.length>0||!O&&!ak&&!ad){J.push(an)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}N=ag;ag=!N&&an==Marker.BACK_SLASH;X=U;aa=ai;P.line=(ad||ak)?P.line+1:P.line;P.column=(ad||ak)?0:P.column+1}if(I){aj.warnings.push("Missing '}' at "+formatPosition([P.line,P.column,P.source])+".")}if(I&&J.length>0){M=J.join("").replace(TAIL_BROKEN_VALUE_PATTERN,"");Z.push([Token.PROPERTY_VALUE,M,[originalMetadata(ab,M,aj)]]);J=[]}if(J.length>0){aj.warnings.push("Invalid character(s) '"+J.join("")+"' at "+formatPosition(ab)+". Ignoring.")}return W}function originalMetadata(f,h,i,g){var j=f[2];return i.inputSourceMapTracker.isTracking(j)?i.inputSourceMapTracker.originalPositionFor(f,h.length,g):f}function tokenTypeFrom(d){var f=d[0]==Marker.AT||d[0]==Marker.UNDERSCORE;var e=d.join("").split(RULE_WORD_SEPARATOR_PATTERN)[0];if(f&&BLOCK_RULES.indexOf(e)>-1){return Token.NESTED_BLOCK}else{if(f&&AT_RULES.indexOf(e)>-1){return Token.AT_RULE}else{if(f){return Token.AT_RULE_BLOCK}else{return Token.RULE}}}}function tokenScopeFrom(b){if(b==Token.RULE){return Token.RULE_SCOPE}else{if(b==Token.NESTED_BLOCK){return Token.NESTED_BLOCK_SCOPE}else{if(b==Token.AT_RULE_BLOCK){return Token.AT_RULE_BLOCK_SCOPE}}}}function isPageMarginBox(d){var c=d.join("").trim();return PAGE_MARGIN_BOXES.indexOf(c)>-1||EXTRA_PAGE_BOXES.indexOf(c)>-1}function isRepeatToken(b){return REPEAT_PATTERN.test(b.join("")+Marker.CLOSE_SQUARE_BRACKET)}module.exports=tokenize;