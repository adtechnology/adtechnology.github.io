var Marker=require("./marker");var Token=require("./token");var formatPosition=require("../utils/format-position");var Level={BLOCK:"block",COMMENT:"comment",DOUBLE_QUOTE:"double-quote",RULE:"rule",SINGLE_QUOTE:"single-quote"};var AT_RULES=["@charset","@import"];var BLOCK_RULES=["@-moz-document","@document","@-moz-keyframes","@-ms-keyframes","@-o-keyframes","@-webkit-keyframes","@keyframes","@media","@supports"];var PAGE_MARGIN_BOXES=["@bottom-center","@bottom-left","@bottom-left-corner","@bottom-right","@bottom-right-corner","@left-bottom","@left-middle","@left-top","@right-bottom","@right-middle","@right-top","@top-center","@top-left","@top-left-corner","@top-right","@top-right-corner"];var EXTRA_PAGE_BOXES=["@footnote","@footnotes","@left","@page-float-bottom","@page-float-top","@right"];var REPEAT_PATTERN=/^\[\s{0,31}\d+\s{0,31}\]$/;var RULE_WORD_SEPARATOR_PATTERN=/[\s\(]/;var TAIL_BROKEN_VALUE_PATTERN=/[\s|\}]*$/;function tokenize(b,a){var c={level:Level.BLOCK,position:{source:a.source||undefined,line:1,column:0,index:0}};return intoTokens(b,a,c,false)}function intoTokens(t,e,D,z){var q=[];var s=q;var A;var w;var j=[];var o;var m;var c=[];var b=D.level;var i=[];var x=[];var B=[];var v;var g=0;var l;var F;var d;var k;var r;var p=false;var f;var n=false;var G;var h;var u=false;var y=false;var C=false;var E=D.position;for(;E.index<t.length;E.index++){var a=t[E.index];l=b==Level.SINGLE_QUOTE||b==Level.DOUBLE_QUOTE;F=a==Marker.SPACE||a==Marker.TAB;d=a==Marker.NEW_LINE_NIX;k=a==Marker.NEW_LINE_NIX&&t[E.index-1]==Marker.NEW_LINE_WIN;r=!n&&b!=Level.COMMENT&&!l&&a==Marker.ASTERISK&&t[E.index-1]==Marker.FORWARD_SLASH;G=!p&&!l&&a==Marker.FORWARD_SLASH&&t[E.index-1]==Marker.ASTERISK;f=b==Level.COMMENT&&G;g=Math.max(g,0);m=x.length===0?[E.line,E.column,E.source]:m;if(h){x.push(a)}else{if(!f&&b==Level.COMMENT){x.push(a)}else{if(r&&(b==Level.BLOCK||b==Level.RULE)&&x.length>1){c.push(m);x.push(a);B.push(x.slice(0,x.length-2));x=x.slice(x.length-2);m=[E.line,E.column-1,E.source];i.push(b);b=Level.COMMENT}else{if(r){i.push(b);b=Level.COMMENT;x.push(a)}else{if(f){v=x.join("").trim()+a;A=[Token.COMMENT,v,[originalMetadata(m,v,e)]];s.push(A);b=i.pop();m=c.pop()||null;x=B.pop()||[]}else{if(G&&t[E.index+1]!=Marker.ASTERISK){e.warnings.push("Unexpected '*/' at "+formatPosition([E.line,E.column,E.source])+".");x=[]}else{if(a==Marker.SINGLE_QUOTE&&!l){i.push(b);b=Level.SINGLE_QUOTE;x.push(a)}else{if(a==Marker.SINGLE_QUOTE&&b==Level.SINGLE_QUOTE){b=i.pop();x.push(a)}else{if(a==Marker.DOUBLE_QUOTE&&!l){i.push(b);b=Level.DOUBLE_QUOTE;x.push(a)}else{if(a==Marker.DOUBLE_QUOTE&&b==Level.DOUBLE_QUOTE){b=i.pop();x.push(a)}else{if(!r&&!f&&a!=Marker.CLOSE_ROUND_BRACKET&&a!=Marker.OPEN_ROUND_BRACKET&&b!=Level.COMMENT&&!l&&g>0){x.push(a)}else{if(a==Marker.OPEN_ROUND_BRACKET&&!l&&b!=Level.COMMENT&&!y){x.push(a);g++}else{if(a==Marker.CLOSE_ROUND_BRACKET&&!l&&b!=Level.COMMENT&&!y){x.push(a);g--}else{if(a==Marker.SEMICOLON&&b==Level.BLOCK&&x[0]==Marker.AT){v=x.join("").trim();q.push([Token.AT_RULE,v,[originalMetadata(m,v,e)]]);x=[]}else{if(a==Marker.COMMA&&b==Level.BLOCK&&w){v=x.join("").trim();w[1].push([tokenScopeFrom(w[0]),v,[originalMetadata(m,v,e,w[1].length)]]);x=[]}else{if(a==Marker.COMMA&&b==Level.BLOCK&&tokenTypeFrom(x)==Token.AT_RULE){x.push(a)}else{if(a==Marker.COMMA&&b==Level.BLOCK){w=[tokenTypeFrom(x),[],[]];v=x.join("").trim();w[1].push([tokenScopeFrom(w[0]),v,[originalMetadata(m,v,e,0)]]);x=[]}else{if(a==Marker.OPEN_CURLY_BRACKET&&b==Level.BLOCK&&w&&w[0]==Token.NESTED_BLOCK){v=x.join("").trim();w[1].push([Token.NESTED_BLOCK_SCOPE,v,[originalMetadata(m,v,e)]]);q.push(w);i.push(b);E.column++;E.index++;x=[];w[2]=intoTokens(t,e,D,true);w=null}else{if(a==Marker.OPEN_CURLY_BRACKET&&b==Level.BLOCK&&tokenTypeFrom(x)==Token.NESTED_BLOCK){v=x.join("").trim();w=w||[Token.NESTED_BLOCK,[],[]];w[1].push([Token.NESTED_BLOCK_SCOPE,v,[originalMetadata(m,v,e)]]);q.push(w);i.push(b);E.column++;E.index++;x=[];w[2]=intoTokens(t,e,D,true);w=null}else{if(a==Marker.OPEN_CURLY_BRACKET&&b==Level.BLOCK){v=x.join("").trim();w=w||[tokenTypeFrom(x),[],[]];w[1].push([tokenScopeFrom(w[0]),v,[originalMetadata(m,v,e,w[1].length)]]);s=w[2];q.push(w);i.push(b);b=Level.RULE;x=[]}else{if(a==Marker.OPEN_CURLY_BRACKET&&b==Level.RULE&&y){j.push(w);w=[Token.PROPERTY_BLOCK,[]];o.push(w);s=w[1];i.push(b);b=Level.RULE;y=false}else{if(a==Marker.OPEN_CURLY_BRACKET&&b==Level.RULE&&isPageMarginBox(x)){v=x.join("").trim();j.push(w);w=[Token.AT_RULE_BLOCK,[],[]];w[1].push([Token.AT_RULE_BLOCK_SCOPE,v,[originalMetadata(m,v,e)]]);s.push(w);s=w[2];i.push(b);b=Level.RULE;x=[]}else{if(a==Marker.COLON&&b==Level.RULE&&!y){v=x.join("").trim();o=[Token.PROPERTY,[Token.PROPERTY_NAME,v,[originalMetadata(m,v,e)]]];s.push(o);y=true;x=[]}else{if(a==Marker.SEMICOLON&&b==Level.RULE&&o&&j.length>0&&x.length>0&&x[0]==Marker.AT){v=x.join("").trim();w[1].push([Token.AT_RULE,v,[originalMetadata(m,v,e)]]);x=[]}else{if(a==Marker.SEMICOLON&&b==Level.RULE&&o&&x.length>0){v=x.join("").trim();o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);o=null;y=false;x=[]}else{if(a==Marker.SEMICOLON&&b==Level.RULE&&o&&x.length===0){o=null;y=false}else{if(a==Marker.SEMICOLON&&b==Level.RULE&&x.length>0&&x[0]==Marker.AT){v=x.join("");s.push([Token.AT_RULE,v,[originalMetadata(m,v,e)]]);y=false;x=[]}else{if(a==Marker.SEMICOLON&&b==Level.RULE&&C){C=false;x=[]}else{if(a==Marker.SEMICOLON&&b==Level.RULE&&x.length===0){}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE&&o&&y&&x.length>0&&j.length>0){v=x.join("");o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);o=null;w=j.pop();s=w[2];b=i.pop();y=false;x=[]}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE&&o&&x.length>0&&x[0]==Marker.AT&&j.length>0){v=x.join("");w[1].push([Token.AT_RULE,v,[originalMetadata(m,v,e)]]);o=null;w=j.pop();s=w[2];b=i.pop();y=false;x=[]}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE&&o&&j.length>0){o=null;w=j.pop();s=w[2];b=i.pop();y=false}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE&&o&&x.length>0){v=x.join("");o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);o=null;w=j.pop();s=q;b=i.pop();y=false;x=[]}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE&&x.length>0&&x[0]==Marker.AT){o=null;w=null;v=x.join("").trim();s.push([Token.AT_RULE,v,[originalMetadata(m,v,e)]]);s=q;b=i.pop();y=false;x=[]}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE&&i[i.length-1]==Level.RULE){o=null;w=j.pop();s=w[2];b=i.pop();y=false;C=true;x=[]}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.RULE){o=null;w=null;s=q;b=i.pop();y=false}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.BLOCK&&!z&&E.index<=t.length-1){e.warnings.push("Unexpected '}' at "+formatPosition([E.line,E.column,E.source])+".");x.push(a)}else{if(a==Marker.CLOSE_CURLY_BRACKET&&b==Level.BLOCK){break}else{if(a==Marker.OPEN_ROUND_BRACKET&&b==Level.RULE&&y){x.push(a);g++}else{if(a==Marker.CLOSE_ROUND_BRACKET&&b==Level.RULE&&y&&g==1){x.push(a);v=x.join("").trim();o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);g--;x=[]}else{if(a==Marker.CLOSE_ROUND_BRACKET&&b==Level.RULE&&y){x.push(a);g--}else{if(a==Marker.FORWARD_SLASH&&t[E.index+1]!=Marker.ASTERISK&&b==Level.RULE&&y&&x.length>0){v=x.join("").trim();o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);o.push([Token.PROPERTY_VALUE,a,[[E.line,E.column,E.source]]]);x=[]}else{if(a==Marker.FORWARD_SLASH&&t[E.index+1]!=Marker.ASTERISK&&b==Level.RULE&&y){o.push([Token.PROPERTY_VALUE,a,[[E.line,E.column,E.source]]]);x=[]}else{if(a==Marker.COMMA&&b==Level.RULE&&y&&x.length>0){v=x.join("").trim();o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);o.push([Token.PROPERTY_VALUE,a,[[E.line,E.column,E.source]]]);x=[]}else{if(a==Marker.COMMA&&b==Level.RULE&&y){o.push([Token.PROPERTY_VALUE,a,[[E.line,E.column,E.source]]]);x=[]}else{if(a==Marker.CLOSE_SQUARE_BRACKET&&o&&o.length>1&&x.length>0&&isRepeatToken(x)){x.push(a);v=x.join("").trim();o[o.length-1][1]+=v;x=[]}else{if((F||(d&&!k))&&b==Level.RULE&&y&&o&&x.length>0){v=x.join("").trim();o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);x=[]}else{if(k&&b==Level.RULE&&y&&o&&x.length>1){v=x.join("").trim();o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);x=[]}else{if(k&&b==Level.RULE&&y){x=[]}else{if(x.length==1&&k){x.pop()}else{if(x.length>0||!F&&!d&&!k){x.push(a)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}u=h;h=!u&&a==Marker.BACK_SLASH;p=r;n=f;E.line=(k||d)?E.line+1:E.line;E.column=(k||d)?0:E.column+1}if(y){e.warnings.push("Missing '}' at "+formatPosition([E.line,E.column,E.source])+".")}if(y&&x.length>0){v=x.join("").replace(TAIL_BROKEN_VALUE_PATTERN,"");o.push([Token.PROPERTY_VALUE,v,[originalMetadata(m,v,e)]]);x=[]}if(x.length>0){e.warnings.push("Invalid character(s) '"+x.join("")+"' at "+formatPosition(m)+". Ignoring.")}return q}function originalMetadata(b,e,d,a){var c=b[2];return d.inputSourceMapTracker.isTracking(c)?d.inputSourceMapTracker.originalPositionFor(b,e.length,a):b}function tokenTypeFrom(b){var c=b[0]==Marker.AT||b[0]==Marker.UNDERSCORE;var a=b.join("").split(RULE_WORD_SEPARATOR_PATTERN)[0];if(c&&BLOCK_RULES.indexOf(a)>-1){return Token.NESTED_BLOCK}else{if(c&&AT_RULES.indexOf(a)>-1){return Token.AT_RULE}else{if(c){return Token.AT_RULE_BLOCK}else{return Token.RULE}}}}function tokenScopeFrom(a){if(a==Token.RULE){return Token.RULE_SCOPE}else{if(a==Token.NESTED_BLOCK){return Token.NESTED_BLOCK_SCOPE}else{if(a==Token.AT_RULE_BLOCK){return Token.AT_RULE_BLOCK_SCOPE}}}}function isPageMarginBox(a){var b=a.join("").trim();return PAGE_MARGIN_BOXES.indexOf(b)>-1||EXTRA_PAGE_BOXES.indexOf(b)>-1}function isRepeatToken(a){return REPEAT_PATTERN.test(a.join("")+Marker.CLOSE_SQUARE_BRACKET)}module.exports=tokenize;