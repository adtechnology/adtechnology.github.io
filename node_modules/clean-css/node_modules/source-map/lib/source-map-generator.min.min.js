var base64VLQ=require("./base64-vlq");var util=require("./util");var ArraySet=require("./array-set").ArraySet;var MappingList=require("./mapping-list").MappingList;function SourceMapGenerator(b){if(!b){b={}}this._file=util.getArg(b,"file",null);this._sourceRoot=util.getArg(b,"sourceRoot",null);this._skipValidation=util.getArg(b,"skipValidation",false);this._sources=new ArraySet();this._names=new ArraySet();this._mappings=new MappingList();this._sourcesContents=null}SourceMapGenerator.prototype._version=3;SourceMapGenerator.fromSourceMap=function SourceMapGenerator_fromSourceMap(d){var e=d.sourceRoot;var f=new SourceMapGenerator({file:d.file,sourceRoot:e});d.eachMapping(function(b){var a={generated:{line:b.generatedLine,column:b.generatedColumn}};if(b.source!=null){a.source=b.source;if(e!=null){a.source=util.relative(e,a.source)}a.original={line:b.originalLine,column:b.originalColumn};if(b.name!=null){a.name=b.name}}f.addMapping(a)});d.sources.forEach(function(b){var a=d.sourceContentFor(b);if(a!=null){f.setSourceContent(b,a)}});return f};SourceMapGenerator.prototype.addMapping=function SourceMapGenerator_addMapping(h){var g=util.getArg(h,"generated");var j=util.getArg(h,"original",null);var i=util.getArg(h,"source",null);var f=util.getArg(h,"name",null);if(!this._skipValidation){this._validateMapping(g,j,i,f)}if(i!=null){i=String(i);if(!this._sources.has(i)){this._sources.add(i)}}if(f!=null){f=String(f);if(!this._names.has(f)){this._names.add(f)}}this._mappings.add({generatedLine:g.line,generatedColumn:g.column,originalLine:j!=null&&j.line,originalColumn:j!=null&&j.column,source:i,name:f})};SourceMapGenerator.prototype.setSourceContent=function SourceMapGenerator_setSourceContent(e,f){var d=e;if(this._sourceRoot!=null){d=util.relative(this._sourceRoot,d)}if(f!=null){if(!this._sourcesContents){this._sourcesContents=Object.create(null)}this._sourcesContents[util.toSetString(d)]=f}else{if(this._sourcesContents){delete this._sourcesContents[util.toSetString(d)];if(Object.keys(this._sourcesContents).length===0){this._sourcesContents=null}}}};SourceMapGenerator.prototype.applySourceMap=function SourceMapGenerator_applySourceMap(l,m,h){var n=m;if(m==null){if(l.file==null){throw new Error('SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map\'s "file" property. Both were omitted.')}n=l.file}var i=this._sourceRoot;if(i!=null){n=util.relative(i,n)}var j=new ArraySet();var k=new ArraySet();this._mappings.unsortedForEach(function(c){if(c.source===n&&c.originalLine!=null){var b=l.originalPositionFor({line:c.originalLine,column:c.originalColumn});if(b.source!=null){c.source=b.source;if(h!=null){c.source=util.join(h,c.source)}if(i!=null){c.source=util.relative(i,c.source)}c.originalLine=b.line;c.originalColumn=b.column;if(b.name!=null){c.name=b.name}}}var a=c.source;if(a!=null&&!j.has(a)){j.add(a)}var d=c.name;if(d!=null&&!k.has(d)){k.add(d)}},this);this._sources=j;this._names=k;l.sources.forEach(function(b){var a=l.sourceContentFor(b);if(a!=null){if(h!=null){b=util.join(h,b)}if(i!=null){b=util.relative(i,b)}this.setSourceContent(b,a)}},this)};SourceMapGenerator.prototype._validateMapping=function SourceMapGenerator_validateMapping(f,h,e,g){if(h&&typeof h.line!=="number"&&typeof h.column!=="number"){throw new Error("original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.")}if(f&&"line" in f&&"column" in f&&f.line>0&&f.column>=0&&!h&&!e&&!g){return}else{if(f&&"line" in f&&"column" in f&&h&&"line" in h&&"column" in h&&f.line>0&&f.column>=0&&h.line>0&&h.column>=0&&e){return}else{throw new Error("Invalid mapping: "+JSON.stringify({generated:f,source:e,original:h,name:g}))}}};SourceMapGenerator.prototype._serializeMappings=function SourceMapGenerator_serializeMappings(){var A=0;var q=1;var r=0;var p=0;var s=0;var x=0;var i="";var u;var B;var y;var z;var v=this._mappings.toArray();for(var w=0,t=v.length;w<t;w++){B=v[w];u="";if(B.generatedLine!==q){A=0;while(B.generatedLine!==q){u+=";";q++}}else{if(w>0){if(!util.compareByGeneratedPositionsInflated(B,v[w-1])){continue}u+=","}}u+=base64VLQ.encode(B.generatedColumn-A);A=B.generatedColumn;if(B.source!=null){z=this._sources.indexOf(B.source);u+=base64VLQ.encode(z-x);x=z;u+=base64VLQ.encode(B.originalLine-1-p);p=B.originalLine-1;u+=base64VLQ.encode(B.originalColumn-r);r=B.originalColumn;if(B.name!=null){y=this._names.indexOf(B.name);u+=base64VLQ.encode(y-s);s=y}}i+=u}return i};SourceMapGenerator.prototype._generateSourcesContent=function SourceMapGenerator_generateSourcesContent(c,d){return c.map(function(a){if(!this._sourcesContents){return null}if(d!=null){a=util.relative(d,a)}var b=util.toSetString(a);return Object.prototype.hasOwnProperty.call(this._sourcesContents,b)?this._sourcesContents[b]:null},this)};SourceMapGenerator.prototype.toJSON=function SourceMapGenerator_toJSON(){var b={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};if(this._file!=null){b.file=this._file}if(this._sourceRoot!=null){b.sourceRoot=this._sourceRoot}if(this._sourcesContents){b.sourcesContent=this._generateSourcesContent(b.sources,b.sourceRoot)}return b};SourceMapGenerator.prototype.toString=function SourceMapGenerator_toString(){return JSON.stringify(this.toJSON())};exports.SourceMapGenerator=SourceMapGenerator;