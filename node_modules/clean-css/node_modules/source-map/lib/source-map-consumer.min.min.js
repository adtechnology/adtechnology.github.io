var util=require("./util");var binarySearch=require("./binary-search");var ArraySet=require("./array-set").ArraySet;var base64VLQ=require("./base64-vlq");var quickSort=require("./quick-sort").quickSort;function SourceMapConsumer(d){var c=d;if(typeof d==="string"){c=JSON.parse(d.replace(/^\)\]\}'/,""))}return c.sections!=null?new IndexedSourceMapConsumer(c):new BasicSourceMapConsumer(c)}SourceMapConsumer.fromSourceMap=function(b){return BasicSourceMapConsumer.fromSourceMap(b)};SourceMapConsumer.prototype._version=3;SourceMapConsumer.prototype.__generatedMappings=null;Object.defineProperty(SourceMapConsumer.prototype,"_generatedMappings",{get:function(){if(!this.__generatedMappings){this._parseMappings(this._mappings,this.sourceRoot)}return this.__generatedMappings}});SourceMapConsumer.prototype.__originalMappings=null;Object.defineProperty(SourceMapConsumer.prototype,"_originalMappings",{get:function(){if(!this.__originalMappings){this._parseMappings(this._mappings,this.sourceRoot)}return this.__originalMappings}});SourceMapConsumer.prototype._charIsMappingSeparator=function SourceMapConsumer_charIsMappingSeparator(e,c){var f=e.charAt(c);return f===";"||f===","};SourceMapConsumer.prototype._parseMappings=function SourceMapConsumer_parseMappings(c,d){throw new Error("Subclasses must implement _parseMappings")};SourceMapConsumer.GENERATED_ORDER=1;SourceMapConsumer.ORIGINAL_ORDER=2;SourceMapConsumer.GREATEST_LOWER_BOUND=1;SourceMapConsumer.LEAST_UPPER_BOUND=2;SourceMapConsumer.prototype.eachMapping=function SourceMapConsumer_eachMapping(n,l,j){var m=l||null;var h=j||SourceMapConsumer.GENERATED_ORDER;var k;switch(h){case SourceMapConsumer.GENERATED_ORDER:k=this._generatedMappings;break;case SourceMapConsumer.ORIGINAL_ORDER:k=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var i=this.sourceRoot;k.map(function(b){var a=b.source===null?null:this._sources.at(b.source);if(a!=null&&i!=null){a=util.join(i,a)}return{source:a,generatedLine:b.generatedLine,generatedColumn:b.generatedColumn,originalLine:b.originalLine,originalColumn:b.originalColumn,name:b.name===null?null:this._names.at(b.name)}},this).forEach(n,m)};SourceMapConsumer.prototype.allGeneratedPositionsFor=function SourceMapConsumer_allGeneratedPositionsFor(k){var p=util.getArg(k,"line");var m={source:util.getArg(k,"source"),originalLine:p,originalColumn:util.getArg(k,"column",0)};if(this.sourceRoot!=null){m.source=util.relative(this.sourceRoot,m.source)}if(!this._sources.has(m.source)){return[]}m.source=this._sources.indexOf(m.source);var l=[];var n=this._findMapping(m,this._originalMappings,"originalLine","originalColumn",util.compareByOriginalPositions,binarySearch.LEAST_UPPER_BOUND);if(n>=0){var o=this._originalMappings[n];if(k.column===undefined){var i=o.originalLine;while(o&&o.originalLine===i){l.push({line:util.getArg(o,"generatedLine",null),column:util.getArg(o,"generatedColumn",null),lastColumn:util.getArg(o,"lastGeneratedColumn",null)});o=this._originalMappings[++n]}}else{var j=o.originalColumn;while(o&&o.originalLine===p&&o.originalColumn==j){l.push({line:util.getArg(o,"generatedLine",null),column:util.getArg(o,"generatedColumn",null),lastColumn:util.getArg(o,"lastGeneratedColumn",null)});o=this._originalMappings[++n]}}}return l};exports.SourceMapConsumer=SourceMapConsumer;function BasicSourceMapConsumer(n){var o=n;if(typeof n==="string"){o=JSON.parse(n.replace(/^\)\]\}'/,""))}var m=util.getArg(o,"version");var r=util.getArg(o,"sources");var k=util.getArg(o,"names",[]);var j=util.getArg(o,"sourceRoot",null);var l=util.getArg(o,"sourcesContent",null);var p=util.getArg(o,"mappings");var q=util.getArg(o,"file",null);if(m!=this._version){throw new Error("Unsupported version: "+m)}r=r.map(String).map(util.normalize).map(function(a){return j&&util.isAbsolute(j)&&util.isAbsolute(a)?util.relative(j,a):a});this._names=ArraySet.fromArray(k.map(String),true);this._sources=ArraySet.fromArray(r,true);this.sourceRoot=j;this.sourcesContent=l;this._mappings=p;this.file=q}BasicSourceMapConsumer.prototype=Object.create(SourceMapConsumer.prototype);BasicSourceMapConsumer.prototype.consumer=SourceMapConsumer;BasicSourceMapConsumer.fromSourceMap=function SourceMapConsumer_fromSourceMap(q){var m=Object.create(BasicSourceMapConsumer.prototype);var o=m._names=ArraySet.fromArray(q._names.toArray(),true);var v=m._sources=ArraySet.fromArray(q._sources.toArray(),true);m.sourceRoot=q._sourceRoot;m.sourcesContent=q._generateSourcesContent(m._sources.toArray(),m.sourceRoot);m.file=q._file;var s=q._mappings.toArray().slice();var n=m.__generatedMappings=[];var t=m.__originalMappings=[];for(var r=0,u=s.length;r<u;r++){var p=s[r];var i=new Mapping;i.generatedLine=p.generatedLine;i.generatedColumn=p.generatedColumn;if(p.source){i.source=v.indexOf(p.source);i.originalLine=p.originalLine;i.originalColumn=p.originalColumn;if(p.name){i.name=o.indexOf(p.name)}t.push(i)}n.push(i)}quickSort(m.__originalMappings,util.compareByOriginalPositions);return m};BasicSourceMapConsumer.prototype._version=3;Object.defineProperty(BasicSourceMapConsumer.prototype,"sources",{get:function(){return this._sources.toArray().map(function(b){return this.sourceRoot!=null?util.join(this.sourceRoot,b):b},this)}});function Mapping(){this.generatedLine=0;this.generatedColumn=0;this.source=null;this.originalLine=null;this.originalColumn=null;this.name=null}BasicSourceMapConsumer.prototype._parseMappings=function SourceMapConsumer_parseMappings(B,t){var H=1;var K=0;var v=0;var D=0;var x=0;var u=0;var E=B.length;var C=0;var J={};var w={};var L=[];var G=[];var A,y,I,F,z;while(C<E){if(B.charAt(C)===";"){H++;C++;K=0}else{if(B.charAt(C)===","){C++}else{A=new Mapping();A.generatedLine=H;for(F=C;F<E;F++){if(this._charIsMappingSeparator(B,F)){break}}y=B.slice(C,F);I=J[y];if(I){C+=y.length}else{I=[];while(C<F){base64VLQ.decode(B,C,w);z=w.value;C=w.rest;I.push(z)}if(I.length===2){throw new Error("Found a source, but no line and column")}if(I.length===3){throw new Error("Found a source and line, but no column")}J[y]=I}A.generatedColumn=K+I[0];K=A.generatedColumn;if(I.length>1){A.source=x+I[1];x+=I[1];A.originalLine=v+I[2];v=A.originalLine;A.originalLine+=1;A.originalColumn=D+I[3];D=A.originalColumn;if(I.length>4){A.name=u+I[4];u+=I[4]}}G.push(A);if(typeof A.originalLine==="number"){L.push(A)}}}}quickSort(G,util.compareByGeneratedPositionsDeflated);this.__generatedMappings=G;quickSort(L,util.compareByOriginalPositions);this.__originalMappings=L};BasicSourceMapConsumer.prototype._findMapping=function SourceMapConsumer_findMapping(k,i,l,h,g,j){if(k[l]<=0){throw new TypeError("Line must be greater than or equal to 1, got "+k[l])}if(k[h]<0){throw new TypeError("Column must be greater than or equal to 0, got "+k[h])}return binarySearch.search(k,i,g,j)};BasicSourceMapConsumer.prototype.computeColumnSpans=function SourceMapConsumer_computeColumnSpans(){for(var d=0;d<this._generatedMappings.length;++d){var e=this._generatedMappings[d];if(d+1<this._generatedMappings.length){var f=this._generatedMappings[d+1];if(e.generatedLine===f.generatedLine){e.lastGeneratedColumn=f.generatedColumn-1;continue}}e.lastGeneratedColumn=Infinity}};BasicSourceMapConsumer.prototype.originalPositionFor=function SourceMapConsumer_originalPositionFor(i){var j={generatedLine:util.getArg(i,"line"),generatedColumn:util.getArg(i,"column")};var l=this._findMapping(j,this._generatedMappings,"generatedLine","generatedColumn",util.compareByGeneratedPositionsDeflated,util.getArg(i,"bias",SourceMapConsumer.GREATEST_LOWER_BOUND));if(l>=0){var g=this._generatedMappings[l];if(g.generatedLine===j.generatedLine){var k=util.getArg(g,"source",null);if(k!==null){k=this._sources.at(k);if(this.sourceRoot!=null){k=util.join(this.sourceRoot,k)}}var h=util.getArg(g,"name",null);if(h!==null){h=this._names.at(h)}return{source:k,line:util.getArg(g,"originalLine",null),column:util.getArg(g,"originalColumn",null),name:h}}}return{source:null,line:null,column:null,name:null}};BasicSourceMapConsumer.prototype.hasContentsOfAllSources=function BasicSourceMapConsumer_hasContentsOfAllSources(){if(!this.sourcesContent){return false}return this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(b){return b==null})};BasicSourceMapConsumer.prototype.sourceContentFor=function SourceMapConsumer_sourceContentFor(h,f){if(!this.sourcesContent){return null}if(this.sourceRoot!=null){h=util.relative(this.sourceRoot,h)}if(this._sources.has(h)){return this.sourcesContent[this._sources.indexOf(h)]}var e;if(this.sourceRoot!=null&&(e=util.urlParse(this.sourceRoot))){var g=h.replace(/^file:\/\//,"");if(e.scheme=="file"&&this._sources.has(g)){return this.sourcesContent[this._sources.indexOf(g)]}if((!e.path||e.path=="/")&&this._sources.has("/"+h)){return this.sourcesContent[this._sources.indexOf("/"+h)]}}if(f){return null}else{throw new Error('"'+h+'" is not in the SourceMap.')}};BasicSourceMapConsumer.prototype.generatedPositionFor=function SourceMapConsumer_generatedPositionFor(h){var j=util.getArg(h,"source");if(this.sourceRoot!=null){j=util.relative(this.sourceRoot,j)}if(!this._sources.has(j)){return{line:null,column:null,lastColumn:null}}j=this._sources.indexOf(j);var i={source:j,originalLine:util.getArg(h,"line"),originalColumn:util.getArg(h,"column")};var f=this._findMapping(i,this._originalMappings,"originalLine","originalColumn",util.compareByOriginalPositions,util.getArg(h,"bias",SourceMapConsumer.GREATEST_LOWER_BOUND));if(f>=0){var g=this._originalMappings[f];if(g.source===i.source){return{line:util.getArg(g,"generatedLine",null),column:util.getArg(g,"generatedColumn",null),lastColumn:util.getArg(g,"lastGeneratedColumn",null)}}}return{line:null,column:null,lastColumn:null}};exports.BasicSourceMapConsumer=BasicSourceMapConsumer;function IndexedSourceMapConsumer(g){var i=g;if(typeof g==="string"){i=JSON.parse(g.replace(/^\)\]\}'/,""))}var f=util.getArg(i,"version");var h=util.getArg(i,"sections");if(f!=this._version){throw new Error("Unsupported version: "+f)}this._sources=new ArraySet();this._names=new ArraySet();var j={line:-1,column:0};this._sections=h.map(function(c){if(c.url){throw new Error("Support for url field in sections not implemented.")}var a=util.getArg(c,"offset");var d=util.getArg(a,"line");var b=util.getArg(a,"column");if(d<j.line||(d===j.line&&b<j.column)){throw new Error("Section offsets must be ordered and non-overlapping.")}j=a;return{generatedOffset:{generatedLine:d+1,generatedColumn:b+1},consumer:new SourceMapConsumer(util.getArg(c,"map"))}})}IndexedSourceMapConsumer.prototype=Object.create(SourceMapConsumer.prototype);IndexedSourceMapConsumer.prototype.constructor=SourceMapConsumer;IndexedSourceMapConsumer.prototype._version=3;Object.defineProperty(IndexedSourceMapConsumer.prototype,"sources",{get:function(){var d=[];for(var f=0;f<this._sections.length;f++){for(var e=0;e<this._sections[f].consumer.sources.length;e++){d.push(this._sections[f].consumer.sources[e])}}return d}});IndexedSourceMapConsumer.prototype.originalPositionFor=function IndexedSourceMapConsumer_originalPositionFor(g){var h={generatedLine:util.getArg(g,"line"),generatedColumn:util.getArg(g,"column")};var e=binarySearch.search(h,this._sections,function(a,b){var c=a.generatedLine-b.generatedOffset.generatedLine;if(c){return c}return(a.generatedColumn-b.generatedOffset.generatedColumn)});var f=this._sections[e];if(!f){return{source:null,line:null,column:null,name:null}}return f.consumer.originalPositionFor({line:h.generatedLine-(f.generatedOffset.generatedLine-1),column:h.generatedColumn-(f.generatedOffset.generatedLine===h.generatedLine?f.generatedOffset.generatedColumn-1:0),bias:g.bias})};IndexedSourceMapConsumer.prototype.hasContentsOfAllSources=function IndexedSourceMapConsumer_hasContentsOfAllSources(){return this._sections.every(function(b){return b.consumer.hasContentsOfAllSources()})};IndexedSourceMapConsumer.prototype.sourceContentFor=function IndexedSourceMapConsumer_sourceContentFor(j,g){for(var f=0;f<this._sections.length;f++){var h=this._sections[f];var i=h.consumer.sourceContentFor(j,true);if(i){return i}}if(g){return null}else{throw new Error('"'+j+'" is not in the SourceMap.')}};IndexedSourceMapConsumer.prototype.generatedPositionFor=function IndexedSourceMapConsumer_generatedPositionFor(h){for(var j=0;j<this._sections.length;j++){var i=this._sections[j];if(i.consumer.sources.indexOf(util.getArg(h,"source"))===-1){continue}var f=i.consumer.generatedPositionFor(h);if(f){var g={line:f.line+(i.generatedOffset.generatedLine-1),column:f.column+(i.generatedOffset.generatedLine===f.line?i.generatedOffset.generatedColumn-1:0)};return g}}return{line:null,column:null}};IndexedSourceMapConsumer.prototype._parseMappings=function IndexedSourceMapConsumer_parseMappings(j,o){this.__generatedMappings=[];this.__originalMappings=[];for(var m=0;m<this._sections.length;m++){var i=this._sections[m];var q=i.consumer._generatedMappings;for(var n=0;n<q.length;n++){var s=q[n];var t=i.consumer._sources.at(s.source);if(i.consumer.sourceRoot!==null){t=util.join(i.consumer.sourceRoot,t)}this._sources.add(t);t=this._sources.indexOf(t);var r=i.consumer._names.at(s.name);this._names.add(r);r=this._names.indexOf(r);var p={source:t,generatedLine:s.generatedLine+(i.generatedOffset.generatedLine-1),generatedColumn:s.generatedColumn+(i.generatedOffset.generatedLine===s.generatedLine?i.generatedOffset.generatedColumn-1:0),originalLine:s.originalLine,originalColumn:s.originalColumn,name:r};this.__generatedMappings.push(p);if(typeof p.originalLine==="number"){this.__originalMappings.push(p)}}}quickSort(this.__generatedMappings,util.compareByGeneratedPositionsDeflated);quickSort(this.__originalMappings,util.compareByOriginalPositions)};exports.IndexedSourceMapConsumer=IndexedSourceMapConsumer;