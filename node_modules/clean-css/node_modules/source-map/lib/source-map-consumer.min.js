var util=require("./util");var binarySearch=require("./binary-search");var ArraySet=require("./array-set").ArraySet;var base64VLQ=require("./base64-vlq");var quickSort=require("./quick-sort").quickSort;function SourceMapConsumer(a){var b=a;if(typeof a==="string"){b=JSON.parse(a.replace(/^\)\]\}'/,""))}return b.sections!=null?new IndexedSourceMapConsumer(b):new BasicSourceMapConsumer(b)}SourceMapConsumer.fromSourceMap=function(a){return BasicSourceMapConsumer.fromSourceMap(a)};SourceMapConsumer.prototype._version=3;SourceMapConsumer.prototype.__generatedMappings=null;Object.defineProperty(SourceMapConsumer.prototype,"_generatedMappings",{get:function(){if(!this.__generatedMappings){this._parseMappings(this._mappings,this.sourceRoot)}return this.__generatedMappings}});SourceMapConsumer.prototype.__originalMappings=null;Object.defineProperty(SourceMapConsumer.prototype,"_originalMappings",{get:function(){if(!this.__originalMappings){this._parseMappings(this._mappings,this.sourceRoot)}return this.__originalMappings}});SourceMapConsumer.prototype._charIsMappingSeparator=function SourceMapConsumer_charIsMappingSeparator(a,b){var d=a.charAt(b);return d===";"||d===","};SourceMapConsumer.prototype._parseMappings=function SourceMapConsumer_parseMappings(b,a){throw new Error("Subclasses must implement _parseMappings")};SourceMapConsumer.GENERATED_ORDER=1;SourceMapConsumer.ORIGINAL_ORDER=2;SourceMapConsumer.GREATEST_LOWER_BOUND=1;SourceMapConsumer.LEAST_UPPER_BOUND=2;SourceMapConsumer.prototype.eachMapping=function SourceMapConsumer_eachMapping(c,e,g){var d=e||null;var b=g||SourceMapConsumer.GENERATED_ORDER;var f;switch(b){case SourceMapConsumer.GENERATED_ORDER:f=this._generatedMappings;break;case SourceMapConsumer.ORIGINAL_ORDER:f=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var a=this.sourceRoot;f.map(function(h){var i=h.source===null?null:this._sources.at(h.source);if(i!=null&&a!=null){i=util.join(a,i)}return{source:i,generatedLine:h.generatedLine,generatedColumn:h.generatedColumn,originalLine:h.originalLine,originalColumn:h.originalColumn,name:h.name===null?null:this._names.at(h.name)}},this).forEach(c,d)};SourceMapConsumer.prototype.allGeneratedPositionsFor=function SourceMapConsumer_allGeneratedPositionsFor(h){var c=util.getArg(h,"line");var f={source:util.getArg(h,"source"),originalLine:c,originalColumn:util.getArg(h,"column",0)};if(this.sourceRoot!=null){f.source=util.relative(this.sourceRoot,f.source)}if(!this._sources.has(f.source)){return[]}f.source=this._sources.indexOf(f.source);var g=[];var e=this._findMapping(f,this._originalMappings,"originalLine","originalColumn",util.compareByOriginalPositions,binarySearch.LEAST_UPPER_BOUND);if(e>=0){var d=this._originalMappings[e];if(h.column===undefined){var b=d.originalLine;while(d&&d.originalLine===b){g.push({line:util.getArg(d,"generatedLine",null),column:util.getArg(d,"generatedColumn",null),lastColumn:util.getArg(d,"lastGeneratedColumn",null)});d=this._originalMappings[++e]}}else{var a=d.originalColumn;while(d&&d.originalLine===c&&d.originalColumn==a){g.push({line:util.getArg(d,"generatedLine",null),column:util.getArg(d,"generatedColumn",null),lastColumn:util.getArg(d,"lastGeneratedColumn",null)});d=this._originalMappings[++e]}}}return g};exports.SourceMapConsumer=SourceMapConsumer;function BasicSourceMapConsumer(e){var d=e;if(typeof e==="string"){d=JSON.parse(e.replace(/^\)\]\}'/,""))}var f=util.getArg(d,"version");var a=util.getArg(d,"sources");var h=util.getArg(d,"names",[]);var i=util.getArg(d,"sourceRoot",null);var g=util.getArg(d,"sourcesContent",null);var c=util.getArg(d,"mappings");var b=util.getArg(d,"file",null);if(f!=this._version){throw new Error("Unsupported version: "+f)}a=a.map(String).map(util.normalize).map(function(j){return i&&util.isAbsolute(i)&&util.isAbsolute(j)?util.relative(i,j):j});this._names=ArraySet.fromArray(h.map(String),true);this._sources=ArraySet.fromArray(a,true);this.sourceRoot=i;this.sourcesContent=g;this._mappings=c;this.file=b}BasicSourceMapConsumer.prototype=Object.create(SourceMapConsumer.prototype);BasicSourceMapConsumer.prototype.consumer=SourceMapConsumer;BasicSourceMapConsumer.fromSourceMap=function SourceMapConsumer_fromSourceMap(f){var k=Object.create(BasicSourceMapConsumer.prototype);var h=k._names=ArraySet.fromArray(f._names.toArray(),true);var a=k._sources=ArraySet.fromArray(f._sources.toArray(),true);k.sourceRoot=f._sourceRoot;k.sourcesContent=f._generateSourcesContent(k._sources.toArray(),k.sourceRoot);k.file=f._file;var d=f._mappings.toArray().slice();var j=k.__generatedMappings=[];var c=k.__originalMappings=[];for(var e=0,b=d.length;e<b;e++){var g=d[e];var l=new Mapping;l.generatedLine=g.generatedLine;l.generatedColumn=g.generatedColumn;if(g.source){l.source=a.indexOf(g.source);l.originalLine=g.originalLine;l.originalColumn=g.originalColumn;if(g.name){l.name=h.indexOf(g.name)}c.push(l)}j.push(l)}quickSort(k.__originalMappings,util.compareByOriginalPositions);return k};BasicSourceMapConsumer.prototype._version=3;Object.defineProperty(BasicSourceMapConsumer.prototype,"sources",{get:function(){return this._sources.toArray().map(function(a){return this.sourceRoot!=null?util.join(this.sourceRoot,a):a},this)}});function Mapping(){this.generatedLine=0;this.generatedColumn=0;this.source=null;this.originalLine=null;this.originalColumn=null;this.name=null}BasicSourceMapConsumer.prototype._parseMappings=function SourceMapConsumer_parseMappings(k,s){var e=1;var b=0;var q=0;var i=0;var o=0;var r=0;var h=k.length;var j=0;var c={};var p={};var a=[];var f=[];var l,n,d,g,m;while(j<h){if(k.charAt(j)===";"){e++;j++;b=0}else{if(k.charAt(j)===","){j++}else{l=new Mapping();l.generatedLine=e;for(g=j;g<h;g++){if(this._charIsMappingSeparator(k,g)){break}}n=k.slice(j,g);d=c[n];if(d){j+=n.length}else{d=[];while(j<g){base64VLQ.decode(k,j,p);m=p.value;j=p.rest;d.push(m)}if(d.length===2){throw new Error("Found a source, but no line and column")}if(d.length===3){throw new Error("Found a source and line, but no column")}c[n]=d}l.generatedColumn=b+d[0];b=l.generatedColumn;if(d.length>1){l.source=o+d[1];o+=d[1];l.originalLine=q+d[2];q=l.originalLine;l.originalLine+=1;l.originalColumn=i+d[3];i=l.originalColumn;if(d.length>4){l.name=r+d[4];r+=d[4]}}f.push(l);if(typeof l.originalLine==="number"){a.push(l)}}}}quickSort(f,util.compareByGeneratedPositionsDeflated);this.__generatedMappings=f;quickSort(a,util.compareByOriginalPositions);this.__originalMappings=a};BasicSourceMapConsumer.prototype._findMapping=function SourceMapConsumer_findMapping(d,f,c,a,b,e){if(d[c]<=0){throw new TypeError("Line must be greater than or equal to 1, got "+d[c])}if(d[a]<0){throw new TypeError("Column must be greater than or equal to 0, got "+d[a])}return binarySearch.search(d,f,b,e)};BasicSourceMapConsumer.prototype.computeColumnSpans=function SourceMapConsumer_computeColumnSpans(){for(var b=0;b<this._generatedMappings.length;++b){var a=this._generatedMappings[b];if(b+1<this._generatedMappings.length){var c=this._generatedMappings[b+1];if(a.generatedLine===c.generatedLine){a.lastGeneratedColumn=c.generatedColumn-1;continue}}a.lastGeneratedColumn=Infinity}};BasicSourceMapConsumer.prototype.originalPositionFor=function SourceMapConsumer_originalPositionFor(f){var e={generatedLine:util.getArg(f,"line"),generatedColumn:util.getArg(f,"column")};var c=this._findMapping(e,this._generatedMappings,"generatedLine","generatedColumn",util.compareByGeneratedPositionsDeflated,util.getArg(f,"bias",SourceMapConsumer.GREATEST_LOWER_BOUND));if(c>=0){var b=this._generatedMappings[c];if(b.generatedLine===e.generatedLine){var d=util.getArg(b,"source",null);if(d!==null){d=this._sources.at(d);if(this.sourceRoot!=null){d=util.join(this.sourceRoot,d)}}var a=util.getArg(b,"name",null);if(a!==null){a=this._names.at(a)}return{source:d,line:util.getArg(b,"originalLine",null),column:util.getArg(b,"originalColumn",null),name:a}}}return{source:null,line:null,column:null,name:null}};BasicSourceMapConsumer.prototype.hasContentsOfAllSources=function BasicSourceMapConsumer_hasContentsOfAllSources(){if(!this.sourcesContent){return false}return this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(a){return a==null})};BasicSourceMapConsumer.prototype.sourceContentFor=function SourceMapConsumer_sourceContentFor(c,a){if(!this.sourcesContent){return null}if(this.sourceRoot!=null){c=util.relative(this.sourceRoot,c)}if(this._sources.has(c)){return this.sourcesContent[this._sources.indexOf(c)]}var b;if(this.sourceRoot!=null&&(b=util.urlParse(this.sourceRoot))){var d=c.replace(/^file:\/\//,"");if(b.scheme=="file"&&this._sources.has(d)){return this.sourcesContent[this._sources.indexOf(d)]}if((!b.path||b.path=="/")&&this._sources.has("/"+c)){return this.sourcesContent[this._sources.indexOf("/"+c)]}}if(a){return null}else{throw new Error('"'+c+'" is not in the SourceMap.')}};BasicSourceMapConsumer.prototype.generatedPositionFor=function SourceMapConsumer_generatedPositionFor(e){var c=util.getArg(e,"source");if(this.sourceRoot!=null){c=util.relative(this.sourceRoot,c)}if(!this._sources.has(c)){return{line:null,column:null,lastColumn:null}}c=this._sources.indexOf(c);var d={source:c,originalLine:util.getArg(e,"line"),originalColumn:util.getArg(e,"column")};var b=this._findMapping(d,this._originalMappings,"originalLine","originalColumn",util.compareByOriginalPositions,util.getArg(e,"bias",SourceMapConsumer.GREATEST_LOWER_BOUND));if(b>=0){var a=this._originalMappings[b];if(a.source===d.source){return{line:util.getArg(a,"generatedLine",null),column:util.getArg(a,"generatedColumn",null),lastColumn:util.getArg(a,"lastGeneratedColumn",null)}}}return{line:null,column:null,lastColumn:null}};exports.BasicSourceMapConsumer=BasicSourceMapConsumer;function IndexedSourceMapConsumer(a){var d=a;if(typeof a==="string"){d=JSON.parse(a.replace(/^\)\]\}'/,""))}var b=util.getArg(d,"version");var e=util.getArg(d,"sections");if(b!=this._version){throw new Error("Unsupported version: "+b)}this._sources=new ArraySet();this._names=new ArraySet();var c={line:-1,column:0};this._sections=e.map(function(g){if(g.url){throw new Error("Support for url field in sections not implemented.")}var i=util.getArg(g,"offset");var f=util.getArg(i,"line");var h=util.getArg(i,"column");if(f<c.line||(f===c.line&&h<c.column)){throw new Error("Section offsets must be ordered and non-overlapping.")}c=i;return{generatedOffset:{generatedLine:f+1,generatedColumn:h+1},consumer:new SourceMapConsumer(util.getArg(g,"map"))}})}IndexedSourceMapConsumer.prototype=Object.create(SourceMapConsumer.prototype);IndexedSourceMapConsumer.prototype.constructor=SourceMapConsumer;IndexedSourceMapConsumer.prototype._version=3;Object.defineProperty(IndexedSourceMapConsumer.prototype,"sources",{get:function(){var b=[];for(var c=0;c<this._sections.length;c++){for(var a=0;a<this._sections[c].consumer.sources.length;a++){b.push(this._sections[c].consumer.sources[a])}}return b}});IndexedSourceMapConsumer.prototype.originalPositionFor=function IndexedSourceMapConsumer_originalPositionFor(d){var c={generatedLine:util.getArg(d,"line"),generatedColumn:util.getArg(d,"column")};var b=binarySearch.search(c,this._sections,function(g,f){var e=g.generatedLine-f.generatedOffset.generatedLine;if(e){return e}return(g.generatedColumn-f.generatedOffset.generatedColumn)});var a=this._sections[b];if(!a){return{source:null,line:null,column:null,name:null}}return a.consumer.originalPositionFor({line:c.generatedLine-(a.generatedOffset.generatedLine-1),column:c.generatedColumn-(a.generatedOffset.generatedLine===c.generatedLine?a.generatedOffset.generatedColumn-1:0),bias:d.bias})};IndexedSourceMapConsumer.prototype.hasContentsOfAllSources=function IndexedSourceMapConsumer_hasContentsOfAllSources(){return this._sections.every(function(a){return a.consumer.hasContentsOfAllSources()})};IndexedSourceMapConsumer.prototype.sourceContentFor=function IndexedSourceMapConsumer_sourceContentFor(c,a){for(var b=0;b<this._sections.length;b++){var e=this._sections[b];var d=e.consumer.sourceContentFor(c,true);if(d){return d}}if(a){return null}else{throw new Error('"'+c+'" is not in the SourceMap.')}};IndexedSourceMapConsumer.prototype.generatedPositionFor=function IndexedSourceMapConsumer_generatedPositionFor(e){for(var c=0;c<this._sections.length;c++){var d=this._sections[c];if(d.consumer.sources.indexOf(util.getArg(e,"source"))===-1){continue}var b=d.consumer.generatedPositionFor(e);if(b){var a={line:b.line+(d.generatedOffset.generatedLine-1),column:b.column+(d.generatedOffset.generatedLine===b.line?d.generatedOffset.generatedColumn-1:0)};return a}}return{line:null,column:null}};IndexedSourceMapConsumer.prototype._parseMappings=function IndexedSourceMapConsumer_parseMappings(k,f){this.__generatedMappings=[];this.__originalMappings=[];for(var h=0;h<this._sections.length;h++){var l=this._sections[h];var d=l.consumer._generatedMappings;for(var g=0;g<d.length;g++){var b=d[g];var a=l.consumer._sources.at(b.source);if(l.consumer.sourceRoot!==null){a=util.join(l.consumer.sourceRoot,a)}this._sources.add(a);a=this._sources.indexOf(a);var c=l.consumer._names.at(b.name);this._names.add(c);c=this._names.indexOf(c);var e={source:a,generatedLine:b.generatedLine+(l.generatedOffset.generatedLine-1),generatedColumn:b.generatedColumn+(l.generatedOffset.generatedLine===b.generatedLine?l.generatedOffset.generatedColumn-1:0),originalLine:b.originalLine,originalColumn:b.originalColumn,name:c};this.__generatedMappings.push(e);if(typeof e.originalLine==="number"){this.__originalMappings.push(e)}}}quickSort(this.__generatedMappings,util.compareByGeneratedPositionsDeflated);quickSort(this.__originalMappings,util.compareByOriginalPositions)};exports.IndexedSourceMapConsumer=IndexedSourceMapConsumer;